<!DOCTYPE html>
<html>
<head>
  <title>IFWL Admin Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <h2>IFWL Admin Login</h2>
  <button id="loginBtn" type="button">Sign in with Google</button>
  <p id="status">JS loaded…</p>

  <!-- Firebase SDK (v8 compat) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <!-- Your init -->
  <script src="./firebase-init.js"></script>

  <script>
    const statusEl = document.getElementById("status");

    window.addEventListener("error", (e) => {
      statusEl.innerText = "JS error: " + e.message;
    });

    window.addEventListener("unhandledrejection", (e) => {
      statusEl.innerText = "Promise error: " + (e.reason?.message || e.reason);
    });

    // sanity checks
    statusEl.innerText =
      "firebase: " + (typeof firebase) +
      " | auth: " + (firebase?.auth ? "ok" : "missing") +
      " | firestore: " + (firebase?.firestore ? "ok" : "missing");

    document.getElementById("loginBtn").addEventListener("click", async () => {
      statusEl.innerText = "Clicked. Opening Google login…";

      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await firebase.auth().signInWithPopup(provider);

        const email = result.user.email.toLowerCase();
        statusEl.innerText = "Signed in: " + email + " (checking access…)";

        const snap = await firebase.firestore().collection("admins").doc(email).get();
        if (!snap.exists) {
          statusEl.innerText = "Access denied.";
          await firebase.auth().signOut();
          return;
        }

        const data = snap.data() || {};
        const roleRaw = (data.role || "").toLowerCase();
        const isOwner = data.owner === true;
        const isHead = roleRaw.includes("head") || data.headsteward === true || isOwner;

        statusEl.innerText = "Access OK. Redirecting…";
        window.location.href = isHead ? "headsteward.html" : "steward.html";

      } catch (e) {
        statusEl.innerText = "Login failed: " + e.message;
      }
    });
  </script>
</body>
</html>
