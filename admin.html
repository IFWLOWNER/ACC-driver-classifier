<!DOCTYPE html>
<html>
<head>
  <title>IFWL Admin Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>
  <h2>IFWL Admin Login</h2>
  <button id="loginBtn" type="button">Sign in with Google</button>
  <p id="status">Loading…</p>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- Your init (cache-busted) -->
  <script src="./firebase-init.js?v=1"></script>

  <script>
    const statusEl = document.getElementById("status");
    const loginBtn = document.getElementById("loginBtn");

    window.addEventListener("error", (e) => {
      statusEl.innerText = "JS error: " + e.message;
    });

    window.addEventListener("unhandledrejection", (e) => {
      statusEl.innerText = "Promise error: " + (e.reason?.message || e.reason);
    });

    // sanity checks (after scripts load)
    try {
      const appsCount = (firebase.apps && firebase.apps.length) ? firebase.apps.length : 0;

      statusEl.innerText =
        "firebase: " + (typeof firebase) +
        " | apps: " + appsCount +
        " | auth: " + (firebase?.auth ? "ok" : "missing") +
        " | firestore: " + (firebase?.firestore ? "ok" : "missing");

      if (appsCount === 0) statusEl.innerText += " ❌";
      else statusEl.innerText += " ✅";
    } catch (e) {
      statusEl.innerText = "Init check failed: " + e.message;
    }

    loginBtn.addEventListener("click", async () => {
      loginBtn.disabled = true;
      statusEl.innerText = "Clicked. Opening Google login…";

      try {
        const provider = new firebase.auth.GoogleAuthProvider();
        const result = await firebase.auth().signInWithPopup(provider);

        const email = (result.user.email || "").toLowerCase().trim();
        statusEl.innerText = "Signed in: " + email + " (checking access…)";

        const snap = await firebase.firestore().collection("admins").doc(email).get();
        if (!snap.exists) {
          statusEl.innerText = "Access denied.";
          await firebase.auth().signOut();
          loginBtn.disabled = false;
          return;
        }

        const data = snap.data() || {};
        const roleRaw = (data.role || "").toLowerCase();
        const isOwner = data.owner === true;
        const isHead = roleRaw.includes("head") || data.headsteward === true || isOwner;

        statusEl.innerText = "Access OK. Redirecting…";
        window.location.href = isHead ? "headsteward.html" : "steward.html";

      } catch (e) {
        statusEl.innerText = "Login failed: " + e.message;
        loginBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
