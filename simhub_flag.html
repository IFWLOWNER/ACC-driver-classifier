<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Flag</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui;background:transparent;overflow:hidden}
    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .panel{
      width:min(520px, 96vw);
      border-radius:24px;
      border:2px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
      padding: 18px 16px;
      text-align:center;
      color:#fff;
      box-shadow:0 18px 55px rgba(0,0,0,.55);
    }
    .big{
      font-weight:1000;
      letter-spacing:.6px;
      font-size: clamp(28px, 4.5vw, 44px);
      margin:0 0 8px;
    }
    .sub{
      margin:0;
      opacity:.9;
      font-size: clamp(14px, 2.2vw, 18px);
      line-height:1.25;
    }
    .stamp{
      margin-top:10px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
      opacity:.85;
    }

    /* state visuals */
    @keyframes rfFlash { 0%,49%{background:#000;} 50%,100%{background:#b30000;} }
    body.red { animation: rfFlash .7s infinite; }
    .dot{display:inline-block;width:14px;height:14px;border-radius:999px;margin-right:10px;vertical-align:middle}
    .dot.green{background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.18)}
    .dot.red{background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.18)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="big" id="title"><span class="dot green" id="dot"></span>GREEN FLAG</div>
      <p class="sub" id="msg">Race control : green flag (does not overide yellow or blue).</p>
      <div class="stamp" id="stamp">Last update: —</div>
    </div>
  </div>

  <script>
    // Your Worker
    const WORKER_BASE = "https://fancy-frog-e248.benjamin-leahy1.workers.dev";

    // Faster polling for overlays
    const POLL_MS = 750;

    const title = document.getElementById("title");
    const msg = document.getElementById("msg");
    const dot = document.getElementById("dot");
    const stamp = document.getElementById("stamp");

    let lastState = null;

    function fmt(ts){
      try { return new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}); }
      catch { return "—"; }
    }

    function apply(state, updatedAt){
      const isRed = state === "red";
      document.body.classList.toggle("red", isRed);

      dot.className = "dot " + (isRed ? "red" : "green");
      title.innerHTML = `<span class="${dot.className}"></span>${isRed ? "RED FLAG" : "RACE CONTROL : GREEN"}`;
      msg.textContent = isRed
        ? "Return to pits immediately. Send standings screenshot into Discord."
        : "RACE CONTROL : GREEN.";
      stamp.textContent = "Last update: " + (updatedAt ? fmt(updatedAt) : "—");
    }

    async function poll(){
      try{
        // cache-buster to avoid any caching anywhere
        const res = await fetch(`${WORKER_BASE}/state?t=${Date.now()}`, { cache:"no-store" });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        const state = (data?.state || "green").toLowerCase();
        const updatedAt = data?.updatedAt || null;

        if(state !== lastState){
          lastState = state;
          apply(state, updatedAt);
        } else if(updatedAt){
          stamp.textContent = "Last update: " + fmt(updatedAt);
        }
      }catch(e){
        // If it fails, keep last shown state (no spam)
      }
    }

    poll();
    setInterval(poll, POLL_MS);
  </script>
</body>
</html>
