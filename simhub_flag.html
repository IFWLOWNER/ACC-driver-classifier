<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Flag + Check-In</title>
  <style>
    html,body{
      height:100%;
      margin:0;
      font-family:system-ui;
      overflow:hidden;
    }

    /* Purple screen background */
    body{
      background: radial-gradient(circle at 25% 20%, #a78bfa 0%, #6d28d9 35%, #2e1065 75%, #120426 100%);
      color:#fff;
    }

    /* This layer is used ONLY to "clear" the SimHub frame */
    #clearLayer{
      position:fixed;
      inset:0;
      display:none;                 /* hidden by default */
      pointer-events:none;

      /* visually invisible but forces repaint/clear */
      background: rgba(0,0,0,0.001);
    }

    .wrap{
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .stack{
      width:min(720px, 96vw);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .panel{
      border-radius:24px;
      border:2px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      padding: 18px 16px;
      text-align:center;
      color:#fff;
      box-shadow:0 18px 55px rgba(0,0,0,.55);
    }

    .big{font-weight:1000;letter-spacing:.6px;font-size: clamp(26px, 4.2vw, 40px);margin:0 0 8px}
    .sub{margin:0;opacity:.92;font-size: clamp(14px, 2.2vw, 18px);line-height:1.25}
    .stamp{margin-top:10px;font-family: ui-monospace, Menlo, Consolas, monospace;font-size: 12px;opacity:.85}

    @keyframes rfFlash { 0%,49%{background:#000;} 50%,100%{background:#b30000;} }
    @keyframes vscFlash { 0%,49%{background:#000;} 50%,100%{background:#8a5a00;} }

    body.red { animation: rfFlash .7s infinite; }
    body.vsc { animation: vscFlash .9s infinite; }

    .dot{display:inline-block;width:14px;height:14px;border-radius:999px;margin-right:10px;vertical-align:middle}
    .dot.green{background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.18)}
    .dot.red{background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.18)}
    .dot.yellow{background:#f59e0b; box-shadow:0 0 0 6px rgba(245,158,11,.18)}

    /* Check-in box styles */
    .titleSmall{
      font-weight:1000;
      letter-spacing:.7px;
      font-size:14px;
      opacity:.95;
      margin:0 0 10px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
    }
    .formRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
    }
    .nameInput{
      flex: 1 1 260px;
      max-width:420px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(0,0,0,.25);
      color:#fff;
      outline:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:14px;
    }
    .sendBtn{
      width:auto;height:auto;
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight:1000;
      letter-spacing:.3px;
      cursor:pointer;
      box-shadow:none;
    }
    .sendBtn:disabled{opacity:.55;cursor:not-allowed}

    .note{
      margin:10px 0 0;
      opacity:.9;
      font-size:12px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      min-height:16px;
    }
    .ok{color:#86efac}
    .bad{color:#ff7a7a}
  </style>
</head>
<body>
  <div id="clearLayer"></div>

  <div class="wrap" id="wrap">
    <div class="stack">

      <!-- FLAG PANEL -->
      <div class="panel" id="panel">
        <div class="big">
          <span class="dot green" id="dot"></span>
          <span id="headline">SERVER GOOD : ADHERE TO RACE FLAGS</span>
        </div>
        <p class="sub" id="msg"></p>
        <div class="stamp" id="stamp"></div>
      </div>

      <!-- CHECK-IN PANEL -->
      <div class="panel" id="checkinPanel">
        <div class="titleSmall">RACE CHECK-IN</div>
        <div class="formRow">
          <input id="checkinName" class="nameInput" type="text" placeholder="Add name here…" maxlength="40" />
          <button id="btnSendCheckin" class="sendBtn">Send</button>
        </div>
        <div class="note" id="checkinNote"></div>
      </div>

    </div>
  </div>

<script>
  const WORKER_BASE = "https://ifwl-flag.benjamin-leahy1.workers.dev";
  const POLL_MS = 500;

  const clearLayer = document.getElementById("clearLayer");
  const wrap = document.getElementById("wrap");

  const dot = document.getElementById("dot");
  const headline = document.getElementById("headline");
  const msg = document.getElementById("msg");
  const stamp = document.getElementById("stamp");

  const checkinPanel = document.getElementById("checkinPanel");
  const checkinName = document.getElementById("checkinName");
  const btnSendCheckin = document.getElementById("btnSendCheckin");
  const checkinNote = document.getElementById("checkinNote");

  function fmt(ts){
    try { return new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}); }
    catch { return "—"; }
  }

  function setDot(color){
    dot.className = "dot " + color;
  }

  function getEffectiveMode(data){
    const state = String(data?.state || "green").toLowerCase();
    const lastCommand = String(data?.lastCommand || "").toLowerCase();

    if(lastCommand === "server_reset") return "server_reset";
    if(state === "red") return "red";
    if(state === "vsc_slow") return "vsc_slow";
    if(state === "vsc_pit") return "vsc_pit";
    return "green";
  }

  // GREEN: clear the frame & hide UI (your SimHub trick)
  function showGreenBlank(){
    document.body.classList.remove("red","vsc");

    wrap.style.display = "none";
    clearLayer.style.display = "block";

    clearLayer.style.opacity = "0.001";
    requestAnimationFrame(() => {
      clearLayer.style.opacity = "0.001";
    });
  }

  function showUI(){
    clearLayer.style.display = "none";
    wrap.style.display = "flex";
  }

  function apply(mode, updatedAt){
    if(mode === "green"){
      showGreenBlank();
      return;
    }

    showUI();
    document.body.classList.remove("red","vsc");

    if(mode === "red"){
      document.body.classList.add("red");
      setDot("red");
      headline.textContent = "RED FLAG";
      msg.textContent = "Drive to pits immediately. Send standings screenshot into Discord.";
    }
    else if(mode === "vsc_slow"){
      document.body.classList.add("vsc");
      setDot("yellow");
      headline.textContent = "VSC — FORMATION";
      msg.textContent = "Remain in formation. 1st gear, enable limiter, no overtaking.";
    }
    else if(mode === "vsc_pit"){
      document.body.classList.add("vsc");
      setDot("yellow");
      headline.textContent = "VSC — PIT NOW";
      msg.textContent = "All cars to enter pits now. Keep formation at pit exit line. No overtaking.";
    }
    else if(mode === "server_reset"){
      setDot("green");
      headline.textContent = "SERVER RESET";
      msg.textContent = "Practice session is live. You have 15 minutes to re-enter the server.";
    }

    stamp.textContent = "Last update: " + (updatedAt ? fmt(updatedAt) : "");
  }

  function showOffline(){
    showUI();
    document.body.classList.remove("red","vsc");
    setDot("red");
    headline.textContent = "FLAG FEED OFFLINE";
    msg.textContent = "Cannot reach Race Control endpoint.";
    stamp.textContent = "";
  }

  async function poll(){
    try{
      const res = await fetch(`${WORKER_BASE}/state?t=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      apply(getEffectiveMode(data), data?.updatedAt || null);
    }catch{
      showOffline();
    }
  }

  function normName(v){
    return String(v || "").trim().replace(/\s+/g, " ");
  }

  async function sendCheckin(){
    const name = normName(checkinName.value);
    if(!name){
      checkinNote.innerHTML = `<span class="bad">Type your name first.</span>`;
      checkinName.focus();
      return;
    }

    btnSendCheckin.disabled = true;
    checkinNote.textContent = "Sending…";

    try{
      const res = await fetch(`${WORKER_BASE}/checkin`,{
        method:"POST",
        mode:"cors",
        cache:"no-store",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ name })
      });

      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

      if(!res.ok){
        throw new Error(data?.detail || data?.error || `HTTP ${res.status}`);
      }

      checkinNote.innerHTML = `<span class="ok">Checked in!</span> (${fmt(Date.now())})`;
      checkinName.value = "";
      checkinName.focus();
    }catch(e){
      checkinNote.innerHTML = `<span class="bad">Check-in failed:</span> ${String(e.message || e)}`;
    }finally{
      btnSendCheckin.disabled = false;
    }
  }

  btnSendCheckin.addEventListener("click", sendCheckin);
  checkinName.addEventListener("keydown", (e) => {
    if(e.key === "Enter") sendCheckin();
  });

  // start
  poll();
  setInterval(poll, POLL_MS);
</script>
</body>
</html>
