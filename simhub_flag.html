<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Flag</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui;overflow:hidden;background:transparent;}
    body.purple{
      background: radial-gradient(circle at 25% 20%, #a78bfa 0%, #6d28d9 35%, #2e1065 75%, #120426 100%);
      color:#fff;
    }

    #clearLayer{position:fixed;inset:0;display:none;pointer-events:none;background: rgba(0,0,0,0.001);}
    .wrap{height:100%;display:flex;align-items:center;justify-content:center;padding:18px;}
    .panel{
      width:min(520px, 96vw);
      border-radius:24px;
      border:2px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(8px);
      padding: 18px 16px;
      text-align:center;
      color:#fff;
      box-shadow:0 18px 55px rgba(0,0,0,.55);
    }

    .big{font-weight:1000;letter-spacing:.6px;font-size: clamp(26px, 4.2vw, 40px);margin:0 0 8px}
    .sub{margin:0;opacity:.9;font-size: clamp(14px, 2.2vw, 18px);line-height:1.25}
    .stamp{margin-top:10px;font-family: ui-monospace, Menlo, Consolas, monospace;font-size: 12px;opacity:.85}

    /* Safer controlled flashing for red/vsc only */
    @keyframes rfFlash { 0%,49%{background:#000;} 50%,100%{background:#b30000;} }
    @keyframes vscFlash { 0%,49%{background:#000;} 50%,100%{background:#8a5a00;} }
    body.red.flash { animation: rfFlash 1.2s infinite; }
    body.vsc.flash { animation: vscFlash 1.4s infinite; }
    body.red.solid { background:#b30000; }
    body.vsc.solid { background:#8a5a00; }

    .dot{display:inline-block;width:14px;height:14px;border-radius:999px;margin-right:10px;vertical-align:middle}
    .dot.green{background:#22c55e; box-shadow:0 0 0 6px rgba(34,197,94,.18)}
    .dot.red{background:#ef4444; box-shadow:0 0 0 6px rgba(239,68,68,.18)}
    .dot.yellow{background:#f59e0b; box-shadow:0 0 0 6px rgba(245,158,11,.18)}
    .dot.silver{background:#cbd5e1; box-shadow:0 0 0 6px rgba(203,213,225,.18)}
    .dot.black{background:#111827; box-shadow:0 0 0 6px rgba(17,24,39,.18)}
    .dot.blue{background:#3b82f6; box-shadow:0 0 0 6px rgba(59,130,246,.18)}

    /* Broadcast */
    body.broadcast_bg{background:#0b1220;color:#fff;}
    .msgBox{
      margin-top:10px;
      font-size: clamp(18px, 3.4vw, 26px);
      font-weight:1000;
      letter-spacing:.3px;
      line-height:1.15;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .countdown{
      margin-top:12px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:12px;
      opacity:.85;
    }

    /* Quali schedule */
    body.quali_bg{background:#0b1220;color:#fff;}
    .warnPill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      margin-top:10px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background:rgba(0,0,0,.25);
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:12px;
      opacity:.95;
    }

    /* Check-in UI */
    .titleSmall{font-weight:1000;letter-spacing:.7px;font-size:14px;opacity:.95;margin:0 0 10px;font-family: ui-monospace, Menlo, Consolas, monospace;}
    .formRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;align-items:center;margin-top:6px;}
    .nameInput{
      flex: 1 1 260px;max-width:420px;padding:12px 12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.20);background: rgba(0,0,0,.25);color:#fff;outline:none;
      font-family: ui-monospace, Menlo, Consolas, monospace;font-size:14px;
    }
    .sendBtn{
      width:auto;height:auto;padding:12px 16px;border-radius:14px;border:1px solid rgba(255,255,255,.20);
      background: rgba(255,255,255,.10);color:#fff;font-weight:1000;letter-spacing:.3px;cursor:pointer;box-shadow:none;
    }
    .sendBtn:disabled{opacity:.55;cursor:not-allowed}
    .note{margin:10px 0 0;opacity:.9;font-size:12px;font-family: ui-monospace, Menlo, Consolas, monospace;min-height:16px;}
    .ok{color:#86efac}
    .bad{color:#ff7a7a}
  </style>
</head>
<body>
  <div id="clearLayer"></div>
  <div class="wrap" id="wrap">
    <div class="panel" id="panel">
      <div id="content"></div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://ifwl-flag.benjamin-leahy1.workers.dev";
  const POLL_MS = 500;
  const FLASH_MS = 4000;

  const clearLayer = document.getElementById("clearLayer");
  const wrap = document.getElementById("wrap");
  const panel = document.getElementById("panel");
  const content = document.getElementById("content");

  function fmt(ts){
    try { return new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}); }
    catch { return "—"; }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function resetAll(){
    document.body.className = "";
    document.body.style.background = "";
    document.body.style.color = "";
  }

  function showGreenBlank(){
    resetAll();
    wrap.style.display = "none";
    clearLayer.style.display = "block";
    clearLayer.style.opacity = "0.001";
    requestAnimationFrame(() => { clearLayer.style.opacity = "0.001"; });
  }

  function showUI(){
    clearLayer.style.display = "none";
    wrap.style.display = "flex";
  }

  function ensurePanelTextColor(isDarkText){
    if(isDarkText){
      panel.style.color = "#111827";
      panel.style.borderColor = "rgba(17,24,39,.20)";
      panel.style.background = "rgba(255,255,255,.72)";
    }else{
      panel.style.color = "#fff";
      panel.style.borderColor = "rgba(255,255,255,.18)";
      panel.style.background = "rgba(0,0,0,.45)";
    }
  }

  // Flash controller for red/vsc
  let flashTimer = null;
  function applyFlash(baseClass){
    if(flashTimer){ clearTimeout(flashTimer); flashTimer = null; }
    document.body.classList.remove("solid","flash");
    document.body.classList.add(baseClass, "flash");
    flashTimer = setTimeout(() => {
      document.body.classList.remove("flash");
      document.body.classList.add("solid");
      flashTimer = null;
    }, FLASH_MS);
  }
  function stopFlash(){
    if(flashTimer){ clearTimeout(flashTimer); flashTimer = null; }
    document.body.classList.remove("flash","solid");
  }

  function getEffectiveMode(data){
    const state = String(data?.state || "green").toLowerCase();
    const lastCommand = String(data?.lastCommand || "").toLowerCase();

    if(lastCommand === "server_reset") return "server_reset";
    if(state === "race_checkin") return "race_checkin";

    if(state === "green_console") return "green_console";

    if(state === "red") return "red";
    if(state === "vsc_slow") return "vsc_slow";
    if(state === "vsc_pit") return "vsc_pit";
    if(state === "server_reset") return "server_reset";
    return "green";
  }

  // Broadcast
  let broadcastTimer = null;
  function renderBroadcastUI(b){
    resetAll();
    stopFlash();
    document.body.classList.add("broadcast_bg");
    ensurePanelTextColor(false);

    const remainingMs = Math.max(0, Number(b?.expiresAt||0) - Date.now());
    const remainingSec = Math.ceil(remainingMs/1000);

    content.innerHTML = `
      <div class="big">
        <span class="dot blue"></span>
        <span>RACE CONTROL MESSAGE</span>
      </div>
      <div class="msgBox">${escapeHtml(String(b?.message || ""))}</div>
      <div class="countdown">Showing for ~${remainingSec}s</div>
      <div class="stamp">Last update: ${b?.ts ? fmt(b.ts) : ""}</div>
    `;

    if(broadcastTimer){ clearTimeout(broadcastTimer); broadcastTimer=null; }
    if(remainingMs>0){
      broadcastTimer = setTimeout(() => { broadcastTimer=null; }, remainingMs+50);
    }
  }

  // ✅ NEW: Quali schedule (time-based)
  function computeQualiNow(q){
    if(!q || !q.startAt || !Array.isArray(q.steps) || q.steps.length===0) return null;

    const now = Date.now();
    const startAt = Number(q.startAt);
    const steps = q.steps;

    // Not started yet (rare)
    if(now < startAt) return { phase:"pending", step: steps[0], idx:0, remainingMs: (startAt-now), endAt: startAt };

    let t = startAt;
    for(let i=0;i<steps.length;i++){
      const durMs = Number(steps[i]?.durationMs || 0);
      const end = t + durMs;
      if(now < end){
        return { phase:"running", step: steps[i], idx:i, remainingMs: (end-now), endAt:end };
      }
      t = end;
    }

    return { phase:"done" };
  }

  function renderQualiScheduleUI(q){
    resetAll();
    stopFlash();
    document.body.classList.add("quali_bg");

    const cur = computeQualiNow(q);
    if(!cur || cur.phase==="done"){
      return false;
    }

    // step styling
    const bg = String(cur?.step?.bg || "#0b1220");
    const fg = String(cur?.step?.fg || "#ffffff");
    const dot = String(cur?.step?.dot || "green");
    const label = String(cur?.step?.label || "SPLIT");
    const remainingMs = Math.max(0, Number(cur.remainingMs||0));
    const remainingSec = Math.ceil(remainingMs/1000);

    // 1 minute warning when <=60s
    const showWarn = remainingMs > 0 && remainingMs <= 60_000;

    // Make the whole screen match split style (no flashing)
    document.body.style.background = bg;
    document.body.style.color = fg;

    // Make panel readable on white (pros)
    ensurePanelTextColor(fg.toLowerCase() !== "#ffffff" && fg.toLowerCase() !== "white");

    const minsLeft = Math.ceil(remainingSec/60);

    content.innerHTML = `
      <div class="big">
        <span class="dot ${escapeHtml(dot)}"></span>
        <span>QUALI SPLIT — ${escapeHtml(label)}</span>
      </div>
      <p class="sub">${escapeHtml("Proceed with this split now.")}</p>
      ${showWarn ? `<div class="warnPill"><span class="dot yellow" style="margin:0;width:12px;height:12px;"></span><span>${minsLeft} minute${minsLeft===1?"":"s"} left</span></div>` : ``}
      <div class="stamp">Switching in ~${minsLeft} min • ${escapeHtml(label)} • ${fmt(Date.now())}</div>
    `;

    return true;
  }

  function renderFlagUI(mode, updatedAt){
    resetAll();
    stopFlash();
    ensurePanelTextColor(false);

    let dotClass = "green";
    let headline = "SERVER GOOD : ADHERE TO RACE FLAGS";
    let msg = "";

    if(mode === "red"){
      applyFlash("red");
      dotClass = "red";
      headline = "RED FLAG";
      msg = "Drive to pits immediately. Send standings screenshot into Discord.";
    } else if(mode === "vsc_slow"){
      applyFlash("vsc");
      dotClass = "yellow";
      headline = "VSC — FORMATION";
      msg = "Remain in formation. 1st gear, enable limiter, no overtaking.";
    } else if(mode === "vsc_pit"){
      applyFlash("vsc");
      dotClass = "yellow";
      headline = "VSC — PIT NOW";
      msg = "All cars to enter pits now. Keep formation at pit exit line. No overtaking.";
    } else if(mode === "server_reset"){
      dotClass = "green";
      headline = "SERVER RESET";
      msg = "Practice session is live. You have 15 minutes to re-enter the server.";
    } else if(mode === "green_console"){
      document.body.style.background = "#0b1220";
      dotClass = "green";
      headline = "GREEN FLAG — CONSOLE ONLY";
      msg = "Adhere to in game rules and flags.";
    }

    content.innerHTML = `
      <div class="big">
        <span class="dot ${dotClass}"></span>
        <span>${escapeHtml(headline)}</span>
      </div>
      <p class="sub">${escapeHtml(msg)}</p>
      <div class="stamp">Last update: ${updatedAt ? fmt(updatedAt) : ""}</div>
    `;

    if(mode === "green_console"){
      const sub = content.querySelector(".sub");
      if(sub){
        sub.innerHTML = `
          ${escapeHtml("Adhere to in game rules and flags.")}<br>
          <span style="display:inline-flex;align-items:center;gap:10px;margin-top:10px;font-weight:1000;letter-spacing:.3px;">
            <span class="dot green" style="margin:0; width:14px; height:14px;"></span>
            <span>SYSTEM LIVE</span>
          </span>
        `;
      }
    }
  }

  function renderCheckinUI(){
    resetAll();
    stopFlash();
    document.body.classList.add("purple");
    ensurePanelTextColor(false);

    content.innerHTML = `
      <div class="titleSmall">RACE CHECK-IN</div>
      <div class="big" style="font-size: clamp(22px, 3.4vw, 30px); margin:0 0 4px;">
        Add name here
      </div>
      <div class="formRow">
        <input id="checkinName" class="nameInput" type="text" placeholder="e.g. Ben Leahy" maxlength="40" />
        <button id="btnSendCheckin" class="sendBtn">Send</button>
      </div>
      <div class="note" id="checkinNote"></div>
      <div class="stamp" style="margin-top:12px; opacity:.75;">Waiting for drivers…</div>
    `;

    const inp = document.getElementById("checkinName");
    const btn = document.getElementById("btnSendCheckin");
    const note = document.getElementById("checkinNote");

    function normName(v){ return String(v || "").trim().replace(/\s+/g, " "); }

    async function send(){
      const name = normName(inp.value);
      if(!name){
        note.innerHTML = `<span class="bad">Type your name first.</span>`;
        inp.focus();
        return;
      }

      btn.disabled = true;
      note.textContent = "Sending…";

      try{
        const res = await fetch(`${WORKER_BASE}/checkin`,{
          method:"POST",
          mode:"cors",
          cache:"no-store",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ name })
        });

        const text = await res.text();
        let data = {};
        try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

        if(!res.ok) throw new Error(data?.detail || data?.error || `HTTP ${res.status}`);

        note.innerHTML = `<span class="ok">Checked in!</span> (${fmt(Date.now())})`;
        inp.value = "";
        inp.focus();
      }catch(e){
        note.innerHTML = `<span class="bad">Check-in failed:</span> ${escapeHtml(String(e.message || e))}`;
      }finally{
        btn.disabled = false;
      }
    }

    btn.addEventListener("click", send);
    inp.addEventListener("keydown", (e) => { if(e.key === "Enter") send(); });
    setTimeout(() => inp.focus(), 50);
  }

  let lastKey = null;

  function apply(data){
    // ✅ 1) Broadcast overrides everything while active
    const b = data?.broadcast || null;
    if(b && b.expiresAt && b.expiresAt > Date.now() && b.message){
      showUI();
      const key = "broadcast:" + String(b.expiresAt) + ":" + String(b.ts);
      if(key !== lastKey){
        renderBroadcastUI(b);
        lastKey = key;
      } else {
        const cd = content.querySelector(".countdown");
        if(cd){
          const remainingSec = Math.ceil(Math.max(0, b.expiresAt - Date.now()) / 1000);
          cd.textContent = `Showing for ~${remainingSec}s`;
        }
      }
      return;
    }

    // ✅ 2) Quali schedule overrides flags while active
    const q = data?.qualiSchedule || null;
    if(q && q.startAt && Array.isArray(q.steps) && q.steps.length){
      showUI();
      const cur = computeQualiNow(q);
      const phase = cur?.phase || "none";
      const idx = String(cur?.idx ?? "");
      const endAt = String(cur?.endAt ?? "");
      const key = "quali:" + phase + ":" + idx + ":" + endAt;

      if(key !== lastKey){
        const ok = renderQualiScheduleUI(q);
        lastKey = key;
        if(ok) return;
      } else {
        // same step: update warning/minutes left smoothly
        renderQualiScheduleUI(q);
        return;
      }
    }

    // ✅ 3) Normal flags
    const mode = getEffectiveMode(data);
    const updatedAt = data?.updatedAt || null;

    if(mode === "green"){
      lastKey = "green";
      showGreenBlank();
      return;
    }

    showUI();
    const key = mode + ":" + String(updatedAt || "");
    if(key !== lastKey){
      if(mode === "race_checkin") renderCheckinUI();
      else renderFlagUI(mode, updatedAt);
      lastKey = key;
    } else {
      if(mode !== "race_checkin"){
        const stampEl = content.querySelector(".stamp");
        if(stampEl) stampEl.textContent = "Last update: " + (updatedAt ? fmt(updatedAt) : "");
      }
    }
  }

  function showOffline(){
    showUI();
    resetAll();
    stopFlash();
    ensurePanelTextColor(false);
    content.innerHTML = `
      <div class="big">
        <span class="dot red"></span>
        <span>FLAG FEED OFFLINE</span>
      </div>
      <p class="sub">Cannot reach Race Control endpoint.</p>
      <div class="stamp"></div>
    `;
    lastKey = "offline";
  }

  async function poll(){
    try{
      const res = await fetch(`${WORKER_BASE}/state?t=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();
      apply(data);
    }catch{
      showOffline();
    }
  }

  poll();
  setInterval(poll, POLL_MS);
</script>
</body>
</html>
