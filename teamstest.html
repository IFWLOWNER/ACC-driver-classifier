<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL – GTeam 3 Team Hub</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: url('ifwl_bg.webp') no-repeat center top;
      background-size: cover;
      min-height: 100vh;
      color: #fff;
    }
    .glass {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.68);
      z-index: -1;
    }

    /* Discord login UI (same style pattern as tickets page) */
    .discord-card {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
    }
    .discord-btn {
      background: #5865F2;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 14px;
      width: 100%;
    }
    .discord-btn:hover { filter: brightness(0.98); }
    .discord-btn svg { width: 20px; height: 20px; }
    .status { margin-top: 12px; font-size: 14px; color: rgba(255,255,255,0.85); text-align:center; }
    .status.error { color: #ffb4b4; }
    .status.success { color: #b9ffcc; }
    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(42, 157, 143, 0.16);
      border: 1px solid rgba(42, 157, 143, 0.35);
      font-size: 13px;
      color: #d9fff8;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <!-- Header -->
  <div class="max-w-5xl mx-auto px-4 sm:px-6 py-6">
    <div class="flex flex-col items-center text-center gap-3">
      <a href="https://ifwl.net/" class="inline-flex justify-center">
        <img src="ifwl_logo.png" alt="IFWL Logo" class="w-52 sm:w-72 drop-shadow-2xl">
      </a>
      <div class="text-3xl sm:text-4xl font-extrabold tracking-wide">GTeam 3 – Team Hub</div>
      <div class="text-white/70 text-sm sm:text-base">Create teams • Apply to join • Leader approvals</div>
    </div>

    <!-- Public user bar -->
    <div id="publicUserBar" class="mt-5 hidden">
      <div class="glass p-4 flex items-center justify-between gap-3">
        <div id="publicUserPill" class="user-pill"></div>
        <button id="discordLogoutBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-semibold">
          Logout
        </button>
      </div>
    </div>

    <!-- Discord Login Section -->
    <div id="discordLoginSection" class="mt-5">
      <div class="glass p-5">
        <div class="text-xl font-bold text-center mb-2">Login with Discord</div>
        <div class="text-white/70 text-center text-sm mb-4">
          You must be logged in to apply to a team.
        </div>

        <div class="discord-card">
          <button id="discordLoginBtn" class="discord-btn">
            <svg viewBox="0 0 127.14 96.36" aria-hidden="true" focusable="false">
              <path fill="#fff" d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2A75.57,75.57,0,0,0,95.73,78c.87.71,1.77,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14C129.24,52.84,122.06,29.11,107.7,8.07ZM42.45,65.69c-6.05,0-11-5.55-11-12.38s4.86-12.39,11-12.39S53.47,46.5,53.39,53.31,48.52,65.69,42.45,65.69Zm42.24,0c-6.05,0-11-5.55-11-12.38s4.86-12.39,11-12.39S95.7,46.5,95.62,53.31,90.76,65.69,84.69,65.69Z"/>
            </svg>
            Login with Discord
          </button>

          <div class="mt-3 text-xs text-white/75 leading-relaxed">
            <strong>Nickname format required:</strong> <code>[drivernumber] - driver name</code><br>
            Example: <code>[18] - Smokey BH92</code>
          </div>

          <div id="discordLoginStatus" class="status"></div>
        </div>
      </div>
    </div>

    <!-- Main App -->
    <div id="appSection" class="mt-5 hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
<!-- Create Team -->
<div class="glass p-5">
  <div class="flex items-center justify-between gap-2 mb-3">
    <div>
      <div class="text-lg font-bold">Create a Team</div>
      <div class="text-white/70 text-sm">Team captains create their entry here</div>
    </div>
  </div>

  <div class="space-y-3">
    <div>
      <label class="text-white/70 text-sm">Team name</label>
      <input id="teamNameInput" type="text"
        class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400"
        placeholder="e.g., Grease Monkey Racing" maxlength="50">
    </div>

    <div>
      <label class="text-white/70 text-sm">Team image (optional URL)</label>
      <input id="teamImageUrlInput" type="url"
        class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400"
        placeholder="https://... (png/jpg/webp)" maxlength="300">
      <div class="text-xs text-white/60 mt-1">
        (We’ll add file upload later — for now use an image URL.)
      </div>
    </div>

    <button id="btnCreateTeam"
      class="w-full px-4 py-3 rounded-xl font-extrabold bg-indigo-500 hover:bg-indigo-400">
      Create Team
    </button>

    <div id="createTeamMsg" class="status"></div>

    <div class="text-xs text-white/60 leading-relaxed">
      You will become the <strong>Team Leader</strong>. Drivers can then apply to join.
    </div>
  </div>
</div>
        <!-- Teams -->
        <div class="glass p-5">
          <div class="flex items-center justify-between gap-2 mb-3">
            <div>
              <div class="text-lg font-bold">Available Teams</div>
              <div class="text-white/70 text-sm">Select a team, then apply</div>
            </div>
            <button id="btnRefreshTeams" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-semibold text-sm">
              Refresh
            </button>
          </div>

          <div id="teamsLoading" class="text-white/70 text-sm">Loading teams…</div>
          <div id="teamsEmpty" class="hidden text-white/70 text-sm">No teams found yet.</div>
          <div id="teamsList" class="mt-3 space-y-2"></div>
        </div>

        <!-- Apply -->
        <div class="glass p-5">
          <div class="text-lg font-bold">Apply to Join Team</div>
          <div class="text-white/70 text-sm mb-4">Your request goes to the team leader for approval.</div>

          <div class="mb-3">
            <div class="text-white/70 text-sm mb-1">Selected team</div>
            <div id="selectedTeam" class="px-3 py-3 rounded-xl bg-white/10 border border-white/10 text-white/90">
              None selected
            </div>
          </div>

          <div class="mb-3">
            <label class="text-white/70 text-sm">Optional note to the team leader</label>
            <textarea id="note" rows="3"
              class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="e.g., availability, stint preferences, experience…"></textarea>
          </div>

          <button id="btnApply" disabled
            class="w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500/35 text-white/70 cursor-not-allowed">
            Submit Application
          </button>

          <div id="applyMsg" class="status"></div>

          <hr class="my-5 border-white/10">

          <div class="text-lg font-bold">Your Applications</div>
          <div class="text-white/70 text-sm mb-3">Pending / Approved / Declined</div>

          <div id="appsEmpty" class="text-white/70 text-sm">No applications yet.</div>
          <div id="appsList" class="mt-3 space-y-2"></div>
        </div>

      </div>
    </div>

    <div class="mt-10 text-center text-xs text-white/50">
      IFWL.net • GTeam 3 Team Hub
    </div>
  </div>

  <script type="module">
    // Firestore (same Firebase project as tickets)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  where,
  orderBy,
  serverTimestamp,
  limit,
  doc,
  setDoc
} from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ==========================================================
    // DISCORD LOGIN (rtGate Gen2) — copied from tickets system
    // ==========================================================
    const RTGATE_BASE = "https://rtgate-vdr3uafd2q-nw.a.run.app/rtGate";
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    const REQUIRE_NICK_FORMAT = true;
    const NICK_REGEX = /^\[\s*\d+\s*\]\s*-\s*.+$/i;

    const LS_KEY = "ifwl_discord_user";
    function safeStr(v){ return (typeof v === "string" ? v : "").trim(); }
    function setDiscordUser(userObj){ localStorage.setItem(LS_KEY, JSON.stringify(userObj)); }
    function getDiscordUser(){
      try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; }
      catch { return null; }
    }
    function clearDiscordUser(){ localStorage.removeItem(LS_KEY); }
    function validateNick(nick){
      if (!REQUIRE_NICK_FORMAT) return true;
      return NICK_REGEX.test(safeStr(nick));
    }

    // ==========================================================
    // Firebase config — copied from tickets system
    // ==========================================================
    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    const EVENT_ID = "gteam3-2026";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // UI
    const discordLoginSection = document.getElementById("discordLoginSection");
    const appSection          = document.getElementById("appSection");

    const publicUserBar    = document.getElementById("publicUserBar");
    const publicUserPill   = document.getElementById("publicUserPill");
    const discordLogoutBtn = document.getElementById("discordLogoutBtn");

    const discordLoginBtn    = document.getElementById("discordLoginBtn");
    const discordLoginStatus = document.getElementById("discordLoginStatus");

    const btnRefreshTeams = document.getElementById("btnRefreshTeams");
    const teamsLoading    = document.getElementById("teamsLoading");
    const teamsEmpty      = document.getElementById("teamsEmpty");
    const teamsList       = document.getElementById("teamsList");

    const teamNameInput = document.getElementById("teamNameInput");
    const teamImageUrlInput = document.getElementById("teamImageUrlInput");
    const btnCreateTeam = document.getElementById("btnCreateTeam");
    const createTeamMsg = document.getElementById("createTeamMsg");

    const selectedTeamEl = document.getElementById("selectedTeam");
    const noteEl         = document.getElementById("note");
    const btnApply       = document.getElementById("btnApply");
    const applyMsg       = document.getElementById("applyMsg");

    const appsEmpty = document.getElementById("appsEmpty");
    const appsList  = document.getElementById("appsList");

    let selectedTeam = null;

    // ==========================================================
    // Discord login flow (rtGate) — copied from tickets system
    // ==========================================================
    async function startDiscordLogin(){
      discordLoginStatus.textContent = "Opening Discord login…";
      discordLoginStatus.className = "status";
      try {
        const r = await fetch(`${RTGATE_BASE}?start=1&redirect=${encodeURIComponent(REDIRECT_URI)}`);
        const data = await r.json();
        if (!r.ok || !data?.url) throw new Error(data?.error || "Failed to start login");
        window.location.href = data.url;
      } catch (e) {
        console.error(e);
        discordLoginStatus.textContent = "Failed to start Discord login. Please try again.";
        discordLoginStatus.className = "status error";
      }
    }

    async function finishDiscordLoginFromCodeIfPresent(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return false;

      // remove code from URL to prevent re-running on refresh
      url.searchParams.delete("code");
      window.history.replaceState({}, document.title, url.toString());

      discordLoginStatus.textContent = "Finishing Discord login…";
      discordLoginStatus.className = "status";

      try {
        const r = await fetch(
          `${RTGATE_BASE}?code=${encodeURIComponent(code)}&redirect=${encodeURIComponent(REDIRECT_URI)}&issue=1`,
          { method: "GET" }
        );
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Login failed");

        const roles = Array.isArray(data.memberRoleIds) ? data.memberRoleIds : [];
        if (!roles.length) {
          discordLoginStatus.textContent = "You must be a member of the IFWL Discord server to use this portal.";
          discordLoginStatus.className = "status error";
          return true;
        }

        const nick = safeStr(data.nick || data.nickname || data.guildNick || data.displayName || "");
        const userObj = {
          nick,
          id: safeStr(data.userId || data.id || ""),
          username: safeStr(data.username || data.user || ""),
          global: safeStr(data.globalName || data.global || ""),
          loggedInAt: Date.now()
        };

        setDiscordUser(userObj);

        if (!validateNick(userObj.nick)) {
          discordLoginStatus.textContent =
            "Login successful, but your IFWL server nickname is not in the required format: [drivernumber] - driver name. Please update your nickname and log in again.";
          discordLoginStatus.className = "status error";
          return true;
        }

        discordLoginStatus.textContent = "Login successful!";
        discordLoginStatus.className = "status success";
        return true;
      } catch (e) {
        console.error(e);
        discordLoginStatus.textContent = "Discord login failed. Please try again.";
        discordLoginStatus.className = "status error";
        return true;
      }
    }

    discordLoginBtn.addEventListener("click", startDiscordLogin);

    discordLogoutBtn.addEventListener("click", () => {
      clearDiscordUser();
      renderDiscordUserUI();
      showLogin();
    });


function makeTeamIdFromName(name){
  return String(name || "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9\-]/g, "")
    .slice(0, 60);
}

btnCreateTeam.addEventListener("click", async () => {
  createTeamMsg.className = "status";
  createTeamMsg.textContent = "";

  if (!requireDiscordOrShowLogin()) return;

  const u = getDiscordUser();
  const teamName = safeStr(teamNameInput.value).slice(0, 50);
  const teamImageUrl = safeStr(teamImageUrlInput.value).slice(0, 300);

  if (!teamName) {
    createTeamMsg.textContent = "Please enter a team name.";
    createTeamMsg.className = "status error";
    return;
  }

  btnCreateTeam.disabled = true;
  btnCreateTeam.classList.add("opacity-60", "cursor-not-allowed");
  createTeamMsg.textContent = "Creating team…";

  try {
    // Create a predictable doc id so duplicates are harder
    // also include leader id to avoid same-name collisions if you want
    const baseId = makeTeamIdFromName(teamName);
    const docId = baseId ? `${baseId}__${u.id}` : `team__${u.id}`;

    const payload = {
      eventId: EVENT_ID,
      teamName,
      teamImageUrl: teamImageUrl || "",
      leaderDiscordId: safeStr(u.id),
      leaderNick: safeStr(u.nick),
      leaderUsername: safeStr(u.username),
      leaderGlobal: safeStr(u.global),

      // Members list starts with leader
      drivers: [
        {
          discordId: safeStr(u.id),
          nick: safeStr(u.nick),
          username: safeStr(u.username),
          global: safeStr(u.global),
          role: "leader",
          joinedAt: null
        }
      ],

      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    };

    // Use setDoc so docId is deterministic
    await setDoc(doc(db, "gteam3_teams", docId), payload, { merge: false });

    teamNameInput.value = "";
    teamImageUrlInput.value = "";

    createTeamMsg.textContent = "Team created! It will appear in the list.";
    createTeamMsg.className = "status success";

    await loadTeams(); // refresh list
  } catch (e) {
    console.error(e);
    createTeamMsg.textContent = "Could not create team (rules/config). Check console.";
    createTeamMsg.className = "status error";
  } finally {
    btnCreateTeam.disabled = false;
    btnCreateTeam.classList.remove("opacity-60", "cursor-not-allowed");
  }
});

    
    // ==========================================================
    // UI gating
    // ==========================================================
    function showLogin(){
      discordLoginSection.classList.remove("hidden");
      appSection.classList.add("hidden");
    }
    function showApp(){
      discordLoginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
    }

    function renderDiscordUserUI(){
      const u = getDiscordUser();
      if (!u) {
        publicUserBar.classList.add("hidden");
        return;
      }
      publicUserBar.classList.remove("hidden");
      publicUserPill.textContent = u.nick ? `Logged in as: ${u.nick}` : "Logged in (Discord)";
    }

    function requireDiscordOrShowLogin(){
      const u = getDiscordUser();
      if (!u) { showLogin(); return false; }
      if (!validateNick(u.nick)) { showLogin(); return false; }
      return true;
    }

    function setApplyEnabled(enabled){
      btnApply.disabled = !enabled;
      btnApply.className = enabled
        ? "w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500 hover:bg-emerald-400"
        : "w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500/35 text-white/70 cursor-not-allowed";
    }

    // ==========================================================
    // Teams loading
    // ==========================================================
    async function loadTeams(){
      teamsLoading.classList.remove("hidden");
      teamsEmpty.classList.add("hidden");
      teamsList.innerHTML = "";
      selectedTeam = null;
      selectedTeamEl.textContent = "None selected";
      setApplyEnabled(false);
      applyMsg.textContent = "";

      const qTeams = query(
        collection(db, "gteam3_teams"),
        where("eventId", "==", EVENT_ID),
        orderBy("createdAt", "desc")
      );

      const snap = await getDocs(qTeams);
      teamsLoading.classList.add("hidden");

      if (snap.empty) {
        teamsEmpty.classList.remove("hidden");
        return;
      }

      snap.forEach(d => {
        const team = { id: d.id, ...d.data() };
        teamsList.appendChild(teamRow(team));
      });
    }

    function teamRow(team){
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "w-full text-left p-3 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 transition";
      btn.innerHTML = `
        <div class="flex items-start justify-between gap-3">
          <div>
            <div class="font-extrabold">${escapeHtml(team.teamName || "Unnamed Team")}</div>
            <div class="text-sm text-white/70">Leader: ${escapeHtml(team.leaderName || "Unknown")}</div>
          </div>
          <div class="text-xs px-2 py-1 rounded-full bg-white/10 border border-white/10 text-white/70">Select</div>
        </div>
      `;
      btn.addEventListener("click", () => {
        selectedTeam = team;
        selectedTeamEl.textContent = `${team.teamName || "Team"} (Leader: ${team.leaderName || "Unknown"})`;
        applyMsg.textContent = "";
        setApplyEnabled(requireDiscordOrShowLogin());
      });
      return btn;
    }

    btnRefreshTeams.addEventListener("click", loadTeams);

    // ==========================================================
    // Applications list (by Discord userId)
    // ==========================================================
    async function loadMyApplications(){
      appsList.innerHTML = "";
      appsEmpty.classList.remove("hidden");

      const u = getDiscordUser();
      if (!u?.id) return;

      const qApps = query(
        collection(db, "gteam3_teamApplications"),
        where("eventId", "==", EVENT_ID),
        where("applicantDiscordId", "==", u.id),
        orderBy("createdAt", "desc"),
        limit(30)
      );

      const snap = await getDocs(qApps);
      if (snap.empty) return;

      appsEmpty.classList.add("hidden");
      snap.forEach(d => {
        const app = { id: d.id, ...d.data() };
        appsList.appendChild(appCard(app));
      });
    }

    function appCard(app){
      const div = document.createElement("div");
      div.className = "p-3 rounded-xl bg-white/10 border border-white/10";
      div.innerHTML = `
        <div class="flex items-center justify-between gap-3">
          <div>
            <div class="font-extrabold">${escapeHtml(app.teamName || "Team")}</div>
            <div class="text-sm text-white/70">Status: ${statusBadge(app.status)}</div>
          </div>
          <div class="text-xs text-white/60">${app.createdAt?.toDate ? app.createdAt.toDate().toLocaleString() : ""}</div>
        </div>
      `;
      return div;
    }

    function statusBadge(status){
      const s = String(status || "pending").toLowerCase();
      if (s === "approved") return `<span class="px-2 py-1 rounded-full bg-emerald-500/20 text-emerald-200 border border-emerald-500/30">Approved</span>`;
      if (s === "declined") return `<span class="px-2 py-1 rounded-full bg-rose-500/20 text-rose-200 border border-rose-500/30">Declined</span>`;
      return `<span class="px-2 py-1 rounded-full bg-amber-500/20 text-amber-200 border border-amber-500/30">Pending</span>`;
    }

    // ==========================================================
    // Apply submit
    // ==========================================================
    btnApply.addEventListener("click", async () => {
      applyMsg.className = "status";
      applyMsg.textContent = "";

      if (!requireDiscordOrShowLogin()) return;
      if (!selectedTeam?.id) {
        applyMsg.textContent = "Please select a team first.";
        applyMsg.className = "status error";
        return;
      }

      const u = getDiscordUser();
      if (!u?.id) {
        applyMsg.textContent = "Discord session missing. Please log in again.";
        applyMsg.className = "status error";
        showLogin();
        return;
      }

      try {
        // Prevent duplicate pending applications to same team
        const dupQ = query(
          collection(db, "gteam3_teamApplications"),
          where("eventId", "==", EVENT_ID),
          where("teamId", "==", selectedTeam.id),
          where("applicantDiscordId", "==", u.id),
          where("status", "==", "pending"),
          limit(1)
        );
        const dupSnap = await getDocs(dupQ);
        if (!dupSnap.empty) {
          applyMsg.textContent = "You already have a pending application for this team.";
          applyMsg.className = "status error";
          return;
        }

        const payload = {
          eventId: EVENT_ID,
          teamId: selectedTeam.id,
          teamName: safeStr(selectedTeam.teamName || "Team"),
          applicantDiscordId: safeStr(u.id),
          applicantNick: safeStr(u.nick),
          applicantUsername: safeStr(u.username),
          applicantGlobal: safeStr(u.global),
          status: "pending",
          note: safeStr(noteEl.value).slice(0, 500),
          createdAt: serverTimestamp(),
          resolvedAt: null,
          resolvedBy: null
        };

        await addDoc(collection(db, "gteam3_teamApplications"), payload);

        noteEl.value = "";
        applyMsg.textContent = "Application submitted! Awaiting team leader approval.";
        applyMsg.className = "status success";
        await loadMyApplications();
      } catch (e) {
        console.error(e);
        applyMsg.textContent = "Could not submit application (rules/config). Check console.";
        applyMsg.className = "status error";
      }
    });

    function escapeHtml(str){
      return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ==========================================================
    // Init
    // ==========================================================
    await finishDiscordLoginFromCodeIfPresent();

    renderDiscordUserUI();

    if (requireDiscordOrShowLogin()) {
      showApp();
      await loadTeams();
      await loadMyApplications();
      setApplyEnabled(false); // until a team is selected
    } else {
      showLogin();
    }
  </script>
</body>
</html>
