<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL – GTeam 3 Team Hub</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{
      margin:0;
      font-family: Arial, sans-serif;
      background: url('ifwl_bg.webp') no-repeat center top;
      background-size: cover;
      min-height: 100vh;
      color: #fff;
    }
    .glass {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      backdrop-filter: blur(6px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.68);
      z-index: -1;
    }

    /* Discord login UI */
    .discord-card {
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
    }
    .discord-btn {
      background: #5865F2;
      border-radius: 12px;
      font-weight: 800;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 12px 14px;
      width: 100%;
    }
    .discord-btn:hover { filter: brightness(0.98); }
    .discord-btn svg { width: 20px; height: 20px; }
    .status { margin-top: 12px; font-size: 14px; color: rgba(255,255,255,0.85); text-align:center; }
    .status.error { color: #ffb4b4; }
    .status.success { color: #b9ffcc; }
    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(42, 157, 143, 0.16);
      border: 1px solid rgba(42, 157, 143, 0.35);
      font-size: 13px;
      color: #d9fff8;
      justify-content: center;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <!-- Header -->
  <div class="max-w-6xl mx-auto px-4 sm:px-6 py-6">
    <div class="flex flex-col items-center text-center gap-3">
      <img src="ifwl_logo.png" alt="IFWL" class="h-24 sm:h-28 drop-shadow-xl" />
      <div class="text-4xl sm:text-5xl font-extrabold tracking-wide">GTeam 3 – Team Hub</div>
      <div class="text-white/70">Create teams • Apply to join • Leader approvals</div>
    </div>

    <!-- Public user bar -->
    <div id="publicUserBar" class="glass mt-6 p-4 flex items-center justify-between gap-3 hidden">
      <div id="publicUserPill" class="user-pill"></div>
      <button id="discordLogoutBtn" class="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-bold">Logout</button>
    </div>

    <!-- Discord Login -->
    <div id="discordLoginSection" class="glass mt-6 p-5 max-w-2xl mx-auto">
      <div class="discord-card">
        <div class="text-2xl font-extrabold text-center">Login with Discord</div>
        <div class="text-white/70 text-center mt-1">You must be logged in to create/apply to a team.</div>

        <div class="mt-4">
          <button id="discordLoginBtn" class="discord-btn">
            <svg viewBox="0 0 127.14 96.36" aria-hidden="true" focusable="false">
              <path fill="#fff" d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2A75.57,75.57,0,0,0,95.73,78c.87.71,1.77,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14C129.24,52.84,122.06,29.11,107.7,8.07ZM42.45,65.69c-6.05,0-11-5.55-11-12.38s4.86-12.39,11-12.39S53.47,46.5,53.39,53.31,48.52,65.69,42.45,65.69Zm42.24,0c-6.05,0-11-5.55-11-12.38s4.86-12.39,11-12.39S95.7,46.5,95.62,53.31,90.76,65.69,84.69,65.69Z"/>
            </svg>
            Login with Discord
          </button>
        </div>

        <div class="text-white/70 text-sm mt-4">
          <div class="font-bold">Nickname format required:</div>
          <div class="mt-1">Example: <code>[ 81 ] - IFWL XSL4Y3RX</code></div>
        </div>

        <div id="discordLoginStatus" class="status"></div>
      </div>
    </div>

    <!-- Main App -->
    <div id="appSection" class="mt-5 hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

        <!-- Create Team -->
        <div class="glass p-5">
          <div class="flex items-center justify-between gap-2 mb-3">
            <div>
              <div class="text-lg font-bold">Create a Team</div>
              <div class="text-white/70 text-sm">Team captains create their entry here</div>
            </div>
          </div>

          <div class="space-y-3">
            <div>
              <label class="text-white/70 text-sm">Team name</label>
              <input id="teamNameInput" type="text"
                class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400"
                placeholder="e.g., Grease Monkey Racing" maxlength="50">
            </div>

            <div>
              <label class="text-white/70 text-sm">Team image (JPEG only, max 5MB)</label>
              <input id="teamImageFileInput" type="file" accept="image/jpeg"
                class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400">
              <div class="text-xs text-white/60 mt-1" id="teamImageHelp">
                Only <strong>IFWL Active Racers</strong> can upload a team logo. (JPG/JPEG, ≤ 5MB)
              </div>
              <div id="teamImagePreviewWrap" class="hidden mt-3">
                <img id="teamImagePreview" alt="Team preview" class="w-full max-h-40 object-contain rounded-xl border border-white/10 bg-black/20">
                <div class="text-xs text-white/60 mt-1">Preview (will upload on “Create Team”).</div>
              </div>
            </div>

            <button id="btnCreateTeam"
              class="w-full px-4 py-3 rounded-xl font-extrabold bg-indigo-500 hover:bg-indigo-400">
              Create Team
            </button>

            <div id="createTeamMsg" class="status"></div>

            <div class="text-xs text-white/60 leading-relaxed">
              You will become the <strong>Team Leader</strong>. Drivers can then apply to join.
            </div>
          </div>
        </div>

        <!-- Teams -->
        <div class="glass p-5">
          <div class="flex items-center justify-between gap-2 mb-3">
            <div>
              <div class="text-lg font-bold">Available Teams</div>
              <div class="text-white/70 text-sm">Select a team, then apply</div>
            </div>
            <button id="btnRefreshTeams" class="px-3 py-2 rounded-xl bg-white/10 hover:bg-white/15 font-semibold text-sm">
              Refresh
            </button>
          </div>

          <div id="teamsLoading" class="text-white/70 text-sm">Loading teams…</div>
          <div id="teamsEmpty" class="hidden text-white/70 text-sm">No teams found yet.</div>
          <div id="teamsList" class="mt-3 space-y-2"></div>
        </div>

        <!-- Apply -->
        <div class="glass p-5">
          <div class="text-lg font-bold">Apply to Join Team</div>
          <div class="text-white/70 text-sm mb-4">Your request goes to the team leader for approval.</div>

          <div class="mb-3">
            <div class="text-white/70 text-sm mb-1">Selected team</div>
            <div id="selectedTeam" class="px-3 py-3 rounded-xl bg-white/10 border border-white/10 text-white/90">
              None selected
            </div>
          </div>

          <div class="mb-3">
            <label class="text-white/70 text-sm">Optional note to the team leader</label>
            <textarea id="note" rows="3"
              class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400"
              placeholder="e.g., availability, stint preferences, experience…"></textarea>
          </div>

          <button id="btnApply" disabled
            class="w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500/35 text-white/70 cursor-not-allowed">
            Submit Application
          </button>

          <div id="applyMsg" class="status"></div>

          <div class="mt-6 border-t border-white/10 pt-4">
            <div class="text-lg font-bold">Your Applications</div>
            <div class="text-white/70 text-sm">Pending / Approved / Declined</div>
            <div id="myApps" class="mt-3 text-white/70 text-sm">No applications yet.</div>
          </div>
        </div>

      </div>


      <!-- Team Leader Controls -->
      <div id="leaderSection" class="glass p-5 mt-5 hidden">
        <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
          <div>
            <div class="text-xl font-extrabold">Team Leader Controls</div>
            <div class="text-white/70 text-sm">Manage your team • approve drivers • select roster • publish JSON</div>
          </div>
          <div class="text-white/60 text-xs">
            Only visible if you are the leader of a team for this event.
          </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mt-4">
          <!-- Edit team -->
          <div class="glass p-4">
            <div class="text-lg font-bold">Edit Team</div>
            <div class="text-white/70 text-sm mb-3">Update your team name and (if allowed) logo.</div>

            <div class="space-y-3">
              <div>
                <label class="text-white/70 text-sm">Team name</label>
                <input id="leaderTeamNameInput" type="text"
                  class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400"
                  maxlength="50">
              </div>

              <div>
                <label class="text-white/70 text-sm">Replace team image (JPEG only, max 5MB)</label>
                <input id="leaderTeamImageFileInput" type="file" accept="image/jpeg"
                  class="mt-1 w-full px-3 py-2 rounded-xl bg-white/10 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400">
                <div class="text-xs text-white/60 mt-1" id="leaderTeamImageHelp">
                  Only <strong>IFWL Active Racers</strong> can upload a team logo.
                </div>
                <div id="leaderTeamImagePreviewWrap" class="hidden mt-3">
                  <img id="leaderTeamImagePreview" alt="Team preview" class="w-full max-h-40 object-contain rounded-xl border border-white/10 bg-black/20">
                  <div class="text-xs text-white/60 mt-1">Preview (will upload on “Save Changes”).</div>
                </div>
              </div>

              <button id="btnLeaderSaveTeam"
                class="w-full px-4 py-3 rounded-xl font-extrabold bg-indigo-500 hover:bg-indigo-400">
                Save Changes
              </button>

              <div id="leaderSaveMsg" class="status"></div>
              <div class="text-xs text-white/60" id="leaderTeamMeta"></div>
            </div>
          </div>

          <!-- Approvals -->
          <div class="glass p-4">
            <div class="text-lg font-bold">Driver Applications</div>
            <div class="text-white/70 text-sm mb-3">Approve or decline join requests.</div>

            <div id="leaderAppsLoading" class="text-white/70 text-sm">Loading applications…</div>
            <div id="leaderAppsEmpty" class="hidden text-white/70 text-sm">No applications for your team yet.</div>
            <div id="leaderAppsList" class="mt-3 space-y-2"></div>
          </div>

          <!-- Roster + Publish -->
          <div class="glass p-4">
            <div class="text-lg font-bold">Roster & Publish</div>
            <div class="text-white/70 text-sm mb-3">Select from accepted drivers, then export.</div>

            <div class="text-white/70 text-sm mb-2">Accepted drivers</div>
            <div id="leaderAcceptedList" class="space-y-2"></div>

            <button id="btnLeaderSaveRoster"
              class="mt-3 w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500 hover:bg-emerald-400">
              Save Roster Selection
            </button>
            <div id="leaderRosterMsg" class="status"></div>

            <div class="mt-4 border-t border-white/10 pt-4">
              <div class="text-white/70 text-sm mb-2">Publish to JSON</div>

              <button id="btnLeaderPublishJson"
                class="w-full px-4 py-3 rounded-xl font-extrabold bg-white/10 hover:bg-white/15">
                Generate & Download JSON
              </button>

              <textarea id="leaderJsonPreview" rows="8"
                class="mt-3 w-full px-3 py-2 rounded-xl bg-black/30 border border-white/10 outline-none focus:ring-2 focus:ring-emerald-400 text-xs font-mono"
                placeholder="JSON preview will appear here…" readonly></textarea>
              <div class="text-xs text-white/60 mt-2">
                This downloads a file to your device. It does not upload anywhere (unless we add that next).
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="text-center text-white/50 text-xs mt-6">IFWL.net • GTeam 3 Team Hub</div>
    </div>
  </div>

  <script type="module">
    // Firestore (same Firebase project as tickets)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      limit,
      doc,
      setDoc,
      updateDoc,
      arrayUnion
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // ==========================================================
    // DISCORD LOGIN (rtGate Gen2) — same as tickets system
    // ==========================================================
    const RTGATE_BASE = "https://rtgate-vdr3uafd2q-nw.a.run.app/rtGate";
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    const REQUIRE_NICK_FORMAT = true;
    const NICK_REGEX = /^\[\s*\d+\s*\]\s*-\s*.+$/;

    const LS_KEY = "ifwl_discord_user";
    function safeStr(v){ return (typeof v === "string" ? v : "").trim(); }
    function setDiscordUser(userObj){ localStorage.setItem(LS_KEY, JSON.stringify(userObj)); }
    function getDiscordUser(){
      try { const raw = localStorage.getItem(LS_KEY); return raw ? JSON.parse(raw) : null; }
      catch { return null; }
    }
    function clearDiscordUser(){ localStorage.removeItem(LS_KEY); }

    function validateNick(nick){
      if (!REQUIRE_NICK_FORMAT) return true;
      return NICK_REGEX.test(safeStr(nick));
    }

    function hasRole(userObj, roleId){
      const roles = Array.isArray(userObj?.memberRoleIds) ? userObj.memberRoleIds : [];
      return roles.includes(roleId);
    }

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    const EVENT_ID = "gteam3-2026";

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    // Role ID: IFWL Active Racer (used to gate logo uploads)
    const ROLE_IFWL_ACTIVE_RACER_ID = "1166713466917224449";

    // Ensure Storage auth (anonymous) so Storage rules can require request.auth != null
    let _storageAuthReady = false;
    async function ensureStorageAuth(){
      if (_storageAuthReady) return true;
      try {
        await signInAnonymously(auth);
        _storageAuthReady = true;
        return true;
      } catch (e) {
        console.warn("Anonymous auth failed (storage may be blocked by rules):", e);
        return false;
      }
    }

    // UI
    const discordLoginSection = document.getElementById("discordLoginSection");
    const appSection          = document.getElementById("appSection");

    const publicUserBar    = document.getElementById("publicUserBar");
    const publicUserPill   = document.getElementById("publicUserPill");
    const discordLogoutBtn = document.getElementById("discordLogoutBtn");

    const discordLoginBtn    = document.getElementById("discordLoginBtn");
    const discordLoginStatus = document.getElementById("discordLoginStatus");

    // Create team UI
    const teamNameInput = document.getElementById("teamNameInput");
    const teamImageFileInput = document.getElementById("teamImageFileInput");
    const teamImagePreviewWrap = document.getElementById("teamImagePreviewWrap");
    const teamImagePreview = document.getElementById("teamImagePreview");
    const teamImageHelp = document.getElementById("teamImageHelp");
    const btnCreateTeam = document.getElementById("btnCreateTeam");
    const createTeamMsg = document.getElementById("createTeamMsg");

    // Team logo preview (local only until upload)
    if (teamImageFileInput) {
      teamImageFileInput.addEventListener("change", () => {
        createTeamMsg.textContent = "";
        createTeamMsg.className = "status";
        const f = teamImageFileInput.files && teamImageFileInput.files[0] ? teamImageFileInput.files[0] : null;
        if (!f) {
          if (teamImagePreviewWrap) teamImagePreviewWrap.classList.add("hidden");
          return;
        }
        const isJpeg = (f.type === "image/jpeg") || /\.jpe?g$/i.test(f.name || "");
        if (!isJpeg) {
          createTeamMsg.textContent = "Team image must be a JPEG (.jpg / .jpeg).";
          createTeamMsg.className = "status error";
          teamImageFileInput.value = "";
          if (teamImagePreviewWrap) teamImagePreviewWrap.classList.add("hidden");
          return;
        }
        const maxBytes = 5 * 1024 * 1024;
        if (f.size > maxBytes) {
          createTeamMsg.textContent = "Team image is too large. Max size is 5MB.";
          createTeamMsg.className = "status error";
          teamImageFileInput.value = "";
          if (teamImagePreviewWrap) teamImagePreviewWrap.classList.add("hidden");
          return;
        }
        // Preview
        const url = URL.createObjectURL(f);
        if (teamImagePreview) teamImagePreview.src = url;
        if (teamImagePreviewWrap) teamImagePreviewWrap.classList.remove("hidden");
      });
    }

    // Teams list
    const btnRefreshTeams = document.getElementById("btnRefreshTeams");
    const teamsLoading    = document.getElementById("teamsLoading");
    const teamsEmpty      = document.getElementById("teamsEmpty");
    const teamsList       = document.getElementById("teamsList");

    // Apply UI
    const selectedTeamEl = document.getElementById("selectedTeam");
    const noteEl         = document.getElementById("note");
    const btnApply       = document.getElementById("btnApply");
    const applyMsg       = document.getElementById("applyMsg");
    const myAppsEl       = document.getElementById("myApps");

    // Team Leader UI
    const leaderSection = document.getElementById("leaderSection");
    const leaderTeamNameInput = document.getElementById("leaderTeamNameInput");
    const leaderTeamImageFileInput = document.getElementById("leaderTeamImageFileInput");
    const leaderTeamImageHelp = document.getElementById("leaderTeamImageHelp");
    const leaderTeamImagePreviewWrap = document.getElementById("leaderTeamImagePreviewWrap");
    const leaderTeamImagePreview = document.getElementById("leaderTeamImagePreview");
    const btnLeaderSaveTeam = document.getElementById("btnLeaderSaveTeam");
    const leaderSaveMsg = document.getElementById("leaderSaveMsg");
    const leaderTeamMeta = document.getElementById("leaderTeamMeta");

    const leaderAppsLoading = document.getElementById("leaderAppsLoading");
    const leaderAppsEmpty = document.getElementById("leaderAppsEmpty");
    const leaderAppsList = document.getElementById("leaderAppsList");

    const leaderAcceptedList = document.getElementById("leaderAcceptedList");
    const btnLeaderSaveRoster = document.getElementById("btnLeaderSaveRoster");
    const leaderRosterMsg = document.getElementById("leaderRosterMsg");

    const btnLeaderPublishJson = document.getElementById("btnLeaderPublishJson");
    const leaderJsonPreview = document.getElementById("leaderJsonPreview");


    // State
    let selectedTeam = null;

    let leaderTeamId = null;
    let leaderTeamData = null; // latest team doc data

    // ==========================================================
    // Discord session helpers
    // ==========================================================
    function renderDiscordUserUI(){
      const u = getDiscordUser();
      if (!u) {
        publicUserBar.classList.add("hidden");
        return;
      }
      publicUserBar.classList.remove("hidden");
      publicUserPill.textContent = u.nick ? `Logged in as: ${u.nick}` : "Logged in (Discord)";

      // Gate team logo upload to IFWL Active Racer
      if (teamImageFileInput && teamImageHelp) {
        const canUpload = hasRole(u, ROLE_IFWL_ACTIVE_RACER_ID);
        teamImageFileInput.disabled = !canUpload;
        if (!canUpload) {
          teamImageHelp.innerHTML = 'Only <strong>IFWL Active Racers</strong> can upload a team logo. (Ask staff to add the role if needed.)';
          // Clear any selected file
          teamImageFileInput.value = "";
          if (teamImagePreviewWrap) teamImagePreviewWrap.classList.add("hidden");
        } else {
          teamImageHelp.innerHTML = 'JPEG only, max 5MB. Your logo uploads when you click <strong>Create Team</strong>.';
        }
      }
    }

    function showLogin(){
      discordLoginSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function showApp(){
      discordLoginSection.classList.add("hidden");
      appSection.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function requireDiscordOrShowLogin(){
      const u = getDiscordUser();
      if (!u) { showLogin(); return false; }
      if (!validateNick(u.nick)) {
        showLogin();
        discordLoginStatus.textContent =
          "Login successful, but your IFWL server nickname is not in the required format: [ drivernumber ] - driver name. Please update it and log in again.";
        discordLoginStatus.className = "status error";
        return false;
      }
      return true;
    }

    // ==========================================================
    // Discord login flow (rtGate)
    // ==========================================================
    async function startDiscordLogin(){
      discordLoginStatus.textContent = "Opening Discord login…";
      discordLoginStatus.className = "status";
      try {
        const r = await fetch(`${RTGATE_BASE}?start=1&redirect=${encodeURIComponent(REDIRECT_URI)}`);
        const data = await r.json();
        if (!r.ok || !data?.url) throw new Error(data?.error || "Failed to start login");
        window.location.href = data.url;
      } catch (e) {
        console.error(e);
        discordLoginStatus.textContent = "Failed to start Discord login. Please try again.";
        discordLoginStatus.className = "status error";
      }
    }

    async function finishDiscordLoginFromCodeIfPresent(){
      const url = new URL(window.location.href);
      const code = url.searchParams.get("code");
      if (!code) return false;

      url.searchParams.delete("code");
      window.history.replaceState({}, document.title, url.toString());

      discordLoginStatus.textContent = "Finishing Discord login…";
      discordLoginStatus.className = "status";

      try {
        const r = await fetch(
          `${RTGATE_BASE}?code=${encodeURIComponent(code)}&redirect=${encodeURIComponent(REDIRECT_URI)}&issue=1`,
          { method: "GET" }
        );
        const data = await r.json();
        if (!r.ok) throw new Error(data?.error || "Login failed");

        const roles = Array.isArray(data.memberRoleIds) ? data.memberRoleIds : [];
        if (!roles.length) {
          discordLoginStatus.textContent = "You must be a member of the IFWL Discord server to use this portal.";
          discordLoginStatus.className = "status error";
          return true;
        }

        const nick = safeStr(data.nick || data.nickname || data.guildNick || data.displayName || "");
        const userObj = {
          nick,
          id: safeStr(data.userId || data.id || ""),
          username: safeStr(data.username || data.user || ""),
          global: safeStr(data.globalName || data.global || ""),
          sessionToken: safeStr(data.sessionToken || ""),
          memberRoleIds: Array.isArray(data.memberRoleIds) ? data.memberRoleIds : [],
          loggedInAt: Date.now()
        };

        setDiscordUser(userObj);

        if (!validateNick(userObj.nick)) {
          discordLoginStatus.textContent =
            "Login successful, but your IFWL server nickname is not in the required format: [ drivernumber ] - driver name. Please update your nickname and log in again.";
          discordLoginStatus.className = "status error";
          showLogin();
          return true;
        }

        discordLoginStatus.textContent = "Login successful!";
        discordLoginStatus.className = "status success";
        renderDiscordUserUI();
        showApp();
        await loadTeams();
        await loadMyApplications();
        await loadLeaderTeamIfAny();
        return true;

      } catch (e) {
        console.error(e);
        discordLoginStatus.textContent = "Discord login failed. Please try again.";
        discordLoginStatus.className = "status error";
        showLogin();
        return true;
      }
    }

    discordLoginBtn.addEventListener("click", startDiscordLogin);

    discordLogoutBtn.addEventListener("click", () => {
      clearDiscordUser();
      renderDiscordUserUI();
      showLogin();
    });

    // ==========================================================
    // Create Team
    // ==========================================================
    function makeTeamIdFromName(name){
      return String(name || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, "-")
        .replace(/[^a-z0-9\-]/g, "")
        .slice(0, 60);
    }

    btnCreateTeam.addEventListener("click", async () => {
      createTeamMsg.className = "status";
      createTeamMsg.textContent = "";

      if (!requireDiscordOrShowLogin()) return;

      const u = getDiscordUser();
      const teamName = safeStr(teamNameInput.value).slice(0, 50);
      const teamLogoFile = teamImageFileInput && teamImageFileInput.files ? teamImageFileInput.files[0] : null;

      if (!teamName) {
        createTeamMsg.textContent = "Please enter a team name.";
        createTeamMsg.className = "status error";
        return;
      }

      btnCreateTeam.disabled = true;
      btnCreateTeam.classList.add("opacity-60", "cursor-not-allowed");
      createTeamMsg.textContent = "Creating team…";

      try {
        const baseId = makeTeamIdFromName(teamName);
        const docId = baseId ? `${baseId}__${u.id}` : `team__${u.id}`;

        // Optional: upload team logo to Firebase Storage (JPEG ≤ 5MB)
        let uploadedLogoUrl = "";
        let uploadedLogoPath = "";

        if (teamLogoFile) {
          // Extra validation (safety)
          const isJpeg = (teamLogoFile.type === "image/jpeg") || /\.jpe?g$/i.test(teamLogoFile.name || "");
          if (!isJpeg) throw new Error("Team image must be JPEG");
          if (teamLogoFile.size > 5 * 1024 * 1024) throw new Error("Team image exceeds 5MB");

          // Enforce: only IFWL Active Racer can upload
          const canUpload = hasRole(u, ROLE_IFWL_ACTIVE_RACER_ID);
          if (!canUpload) throw new Error("Only IFWL Active Racers can upload a team logo.");

          const okAuth = await ensureStorageAuth();
          if (!okAuth) throw new Error("Storage auth failed (check Storage rules / Anonymous Auth).");

          uploadedLogoPath = `gteam3/team_logos/${EVENT_ID}/${docId}.jpg`;
          const refObj = storageRef(storage, uploadedLogoPath);
          await uploadBytes(refObj, teamLogoFile, { contentType: "image/jpeg" });
          uploadedLogoUrl = await getDownloadURL(refObj);
        }

        const payload = {
          eventId: EVENT_ID,
          teamName,
          teamImageUrl: uploadedLogoUrl || "",
          teamImagePath: uploadedLogoPath || "",

          leaderDiscordId: safeStr(u.id),
          leaderNick: safeStr(u.nick),
          leaderUsername: safeStr(u.username),
          leaderGlobal: safeStr(u.global),

          // Members list starts with leader (flexible schema)
          drivers: [
            {
              discordId: safeStr(u.id),
              nick: safeStr(u.nick),
              username: safeStr(u.username),
              global: safeStr(u.global),
              role: "leader",
              joinedAt: null
            }
          ],

          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        await setDoc(doc(db, "gteam3_teams", docId), payload, { merge: false });

        teamNameInput.value = "";
        if (teamImageFileInput) teamImageFileInput.value = "";
        if (teamImagePreviewWrap) teamImagePreviewWrap.classList.add("hidden");

        createTeamMsg.textContent = "Team created! It will appear in the list.";
        createTeamMsg.className = "status success";

        await loadTeams();
      } catch (e) {
        console.error(e);
        createTeamMsg.textContent = String(e?.message || "Could not create team (rules/config). Check console.");
        createTeamMsg.className = "status error";
      } finally {
        btnCreateTeam.disabled = false;
        btnCreateTeam.classList.remove("opacity-60", "cursor-not-allowed");
      }
    });

    // ==========================================================
    // Teams loading
    // ==========================================================
    function setApplyEnabled(enabled){
      btnApply.disabled = !enabled;
      btnApply.className = enabled
        ? "w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500 hover:bg-emerald-400"
        : "w-full px-4 py-3 rounded-xl font-extrabold bg-emerald-500/35 text-white/70 cursor-not-allowed";
    }

    async function loadTeams(){
      teamsLoading.classList.remove("hidden");
      teamsEmpty.classList.add("hidden");
      teamsList.innerHTML = "";
      selectedTeam = null;
      selectedTeamEl.textContent = "None selected";
      setApplyEnabled(false);
      applyMsg.textContent = "";

      const qTeams = query(
        collection(db, "gteam3_teams"),
        where("eventId", "==", EVENT_ID),
        orderBy("teamName", "asc"),
        limit(200)
      );

      try {
        const snap = await getDocs(qTeams);

        teamsLoading.classList.add("hidden");

        if (snap.empty) {
          teamsEmpty.classList.remove("hidden");
          return;
        }

        const teams = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        teams.forEach(team => {
          const card = document.createElement("button");
          card.type = "button";
          card.className = "w-full text-left glass px-4 py-3 hover:bg-white/10 transition";

          const img = team.teamImageUrl
            ? `<img src="${team.teamImageUrl}" alt="logo" class="h-10 w-10 rounded-xl object-cover border border-white/10 bg-black/20">`
            : `<div class="h-10 w-10 rounded-xl border border-white/10 bg-white/5 flex items-center justify-center text-white/60 text-xs">No<br>Logo</div>`;

          card.innerHTML = `
            <div class="flex items-center gap-3">
              ${img}
              <div class="min-w-0">
                <div class="font-extrabold text-lg truncate">${(team.teamName || "").toString()}</div>
                <div class="text-white/70 text-sm truncate">Leader: ${(team.leaderNick || team.leaderUsername || "Unknown").toString()}</div>
              </div>
            </div>
          `;

          card.addEventListener("click", () => {
            selectedTeam = team;
            selectedTeamEl.textContent = team.teamName || team.id;
            setApplyEnabled(true);
          });

          teamsList.appendChild(card);
        });

      } catch (e) {
        console.error(e);
        teamsLoading.textContent = "Error loading teams (check console).";
      }
    }

    btnRefreshTeams.addEventListener("click", async () => {
      if (!requireDiscordOrShowLogin()) return;
      await loadTeams();
    });

    // ==========================================================
    // Applications
    // ==========================================================
    async function loadMyApplications(){
      const u = getDiscordUser();
      if (!u) return;

      const qApps = query(
        collection(db, "gteam3_applications"),
        where("eventId", "==", EVENT_ID),
        where("applicantDiscordId", "==", safeStr(u.id)),
        orderBy("createdAt", "desc"),
        limit(50)
      );

      try {
        const snap = await getDocs(qApps);
        if (snap.empty) {
          myAppsEl.textContent = "No applications yet.";
          return;
        }

        const rows = snap.docs.map(d => d.data());
        myAppsEl.innerHTML = rows.map(r => {
          const status = (r.status || "pending").toString();
          const badge = status === "approved" ? "bg-emerald-500/30 text-emerald-100"
                      : status === "declined" ? "bg-red-500/30 text-red-100"
                      : "bg-yellow-500/30 text-yellow-100";

          return `
            <div class="glass p-3 mb-2">
              <div class="flex items-center justify-between gap-2">
                <div class="font-bold truncate">${(r.teamName || r.teamId || "Team").toString()}</div>
                <div class="text-xs px-2 py-1 rounded-full ${badge}">${status.toUpperCase()}</div>
              </div>
              ${r.note ? `<div class="text-white/70 text-sm mt-1">${r.note.toString()}</div>` : ""}
            </div>
          `;
        }).join("");
      } catch (e) {
        console.error(e);
        myAppsEl.textContent = "Error loading applications (check console).";
      }
    }

    

    // ==========================================================
    // Team Leader Controls
    // ==========================================================
    function canUploadTeamLogo(u){
      return hasRole(u, ROLE_IFWL_ACTIVE_RACER_ID);
    }

    function setLeaderLogoGating(){
      const u = getDiscordUser();
      if (!leaderTeamImageFileInput || !leaderTeamImageHelp) return;
      const ok = !!u && canUploadTeamLogo(u);
      leaderTeamImageFileInput.disabled = !ok;
      if (!ok) {
        leaderTeamImageHelp.innerHTML = 'Only <strong>IFWL Active Racers</strong> can upload a team logo. (Ask staff to add the role if needed.)';
        leaderTeamImageFileInput.value = "";
        if (leaderTeamImagePreviewWrap) leaderTeamImagePreviewWrap.classList.add("hidden");
      } else {
        leaderTeamImageHelp.innerHTML = 'JPEG only, max 5MB. Upload happens when you click <strong>Save Changes</strong>.';
      }
    }

    // Logo preview (leader)
    if (leaderTeamImageFileInput) {
      leaderTeamImageFileInput.addEventListener("change", () => {
        if (!leaderSaveMsg) return;
        leaderSaveMsg.textContent = "";
        leaderSaveMsg.className = "status";
        const f = leaderTeamImageFileInput.files && leaderTeamImageFileInput.files[0] ? leaderTeamImageFileInput.files[0] : null;
        if (!f) {
          if (leaderTeamImagePreviewWrap) leaderTeamImagePreviewWrap.classList.add("hidden");
          return;
        }
        const isJpeg = (f.type === "image/jpeg") || /\.jpe?g$/i.test(f.name || "");
        if (!isJpeg) {
          leaderSaveMsg.textContent = "Team image must be a JPEG (.jpg / .jpeg).";
          leaderSaveMsg.className = "status error";
          leaderTeamImageFileInput.value = "";
          if (leaderTeamImagePreviewWrap) leaderTeamImagePreviewWrap.classList.add("hidden");
          return;
        }
        const maxBytes = 5 * 1024 * 1024;
        if (f.size > maxBytes) {
          leaderSaveMsg.textContent = "Team image is too large. Max size is 5MB.";
          leaderSaveMsg.className = "status error";
          leaderTeamImageFileInput.value = "";
          if (leaderTeamImagePreviewWrap) leaderTeamImagePreviewWrap.classList.add("hidden");
          return;
        }
        const url = URL.createObjectURL(f);
        if (leaderTeamImagePreview) leaderTeamImagePreview.src = url;
        if (leaderTeamImagePreviewWrap) leaderTeamImagePreviewWrap.classList.remove("hidden");
      });
    }

    async function loadLeaderTeamIfAny(){
      leaderTeamId = null;
      leaderTeamData = null;

      if (!leaderSection) return;
      leaderSection.classList.add("hidden");

      const u = getDiscordUser();
      if (!u) return;

      setLeaderLogoGating();

      try {
        const qLeaderTeam = query(
          collection(db, "gteam3_teams"),
          where("eventId", "==", EVENT_ID),
          where("leaderDiscordId", "==", safeStr(u.id)),
          limit(1)
        );
        const snap = await getDocs(qLeaderTeam);
        if (snap.empty) return;

        const d = snap.docs[0];
        leaderTeamId = d.id;
        leaderTeamData = d.data() || {};

        // Populate edit UI
        if (leaderTeamNameInput) leaderTeamNameInput.value = safeStr(leaderTeamData.teamName).slice(0, 50);
        if (leaderTeamMeta) leaderTeamMeta.textContent = `Team ID: ${leaderTeamId}`;

        leaderSection.classList.remove("hidden");

        await loadLeaderApplications();
        renderAcceptedDrivers();
      } catch (e) {
        console.error(e);
        // If leader controls fail, we just hide them (avoid breaking app)
        leaderSection.classList.add("hidden");
      }
    }

    async function refreshLeaderTeamDoc(){
      if (!leaderTeamId) return;
      try {
        const refTeam = doc(db, "gteam3_teams", leaderTeamId);
        const snap = await getDoc(refTeam);
        if (snap.exists()) leaderTeamData = snap.data() || {};
      } catch (e) {
        console.error(e);
      }
    }

    async function loadLeaderApplications(){
      if (!leaderAppsLoading || !leaderAppsList || !leaderAppsEmpty) return;
      leaderAppsLoading.classList.remove("hidden");
      leaderAppsEmpty.classList.add("hidden");
      leaderAppsList.innerHTML = "";

      if (!leaderTeamId) {
        leaderAppsLoading.classList.add("hidden");
        leaderAppsEmpty.classList.remove("hidden");
        return;
      }

      try {
        const qApps = query(
          collection(db, "gteam3_applications"),
          where("eventId", "==", EVENT_ID),
          where("teamId", "==", leaderTeamId),
          orderBy("createdAt", "desc"),
          limit(200)
        );
        const snap = await getDocs(qApps);

        leaderAppsLoading.classList.add("hidden");

        if (snap.empty) {
          leaderAppsEmpty.classList.remove("hidden");
          return;
        }

        const apps = snap.docs.map(d => ({ _id: d.id, ...(d.data() || {}) }));

        apps.forEach(appRow => {
          const status = safeStr(appRow.status || "pending").toLowerCase();
          const badge = status === "approved" ? "bg-emerald-500/30 text-emerald-100"
                      : status === "declined" ? "bg-red-500/30 text-red-100"
                      : "bg-yellow-500/30 text-yellow-100";

          const wrap = document.createElement("div");
          wrap.className = "glass p-3";

          const note = safeStr(appRow.note);
          const who = safeStr(appRow.applicantNick || appRow.applicantUsername || appRow.applicantDiscordId || "Applicant");
          const did = safeStr(appRow.applicantDiscordId);

          wrap.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <div class="min-w-0">
                <div class="font-bold truncate">${who}</div>
                <div class="text-white/60 text-xs truncate">${did}</div>
              </div>
              <div class="text-xs px-2 py-1 rounded-full ${badge} whitespace-nowrap">${status.toUpperCase()}</div>
            </div>
            ${note ? `<div class="text-white/70 text-sm mt-2">${note}</div>` : ""}
          `;

          if (status === "pending") {
            const actions = document.createElement("div");
            actions.className = "flex gap-2 mt-3";

            const btnApprove = document.createElement("button");
            btnApprove.className = "flex-1 px-3 py-2 rounded-xl font-extrabold bg-emerald-500 hover:bg-emerald-400";
            btnApprove.textContent = "Approve";

            const btnDecline = document.createElement("button");
            btnDecline.className = "flex-1 px-3 py-2 rounded-xl font-extrabold bg-red-500/70 hover:bg-red-500/80";
            btnDecline.textContent = "Decline";

            btnApprove.addEventListener("click", async () => {
              btnApprove.disabled = true; btnDecline.disabled = true;
              try { await approveApplication(appRow); }
              finally { btnApprove.disabled = false; btnDecline.disabled = false; }
            });

            btnDecline.addEventListener("click", async () => {
              btnApprove.disabled = true; btnDecline.disabled = true;
              try { await declineApplication(appRow); }
              finally { btnApprove.disabled = false; btnDecline.disabled = false; }
            });

            actions.appendChild(btnApprove);
            actions.appendChild(btnDecline);
            wrap.appendChild(actions);
          }

          leaderAppsList.appendChild(wrap);
        });
      } catch (e) {
        console.error(e);
        leaderAppsLoading.textContent = "Error loading applications (check console).";
      }
    }

    async function approveApplication(appRow){
      if (!leaderTeamId || !appRow?._id) return;
      try {
        await updateDoc(doc(db, "gteam3_applications", appRow._id), {
          status: "approved",
          updatedAt: serverTimestamp()
        });

        const refTeam = doc(db, "gteam3_teams", leaderTeamId);
        const snap = await getDoc(refTeam);
        if (!snap.exists()) throw new Error("Team doc not found");

        const team = snap.data() || {};
        const drivers = Array.isArray(team.drivers) ? team.drivers : [];
        const did = safeStr(appRow.applicantDiscordId);

        const exists = drivers.some(d => safeStr(d?.discordId) === did);
        if (!exists && did) {
          const newDriver = {
            discordId: did,
            nick: safeStr(appRow.applicantNick),
            username: safeStr(appRow.applicantUsername),
            global: safeStr(appRow.applicantGlobal),
            role: "driver",
            joinedAt: null
          };
          await updateDoc(refTeam, {
            drivers: [...drivers, newDriver],
            updatedAt: serverTimestamp()
          });
        } else {
          await updateDoc(refTeam, { updatedAt: serverTimestamp() });
        }

        await refreshLeaderTeamDoc();
        renderAcceptedDrivers();
        await loadLeaderApplications();
        await loadTeams();
      } catch (e) {
        console.error(e);
        alert(String(e?.message || "Approve failed. Check console."));
      }
    }

    async function declineApplication(appRow){
      if (!appRow?._id) return;
      try {
        await updateDoc(doc(db, "gteam3_applications", appRow._id), {
          status: "declined",
          updatedAt: serverTimestamp()
        });
        await loadLeaderApplications();
      } catch (e) {
        console.error(e);
        alert("Decline failed. Check console.");
      }
    }

    function getTeamDrivers(){
      return Array.isArray(leaderTeamData?.drivers) ? leaderTeamData.drivers : [];
    }

    function getPublishedRosterIds(){
      return Array.isArray(leaderTeamData?.publishedRosterIds) ? leaderTeamData.publishedRosterIds : [];
    }

    function renderAcceptedDrivers(){
      if (!leaderAcceptedList) return;
      leaderAcceptedList.innerHTML = "";

      const drivers = getTeamDrivers();
      if (!drivers.length) {
        leaderAcceptedList.innerHTML = `<div class="text-white/70 text-sm">No drivers on your team yet.</div>`;
        return;
      }

      const published = new Set(getPublishedRosterIds());

      drivers.forEach(d => {
        const did = safeStr(d?.discordId);
        const isLeader = safeStr(d?.role) === "leader";
        const label = safeStr(d?.nick || d?.username || did || "Driver");

        const row = document.createElement("label");
        row.className = "flex items-center gap-3 p-2 rounded-xl bg-white/5 border border-white/10";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "h-4 w-4";
        cb.dataset.did = did;

        if (isLeader) {
          cb.checked = true;
          cb.disabled = true;
        } else {
          cb.checked = published.size ? published.has(did) : true; // default include all if none saved
        }

        const text = document.createElement("div");
        text.className = "min-w-0";
        text.innerHTML = `
          <div class="font-bold truncate">${label}${isLeader ? " <span class='text-white/60 text-xs'>(Leader)</span>" : ""}</div>
          <div class="text-white/60 text-xs truncate">${did}</div>
        `;

        row.appendChild(cb);
        row.appendChild(text);
        leaderAcceptedList.appendChild(row);
      });
    }

    function getRosterSelectionFromUI(){
      if (!leaderAcceptedList) return [];
      const checks = leaderAcceptedList.querySelectorAll("input[type='checkbox']");
      const ids = [];
      checks.forEach(cb => {
        const did = safeStr(cb.dataset.did);
        if (cb.checked && did) ids.push(did);
      });
      return ids;
    }

    async function saveRosterSelection(){
      if (!leaderTeamId) return;
      leaderRosterMsg.className = "status";
      leaderRosterMsg.textContent = "";

      const rosterIds = getRosterSelectionFromUI();
      if (!rosterIds.length) {
        leaderRosterMsg.textContent = "Select at least one driver.";
        leaderRosterMsg.className = "status error";
        return;
      }

      try {
        await updateDoc(doc(db, "gteam3_teams", leaderTeamId), {
          publishedRosterIds: rosterIds,
          updatedAt: serverTimestamp()
        });
        await refreshLeaderTeamDoc();
        leaderRosterMsg.textContent = "Roster saved.";
        leaderRosterMsg.className = "status success";
      } catch (e) {
        console.error(e);
        leaderRosterMsg.textContent = "Failed to save roster (check console).";
        leaderRosterMsg.className = "status error";
      }
    }

    function buildPublishJson(){
      const drivers = getTeamDrivers();
      const rosterIds = getRosterSelectionFromUI();
      const rosterSet = new Set(rosterIds);

      // Include only selected drivers; leader checkbox is always selected+disabled so included.
      const roster = drivers
        .filter(d => rosterSet.has(safeStr(d?.discordId)))
        .map(d => ({
          discordId: safeStr(d?.discordId),
          nick: safeStr(d?.nick),
          username: safeStr(d?.username),
          global: safeStr(d?.global),
          role: safeStr(d?.role || "driver")
        }));

      return {
        eventId: EVENT_ID,
        teamId: leaderTeamId,
        teamName: safeStr(leaderTeamData?.teamName),
        teamImageUrl: safeStr(leaderTeamData?.teamImageUrl),
        leader: {
          discordId: safeStr(leaderTeamData?.leaderDiscordId),
          nick: safeStr(leaderTeamData?.leaderNick),
          username: safeStr(leaderTeamData?.leaderUsername),
          global: safeStr(leaderTeamData?.leaderGlobal)
        },
        roster,
        publishedAt: new Date().toISOString()
      };
    }

    function downloadJson(filename, obj){
      const text = JSON.stringify(obj, null, 2);
      if (leaderJsonPreview) leaderJsonPreview.value = text;

      const blob = new Blob([text], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        URL.revokeObjectURL(a.href);
        a.remove();
      }, 0);
    }

    async function saveLeaderTeamEdits(){
      if (!leaderTeamId) return;
      if (!requireDiscordOrShowLogin()) return;

      leaderSaveMsg.className = "status";
      leaderSaveMsg.textContent = "";

      const u = getDiscordUser();

      const newName = safeStr(leaderTeamNameInput?.value).slice(0, 50);
      if (!newName) {
        leaderSaveMsg.textContent = "Team name cannot be empty.";
        leaderSaveMsg.className = "status error";
        return;
      }

      btnLeaderSaveTeam.disabled = true;
      btnLeaderSaveTeam.classList.add("opacity-60", "cursor-not-allowed");
      leaderSaveMsg.textContent = "Saving…";

      try {
        const refTeam = doc(db, "gteam3_teams", leaderTeamId);

        let uploadedLogoUrl = "";
        let uploadedLogoPath = "";

        const f = leaderTeamImageFileInput && leaderTeamImageFileInput.files ? leaderTeamImageFileInput.files[0] : null;
        if (f) {
          const isJpeg = (f.type === "image/jpeg") || /\.jpe?g$/i.test(f.name || "");
          if (!isJpeg) throw new Error("Team image must be JPEG");
          if (f.size > 5 * 1024 * 1024) throw new Error("Team image exceeds 5MB");
          if (!canUploadTeamLogo(u)) throw new Error("Only IFWL Active Racers can upload a team logo.");

          const okAuth = await ensureStorageAuth();
          if (!okAuth) throw new Error("Storage auth failed (check Storage rules / Anonymous Auth).");

          uploadedLogoPath = `gteam3/team_logos/${EVENT_ID}/${leaderTeamId}.jpg`;
          const refObj = storageRef(storage, uploadedLogoPath);
          await uploadBytes(refObj, f, { contentType: "image/jpeg" });
          uploadedLogoUrl = await getDownloadURL(refObj);
        }

        const updatePayload = {
          teamName: newName,
          updatedAt: serverTimestamp()
        };
        if (uploadedLogoUrl) {
          updatePayload.teamImageUrl = uploadedLogoUrl;
          updatePayload.teamImagePath = uploadedLogoPath;
        }

        await updateDoc(refTeam, updatePayload);

        // Reset file picker + preview
        if (leaderTeamImageFileInput) leaderTeamImageFileInput.value = "";
        if (leaderTeamImagePreviewWrap) leaderTeamImagePreviewWrap.classList.add("hidden");

        await refreshLeaderTeamDoc();
        leaderSaveMsg.textContent = "Saved.";
        leaderSaveMsg.className = "status success";

        await loadTeams(); // refresh public list
        renderAcceptedDrivers();
      } catch (e) {
        console.error(e);
        leaderSaveMsg.textContent = String(e?.message || "Save failed (check console).");
        leaderSaveMsg.className = "status error";
      } finally {
        btnLeaderSaveTeam.disabled = false;
        btnLeaderSaveTeam.classList.remove("opacity-60", "cursor-not-allowed");
      }
    }

    if (btnLeaderSaveTeam) btnLeaderSaveTeam.addEventListener("click", saveLeaderTeamEdits);
    if (btnLeaderSaveRoster) btnLeaderSaveRoster.addEventListener("click", saveRosterSelection);

    if (btnLeaderPublishJson) {
      btnLeaderPublishJson.addEventListener("click", async () => {
        if (!leaderTeamId) return;
        // Ensure the latest team data is used
        await refreshLeaderTeamDoc();
        const obj = buildPublishJson();
        const safeName = safeStr(obj.teamName || "team").toLowerCase().replace(/\s+/g, "_").replace(/[^a-z0-9_]/g, "").slice(0, 40);
        downloadJson(`${EVENT_ID}_${safeName || leaderTeamId}.json`, obj);
      });
    }

btnApply.addEventListener("click", async () => {
      applyMsg.className = "status";
      applyMsg.textContent = "";

      if (!requireDiscordOrShowLogin()) return;
      const u = getDiscordUser();

      if (!selectedTeam) {
        applyMsg.textContent = "Please select a team first.";
        applyMsg.className = "status error";
        return;
      }

      btnApply.disabled = true;
      btnApply.classList.add("opacity-60", "cursor-not-allowed");
      applyMsg.textContent = "Submitting application…";

      try {
        const payload = {
          eventId: EVENT_ID,
          teamId: selectedTeam.id,
          teamName: safeStr(selectedTeam.teamName),
          leaderDiscordId: safeStr(selectedTeam.leaderDiscordId),

          applicantDiscordId: safeStr(u.id),
          applicantNick: safeStr(u.nick),
          applicantUsername: safeStr(u.username),
          applicantGlobal: safeStr(u.global),

          note: safeStr(noteEl.value).slice(0, 500),
          status: "pending",

          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };

        await addDoc(collection(db, "gteam3_applications"), payload);

        noteEl.value = "";
        applyMsg.textContent = "Application submitted! Await leader approval.";
        applyMsg.className = "status success";

        await loadMyApplications();
      } catch (e) {
        console.error(e);
        applyMsg.textContent = "Could not submit application (rules/config). Check console.";
        applyMsg.className = "status error";
      } finally {
        btnApply.disabled = false;
        btnApply.classList.remove("opacity-60", "cursor-not-allowed");
        setApplyEnabled(!!selectedTeam);
      }
    });

    // ==========================================================
    // Init
    // ==========================================================
    await finishDiscordLoginFromCodeIfPresent();
    renderDiscordUserUI();

    if (requireDiscordOrShowLogin()) {
      showApp();
      await loadTeams();
      await loadMyApplications();
      await loadLeaderTeamIfAny();
    } else {
      showLogin();
    }
  </script>
</body>
</html>
