<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL — Race Control</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --panel: rgba(255,255,255,.86);
      --panel2: rgba(255,255,255,.72);
      --line: rgba(15,23,42,.14);
      --line2: rgba(15,23,42,.18);
      --text:#0f172a;
      --muted: rgba(15,23,42,.68);

      --red:#dc2626;
      --amber:#f59e0b;
      --green:#16a34a;
      --blue:#2563eb;

      --shadow: 0 18px 55px rgba(2,6,23,.16);
      --shadow2: 0 10px 28px rgba(2,6,23,.14);

      --radius: 16px;
      --radius2: 14px;
      --mono: ui-monospace, Menlo, Consolas, monospace;
      --sans: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(255,255,255,.82), rgba(255,255,255,.88)),
        url("ifwl_bg.webp");
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      overflow-x:hidden;
    }

    /* subtle overlay for readability on busy bg */
    body:before{
      content:"";
      position:fixed; inset:0;
      background:
        radial-gradient(1200px 800px at 18% 10%, rgba(37,99,235,.12), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(22,163,74,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.65), rgba(255,255,255,.72));
      pointer-events:none;
    }

    .wrap{
      position:relative;
      width:min(1180px, 94vw);
      margin: 16px auto 28px;
    }

    /* HEADER / AUTH CENTER */
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      padding: 14px 14px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      min-width: 260px;
    }

    .brand img{
      width: 44px;
      height: 44px;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(2,6,23,.18));
    }

    .brandText{
      display:flex;
      flex-direction:column;
      gap:3px;
      line-height:1.1;
    }

    .brandText .title{
      font-weight: 1000;
      letter-spacing:.3px;
      font-size: 16px;
    }

    .brandText .sub{
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .authCenter{
      display:flex;
      flex-direction:column;
      gap:8px;
      flex:1;
      min-width: 320px;
      max-width: 680px;
    }

    .authRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .authRow input{
      flex: 1 1 260px;
      padding:11px 12px;
      border-radius: 12px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.9);
      color: var(--text);
      outline:none;
      font-family: var(--mono);
      font-size: 12.5px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
    }

    .authNote{
      color: var(--muted);
      font-size: 12px;
      line-height:1.25;
      font-family: var(--mono);
    }

    /* right status */
    .statusStrip{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
      min-width: 280px;
    }

    .liveLine{
      display:flex;
      align-items:center;
      gap:8px;
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(15,23,42,.82);
      letter-spacing:.2px;
    }

    .dot{
      width:10px;height:10px;border-radius:999px;
      background: var(--green);
      box-shadow: 0 0 0 0 rgba(22,163,74,.35);
      animation: pulse 1.25s infinite;
      border: 1px solid rgba(15,23,42,.18);
    }
    .dot.off{
      background: rgba(220,38,38,.85);
      animation:none;
      box-shadow:none;
    }
    @keyframes pulse{
      0%{box-shadow:0 0 0 0 rgba(22,163,74,.30)}
      70%{box-shadow:0 0 0 14px rgba(22,163,74,0)}
      100%{box-shadow:0 0 0 0 rgba(22,163,74,0)}
    }

    .badge{
      font-family:var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: rgba(255,255,255,.75);
      color: rgba(15,23,42,.85);
    }

    .statusBox{
      width: min(420px, 100%);
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(255,255,255,.78);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
      font-family: var(--mono);
      font-size: 12px;
      color: rgba(15,23,42,.88);
      white-space: pre-wrap;
    }

    /* PANELS */
    .panel{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: var(--panel);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    .panelHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.84), rgba(255,255,255,.66));
      border-bottom:1px solid rgba(15,23,42,.08);
    }

    .panelTitle{
      font-family: var(--mono);
      font-weight: 1000;
      letter-spacing:.35px;
      font-size: 12.5px;
      opacity: .96;
      display:flex;
      align-items:center;
      gap:10px;
      text-transform: uppercase;
    }

    .chip{
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.72);
      color: rgba(15,23,42,.78);
    }

    .panelBody{
      padding: 12px 14px 14px;
    }

    /* BUTTONS */
    button{
      border:none;
      cursor:pointer;
      font-weight: 1000;
      letter-spacing:.25px;
      transition: transform .06s ease, filter .12s ease, opacity .12s ease;
      color: var(--text);
    }
    button:active{ transform: translateY(1px) scale(.995); }
    button[disabled]{ opacity:.55; cursor:not-allowed; transform:none; }

    .btn{
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.8);
      box-shadow: 0 10px 25px rgba(2,6,23,.10);
      padding: 10px 12px;
      font-size: 12px;
      font-family: var(--mono);
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn.danger{
      border-color: rgba(220,38,38,.40);
      background: rgba(220,38,38,.10);
    }

    /* LAYOUT SECTIONS */
    .stack{
      display:flex;
      flex-direction:column;
      gap:14px;
      margin-top: 14px;
    }

    /* BROADCAST */
    .msgRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    .msgBox{
      flex: 1 1 420px;
      width:100%;
      min-height: 104px;
      resize: vertical;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.9);
      color: var(--text);
      outline:none;
      font-family: var(--mono);
      font-size: 12.5px;
      line-height:1.25;
    }
    .msgHelp{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12px;
      font-family: var(--mono);
      line-height:1.25;
    }

    /* COMMAND GRID */
    .cmdGrid{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 10px;
    }

    .cmd{
      grid-column: span 4;
      min-height: 94px;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.86);
      box-shadow: 0 14px 30px rgba(2,6,23,.10);
      padding: 12px 12px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:8px;
      text-align:left;
      position:relative;
      overflow:hidden;
    }
    .cmd:hover{ filter: brightness(1.01); }

    .cmd .stripe{
      position:absolute; left:0; top:0; bottom:0;
      width: 6px;
      opacity:.95;
    }
    .cmd.red .stripe{ background: linear-gradient(180deg, #ef4444, #991b1b); }
    .cmd.yellow .stripe{ background: linear-gradient(180deg, #fbbf24, #b45309); }
    .cmd.green .stripe{ background: linear-gradient(180deg, #22c55e, #166534); }
    .cmd.blue .stripe{ background: linear-gradient(180deg, #60a5fa, #1d4ed8); }

    .cmd .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      z-index:1;
    }
    .cmd .name{
      font-family: var(--mono);
      font-size: 13px;
      letter-spacing:.35px;
      font-weight: 1000;
      text-transform: uppercase;
    }
    .cmd .tag{
      font-family: var(--mono);
      font-size: 10.5px;
      padding: 4px 7px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.72);
      color: rgba(15,23,42,.80);
      white-space:nowrap;
    }
    .cmd .desc{
      z-index:1;
      font-size: 12px;
      color: rgba(15,23,42,.70);
      line-height:1.25;
      font-family: var(--mono);
    }

    .span6{ grid-column: span 6; }
    .span12{ grid-column: span 12; }

    @media (max-width: 980px){
      .cmd{ grid-column: span 6; }
      .span6{ grid-column: span 12; }
      .statusStrip{ align-items:flex-start; }
      .topbar{ flex-direction:column; align-items:stretch; }
      .statusStrip{ align-items:flex-start; }
      .statusBox{ width:100%; }
    }
    @media (max-width: 560px){
      .cmd{ grid-column: span 12; }
    }

    /* pills */
    .minirow{
      margin-top: 12px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      font-family: var(--mono);
      font-size: 11.5px;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.72);
      color: rgba(15,23,42,.82);
      white-space:nowrap;
    }
    .ok{color:#166534}
    .bad{color:#991b1b}
    .warn{color:#92400e}

    /* check-in list */
    .list{
      margin:0;
      padding:0;
      list-style:none;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height: 280px;
      overflow:auto;
    }
    .item{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      font-family: var(--mono);
      font-size: 12.5px;
    }
    .itemName{ font-weight:1000; }
    .itemTime{ opacity:.78; }

    /* Quali Split Scheduler (inside Flag panel) */
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .rowLine{
      display:grid;
      grid-template-columns: 18px 118px 1fr 132px;
      gap:10px;
      align-items:center;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.10);
      background: rgba(255,255,255,.82);
      font-family: var(--mono);
      font-size: 12.5px;
    }
    @media (max-width: 560px){
      .rowLine{
        grid-template-columns: 18px 1fr;
      }
      .rowLine > :nth-child(3),
      .rowLine > :nth-child(4){
        grid-column: 1 / -1;
      }
    }

    .rowLine label{ font-weight:1000; letter-spacing:.3px; }
    .rowLine input[type="number"], .rowLine select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(255,255,255,.92);
      color: var(--text);
      outline:none;
      font-family: var(--mono);
      font-size: 12.5px;
    }
    .muted{ opacity:.78; font-size: 12px; font-family: var(--mono); }

    .warnBox{
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px solid rgba(245,158,11,.35);
      background: rgba(245,158,11,.10);
      font-family: var(--mono);
      font-size: 12.5px;
      opacity:.97;
      line-height:1.3;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 12.5px;
      font-family: var(--mono);
      line-height:1.25;
    }

    /* sticky status on mobile */
    @media (max-width: 560px){
      .statusBox{
        position: sticky;
        top: 10px;
        z-index: 50;
        backdrop-filter: blur(10px);
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- AUTHORISATION CENTER TOP -->
    <div class="topbar">
      <div class="brand">
        <img src="ifwl_logo.png" alt="IFWL Logo" />
        <div class="brandText">
          <div class="title">IFWL Race Control</div>
          <div class="sub">Stewards Console • Live Operations</div>
        </div>
      </div>

      <div class="authCenter">
        <div class="authRow">
          <input id="tokenInput" type="password" placeholder="Enter steward token (one-time) — stored on this device" />
          <button class="btn" id="btnSaveToken" type="button">Save token</button>
          <button class="btn danger" id="btnClearToken" type="button">Clear token</button>
        </div>
        <div class="authNote">
          Token is stored <b>only in your browser</b> (localStorage) on this device.
          If you change PCs/browsers, you’ll need to enter it again.
        </div>
      </div>

      <div class="statusStrip">
        <div class="liveLine">
          <span class="dot off" id="liveDot" aria-hidden="true"></span>
          <span>Operations Link</span>
          <span class="badge" id="opsBadge">OFFLINE</span>
        </div>
        <div class="statusBox" id="status">Ready.</div>
      </div>
    </div>

    <div class="stack">
      <!-- BROADCAST MESSAGE TOP (2ND DOWN) -->
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle">Send Message to All Drivers <span class="chip">Shows 20s</span></div>
          <div class="panelBtns">
            <button class="btn" id="btnSendBroadcast" type="button">Send message</button>
          </div>
        </div>
        <div class="panelBody">
          <div class="msgRow">
            <textarea id="broadcastText" class="msgBox" maxlength="220"
              placeholder="Type message here… (e.g. Please hold position at pit exit, stewards reviewing incident)"></textarea>
          </div>
          <div class="msgHelp">Tip: Ctrl+Enter sends. Message disappears automatically after 20 seconds.</div>
        </div>
      </div>

      <!-- FLAG & SERVER CONTROL (WITH SPLITS INSIDE) -->
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle">Flag &amp; Server Control <span class="chip">Live Commands</span></div>
          <div class="panelBtns">
            <span class="chip">Authorised use only</span>
          </div>
        </div>

        <div class="panelBody">
          <div class="cmdGrid">
            <button class="cmd red span6" id="btnRed" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">CALL RED FLAG</div>
                <div class="tag">TRACK STOP</div>
              </div>
              <div class="desc">Immediate session halt. Drivers: slow safely, no overtaking, follow steward instructions.</div>
            </button>

            <button class="cmd yellow span6" id="btnVscSlow" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">VIRTUAL SAFETY CAR</div>
                <div class="tag">REDUCED SPEED</div>
              </div>
              <div class="desc">Remain in formation. Continue at reduced speed. Maintain gaps and follow delta rules.</div>
            </button>

            <button class="cmd yellow span6" id="btnVscPit" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">VSC — ENTER PITS</div>
                <div class="tag">PIT NOW</div>
              </div>
              <div class="desc">Enter pits now. Keep formation at pit exit line. No overtakes unless instructed.</div>
            </button>

            <button class="cmd green span6" id="btnGreen" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">GREEN FLAG</div>
                <div class="tag">RACING RESUMES</div>
              </div>
              <div class="desc">Session continues. Standard rules apply. Drivers: be alert on restart.</div>
            </button>

            <button class="cmd green span6" id="btnReset" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">SERVER RESET</div>
                <div class="tag">PRACTICE LIVE</div>
              </div>
              <div class="desc">Resets to Practice (15 min). Use for recovery only when approved by Race Director.</div>
            </button>

            <button class="cmd blue span6" id="btnCheckIn" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">RACE CHECK-IN</div>
                <div class="tag">DRIVER SCREEN</div>
              </div>
              <div class="desc">Shows driver check-in screen. Use before grid / session start to confirm attendance.</div>
            </button>

            <button class="cmd green span12" id="btnGreenConsole" type="button">
              <span class="stripe" aria-hidden="true"></span>
              <div class="hdr">
                <div class="name">GREEN FLAG — CONSOLE ONLY</div>
                <div class="tag">
                  <span style="display:inline-flex;align-items:center;gap:8px;">
                    <span class="dot" aria-hidden="true" style="animation:pulse 1.25s infinite;"></span>
                    SYSTEM LIVE
                  </span>
                </div>
              </div>
              <div class="desc">Console sessions: adhere to in-game rules &amp; flags. Use this command for console green state.</div>
            </button>
          </div>

          <div class="minirow">
            <span class="pill" id="endpointPill">Endpoint: —</span>
            <span class="pill" id="livePill">Live feed: —</span>
            <span class="pill" id="pollPill">Polling: —</span>
            <span class="pill" id="statePill">Current: —</span>
            <span class="pill" id="authPill">Auth: —</span>
            <span class="pill" id="checkinPill">Check-ins: —</span>
          </div>

          <!-- SPLIT SYSTEM INSIDE FLAG & SERVER CONTROL -->
          <div class="panel" style="margin-top:14px; background: rgba(255,255,255,.72);">
            <div class="panelHeader">
              <div class="panelTitle">Quali Split Scheduler <span class="chip">1–3 splits</span></div>
              <div class="panelBtns">
                <button class="btn" id="btnStartQuali" type="button">Start Quali Splits</button>
                <button class="btn danger" id="btnStopQuali" type="button">Stop Quali Splits</button>
              </div>
            </div>

            <div class="panelBody">
              <div class="grid">
                <div class="rowLine">
                  <input type="checkbox" id="enBeginner" checked />
                  <label for="enBeginner">BEGINNER</label>
                  <div>
                    <div class="muted">Duration (minutes)</div>
                    <input id="minBeginner" type="number" min="1" max="60" step="1" value="4" />
                  </div>
                  <div>
                    <div class="muted">Order</div>
                    <select id="ordBeginner">
                      <option value="1" selected>1st</option>
                      <option value="2">2nd</option>
                      <option value="3">3rd</option>
                    </select>
                  </div>
                </div>

                <div class="rowLine">
                  <input type="checkbox" id="enAms" checked />
                  <label for="enAms">AMS</label>
                  <div>
                    <div class="muted">Duration (minutes)</div>
                    <input id="minAms" type="number" min="1" max="60" step="1" value="2" />
                  </div>
                  <div>
                    <div class="muted">Order</div>
                    <select id="ordAms">
                      <option value="0">—</option>
                      <option value="1">1st</option>
                      <option value="2" selected>2nd</option>
                      <option value="3">3rd</option>
                    </select>
                  </div>
                </div>

                <div class="rowLine">
                  <input type="checkbox" id="enPros" checked />
                  <label for="enPros">PROS</label>
                  <div>
                    <div class="muted">Duration (minutes)</div>
                    <input id="minPros" type="number" min="1" max="60" step="1" value="1" />
                  </div>
                  <div>
                    <div class="muted">Order</div>
                    <select id="ordPros">
                      <option value="0">—</option>
                      <option value="1">1st</option>
                      <option value="2">2nd</option>
                      <option value="3" selected>3rd</option>
                    </select>
                  </div>
                </div>
              </div>

              <div class="warnBox" id="qualiHint">
                Rule: tick the splits you need, set minutes, and choose unique orders starting at 1 (e.g. 1–2 or 1–2–3).
                If you only want 1 split, set just one split to order 1 and disable the rest.
              </div>
            </div>
          </div>

          <div class="hint">Tip: keep this page private — it can trigger live race control.</div>
        </div>
      </div>

      <!-- CHECK-INS PANEL (still present) -->
      <div class="panel">
        <div class="panelHeader">
          <div class="panelTitle">Race Check-ins <span class="chip">Live</span></div>
          <div class="panelBtns">
            <button class="btn" id="btnRefreshCheckins" type="button">Refresh</button>
            <button class="btn danger" id="btnClearCheckins" type="button">Clear All</button>
          </div>
        </div>
        <div class="panelBody">
          <ul class="list" id="checkinList">
            <li class="item"><span class="itemName">—</span><span class="itemTime">No check-ins yet</span></li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WORKER_BASE = "https://ifwl-flag.benjamin-leahy1.workers.dev";
    const TOKEN_KEY = "ifwl_racecontrol_token_v1";
    const POLL_MS = 1000;
    const CHECKIN_REFRESH_MS = 4000;

    const statusEl = document.getElementById("status");
    const endpointPill = document.getElementById("endpointPill");
    const livePill = document.getElementById("livePill");
    const pollPill = document.getElementById("pollPill");
    const statePill = document.getElementById("statePill");
    const authPill = document.getElementById("authPill");
    const checkinPill = document.getElementById("checkinPill");

    const tokenInput = document.getElementById("tokenInput");
    const btnSaveToken = document.getElementById("btnSaveToken");
    const btnClearToken = document.getElementById("btnClearToken");

    const btnCheckIn = document.getElementById("btnCheckIn");

    const checkinListEl = document.getElementById("checkinList");
    const btnRefreshCheckins = document.getElementById("btnRefreshCheckins");
    const btnClearCheckins = document.getElementById("btnClearCheckins");

    const btnGreenConsole = document.getElementById("btnGreenConsole");

    // Broadcast
    const broadcastText = document.getElementById("broadcastText");
    const btnSendBroadcast = document.getElementById("btnSendBroadcast");

    // Quali scheduler controls
    const btnStartQuali = document.getElementById("btnStartQuali");
    const btnStopQuali = document.getElementById("btnStopQuali");

    const enBeginner = document.getElementById("enBeginner");
    const enAms = document.getElementById("enAms");
    const enPros = document.getElementById("enPros");

    const minBeginner = document.getElementById("minBeginner");
    const minAms = document.getElementById("minAms");
    const minPros = document.getElementById("minPros");

    const ordBeginner = document.getElementById("ordBeginner");
    const ordAms = document.getElementById("ordAms");
    const ordPros = document.getElementById("ordPros");

    const buttons = [
      document.getElementById("btnRed"),
      document.getElementById("btnVscSlow"),
      document.getElementById("btnVscPit"),
      document.getElementById("btnGreen"),
      document.getElementById("btnReset"),
      document.getElementById("btnCheckIn"),
      btnGreenConsole,
      btnSendBroadcast,
      btnStartQuali,
      btnStopQuali
    ];

    endpointPill.textContent = `Endpoint: ${WORKER_BASE}`;

    function fmt(ts){
      try { return new Date(ts).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit", second:"2-digit"}); }
      catch { return "—"; }
    }

    function setBusy(isBusy){
      for(const b of buttons) b.disabled = isBusy;
      btnRefreshCheckins.disabled = isBusy;
      btnClearCheckins.disabled = isBusy;
    }

    // --- UI helpers for header live badge ---
    const liveDot = document.getElementById("liveDot");
    const opsBadge = document.getElementById("opsBadge");

    function setLive(ok, detail=""){
      livePill.innerHTML = ok
        ? `Live feed: <span class="ok">CONNECTED</span>`
        : `Live feed: <span class="bad">OFFLINE</span>${detail ? " — " + detail : ""}`;

      if(liveDot && opsBadge){
        if(ok){
          liveDot.classList.remove("off");
          opsBadge.textContent = "ONLINE";
          opsBadge.style.borderColor = "rgba(22,163,74,.35)";
        }else{
          liveDot.classList.add("off");
          opsBadge.textContent = "OFFLINE";
          opsBadge.style.borderColor = "rgba(220,38,38,.30)";
        }
      }
    }

    function setPolling(on){
      pollPill.innerHTML = on
        ? `Polling: <span class="warn">ON</span>`
        : `Polling: <span class="ok">OFF</span>`;
    }

    function modeFrom(data){
      const state = String(data?.state || "green").toLowerCase();
      const lastCommand = String(data?.lastCommand || "").toLowerCase();
      return lastCommand || state || "green";
    }

    function updateCurrentPill(data){
      const m = modeFrom(data);
      const when = data?.updatedAt ? fmt(data.updatedAt) : "—";
      statePill.textContent = `Current: ${m} @ ${when}`;
    }

    function getToken(){
      return (localStorage.getItem(TOKEN_KEY) || "").trim();
    }

    function setToken(t){
      const v = (t || "").trim();
      if(v) localStorage.setItem(TOKEN_KEY, v);
      else localStorage.removeItem(TOKEN_KEY);
      updateAuthUI();
    }

    function updateAuthUI(){
      const has = !!getToken();
      authPill.innerHTML = has
        ? `Auth: <span class="ok">SET</span>`
        : `Auth: <span class="bad">MISSING</span>`;
    }

    async function getState(){
      const res = await fetch(`${WORKER_BASE}/state?t=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function postAuthed(path, payload){
      const token = getToken();
      if(!token){
        statusEl.textContent =
          "ERROR — Missing token.\n\n" +
          "Enter the steward token at the top and click 'Save token'.";
        throw new Error("missing_token");
      }

      const res = await fetch(`${WORKER_BASE}${path}`,{
        method:"POST",
        mode:"cors",
        cache:"no-store",
        headers:{
          "Content-Type":"application/json",
          "x-auth": token
        },
        body: JSON.stringify(payload || {})
      });

      const text = await res.text();
      let data = {};
      try { data = text ? JSON.parse(text) : {}; } catch { data = { raw: text }; }

      if(!res.ok){
        throw new Error(data?.detail || data?.error || `HTTP ${res.status} — ${text || "no body"}`);
      }
      return data;
    }

    async function setState(state){
      setBusy(true);
      statusEl.textContent = `Sending "${state}"…`;
      let postOk = false;

      try{
        const data = await postAuthed("/set", { state });
        postOk = true;
        const shown = modeFrom(data);
        statusEl.textContent = `OK — "${shown}" @ ${fmt(data.updatedAt)}`;
        updateCurrentPill(data);
      }catch(err){
        statusEl.textContent =
          `WARN — POST may have sent, but browser couldn't read the response.\n` +
          `Reason: ${err.message}\n` +
          `Verifying via /state…`;
      }

      try{
        await new Promise(r => setTimeout(r, 150));
        const fresh = await getState();
        updateCurrentPill(fresh);

        if(!postOk){
          statusEl.textContent =
            `Verified via /state — now "${modeFrom(fresh)}" @ ${fmt(fresh.updatedAt)}\n` +
            `(If Discord posted, command definitely executed.)`;
        }
      }catch(e){
        statusEl.textContent += `\nERROR — Could not verify /state: ${e.message}`;
      }finally{
        setBusy(false);
      }
    }

    // Broadcast
    function normMsg(v){ return String(v || "").replace(/\s+/g, " ").trim(); }

    async function sendBroadcast(){
      const msg = normMsg(broadcastText.value);
      if(!msg){
        statusEl.textContent = "ERROR — Type a message first.";
        broadcastText.focus();
        return;
      }

      setBusy(true);
      statusEl.textContent = "Sending message to all drivers (20s)…";

      try{
        await postAuthed("/broadcast", { message: msg });
        broadcastText.value = "";
        statusEl.textContent = `OK — Message sent @ ${fmt(Date.now())}`;
      }catch(e){
        statusEl.textContent = `ERROR — Could not send message: ${e.message}`;
      }finally{
        setBusy(false);
      }
    }

    // Quali scheduler
    function getIntMinutes(inp){
      const n = Number(inp.value);
      if(!Number.isFinite(n)) return null;
      const i = Math.round(n);
      if(i < 1 || i > 60) return null;
      return i;
    }

    function buildQualiSteps(){
      const candidates = [
        {
          key:"beginner",
          label:"BEGINNER",
          enabled: !!enBeginner.checked,
          minutes: getIntMinutes(minBeginner),
          order: Number(ordBeginner.value || 0),
          style: { bg:"#b30000", fg:"#ffffff", dot:"red" }
        },
        {
          key:"ams",
          label:"AMS",
          enabled: !!enAms.checked,
          minutes: getIntMinutes(minAms),
          order: Number(ordAms.value || 0),
          style: { bg:"#9ca3af", fg:"#ffffff", dot:"silver" }
        },
        {
          key:"pros",
          label:"PROS",
          enabled: !!enPros.checked,
          minutes: getIntMinutes(minPros),
          order: Number(ordPros.value || 0),
          style: { bg:"#ffffff", fg:"#111827", dot:"black" }
        }
      ];

      const enabled = candidates.filter(x => x.enabled);

      if(enabled.length === 0){
        return { error: "Select at least 1 split." };
      }

      for(const s of enabled){
        if(!s.minutes){
          return { error: `${s.label}: minutes must be 1–60.` };
        }
        if(!s.order || s.order < 1 || s.order > 3){
          return { error: `${s.label}: set an order (1st/2nd/3rd).` };
        }
      }

      // Orders must be unique and sequential from 1..N
      const orders = enabled.map(x => x.order);
      const uniq = new Set(orders);
      if(uniq.size !== orders.length){
        return { error: "Orders must be unique (no duplicates)." };
      }

      const sortedOrders = [...orders].sort((a,b)=>a-b);
      const N = enabled.length;
      for(let i=0;i<N;i++){
        if(sortedOrders[i] !== (i+1)){
          return { error: `Orders must start at 1 and run sequentially (1..${N}).` };
        }
      }

      const steps = enabled
        .sort((a,b)=>a.order-b.order)
        .map(s => ({
          key: s.key,
          label: s.label,
          minutes: s.minutes,
          bg: s.style.bg,
          fg: s.style.fg,
          dot: s.style.dot
        }));

      return { steps };
    }

    async function startQuali(){
      const built = buildQualiSteps();
      if(built.error){
        statusEl.textContent = `ERROR — ${built.error}`;
        return;
      }

      setBusy(true);
      statusEl.textContent = "Starting quali split schedule…";

      try{
        const data = await postAuthed("/quali_schedule", { steps: built.steps });
        statusEl.textContent = `OK — Quali schedule started @ ${fmt(data?.qualiSchedule?.startAt || Date.now())}`;
      }catch(e){
        statusEl.textContent = `ERROR — Could not start quali schedule: ${e.message}`;
      }finally{
        setBusy(false);
      }
    }

    async function stopQuali(){
      setBusy(true);
      statusEl.textContent = "Stopping quali split schedule…";
      try{
        await postAuthed("/quali_schedule/stop", { ok:true });
        statusEl.textContent = `OK — Quali schedule stopped @ ${fmt(Date.now())}`;
      }catch(e){
        statusEl.textContent = `ERROR — Could not stop quali schedule: ${e.message}`;
      }finally{
        setBusy(false);
      }
    }

    // Check-ins
    function normName(v){ return String(v || "").trim().replace(/\s+/g, " "); }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function renderCheckins(items){
      const list = Array.isArray(items) ? items : [];
      checkinPill.textContent = `Check-ins: ${list.length} @ ${fmt(Date.now())}`;

      if(list.length === 0){
        checkinListEl.innerHTML = `<li class="item"><span class="itemName">—</span><span class="itemTime">No check-ins yet</span></li>`;
        return;
      }

      const sorted = [...list].sort((a,b) => (b?.ts||0) - (a?.ts||0));
      checkinListEl.innerHTML = sorted.map(x => {
        const name = normName(x?.name) || "Unknown";
        const t = x?.ts ? fmt(x.ts) : "—";
        return `<li class="item"><span class="itemName">${escapeHtml(name)}</span><span class="itemTime">${t}</span></li>`;
      }).join("");
    }

    async function fetchCheckins(){
      const res = await fetch(`${WORKER_BASE}/checkins?t=${Date.now()}`, { cache:"no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }

    async function refreshCheckins(showStatus=false){
      try{
        const data = await fetchCheckins();
        renderCheckins(data?.items || []);
        if(showStatus) statusEl.textContent = `OK — Check-ins refreshed @ ${fmt(Date.now())}`;
      }catch(e){
        if(showStatus) statusEl.textContent = `ERROR — Could not load check-ins: ${e.message}`;
      }
    }

    async function clearAllCheckins(){
      if(!confirm("Clear ALL check-ins?")) return;

      setBusy(true);
      statusEl.textContent = "Clearing all check-ins…";

      try{
        await postAuthed("/checkins/clear", { ok:true });
        statusEl.textContent = `OK — Cleared check-ins @ ${fmt(Date.now())}`;
        await refreshCheckins(false);
      }catch(e){
        statusEl.textContent = `ERROR — Could not clear check-ins: ${e.message}`;
      }finally{
        setBusy(false);
      }
    }

    function burstRefreshCheckins(){
      refreshCheckins(false);
      setTimeout(() => refreshCheckins(false), 1000);
      setTimeout(() => refreshCheckins(false), 2000);
      setTimeout(() => refreshCheckins(false), 3000);
    }

    // Buttons
    document.getElementById("btnRed").addEventListener("click", ()=>setState("red"));
    document.getElementById("btnVscSlow").addEventListener("click", ()=>setState("vsc_slow"));
    document.getElementById("btnVscPit").addEventListener("click", ()=>setState("vsc_pit"));
    document.getElementById("btnGreen").addEventListener("click", ()=>setState("green"));
    document.getElementById("btnReset").addEventListener("click", ()=>setState("server_reset"));

    btnGreenConsole.addEventListener("click", ()=>setState("green_console"));

    btnCheckIn.addEventListener("click", async () => {
      await setState("race_checkin");
      burstRefreshCheckins();
    });

    btnSendBroadcast.addEventListener("click", sendBroadcast);
    broadcastText.addEventListener("keydown", (e) => {
      if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        e.preventDefault();
        sendBroadcast();
      }
    });

    btnStartQuali.addEventListener("click", startQuali);
    btnStopQuali.addEventListener("click", stopQuali);

    btnRefreshCheckins.addEventListener("click", () => refreshCheckins(true));
    btnClearCheckins.addEventListener("click", clearAllCheckins);

    // Token UI
    btnSaveToken.addEventListener("click", () => {
      setToken(tokenInput.value);
      tokenInput.value = "";
      statusEl.textContent = "Token saved on this device.";
    });
    btnClearToken.addEventListener("click", () => {
      setToken("");
      tokenInput.value = "";
      statusEl.textContent = "Token cleared on this device.";
    });
    tokenInput.addEventListener("keydown", (e) => {
      if(e.key === "Enter"){
        setToken(tokenInput.value);
        tokenInput.value = "";
        statusEl.textContent = "Token saved on this device.";
      }
    });

    // --- Live feed: SSE first, fallback polling if SSE fails ---
    let pollTimer = null;

    function startPolling(){
      if(pollTimer) return;
      setPolling(true);

      const tick = async () => {
        try{
          const data = await getState();
          updateCurrentPill(data);
        }catch{}
      };

      tick();
      pollTimer = setInterval(tick, POLL_MS);
    }

    function stopPolling(){
      if(pollTimer){
        clearInterval(pollTimer);
        pollTimer = null;
      }
      setPolling(false);
    }

    function startSSE(){
      try{
        const es = new EventSource(`${WORKER_BASE}/events?t=${Date.now()}`);

        es.onopen = () => {
          setLive(true);
          stopPolling();
        };

        es.onmessage = (ev) => {
          try{
            const data = JSON.parse(ev.data);
            updateCurrentPill(data);
          }catch{}
        };

        es.onerror = () => {
          setLive(false, "fallback to polling");
          try { es.close(); } catch {}
          startPolling();
          setTimeout(startSSE, 2000);
        };
      }catch{
        setLive(false, "fallback to polling");
        startPolling();
      }
    }

    // Check-in auto-refresh loop
    let checkinTimer = null;
    function startCheckinAutoRefresh(){
      if(checkinTimer) return;
      const tick = () => refreshCheckins(false);
      tick();
      checkinTimer = setInterval(tick, CHECKIN_REFRESH_MS);
    }

    // Init
    (async () => {
      updateAuthUI();
      setLive(false);
      setPolling(false);

      try{
        const data = await getState();
        updateCurrentPill(data);
      }catch{
        statePill.textContent = "Current: —";
      }

      startSSE();
      startCheckinAutoRefresh();
      await refreshCheckins(false);
    })();
  </script>
</body>
</html>
