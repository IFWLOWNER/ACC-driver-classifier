<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFWL Stream Racer</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121a24; --text:#e7eef8; --muted:#9fb2c9; --accent:#4dd4ff; --danger:#ff5b6b; }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; }
    .wrap { display:grid; gap:12px; max-width:1100px; margin:0 auto; padding:12px; }
    header { display:flex; gap:12px; align-items:center; justify-content:space-between; background:var(--panel); border-radius:14px; padding:10px 12px; border:1px solid #1b2a3b; }
    header .left { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .pill { font-size:12px; padding:6px 10px; border-radius:999px; background:#0e1620; color:var(--muted); border:1px solid #1b2a3b; }
    .pill strong { color:var(--text); }
    .grid { display:grid; grid-template-columns: 1fr 340px; gap:12px; }
    @media (max-width: 980px){ .grid{ grid-template-columns:1fr; } }
    .card { background:var(--panel); border-radius:14px; padding:12px; border:1px solid #1b2a3b; }
    canvas { width:100%; height:auto; display:block; background:#070a0f; border-radius:14px; border:1px solid #1b2a3b; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    input,button { border-radius:12px; border:1px solid #1b2a3b; background:#0e1620; color:var(--text); padding:10px 12px; font-size:14px; }
    input { flex:1; min-width:180px; outline:none; }
    button { cursor:pointer; }
    button.primary { background:linear-gradient(180deg,#1a7ea0,#0f5f7b); border-color:#2aa6ce; }
    button.danger { background:linear-gradient(180deg,#a01a2a,#7b0f1c); border-color:#ff5b6b55; }
    button:disabled { opacity:.55; cursor:not-allowed; }
    .hint { color:var(--muted); font-size:12px; line-height:1.35; }
    .big { font-size:18px; font-weight:700; }
    .leaderboard { display:grid; gap:8px; }
    .lb-item { display:flex; justify-content:space-between; gap:10px; padding:10px; border-radius:12px; background:#0e1620; border:1px solid #1b2a3b; }
    .lb-item.out { opacity:.65; }
    .controls { display:none; gap:10px; margin-top:10px; }
    .controls button { flex:1; padding:14px 12px; font-size:16px; }
    .hr { height:1px; background:#1b2a3b; margin:10px 0; }
    .small { font-size:12px; color:var(--muted); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <div class="pill"><strong>IFWL Stream Racer</strong></div>
      <div class="pill">Phase: <strong id="phaseText">‚Äî</strong></div>
      <div class="pill">Time: <strong id="timeText">‚Äî</strong></div>
    </div>
    <div class="pill" id="modePill">Mode: <strong>‚Äî</strong></div>
  </header>

  <div class="grid">
    <div class="card">
      <canvas id="game" width="960" height="540"></canvas>
      <div class="controls" id="touchControls">
        <button id="btnLeft">‚¨ÖÔ∏è Left</button>
        <button id="btnRight">Right ‚û°Ô∏è</button>
      </div>
      <div class="hint" style="margin-top:10px">
        <span style="color:#93ffd2">Player:</span> Enter your name ‚Üí join a car (max 7). Steer on mobile with buttons.<br/>
        <span style="color:#ffd38a">Host:</span> Open <span class="mono">?host=1</span> on your stream PC to start races.
      </div>
    </div>

    <div class="card">
      <div class="big" id="sideTitle">Join</div>
      <div class="hint" id="sideHint" style="margin-top:6px">
        Type your name and press Enter. First come first served.
      </div>

      <div class="hr"></div>

      <div class="row">
        <input id="nameInput" placeholder="Your name‚Ä¶" maxlength="18" />
        <button class="primary" id="joinBtn">Join</button>
        <button class="danger" id="leaveBtn" disabled>Leave</button>
      </div>

      <div class="hint" style="margin-top:10px" id="statusLine">Status: ‚Äî</div>

      <div class="hr"></div>

      <div class="big" style="font-size:16px">Cars</div>
      <div class="leaderboard" id="carsList" style="margin-top:8px"></div>

      <div class="hr"></div>

      <div class="big" style="font-size:16px">Leaderboard</div>
      <div class="hint" style="margin:6px 0 8px">Shown automatically for 30s after each 60s race.</div>
      <div class="leaderboard" id="lbList"></div>

      <div class="hr"></div>
      <div class="small">Tip: if ‚ÄúPhase: undefined‚Äù, it means no host is running. Open the same page with <span class="mono">?host=1</span>.</div>
    </div>
  </div>
</div>

<!-- Firebase RTDB compat -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

<script>
(() => {
  // ----------------------------
  // CONFIG
  // ----------------------------
  const MAX_CARS = 7;
  const RACE_SECONDS = 60;
  const LEADERBOARD_SECONDS = 30;
  const ROOM = "main";

  // üî• PASTE YOUR firebaseConfig HERE (your existing one)
  const firebaseConfig = {
    apiKey: "AIzaSyDDV3oaa0PCRSbVP3-jplsFUHiLm6Zil1M",
    authDomain: "ifwl-stream-game.firebaseapp.com",
    databaseURL: "https://ifwl-stream-game-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ifwl-stream-game",
    storageBucket: "ifwl-stream-game.firebasestorage.app",
    messagingSenderId: "132989681275",
    appId: "1:132989681275:web:307b06df334c1d0685ecde",
    measurementId: "G-EV4Z45T295"
  };

  // ----------------------------
  // DOM
  // ----------------------------
  const qs = new URLSearchParams(location.search);
  const isHost = qs.get("host") === "1";

  const canvas = document.getElementById("game");
  const ctx = canvas.getContext("2d");
  const phaseText = document.getElementById("phaseText");
  const timeText = document.getElementById("timeText");
  const modePill = document.getElementById("modePill");

  const nameInput = document.getElementById("nameInput");
  const joinBtn = document.getElementById("joinBtn");
  const leaveBtn = document.getElementById("leaveBtn");
  const statusLine = document.getElementById("statusLine");
  const carsList = document.getElementById("carsList");
  const lbList = document.getElementById("lbList");
  const touchControls = document.getElementById("touchControls");
  const btnLeft = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const sideTitle = document.getElementById("sideTitle");
  const sideHint = document.getElementById("sideHint");

  modePill.innerHTML = `Mode: <strong>${isHost ? "HOST" : "PLAYER"}</strong>`;

  function setStatus(msg){ statusLine.textContent = "Status: " + msg; }

  // ----------------------------
  // FIREBASE INIT
  // ----------------------------
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  function roomRef(path=""){
    const base = db.ref(`rooms/${ROOM}`);
    return path ? base.child(path) : base;
  }
  async function fbGet(path){
    const snap = await roomRef(path).get();
    return snap.val();
  }
  async function fbSet(path, value){
    await roomRef(path).set(value);
  }
  async function fbOn(path, cb){
    roomRef(path).on("value", s => cb(s.val()));
  }

  // ----------------------------
  // GAME STATE
  // ----------------------------
  const playerId = (crypto?.randomUUID?.() || (Date.now()+"-"+Math.random())).slice(0,24);
  let mySlot = null;

  const carColors = ["#ff4d6d","#4dd4ff","#93ffd2","#ffd38a","#b39cff","#a7ff4d","#ff9bf5"];

  function makeDefaultRoom(){
    const cars = {};
    for (let i=0;i<MAX_CARS;i++){
      cars[i] = { name:"", alive:false, score:0, input:0, eliminatedAt:null };
    }
    return {
      phase:"lobby",
      phaseEndsAt: Date.now() + 5000,
      cars,
      obstacles: [],
      // track params
      t: 0,
      lastTick: Date.now(),
      scroll: 0,
      seed: Math.floor(Math.random()*1e9),
      hostPing: Date.now()
    };
  }

  function resetForRace(room){
    room.phase = "race";
    room.phaseEndsAt = Date.now() + RACE_SECONDS*1000;
    room.obstacles = [];
    room.t = 0;
    room.scroll = 0;
    room.lastTick = Date.now();

    for (let i=0;i<MAX_CARS;i++){
      const c = room.cars[i];
      if (c.name && c.name.trim()){
        c.alive = true;
        c.score = 0;
        c.input = 0;
        c.eliminatedAt = null;
      } else {
        c.alive = false;
        c.score = 0;
        c.input = 0;
        c.eliminatedAt = null;
      }
    }
  }

  function resetForLeaderboard(room){
    room.phase = "leaderboard";
    room.phaseEndsAt = Date.now() + LEADERBOARD_SECONDS*1000;
  }

  function resetForLobby(room){
    room.phase = "lobby";
    room.phaseEndsAt = Date.now() + 4000;
    for (let i=0;i<MAX_CARS;i++){
      const c = room.cars[i];
      c.alive = false;
      c.score = 0;
      c.input = 0;
      c.eliminatedAt = null;
    }
    room.obstacles = [];
    room.t = 0;
    room.scroll = 0;
    room.lastTick = Date.now();
  }

  // ----------------------------
  // TRACK + PHYSICS (scrolling top-down)
  // ----------------------------
  // Track is defined by centerline x as a function of worldY.
  // We render the segment from scroll..scroll+screenHeight.
  function centerX(worldY, t){
    // mix a few sine waves so it looks like a race track
    return 480
      + Math.sin((worldY*0.0022) + t*0.9) * 160
      + Math.sin((worldY*0.0011) + t*0.4) * 80;
  }

  const ROAD_HALF = 190;      // half width of asphalt
  const KERB = 18;            // kerb thickness
  const CAR_W = 28;
  const CAR_H = 46;
  const CAR_Y = 420;          // on-screen y for cars (fixed)
  const SCROLL_SPEED = 270;   // track movement speed (px/sec)

  function hostTick(room){
    const now = Date.now();
    const dt = Math.min(0.05, (now - room.lastTick)/1000);
    room.lastTick = now;

    room.t += dt;
    room.scroll += SCROLL_SPEED * dt;

    // spawn obstacles ahead (world space)
    // choose a worldY ahead of view, and a lateral offset from center
    if (Math.random() < 0.11){
      const spawnY = room.scroll - 120; // slightly above top
      const cx = centerX(spawnY, room.t);
      const offset = (Math.random()*2 - 1) * (ROAD_HALF - 40);
      room.obstacles.push({
        wy: spawnY,
        wx: cx + offset,
        r: 16 + Math.random()*10,
        kind: Math.random() < 0.6 ? "block" : "cone"
      });
    }

    // cull obstacles behind
    room.obstacles = room.obstacles.filter(o => o.wy < room.scroll + 900);

    // update cars
    for (let i=0;i<MAX_CARS;i++){
      const c = room.cars[i];
      if (!c.name || !c.alive) continue;

      c.score += dt;

      // each car gets a starting lane offset
      const laneOffset = (i - (MAX_CARS-1)/2) * 34; // spread a bit
      // steering input shifts car left/right
      const steer = (c.input || 0) * 140; // px

      // Car's world position:
      // worldY at the car‚Äôs on-screen Y
      const carWY = room.scroll + CAR_Y;
      const cx = centerX(carWY, room.t);

      const carX = cx + laneOffset + steer;
      const carY = CAR_Y;

      // off track = OUT
      const dxFromCenter = Math.abs(carX - cx);
      if (dxFromCenter > (ROAD_HALF - 14)){
        c.alive = false;
        c.eliminatedAt = now;
        continue;
      }

      // collision vs obstacles (convert obstacle world to screen)
      for (const ob of room.obstacles){
        const sy = ob.wy - room.scroll; // screen y
        const sx = ob.wx;               // already in screen space x (because centerX uses screen coords)
        // Only check near the car
        if (sy < carY - 70 || sy > carY + 70) continue;

        const dx = Math.abs(carX - sx);
        const dy = Math.abs(carY - sy);
        if (dx < (CAR_W/2 + ob.r*0.7) && dy < (CAR_H/2 + ob.r*0.7)){
          c.alive = false;
          c.eliminatedAt = now;
          break;
        }
      }
    }
  }

  function computeLeaderboard(room){
    const entries = [];
    for (let i=0;i<MAX_CARS;i++){
      const c = room.cars[i];
      if (!c.name) continue;
      entries.push({ slot:i, name:c.name, score:c.score, alive:c.alive });
    }
    entries.sort((a,b) => b.score - a.score);
    return entries;
  }

  // ----------------------------
  // RENDER
  // ----------------------------
  function draw(room){
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // background grass
    ctx.fillStyle = "#06110b";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    // draw track as many horizontal strips (cheap + effective)
    const t = room.t || 0;
    const scroll = room.scroll || 0;

    // road shading stripes
    for (let y=0; y<canvas.height; y+=6){
      const wy = scroll + y;
      const cx = centerX(wy, t);
      const left = cx - ROAD_HALF;
      const right = cx + ROAD_HALF;

      // asphalt
      ctx.fillStyle = (Math.floor((wy/60)) % 2 === 0) ? "#0b141f" : "#0a121b";
      ctx.fillRect(left, y, right-left, 6);

      // kerbs
      ctx.fillStyle = (Math.floor((wy/24)) % 2 === 0) ? "#c92b2b" : "#e7eef8";
      ctx.fillRect(left - KERB, y, KERB, 6);
      ctx.fillRect(right, y, KERB, 6);

      // edge dark line
      ctx.fillStyle = "#22364a";
      ctx.fillRect(left-1, y, 1, 6);
      ctx.fillRect(right, y, 1, 6);
    }

    // obstacles
    if (room.obstacles && room.obstacles.length){
      for (const ob of room.obstacles){
        const sy = ob.wy - scroll;
        if (sy < -60 || sy > canvas.height+60) continue;

        if (ob.kind === "cone"){
          // triangle cone
          ctx.fillStyle = "#ff9b4d";
          ctx.beginPath();
          ctx.moveTo(ob.wx, sy - ob.r);
          ctx.lineTo(ob.wx - ob.r*0.8, sy + ob.r);
          ctx.lineTo(ob.wx + ob.r*0.8, sy + ob.r);
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle = "#2b1b0e";
          ctx.lineWidth = 2;
          ctx.stroke();
        } else {
          // block
          ctx.fillStyle = "#2a3c52";
          ctx.fillRect(ob.wx - ob.r, sy - ob.r, ob.r*2, ob.r*2);
          ctx.strokeStyle = "#476587";
          ctx.lineWidth = 2;
          ctx.strokeRect(ob.wx - ob.r, sy - ob.r, ob.r*2, ob.r*2);
        }
      }
    }

    // cars
    for (let i=0;i<MAX_CARS;i++){
      const c = room.cars?.[i];
      const hasName = c?.name && c.name.trim();
      if (!hasName) continue;

      const laneOffset = (i - (MAX_CARS-1)/2) * 34;
      const steer = (c.input || 0) * 140;

      const carWY = scroll + CAR_Y;
      const cx = centerX(carWY, t);
      const x = cx + laneOffset + steer;
      const y = CAR_Y;

      const alive = !!c.alive;

      // car body
      ctx.save();
      ctx.globalAlpha = alive ? 1 : 0.3;

      // shadow
      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fillRect(x - CAR_W/2 + 2, y - CAR_H/2 + 6, CAR_W, CAR_H);

      // body
      ctx.fillStyle = carColors[i];
      ctx.fillRect(x - CAR_W/2, y - CAR_H/2, CAR_W, CAR_H);

      // cockpit
      ctx.fillStyle = "#071019";
      ctx.fillRect(x - CAR_W/2 + 5, y - CAR_H/2 + 10, CAR_W-10, 16);

      // front wing
      ctx.fillStyle = "#0e1620";
      ctx.fillRect(x - CAR_W/2 - 6, y - CAR_H/2 - 6, CAR_W + 12, 8);

      // rear wing
      ctx.fillRect(x - CAR_W/2 - 6, y + CAR_H/2 - 2, CAR_W + 12, 8);

      // number
      ctx.fillStyle = "#e7eef8";
      ctx.font = "700 12px system-ui";
      ctx.textAlign = "center";
      ctx.fillText(String(i+1), x, y+4);

      // name
      ctx.font = "12px system-ui";
      ctx.fillText(c.name, x, y - CAR_H/2 - 10);

      ctx.restore();

      if (!alive && room.phase === "race"){
        ctx.fillStyle = "#ff5b6b";
        ctx.font = "700 14px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("OUT", x, y + CAR_H/2 + 18);
      }
    }

    // HUD top strip
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(0,0,canvas.width,30);
    ctx.fillStyle = "#e7eef8";
    ctx.font = "14px system-ui";
    ctx.textAlign = "left";
    ctx.fillText(`Phase: ${room.phase || "‚Äî"}`, 10, 20);
  }

  function renderSide(room){
    carsList.innerHTML = "";
    for (let i=0;i<MAX_CARS;i++){
      const c = room.cars[i];
      const taken = c.name && c.name.trim();
      const el = document.createElement("div");
      el.className = "lb-item" + (taken && room.phase==="race" && !c.alive ? " out" : "");
      el.innerHTML = `
        <div><strong>#${i+1}</strong> ${taken ? "‚Äî "+escapeHtml(c.name) : "<span class='small'>(empty)</span>"}</div>
        <div class="mono">${taken ? (room.phase==="race" ? (c.alive ? "IN" : "OUT") : "") : ""}</div>
      `;
      carsList.appendChild(el);
    }

    lbList.innerHTML = "";
    const entries = computeLeaderboard(room);
    entries.forEach((e, idx) => {
      const el = document.createElement("div");
      el.className = "lb-item";
      el.innerHTML = `
        <div><strong>${idx+1}.</strong> ${escapeHtml(e.name)} <span class="small">(Car #${e.slot+1})</span></div>
        <div class="mono">${e.score.toFixed(2)}</div>
      `;
      lbList.appendChild(el);
    });

    phaseText.textContent = room.phase || "‚Äî";
    const msLeft = Math.max(0, (room.phaseEndsAt || Date.now()) - Date.now());
    timeText.textContent = (msLeft/1000).toFixed(1) + "s";

    if (isHost){
      sideTitle.textContent = "Host Panel";
      sideHint.innerHTML = `You are the host. Keep this open on stream PC.<br/>Share: <span class="mono">${location.origin + location.pathname}</span>`;
      nameInput.disabled = true;
      joinBtn.disabled = true;
      leaveBtn.disabled = true;
      touchControls.style.display = "none";
    } else {
      sideTitle.textContent = "Join";
      sideHint.textContent = "Type your name and press Enter. First come first served.";
      nameInput.disabled = false;
      joinBtn.disabled = false;
      touchControls.style.display = mySlot !== null ? "flex" : "none";
      leaveBtn.disabled = (mySlot === null);
    }
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }

  // ----------------------------
  // JOIN / LEAVE / INPUT
  // ----------------------------
  function sanitizeName(s){
    return (s || "").trim().replace(/\s+/g," ").slice(0,18);
  }

  async function join(name){
    name = sanitizeName(name);
    if (!name) return setStatus("Enter a name first.");

    const carsRef = db.ref(`rooms/${ROOM}/cars`);
    const res = await carsRef.transaction(cars => {
      if (!cars) {
        cars = {};
        for (let i=0;i<MAX_CARS;i++) cars[i] = { name:"", alive:false, score:0, input:0, eliminatedAt:null };
      }
      let free = null;
      for (let i=0;i<MAX_CARS;i++){
        if (!cars[i]?.name) { free = i; break; }
      }
      if (free === null) return; // abort
      cars[free] = cars[free] || { name:"", alive:false, score:0, input:0, eliminatedAt:null };
      cars[free].name = name;
      cars[free].input = 0;
      cars[free].alive = false;
      cars[free].score = 0;
      cars[free].eliminatedAt = null;
      cars[free]._pid = playerId;
      return cars;
    });

    if (!res.committed){
      setStatus("All 7 cars are taken.");
      return;
    }

    const cars = res.snapshot.val();
    let slot = null;
    for (let i=0;i<MAX_CARS;i++){
      if (cars[i]?._pid === playerId) { slot = i; break; }
    }
    if (slot === null){
      for (let i=0;i<MAX_CARS;i++){
        if (cars[i]?.name === name) { slot = i; break; }
      }
    }

    mySlot = slot;
    setStatus(`Joined car #${slot+1} as ${name}.`);
  }

  async function leave(){
    if (mySlot === null) return;
    const slot = mySlot;
    mySlot = null;

    const slotRef = roomRef(`cars/${slot}`);
    const snap = await slotRef.get();
    const val = snap.val();
    if (val && val._pid === playerId){
      await slotRef.set({ name:"", alive:false, score:0, input:0, eliminatedAt:null });
      setStatus("Left the car.");
    } else {
      setStatus("Left (slot not owned by this device).");
    }
  }

  async function sendInput(dir){
    if (mySlot === null) return;
    await roomRef(`cars/${mySlot}/input`).set(dir);
  }

  // ----------------------------
  // HOST LOOP + SUBSCRIBE
  // ----------------------------
  let currentRoom = null;

  async function hostInit(){
    setStatus("HOST running.");
    const existing = await fbGet("");
    if (!existing || !existing.cars){
      await fbSet("", makeDefaultRoom());
    }
    const room = await fbGet("");
    if (!room.phase) {
      const fresh = makeDefaultRoom();
      resetForRace(fresh);
      await fbSet("", fresh);
      return;
    }
    if (room.phase !== "race"){
      resetForRace(room);
      await fbSet("", room);
    }
  }

  async function fbGet(path){
    const snap = await roomRef(path).get();
    return snap.val();
  }

  function firebaseLoop(){
    if (isHost){
      const tick = async () => {
        try{
          const room = await fbGet("");
          if (!room) return;

          room.hostPing = Date.now();

          if (room.phase === "race"){
            hostTick(room);
            if (Date.now() >= room.phaseEndsAt){
              resetForLeaderboard(room);
            }
          } else if (room.phase === "leaderboard"){
            if (Date.now() >= room.phaseEndsAt){
              resetForLobby(room);
              resetForRace(room);
            }
          } else {
            if (Date.now() >= room.phaseEndsAt){
              resetForRace(room);
            }
          }

          await fbSet("", room);
        } catch(e){
          console.error(e);
        }
        setTimeout(tick, 50);
      };
      tick();
    }

    fbOn("", room => {
      if (!room) return;
      currentRoom = room;
      draw(currentRoom);
      renderSide(currentRoom);
    });
  }

  // ----------------------------
  // UI EVENTS
  // ----------------------------
  function tryJoin(){ join(nameInput.value); }

  joinBtn.addEventListener("click", tryJoin);
  nameInput.addEventListener("keydown", (e) => { if (e.key === "Enter") tryJoin(); });
  leaveBtn.addEventListener("click", leave);

  const steerHold = { left:false, right:false };
  function updateSteer(){
    if (mySlot === null) return;
    const dir = steerHold.left && !steerHold.right ? -1 : steerHold.right && !steerHold.left ? 1 : 0;
    sendInput(dir);
  }
  function bindHold(btn, side){
    const down = () => { steerHold[side]=true; updateSteer(); };
    const up = () => { steerHold[side]=false; updateSteer(); };
    btn.addEventListener("pointerdown", down);
    btn.addEventListener("pointerup", up);
    btn.addEventListener("pointercancel", up);
    btn.addEventListener("pointerleave", up);
  }
  bindHold(btnLeft, "left");
  bindHold(btnRight, "right");

  window.addEventListener("keydown", (e) => {
    if (mySlot === null) return;
    if (e.key === "ArrowLeft" || e.key.toLowerCase()==="a") { steerHold.left=true; updateSteer(); }
    if (e.key === "ArrowRight" || e.key.toLowerCase()==="d") { steerHold.right=true; updateSteer(); }
  });
  window.addEventListener("keyup", (e) => {
    if (mySlot === null) return;
    if (e.key === "ArrowLeft" || e.key.toLowerCase()==="a") { steerHold.left=false; updateSteer(); }
    if (e.key === "ArrowRight" || e.key.toLowerCase()==="d") { steerHold.right=false; updateSteer(); }
  });

  // ----------------------------
  // BOOT
  // ----------------------------
  (async () => {
    if (isHost) await hostInit();
    firebaseLoop();
    setStatus(isHost ? "HOST ready. Race should start immediately." : "Joined as PLAYER. If race doesn‚Äôt start, open a HOST tab with ?host=1.");
  })();
})();
</script>
</body>
</html>
