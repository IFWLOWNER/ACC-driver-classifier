<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFWL Stream Racer</title>
  <style>
    :root{--bg:#0b0f14;--panel:#121a24;--text:#e7eef8;--muted:#9fb2c9;--danger:#ff5b6b;}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial}
    .wrap{display:grid;gap:12px;max-width:1100px;margin:0 auto;padding:12px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;background:var(--panel);border-radius:14px;padding:10px 12px;border:1px solid #1b2a3b}
    header .left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#0e1620;color:var(--muted);border:1px solid #1b2a3b}
    .pill strong{color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:12px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--panel);border-radius:14px;padding:12px;border:1px solid #1b2a3b}
    canvas{width:100%;height:auto;display:block;background:#070a0f;border-radius:14px;border:1px solid #1b2a3b}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input,button{border-radius:12px;border:1px solid #1b2a3b;background:#0e1620;color:var(--text);padding:10px 12px;font-size:14px}
    input{flex:1;min-width:180px;outline:none}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#1a7ea0,#0f5f7b);border-color:#2aa6ce}
    button.danger{background:linear-gradient(180deg,#a01a2a,#7b0f1c);border-color:#ff5b6b55}
    .hint{color:var(--muted);font-size:12px;line-height:1.35}
    .big{font-size:18px;font-weight:700}
    .leaderboard{display:grid;gap:8px}
    .lb-item{display:flex;justify-content:space-between;gap:10px;padding:10px;border-radius:12px;background:#0e1620;border:1px solid #1b2a3b}
    .lb-item.out{opacity:.65}
    .controls{display:none;gap:10px;margin-top:10px}
    .controls button{flex:1;padding:14px 12px;font-size:16px}
    .hr{height:1px;background:#1b2a3b;margin:10px 0}
    .small{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .banner{display:none;background:rgba(255,91,107,.12);border:1px solid rgba(255,91,107,.35);color:#ffd7dc;border-radius:12px;padding:10px 12px;white-space:pre-wrap;margin-bottom:10px;font-size:13px;line-height:1.35}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="left">
      <div class="pill"><strong>IFWL Stream Racer</strong> <span class="mono">vFix-02</span></div>
      <div class="pill">Phase: <strong id="phaseText">—</strong></div>
      <div class="pill">Time: <strong id="timeText">—</strong></div>
      <div class="pill">HOST TICK: <strong id="tickText">—</strong></div>
    </div>
    <div class="pill" id="modePill">Mode: <strong>—</strong></div>
  </header>

  <div class="grid">
    <div class="card">
      <div class="banner" id="errBanner"></div>
      <canvas id="game" width="960" height="540"></canvas>

      <div class="controls" id="touchControls">
        <button id="btnLeft">⬅️ Left</button>
        <button id="btnRight">Right ➡️</button>
      </div>

      <div class="hint" style="margin-top:10px">
        <span style="color:#93ffd2">Player:</span> Enter name → join a car (max 7). Steer on mobile with buttons.<br/>
        <span style="color:#ffd38a">Host:</span> Open <span class="mono">?host=1</span> on your stream PC to start races.
      </div>
    </div>

    <div class="card">
      <div class="big" id="sideTitle">Join</div>
      <div class="hint" id="sideHint" style="margin-top:6px">Type your name and press Enter. First come first served.</div>

      <div class="hr"></div>

      <div class="row">
        <input id="nameInput" placeholder="Your name…" maxlength="18" />
        <button class="primary" id="joinBtn">Join</button>
        <button class="danger" id="leaveBtn" disabled>Leave</button>
      </div>

      <div class="hint" style="margin-top:10px" id="statusLine">Status: —</div>

      <div class="hr"></div>

      <div class="row" id="hostBtns" style="display:none">
        <button class="danger" id="resetBtn">Reset Room</button>
      </div>

      <div class="hr"></div>

      <div class="big" style="font-size:16px">Cars</div>
      <div class="leaderboard" id="carsList" style="margin-top:8px"></div>

      <div class="hr"></div>

      <div class="big" style="font-size:16px">Leaderboard</div>
      <div class="hint" style="margin:6px 0 8px">Shown automatically for 30s after each 60s race.</div>
      <div class="leaderboard" id="lbList"></div>

      <div class="hr"></div>
      <div class="small">
        RTDB Rules must allow read/write (temporary): <span class="mono">{ ".read": true, ".write": true }</span>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-database-compat.js"></script>

<script>
(() => {
  const MAX_CARS=7, RACE_SECONDS=60, LEADERBOARD_SECONDS=30, ROOM="main";

  const firebaseConfig = {
    apiKey: "AIzaSyDDV3oaa0PCRSbVP3-jplsFUHiLm6Zil1M",
    authDomain: "ifwl-stream-game.firebaseapp.com",
    databaseURL: "https://ifwl-stream-game-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "ifwl-stream-game",
    storageBucket: "ifwl-stream-game.firebasestorage.app",
    messagingSenderId: "132989681275",
    appId: "1:132989681275:web:307b06df334c1d0685ecde",
    measurementId: "G-EV4Z45T295"
  };

  const qs=new URLSearchParams(location.search);
  const isHost = qs.get("host")==="1";

  const canvas=document.getElementById("game"), ctx=canvas.getContext("2d");
  const phaseText=document.getElementById("phaseText");
  const timeText=document.getElementById("timeText");
  const tickText=document.getElementById("tickText");
  const modePill=document.getElementById("modePill");

  const nameInput=document.getElementById("nameInput");
  const joinBtn=document.getElementById("joinBtn");
  const leaveBtn=document.getElementById("leaveBtn");
  const statusLine=document.getElementById("statusLine");
  const carsList=document.getElementById("carsList");
  const lbList=document.getElementById("lbList");

  const touchControls=document.getElementById("touchControls");
  const btnLeft=document.getElementById("btnLeft");
  const btnRight=document.getElementById("btnRight");

  const sideTitle=document.getElementById("sideTitle");
  const sideHint=document.getElementById("sideHint");
  const errBanner=document.getElementById("errBanner");

  const hostBtns=document.getElementById("hostBtns");
  const resetBtn=document.getElementById("resetBtn");

  modePill.innerHTML = `Mode: <strong>${isHost ? "HOST" : "PLAYER"}</strong>`;

  function setStatus(m){ statusLine.textContent="Status: "+m; }
  function showErr(m){ errBanner.style.display="block"; errBanner.textContent=m; }
  function clearErr(){ errBanner.style.display="none"; errBanner.textContent=""; }
  function escapeHtml(s){ return (s||"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  // No-crypto id
  const playerId=(Date.now().toString(36)+Math.random().toString(36).slice(2)).slice(0,24);
  let mySlot=null;

  const carColors=["#ff4d6d","#4dd4ff","#93ffd2","#ffd38a","#b39cff","#a7ff4d","#ff9bf5"];

  try { firebase.initializeApp(firebaseConfig); } catch(e){}
  const db=firebase.database();
  const base=()=>db.ref(`rooms/${ROOM}`);
  const carsRef=()=>db.ref(`rooms/${ROOM}/cars`);

  async function safeUpdate(ref, patch){
    try{ await ref.update(patch); clearErr(); }
    catch(e){ showErr("DB UPDATE ERROR:\n"+(e?.message||String(e))); throw e; }
  }
  async function safeSet(ref, val){
    try{ await ref.set(val); clearErr(); }
    catch(e){ showErr("DB SET ERROR:\n"+(e?.message||String(e))); throw e; }
  }

  function makeDefaultRoom(){
    const cars={};
    for(let i=0;i<MAX_CARS;i++) cars[i]={name:"",alive:false,score:0,input:0,eliminatedAt:null};
    return { phase:"lobby", phaseEndsAt:Date.now()+4000, cars, obstacles:[], t:0, scroll:0, lastTick:Date.now(), hostPing:Date.now() };
  }
  function resetForRace(room){
    room.phase="race"; room.phaseEndsAt=Date.now()+RACE_SECONDS*1000;
    room.obstacles=[]; room.t=0; room.scroll=0; room.lastTick=Date.now();
    for(let i=0;i<MAX_CARS;i++){
      const c=room.cars[i];
      if(c.name && c.name.trim()){ c.alive=true; c.score=0; c.input=0; c.eliminatedAt=null; }
      else { c.alive=false; c.score=0; c.input=0; c.eliminatedAt=null; }
    }
  }
  function resetForLeaderboard(room){ room.phase="leaderboard"; room.phaseEndsAt=Date.now()+LEADERBOARD_SECONDS*1000; }
  function resetForLobby(room){
    room.phase="lobby"; room.phaseEndsAt=Date.now()+4000;
    for(let i=0;i<MAX_CARS;i++){ const c=room.cars[i]; c.alive=false; c.score=0; c.input=0; c.eliminatedAt=null; }
    room.obstacles=[]; room.t=0; room.scroll=0; room.lastTick=Date.now();
  }

  function centerX(worldY,t){ return 480 + Math.sin((worldY*0.0022)+t*0.9)*160 + Math.sin((worldY*0.0011)+t*0.4)*80; }
  const ROAD_HALF=190, KERB=18, CAR_W=28, CAR_H=46, CAR_Y=420, SCROLL_SPEED=270;

  function hostSimStep(room){
    const now=Date.now();
    const dt=Math.min(0.05,(now-room.lastTick)/1000);
    room.lastTick=now;
    room.t+=dt;
    room.scroll+=SCROLL_SPEED*dt;

    if(Math.random()<0.11){
      const spawnWY=room.scroll-120;
      const cx=centerX(spawnWY,room.t);
      const offset=(Math.random()*2-1)*(ROAD_HALF-40);
      room.obstacles.push({ wy:spawnWY, wx:cx+offset, r:16+Math.random()*10, kind:Math.random()<0.6?"block":"cone" });
    }
    room.obstacles=room.obstacles.filter(o=>o.wy<room.scroll+900);

    for(let i=0;i<MAX_CARS;i++){
      const c=room.cars[i];
      if(!c.name || !c.alive) continue;

      c.score+=dt;

      const laneOffset=(i-(MAX_CARS-1)/2)*34;
      const steer=(c.input||0)*140;

      const carWY=room.scroll+CAR_Y;
      const cx=centerX(carWY,room.t);

      const carX=cx+laneOffset+steer;
      const carY=CAR_Y;

      if(Math.abs(carX-cx)>(ROAD_HALF-14)){ c.alive=false; c.eliminatedAt=now; continue; }

      for(const ob of room.obstacles){
        const sy=ob.wy-room.scroll;
        if(sy<carY-70 || sy>carY+70) continue;
        const dx=Math.abs(carX-ob.wx);
        const dy=Math.abs(carY-sy);
        if(dx<(CAR_W/2+ob.r*0.7) && dy<(CAR_H/2+ob.r*0.7)){ c.alive=false; c.eliminatedAt=now; break; }
      }
    }
  }

  function computeLeaderboard(room){
    const e=[];
    for(let i=0;i<MAX_CARS;i++){ const c=room.cars[i]; if(!c.name) continue; e.push({slot:i,name:c.name,score:c.score,alive:c.alive}); }
    e.sort((a,b)=>b.score-a.score);
    return e;
  }

  function draw(room){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#06110b"; ctx.fillRect(0,0,canvas.width,canvas.height);

    const t=room.t||0, scroll=room.scroll||0;

    for(let y=0;y<canvas.height;y+=6){
      const wy=scroll+y;
      const cx=centerX(wy,t);
      const left=cx-ROAD_HALF, right=cx+ROAD_HALF;
      ctx.fillStyle=(Math.floor(wy/60)%2===0)?"#0b141f":"#0a121b";
      ctx.fillRect(left,y,right-left,6);

      ctx.fillStyle=(Math.floor(wy/24)%2===0)?"#c92b2b":"#e7eef8";
      ctx.fillRect(left-KERB,y,KERB,6);
      ctx.fillRect(right,y,KERB,6);

      ctx.fillStyle="#22364a";
      ctx.fillRect(left-1,y,1,6);
      ctx.fillRect(right,y,1,6);
    }

    if(room.obstacles && room.obstacles.length){
      for(const ob of room.obstacles){
        const sy=ob.wy-scroll;
        if(sy<-60 || sy>canvas.height+60) continue;
        if(ob.kind==="cone"){
          ctx.fillStyle="#ff9b4d";
          ctx.beginPath();
          ctx.moveTo(ob.wx,sy-ob.r);
          ctx.lineTo(ob.wx-ob.r*0.8,sy+ob.r);
          ctx.lineTo(ob.wx+ob.r*0.8,sy+ob.r);
          ctx.closePath();
          ctx.fill();
          ctx.strokeStyle="#2b1b0e"; ctx.lineWidth=2; ctx.stroke();
        } else {
          ctx.fillStyle="#2a3c52";
          ctx.fillRect(ob.wx-ob.r,sy-ob.r,ob.r*2,ob.r*2);
          ctx.strokeStyle="#476587"; ctx.lineWidth=2;
          ctx.strokeRect(ob.wx-ob.r,sy-ob.r,ob.r*2,ob.r*2);
        }
      }
    }

    for(let i=0;i<MAX_CARS;i++){
      const c=room.cars?.[i];
      if(!c?.name) continue;

      const laneOffset=(i-(MAX_CARS-1)/2)*34;
      const steer=(c.input||0)*140;

      const carWY=scroll+CAR_Y;
      const cx=centerX(carWY,t);
      const x=cx+laneOffset+steer, y=CAR_Y;

      const alive=!!c.alive;
      ctx.save();
      ctx.globalAlpha=alive?1:0.3;

      ctx.fillStyle="rgba(0,0,0,0.35)";
      ctx.fillRect(x-CAR_W/2+2,y-CAR_H/2+6,CAR_W,CAR_H);

      ctx.fillStyle=carColors[i];
      ctx.fillRect(x-CAR_W/2,y-CAR_H/2,CAR_W,CAR_H);

      ctx.fillStyle="#071019";
      ctx.fillRect(x-CAR_W/2+5,y-CAR_H/2+10,CAR_W-10,16);

      ctx.fillStyle="#0e1620";
      ctx.fillRect(x-CAR_W/2-6,y-CAR_H/2-6,CAR_W+12,8);
      ctx.fillRect(x-CAR_W/2-6,y+CAR_H/2-2,CAR_W+12,8);

      ctx.fillStyle="#e7eef8";
      ctx.font="700 12px system-ui";
      ctx.textAlign="center";
      ctx.fillText(String(i+1),x,y+4);

      ctx.font="12px system-ui";
      ctx.fillText(c.name,x,y-CAR_H/2-10);

      ctx.restore();

      if(!alive && room.phase==="race"){
        ctx.fillStyle="#ff5b6b";
        ctx.font="700 14px system-ui";
        ctx.textAlign="center";
        ctx.fillText("OUT",x,y+CAR_H/2+18);
      }
    }
  }

  function renderSide(room){
    carsList.innerHTML="";
    for(let i=0;i<MAX_CARS;i++){
      const c=room.cars[i];
      const taken=c.name && c.name.trim();
      const el=document.createElement("div");
      el.className="lb-item"+(taken && room.phase==="race" && !c.alive ? " out":"");
      el.innerHTML=`<div><strong>#${i+1}</strong> ${taken?"— "+escapeHtml(c.name):"<span class='small'>(empty)</span>"}</div>
                    <div class="mono">${taken?(room.phase==="race"?(c.alive?"IN":"OUT"):""):""}</div>`;
      carsList.appendChild(el);
    }

    lbList.innerHTML="";
    const entries=computeLeaderboard(room);
    entries.forEach((e,idx)=>{
      const el=document.createElement("div");
      el.className="lb-item";
      el.innerHTML=`<div><strong>${idx+1}.</strong> ${escapeHtml(e.name)} <span class="small">(Car #${e.slot+1})</span></div>
                    <div class="mono">${e.score.toFixed(2)}</div>`;
      lbList.appendChild(el);
    });

    phaseText.textContent=room.phase||"—";
    const msLeft=Math.max(0,(room.phaseEndsAt||Date.now())-Date.now());
    timeText.textContent=(msLeft/1000).toFixed(1)+"s";
  }

  async function join(name){
    name=(name||"").trim().replace(/\s+/g," ").slice(0,18);
    if(!name) return setStatus("Enter a name first.");

    const res=await carsRef().transaction(cars=>{
      if(!cars){
        cars={}; for(let i=0;i<MAX_CARS;i++) cars[i]={name:"",alive:false,score:0,input:0,eliminatedAt:null};
      }
      let free=null;
      for(let i=0;i<MAX_CARS;i++){ if(!cars[i]?.name){ free=i; break; } }
      if(free===null) return;

      cars[free]=cars[free]||{name:"",alive:false,score:0,input:0,eliminatedAt:null};
      cars[free].name=name;
      cars[free].input=0;
      cars[free].alive=false;
      cars[free].score=0;
      cars[free].eliminatedAt=null;
      cars[free]._pid=playerId;
      return cars;
    });

    if(!res.committed) return setStatus("All 7 cars are taken.");

    const cars=res.snapshot.val();
    let slot=null;
    for(let i=0;i<MAX_CARS;i++){ if(cars[i]?._pid===playerId){ slot=i; break; } }
    mySlot=slot;
    leaveBtn.disabled = (mySlot===null);
    touchControls.style.display = (mySlot!==null && !isHost) ? "flex" : "none";
    setStatus(`Joined car #${slot+1} as ${name}.`);
  }

  async function leave(){
    if(mySlot===null) return;
    const slot=mySlot; mySlot=null;
    const ref=db.ref(`rooms/${ROOM}/cars/${slot}`);
    const snap=await ref.get();
    const val=snap.val();
    if(val && val._pid===playerId){
      await safeSet(ref,{name:"",alive:false,score:0,input:0,eliminatedAt:null});
      setStatus("Left the car.");
    } else setStatus("Left (slot not owned by this device).");
    leaveBtn.disabled=true;
    touchControls.style.display="none";
  }

  async function sendInput(dir){
    if(mySlot===null) return;
    await safeSet(db.ref(`rooms/${ROOM}/cars/${mySlot}/input`), dir);
  }

  const steerHold={left:false,right:false};
  function updateSteer(){
    if(mySlot===null) return;
    const dir = steerHold.left && !steerHold.right ? -1 : steerHold.right && !steerHold.left ? 1 : 0;
    sendInput(dir);
  }
  function bindHold(btn,side){
    const down=()=>{steerHold[side]=true;updateSteer();};
    const up=()=>{steerHold[side]=false;updateSteer();};
    btn.addEventListener("pointerdown",down);
    btn.addEventListener("pointerup",up);
    btn.addEventListener("pointercancel",up);
    btn.addEventListener("pointerleave",up);
  }
  bindHold(btnLeft,"left");
  bindHold(btnRight,"right");
  window.addEventListener("keydown",e=>{
    if(mySlot===null) return;
    if(e.key==="ArrowLeft"||e.key.toLowerCase()==="a"){steerHold.left=true;updateSteer();}
    if(e.key==="ArrowRight"||e.key.toLowerCase()==="d"){steerHold.right=true;updateSteer();}
  });
  window.addEventListener("keyup",e=>{
    if(mySlot===null) return;
    if(e.key==="ArrowLeft"||e.key.toLowerCase()==="a"){steerHold.left=false;updateSteer();}
    if(e.key==="ArrowRight"||e.key.toLowerCase()==="d"){steerHold.right=false;updateSteer();}
  });

  joinBtn.addEventListener("click",()=>join(nameInput.value));
  nameInput.addEventListener("keydown",e=>{ if(e.key==="Enter") join(nameInput.value); });
  leaveBtn.addEventListener("click",leave);

  async function resetRoom(){
    const fresh=makeDefaultRoom();
    resetForRace(fresh);
    await safeSet(base(), fresh);
    setStatus("Room reset.");
  }

  async function ensureRoom(){
    const snap=await base().get();
    const room=snap.val();
    if(!room || !room.cars){
      await resetRoom();
      return;
    }
    // ensure required keys exist
    const patch={};
    if(room.scroll===undefined) patch.scroll=0;
    if(room.hostPing===undefined) patch.hostPing=Date.now();
    if(room.obstacles===undefined) patch.obstacles=[];
    if(Object.keys(patch).length) await safeUpdate(base(), patch);
  }

  function subscribe(){
    base().on("value", snap=>{
      const room=snap.val();
      if(!room) return;
      draw(room);
      renderSide(room);
    });
  }

  async function hostStart(){
    hostBtns.style.display="flex";
    resetBtn.onclick=resetRoom;

    await ensureRoom();

    // Heartbeat proves host loop is alive
    let hostCounter=0;

    const tick = async () => {
      hostCounter++;
      tickText.textContent = String(hostCounter);

      try{
        const snap=await base().get();
        const room=snap.val();
        if(!room) return setTimeout(tick, 200);

        room.hostPing = Date.now();

        if(room.phase==="race"){
          hostSimStep(room);
          if(Date.now()>=room.phaseEndsAt) resetForLeaderboard(room);
        } else if(room.phase==="leaderboard"){
          if(Date.now()>=room.phaseEndsAt){ resetForLobby(room); resetForRace(room); }
        } else {
          if(Date.now()>=room.phaseEndsAt) resetForRace(room);
        }

        await safeUpdate(base(), {
          phase: room.phase,
          phaseEndsAt: room.phaseEndsAt,
          t: room.t,
          scroll: room.scroll,
          lastTick: room.lastTick,
          hostPing: room.hostPing,
          obstacles: room.obstacles,
          cars: room.cars
        });

      } catch(e){
        // banner already shows error
      }
      setTimeout(tick, 50);
    };

    tick();
  }

  (async ()=>{
    subscribe();

    if(isHost){
      sideTitle.textContent="Host Panel";
      sideHint.innerHTML=`You are the host. Keep this open on stream PC.<br/>Share: <span class="mono">${location.origin+location.pathname}</span>`;
      nameInput.disabled=true; joinBtn.disabled=true; leaveBtn.disabled=true;
      touchControls.style.display="none";
      setStatus("HOST starting…");
      await hostStart();
      setStatus("HOST running. Track should move.");
    } else {
      setStatus("PLAYER ready. If nothing moves, open a host tab with ?host=1.");
    }
  })();
})();
</script>
</body>
</html>
