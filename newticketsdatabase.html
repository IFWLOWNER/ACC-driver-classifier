<!DOCTYPE html>
<html lang="en">
<head>

  <style>
    @font-face {
      font-family: 'GoodTimesRG';
      src: url('GoodTimesRg.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    /* Apply custom font to header and nav links */
    header, header nav ul li a {
      font-family: 'GoodTimesRG', serif;
      font-style: normal;
    }
  </style>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Tickets • Highlight Finalised Tickets</title>
  <style>
    /* ------------------------------------------------------------
       Base styling
       ------------------------------------------------------------ */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #6200EE;
      width: 100%;
      padding: 12px 0;
      color: #fff;
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 24px;
      position: relative;
    }
    .logout-btn {
      background-color: transparent;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 16px;
      top: 12px;
    }

    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 24px;
      max-width: 800px;
      width: 100%;
      margin-bottom: 24px;
    }
    .section-title {
      margin-top: 0;
      text-align: center;
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    /* Primary purple button */
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #6200EE;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .link-btn {
      background: none;
      border: none;
      color: #6200EE;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .status.error { color: #c00; }
    .status.success { color: #080; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #eee;
    }

    .hidden { display: none; }

    /* ------------------------------------------------------------
       Row highlights
       ------------------------------------------------------------ */
    .appeal-highlight { background-color: #E84040; }
    .finalised-row { background-color: #A5FF7F; }

    /* ------------------------------------------------------------
       Appeal form
       ------------------------------------------------------------ */
    .appeal-form {
      background: #fafafa;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .appeal-form input[type="text"],
    .appeal-form textarea {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .appeal-form button {
      width: auto;
      margin-right: 8px;
    }

    /* ------------------------------------------------------------
       Admin detail row
       ------------------------------------------------------------ */
    .detailRow td {
      background-color: #eef7ff;
      padding: 0;
    }
    .detail-container {
      padding: 16px;
      font-size: 0.95rem;
    }
    .detail-container p { margin: 4px 0; }
    .detail-container a { color: #1a0dab; text-decoration: underline; }
    .detail-container hr {
      margin: 12px 0;
      border: none;
      border-top: 1px solid #ccc;
    }
    .detail-container .appeal-box {
      padding: 8px;
      border: 1px solid #f5e6a0;
      border-radius: 4px;
      background-color: #fffdf0;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #333;
    }
    .detail-container .appeal-box strong { color: #b36b00; }
    .detail-container .review-form {
      background: #eef7ff;
      padding: 12px;
      border: 1px solid #9ecfff;
      border-radius: 6px;
      margin-top: 12px;
    }
    .detail-container .review-form select,
    .detail-container .review-form textarea,
    .detail-container .review-form input[type="text"] {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .detail-container .review-form button {
      width: auto;
      margin-right: 8px;
    }
  </style>

  <!-- jsPDF UMD build for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- NOTE: Removed the early overviewAdminBtn script that ran before Firebase initialized -->
</head>
<body style="margin:0;font-family:sans-serif;background:url('ifwl_bg.webp') no-repeat center top;background-size:cover;">
  
<header style="background-color:#2A9D8F; padding:16px 0;">
  <div style="max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:center;">
    <a href="https://ifwl.net/">
      <img src="ifwlheaderlogo.webp" alt="IFWL" style="height:48px;">
    </a>
    <nav>
      <ul style="list-style:none; margin:0; padding:0; display:flex; gap:24px; white-space:nowrap; justify-content:center;">
        <li><a href="https://ifwl.net/" style="color:#FFF; text-decoration:none;">Home</a></li>
        <li><a href="https://ifwl.net/events" style="color:#FFF; text-decoration:none;">Races</a></li>
        <li><a href="https://ifwl.net/events/competitions/standings" style="color:#FFF; text-decoration:none;">Standings</a></li>
        <li><a href="https://ifwl.net/grid" style="color:#FFF; text-decoration:none;">Grid</a></li>
        <li><a href="https://ifwl.net/paddock/safety-car" style="color:#FFF; text-decoration:none;">Paddock</a></li>
        <li><a href="https://ifwl.net/merchandise" style="color:#FFF; text-decoration:none;">Merch</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/" style="color:#FFF; text-decoration:none;">Classifier</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/ifwl_live_stewarding.html" style="color:#FFF; text-decoration:none;">Live Stewarding Page</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/stewarding_codes.html" style="color:#FFF; text-decoration:none;">Stewarding Codes Explained</a></li>
      </ul>
    </nav>
  </div>
</header>

<div style="text-align:right; margin:12px; width:100%; max-width:800px;">
  <button id="logoutBtn" style="padding:6px 12px; font-size:14px; cursor:pointer;">Logout</button>
</div>

  <!-- ==============================================================
       MENU SECTION (new) — the landing view with three buttons
       ============================================================== -->
  <div id="menuSection" class="container">
    <h2 class="section-title">Ticketing</h2>
    <div class="form-group">
      <button id="menuViewBtn">View All Tickets</button>
    </div>
    <div class="form-group">
      <button id="menuSubmitBtn">Submit Ticket</button>
    </div>
    <div class="form-group" style="margin-bottom:0;">
      <button id="menuAdminBtn">Admin Login</button>
    </div>
  </div>

  <!-- ==============================================================
       SUBMIT A NEW TICKET (unchanged, now hidden by default)
       ============================================================== -->
  <div id="submitSection" class="container hidden">
    <h2 class="section-title">Submit a New Ticket</h2>

    <!-- Important note -->
    <div class="status" style="margin-bottom:16px;">
      <strong>Important:</strong> Ticket submissions are final. Once submitted, a ticket
      <strong>cannot be withdrawn or edited</strong>. Please review carefully before submitting.
    </div>

    <!-- Accused (Driver) Dropdown -->
    <div class="form-group">
      <label for="accusedSelect">Accused (Driver) <span style="color: red;">*</span></label>
      <select id="accusedSelect">
        <option value="" disabled selected>Select a driver…</option>
      </select>
    </div>
    <div id="newDriverContainer" class="form-group hidden">
      <label for="newDriverInput"><strong>Add New Driver</strong></label>
      <input type="text" id="newDriverInput" placeholder="Type new driver name…" />
    </div>

    <!-- Driver Reporting Dropdown -->
    <div class="form-group">
      <label for="reporterSelect">Driver Reporting <span style="color: red;">*</span></label>
      <select id="reporterSelect">
        <option value="" disabled selected>Select reporting driver…</option>
      </select>
    </div>
    <div id="newReporterContainer" class="form-group hidden">
      <label for="newReporterInput"><strong>Add New Reporting Driver</strong></label>
      <input type="text" id="newReporterInput" placeholder="Type new driver name…" />
    </div>

    <!-- Competition Dropdown (hard-coded) -->
    <div class="form-group">
      <label for="competitionSelect">Competition <span style="color: red;">*</span></label>
      <select id="competitionSelect">
        <option value="" disabled selected>Select a competition…</option>
        <option value="ACC - BEGINNER CONSOLE">ACC - BEGINNER CONSOLE</option>
        <option value="ACC - BEGINNER PC">ACC - BEGINNER PC</option>
        <option value="ACC - PRO AM CONSOLE">ACC - PRO AM CONSOLE</option>
        <option value="ACC - CONSOLE OPEN TRACK">ACC - CONSOLE OPEN TRACK</option>
        <option value="ACC - PC OPEN TRACK">ACC - PC OPEN TRACK</option>
        <option value="LMU MULTICLASS">LMU MULTICLASS</option>
        <option value="RACEROOM">RACEROOM</option>
        <option value="ACC - PRO AM PC">ACC - PRO AM PC</option>
        <option value="ACC - ENDURO SOLO">ACC - ENDURO SOLO</option>
        <option value="ACC - ENDURO TEAMS">ACC - ENDURO TEAMS</option>
        <option value="ACC - GMC">ACC - GMC</option>
        <option value="ACC - AMATEUR PC">ACC - AMATEUR PC</option>
        <option value="ACC - AMATEUR CONSOLE">ACC - AMATEUR CONSOLE</option>
        <option value="AC - all game modes">AC – all game modes</option>
        <option value="AC EVO - all game modes">AC EVO – all game modes</option>
        <option value="F1 2025">F1 2025</option>
      </select>
    </div>

    <!-- Full Incident Summary -->
    <div class="form-group">
      <label for="fullIncident">Full Incident Summary <span style="color: red;">*</span></label>
      <textarea id="fullIncident" placeholder="Describe the incident in detail…" required></textarea>
    </div>

    <!-- Event Dropdown (static) -->
    <div class="form-group">
      <label for="eventSelect">Event</label>
      <select id="eventSelect">
        <option value="Practice">Practice</option>
        <option value="Qualifying">Qualifying</option>
        <option value="Race 1">Race 1</option>
        <option value="Race 2">Race 2</option>
        <option value="Race 3">Race 3</option>
      </select>
    </div>

    <!-- Proof URL -->
    <div class="form-group">
      <label for="proofUrl">Proof URL (if any)</label>
      <input type="url" id="proofUrl" placeholder="any video or image hosting site such as youtube/google drive/imgur" />
    </div>

    <!-- Season Dropdown (static) -->
    <div class="form-group">
      <label for="seasonSelect">Season</label>
      <select id="seasonSelect">
        <option value="Test Season">Test Season</option>
        <option value="Season 1">Season 1</option>
        <option value="Season 2">Season 2</option>
        <option value="Season 3">Season 3</option>
        <option value="Season 4">Season 4</option>
      </select>
    </div>

    <!-- Track Dropdown (dynamic) -->
    <div class="form-group">
      <label for="trackSelect">Track</label>
      <select id="trackSelect">
        <option value="" disabled selected>Select a track…</option>
      </select>
    </div>
    <div id="newTrackContainer" class="form-group hidden">
      <label for="newTrackInput"><strong>Add New Track</strong></label>
      <input type="text" id="newTrackInput" placeholder="Type new track name…" />
    </div>

    <!-- Rule Breach Dropdown (dynamic) -->
    <div class="form-group">
      <label for="ruleBreachSelect">Rule Breach</label>
      <select id="ruleBreachSelect">
        <option value="" disabled selected>Select a regulation…</option>
      </select>
    </div>

    <!-- Submit Button -->
    <button id="submitBtn">Submit Ticket</button>
    <div class="status" id="statusMsg"></div>

    <!-- Old inline links hidden (menu now provides buttons) -->
    <button id="viewTicketsBtn" class="link-btn hidden">View All Tickets</button>
    <button id="loginToggleBtn" class="link-btn hidden">Admin Login</button>
  </div>

  <!-- ==============================================================
       VIEW ALL TICKETS
       ============================================================== -->
  <div id="viewSection" class="container hidden">
    <h2 class="section-title">All Submitted Tickets</h2>
    <div id="ticketsListContainer"></div>
    <button id="backFromViewBtn" class="link-btn">← Back to Menu</button>
  </div>

  <!-- ==============================================================
       LOGIN FORM (Admins)
       ============================================================== -->
  <div id="loginSection" class="container hidden">
    <h2 class="section-title">Admin Sign-In</h2>
    <div class="form-group">
      <label for="email">Email <span style="color: red;">*</span></label>
      <input type="email" id="email" placeholder="admin@example.com" required />
    </div>
    <div class="form-group">
      <label for="password">Password <span style="color: red;">*</span></label>
      <input type="password" id="password" placeholder="••••••••" required />
    </div>
    <button id="loginBtn">Login</button>
    <div class="status" id="loginStatusMsg"></div>
    <button id="backFromLoginBtn" class="link-btn">← Back to Menu</button>
  </div>

  <!-- ==============================================================
       ADMIN DASHBOARD
       ============================================================== -->
  <div id="adminSection" class="container hidden" style="max-width: 1100px; padding:24px;">
    <h2 class="section-title">Admin Dashboard</h2>
    <button id="overviewAdminBtn" style="margin-bottom:12px; padding:8px 16px; background-color:#444; color:#fff; border:none; border-radius:4px; cursor:pointer;">Generate Overview PDF</button>
    <div id="adminTicketsContainer" style="overflow-x:auto;"></div>
  </div>

  <!-- ==============================================================
       Firebase v9+ Modular SDK & App Logic (including PDF generation)
       ============================================================== -->
  <script type="module">
    // 1) Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, getDoc, query, where, orderBy,
      serverTimestamp, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    const app  = initializeApp(firebaseConfig);
    const db   = getFirestore(app);
    const auth = getAuth(app);

    // 2) DOM elements
    const menuSection           = document.getElementById("menuSection");
    const submitSection         = document.getElementById("submitSection");
    const viewSection           = document.getElementById("viewSection");
    const loginSection          = document.getElementById("loginSection");
    const adminSection          = document.getElementById("adminSection");

    // Menu buttons
    const menuViewBtn           = document.getElementById("menuViewBtn");
    const menuSubmitBtn         = document.getElementById("menuSubmitBtn");
    const menuAdminBtn          = document.getElementById("menuAdminBtn");

    // Submit-ticket elements
    const accusedSelect         = document.getElementById("accusedSelect");
    const newDriverContainer    = document.getElementById("newDriverContainer");
    const newDriverInput        = document.getElementById("newDriverInput");

    const reporterSelect        = document.getElementById("reporterSelect");
    const newReporterContainer  = document.getElementById("newReporterContainer");
    const newReporterInput      = document.getElementById("newReporterInput");

    const competitionSelect     = document.getElementById("competitionSelect");
    const fullIncident          = document.getElementById("fullIncident");
    const eventSelect           = document.getElementById("eventSelect");
    const proofUrlInput         = document.getElementById("proofUrl");
    const seasonSelect          = document.getElementById("seasonSelect");

    const trackSelect           = document.getElementById("trackSelect");
    const newTrackContainer     = document.getElementById("newTrackContainer");
    const newTrackInput         = document.getElementById("newTrackInput");

    const ruleBreachSelect      = document.getElementById("ruleBreachSelect");

    const submitBtn             = document.getElementById("submitBtn");
    const statusMsg             = document.getElementById("statusMsg");

    // View all tickets (public)
    const backFromViewBtn       = document.getElementById("backFromViewBtn");
    const ticketsListContainer  = document.getElementById("ticketsListContainer");

    // Login (admin)
    const loginBtn              = document.getElementById("loginBtn");
    const backFromLoginBtn      = document.getElementById("backFromLoginBtn");
    const emailInput            = document.getElementById("email");
    const passwordInput         = document.getElementById("password");
    const loginStatusMsg        = document.getElementById("loginStatusMsg");

    // Admin
    const logoutBtn             = document.getElementById("logoutBtn");
    const adminTicketsContainer = document.getElementById("adminTicketsContainer");
    const overviewAdminBtn      = document.getElementById("overviewAdminBtn");

    // ----------------------------------------------------------------
    // Show exactly one section
    // ----------------------------------------------------------------
    function showSection(sectionToShow) {
      [menuSection, submitSection, viewSection, loginSection, adminSection].forEach(sec => sec.classList.add("hidden"));
      sectionToShow.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ----------------------------------------------------------------
    // Populate dropdowns
    // ----------------------------------------------------------------
    async function populateDriverDropdown() {
      const snapshot = await getDocs(collection(db, "drivers"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.fullName && typeof data.fullName === "string") names.push(data.fullName);
      });
      names.sort((a,b) => a.localeCompare(b));

      accusedSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = ""; ph.textContent = "Select a driver…"; ph.disabled = true; ph.selected = true;
      accusedSelect.appendChild(ph);
      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        accusedSelect.appendChild(opt);
      });
      const addOpt = document.createElement("option");
      addOpt.value = "__ADD_NEW__"; addOpt.textContent = "➕ Add New Driver…";
      accusedSelect.appendChild(addOpt);

      accusedSelect.addEventListener("change", () => {
        accusedSelect.value === "__ADD_NEW__" ? newDriverContainer.classList.remove("hidden") : newDriverContainer.classList.add("hidden");
      });
    }

    async function populateReporterDropdown() {
      const snapshot = await getDocs(collection(db, "drivers"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.fullName && typeof data.fullName === "string") names.push(data.fullName);
      });
      names.sort((a,b) => a.localeCompare(b));

      reporterSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = ""; ph.textContent = "Select reporting driver…"; ph.disabled = true; ph.selected = true;
      reporterSelect.appendChild(ph);
      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        reporterSelect.appendChild(opt);
      });
      const addOpt = document.createElement("option");
      addOpt.value = "__ADD_NEW__"; addOpt.textContent = "➕ Add New Reporting Driver…";
      reporterSelect.appendChild(addOpt);

      reporterSelect.addEventListener("change", () => {
        reporterSelect.value === "__ADD_NEW__" ? newReporterContainer.classList.remove("hidden") : newReporterContainer.classList.add("hidden");
      });
    }

    async function populateTrackDropdown() {
      const snapshot = await getDocs(collection(db, "tracks"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name && typeof data.name === "string") names.push(data.name);
      });
      names.sort((a,b) => a.localeCompare(b));

      trackSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = ""; ph.textContent = "Select a track…"; ph.disabled = true; ph.selected = true;
      trackSelect.appendChild(ph);
      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        trackSelect.appendChild(opt);
      });
      const addOpt = document.createElement("option");
      addOpt.value = "__ADD_NEW__"; addOpt.textContent = "➕ Add New Track…";
      trackSelect.appendChild(addOpt);

      trackSelect.addEventListener("change", () => {
        trackSelect.value === "__ADD_NEW__" ? newTrackContainer.classList.remove("hidden") : newTrackContainer.classList.add("hidden");
      });
    }

    async function populateRegulationsDropdown() {
      const snapshot = await getDocs(collection(db, "regulations"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name && typeof data.name === "string") names.push(data.name);
      });
      names.sort((a,b) => a.localeCompare(b));

      ruleBreachSelect.innerHTML = "";
      const ph = document.createElement("option");
      ph.value = ""; ph.textContent = "Select a regulation…"; ph.disabled = true; ph.selected = true;
      ruleBreachSelect.appendChild(ph);
      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name; opt.textContent = name;
        ruleBreachSelect.appendChild(opt);
      });
    }

    // Populate on load (so submit section is ready when opened)
    populateDriverDropdown();
    populateReporterDropdown();
    populateTrackDropdown();
    populateRegulationsDropdown();

    // ----------------------------------------------------------------
    // Submit ticket
    // ----------------------------------------------------------------
    submitBtn.addEventListener("click", async () => {
      submitBtn.disabled = true;
      statusMsg.textContent = "Submitting…";
      statusMsg.className = "status";

      let accused = accusedSelect.value;
      const newDriverName = newDriverInput.value.trim();

      let reporter = reporterSelect.value;
      const newReporterName = newReporterInput.value.trim();

      const competition = competitionSelect.value;
      const summary = fullIncident.value.trim();
      const eventVal = eventSelect.value;
      const proofUrl = proofUrlInput.value.trim();
      const season = seasonSelect.value;

      let track = trackSelect.value;
      const newTrackName = newTrackInput.value.trim();

      const ruleBreach = ruleBreachSelect.value;

      if (((!accused && !newDriverName)) || ((!reporter && !newReporterName)) || !competition || !summary) {
        statusMsg.textContent = "Please fill in all required fields: Accused, Driver Reporting, Competition, Full Incident Summary.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }

      if (accused === "__ADD_NEW__") {
        accused = newDriverName;
        try { await addDoc(collection(db, "drivers"), { fullName: newDriverName }); } catch (e) { console.error(e); }
      }
      if (reporter === "__ADD_NEW__") {
        reporter = newReporterName;
        try { await addDoc(collection(db, "drivers"), { fullName: newReporterName }); } catch (e) { console.error(e); }
      }
      if (track === "__ADD_NEW__") {
        track = newTrackName;
        try { await addDoc(collection(db, "tracks"), { name: newTrackName }); } catch (e) { console.error(e); }
      }

      const newTicket = {
        accused, reporter, competition,
        fullIncident: summary,
        event: eventVal,
        proofUrl,
        season,
        track,
        ruleBreach,
        status: "New Submission",
        stewardDecision: "",
        stewardTag: "",
        timestamp: serverTimestamp()
      };

      try {
        const docRef = await addDoc(collection(db, "tickets"), newTicket);
        statusMsg.textContent = `Ticket submitted (ID: ${docRef.id}). Thank you!`;
        statusMsg.className = "status success";

        accusedSelect.value = "";
        newDriverContainer.classList.add("hidden");
        newDriverInput.value = "";

        reporterSelect.value = "";
        newReporterContainer.classList.add("hidden");
        newReporterInput.value = "";

        fullIncident.value = "";
        eventSelect.value = "Practice";
        proofUrlInput.value = "";
        seasonSelect.value = "Season 1";

        trackSelect.value = "";
        newTrackContainer.classList.add("hidden");
        newTrackInput.value = "";

        ruleBreachSelect.value = "";

      } catch (error) {
        console.error("Error writing ticket: ", error);
        statusMsg.textContent = "Error submitting ticket. Please try again.";
        statusMsg.className = "status error";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ----------------------------------------------------------------
    // Public appeal helpers, Admin detail view, fetch & render tickets
    // (unchanged from your version; trimmed for brevity)
    // ----------------------------------------------------------------
    function toggleAppealForm(ticketId, container) { /* ...unchanged... */ }
    async function toggleDetailView(ticketId, container) { /* ...unchanged... */ }

    async function fetchAndRenderTickets(targetContainer, isAdmin = false) {
      const ticketsCol   = collection(db, "tickets");
      const ticketsQuery = query(ticketsCol);

      try {
        const snapshot = await getDocs(ticketsQuery);
        if (snapshot.empty) {
          targetContainer.innerHTML = "<p>No tickets have been submitted yet.</p>";
          return;
        }

        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Accused</th>
                <th>Reporter</th>
                <th>Competition</th>
                <th>Status</th>
                <th>Assigned Steward</th>
                <th>Submitted At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        snapshot.forEach(docSnap => {
          const data  = docSnap.data();
          const tsObj = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : null;
          const tsStr = tsObj ? tsObj.toLocaleString() : "";
          const id    = docSnap.id;
          const steward = data.stewardTag || "";

          let isExpired = false;
          if (tsObj) {
            const now = Date.now();
            if (now - tsObj.getTime() > 24 * 60 * 60 * 1000) isExpired = true;
          }

          const isFinalised = (data.status === "Finalised");
          const rowClassList = ["ticketRow"];
          if (isFinalised) rowClassList.push("finalised-row");

          let actionButtonHTML = "";
          if (isAdmin) {
            actionButtonHTML = `<button data-id="${id}" class="openBtn">Open</button>`;
          } else {
            actionButtonHTML = isExpired
              ? `<button disabled style="background-color:#999;cursor:not-allowed;">Appeal Period Expired</button>`
              : `<button data-id="${id}" class="appealBtn">Appeal</button>`;
          }

          tableHTML += `
            <tr data-id="${id}" class="${rowClassList.join(" ")}">
              <td>${id}</td>
              <td>${data.accused || ""}</td>
              <td>${data.reporter || ""}</td>
              <td>${data.competition || ""}</td>
              <td>${data.status || ""}</td>
              <td>${steward}</td>
              <td>${tsStr}</td>
              <td>${actionButtonHTML}</td>
            </tr>
          `;
        });

        tableHTML += `</tbody></table>`;
        targetContainer.innerHTML = tableHTML;

        const ticketRows = targetContainer.querySelectorAll("tr.ticketRow");
        ticketRows.forEach(async (row) => {
          const ticketId = row.getAttribute("data-id");
          const appealsRef = collection(db, "tickets", ticketId, "appeals");
          const appealsSnapshot = await getDocs(appealsRef);
          if (!appealsSnapshot.empty) row.classList.add("appeal-highlight");
        });

        if (isAdmin) {
          targetContainer.querySelectorAll(".openBtn").forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleDetailView(ticketId, targetContainer);
            });
          });
        } else {
          targetContainer.querySelectorAll(".appealBtn").forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleAppealForm(ticketId, targetContainer);
            });
          });
        }

      } catch (err) {
        console.error("Error fetching tickets:", err);
        targetContainer.innerHTML = "<p>Error loading tickets.</p>";
      }
    }

    // ----------------------------------------------------------------
    // Menu navigation
    // ----------------------------------------------------------------
    menuViewBtn.addEventListener("click", async () => {
      showSection(viewSection);
      ticketsListContainer.innerHTML = "<p>Loading tickets…</p>";
      await fetchAndRenderTickets(ticketsListContainer, false);
    });
    menuSubmitBtn.addEventListener("click", () => showSection(submitSection));
    menuAdminBtn.addEventListener("click", () => showSection(loginSection));

    backFromViewBtn.addEventListener("click", () => showSection(menuSection));
    backFromLoginBtn.addEventListener("click", () => showSection(menuSection));

    // ----------------------------------------------------------------
    // Auth
    // ----------------------------------------------------------------
    loginBtn.addEventListener("click", async () => {
      loginBtn.disabled = true;
      loginStatusMsg.textContent = "Signing in…";
      loginStatusMsg.className = "status";
      const email = emailInput.value.trim();
      const pw    = passwordInput.value.trim();
      if (!email || !pw) {
        loginStatusMsg.textContent = "Email & password are required.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (err) {
        console.error("Login error:", err);
        loginStatusMsg.textContent = "Login failed. Check credentials.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => { await signOut(auth); });

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        logoutBtn.classList.remove("hidden");
        showSection(adminSection);
        adminTicketsContainer.innerHTML = "<p>Loading tickets…</p>";
        await fetchAndRenderTickets(adminTicketsContainer, true);
      } else {
        logoutBtn.classList.add("hidden");
        showSection(menuSection); // default to menu when logged out
      }
    });

    // ----------------------------------------------------------------
    // Helpers for PDF generation (unchanged)
    // ----------------------------------------------------------------
    function getImageDataURL(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.setAttribute("crossOrigin", "anonymous");
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = function(e) { reject(e); };
        img.src = url;
      });
    }

    const postRaceCodeLookup = {
      RP1mi:"Unsafe Track Rejoin (10s)", RP1St:"Unsafe Track Rejoin (30s)", RP1Se:"Unsafe Track Rejoin (SG30)",
      RP2mi:"Unsafe Pit Exit / Crossing pit line (10s)", RP2St:"Unsafe Pit Exit / Crossing pit line (30s)", RP2Se:"Unsafe Pit Exit / Crossing pit line (SG30)",
      RP3mi:"Blue Flag Abuse / Blocking While Lapped (5s)", RP3St:"Blue Flag Abuse / Blocking While Lapped (15s)", RP3Se:"Blue Flag Abuse / Blocking While Lapped (SG30)",
      RP4mi:"Formation Lap / Start Line Infingement (30s)", RP4St:"Formation Lap / Start Line Infingement (SG30)", RP4Se:"Formation Lap / Start Line Infingement (DQ)",
      RP5mi:"Illegal Overtake (Off-Track or Gained Advantage) (5s)", RP5St:"Illegal Overtake (Off-Track or Gained Advantage) (15s)", RP5Se:"Illegal Overtake (Off-Track or Gained Advantage) (30s)",
      RP6mi:"Late Blocking / Moving Under Braking (5s)", RP6St:"Late Blocking / Moving Under Braking (30s)", RP6Se:"Late Blocking / Moving Under Braking (SG30)",
      RP7mi:"Divebomb / Overly Ambitious Lunge (10s)", RP7St:"Divebomb / Overly Ambitious Lunge (30s)", RP7Se:"Divebomb / Overly Ambitious Lunge (SG30)",
      RP8Mi:"Rear-End Collision (Braking Zone) (5s)", RP8St:"Rear-End Collision (Braking Zone) (15s)", RP8Se:"Rear-End Collision (Braking Zone) (SG30)",
      RP9Mi:"Squeezing Off Track / Not Leaving Room (5s)", RP9St:"Squeezing Off Track / Not Leaving Room (15s)", RP9Se:"Squeezing Off Track / Not Leaving Room (SG30)",
      RP10Mi:"Excessive flashing (10s)", RP10St:"Excessive flashing (10s)", RP10Se:"Excessive flashing (10s)",
      RP11Mi:"Intentional Ramming (DQ)", RP11St:"Intentional Ramming (DQ)", RP11Se:"Intentional Ramming (DQ)"
    };

    async function generateDiscordForm(ticketId, ticketData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4", lineHeight: 1.2 });

      const ifwlLogoUrl = "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/ifwl_logo.png";
      let ifwlImgData;
      try { ifwlImgData = await getImageDataURL(ifwlLogoUrl); } catch (e) { console.warn("Could not load IFWL logo:", e); }
      let y = 10;
      if (ifwlImgData) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgWidthMM = 60;
        const imgProps = doc.getImageProperties(ifwlImgData);
        const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
        const x = (pageWidth - imgWidthMM) / 2;
        doc.addImage(ifwlImgData, "PNG", x, y, imgWidthMM, imgHeightMM);
        y += imgHeightMM + 10;
      }

      doc.setFontSize(16); doc.setFont("helvetica","bold");
      doc.text("IFWL Steward Decision", doc.internal.pageSize.getWidth()/2, y, { align: "center" }); y += 12;

      doc.setFontSize(11); doc.setFont("helvetica","bold"); doc.text("From:", 15, y);
      doc.setFont("helvetica","normal"); doc.text("The Stewards", 25, y);
      const rightX = doc.internal.pageSize.getWidth() - 15;
      doc.setFont("helvetica","bold"); doc.text(`Document: ${ticketId}`, rightX, y, { align: "right" }); y += 8;

      doc.setFont("helvetica","bold"); doc.text("To:", 15, y);
      doc.setFont("helvetica","normal"); doc.text(ticketData.reporter || "—", 25, y);

      let dateStr = "—", timeStr = "—";
      if (ticketData.timestamp && ticketData.timestamp.toDate) {
        const d = ticketData.timestamp.toDate();
        dateStr = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0");
        timeStr = String(d.getHours()).padStart(2,"0")+":"+String(d.getMinutes()).padStart(2,"0");
      }
      doc.setFont("helvetica","bold"); doc.text("Date:", rightX, y, { align: "right" });
      doc.setFont("helvetica","normal"); doc.text(dateStr, rightX-20, y, { align: "right" });
      doc.setFont("helvetica","bold"); doc.text("Time:", rightX-45, y, { align: "right" });
      doc.setFont("helvetica","normal"); doc.text(timeStr, rightX-65, y, { align: "right" }); y += 12;

      doc.setFont("helvetica","normal");
      const intro = "The IFWL.NET Racing Stewards, having received a formal report from one of our drivers, have officially opened the ticket detailed below. At present, the stewards are undertaking a comprehensive review, which includes gathering any available telemetry data & consulting relevant race footage. Please refer to the ticket for full details on the current status, next steps, and any additional documentation submitted.";
      const introLines = doc.splitTextToSize(intro, 180);
      doc.text(introLines, 15, y); y += introLines.length * 6 + 8;

      doc.setFont("helvetica","bold"); doc.text("No / Driver:", 15, y);
      doc.setFont("helvetica","normal"); doc.text(ticketData.accused || "—", 45, y); y += 8;

      doc.setFont("helvetica","bold"); doc.text("Competitor:", 15, y);
      doc.setFont("helvetica","normal"); doc.text(ticketData.competition || "—", 45, y); y += 8;

      doc.setFont("helvetica","bold"); doc.text("Time:", 15, y);
      doc.setFont("helvetica","normal"); doc.text(timeStr, 45, y); y += 8;

      doc.setFont("helvetica","bold"); doc.text("Session:", 15, y);
      doc.setFont("helvetica","normal"); doc.text(ticketData.event || "—", 45, y); y += 8;

      doc.setFont("helvetica","bold"); doc.text("Status:", 15, y);
      doc.setFont("helvetica","normal"); doc.text(ticketData.status || "—", 45, y); y += 12;

      doc.setFont("helvetica","bold"); doc.text("Fact:", 15, y);
      doc.setFont("helvetica","normal"); const factLines = doc.splitTextToSize(ticketData.fullIncident || "—", 150);
      doc.text(factLines, 45, y); y += factLines.length * 6 + 4;

      doc.setFont("helvetica","bold"); doc.text("Offence:", 15, y);
      doc.setFont("helvetica","normal"); const offenceLines = doc.splitTextToSize(ticketData.ruleBreach || "—", 150);
      doc.text(offenceLines, 45, y); y += offenceLines.length * 6 + 4;

      doc.setFont("helvetica","bold"); doc.text("Decision:", 15, y);
      doc.setFont("helvetica","normal"); const decisionLines = doc.splitTextToSize(ticketData.stewardDecision || "—", 150);
      doc.text(decisionLines, 45, y); y += decisionLines.length * 6 + 4;

      doc.setFont("helvetica","bold"); doc.text("Reason:", 15, y);
      doc.setFont("helvetica","normal"); const reasonLines = doc.splitTextToSize(ticketData.fullIncident || "—", 150);
      doc.text(reasonLines, 45, y); y += reasonLines.length * 6 + 8;

      doc.setFont("helvetica","bold"); doc.text("Post-Race Code:", 15, y);
      doc.setFont("helvetica","normal");
      const prc = ticketData.postRaceCode || "";
      const prcDesc = prc && postRaceCodeLookup[prc] ? `${prc} – ${postRaceCodeLookup[prc]}` : "—";
      doc.text(prcDesc, 60, y); y += 8;

      doc.setFont("helvetica","bold"); doc.text("Future Advice:", 15, y);
      doc.setFont("helvetica","normal"); const adviceLines = doc.splitTextToSize(ticketData.futureAdvice || "—", 150);
      doc.text(adviceLines, 45, y); y += adviceLines.length * 6 + 4;

      doc.setFont("helvetica","bold"); doc.text("The Stewards", 15, y); y += 12;

      const logoMap = {
        "ACC - BEGINNER CONSOLE": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - BEGINNER PC": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - PRO AM CONSOLE": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - PRO AM PC": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - ENDURO SOLO": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - ENDURO TEAMS": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - GMC": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - AMATEUR PC": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - AMATEUR CONSOLE": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "AC - all game modes": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/aclogo.webp",
        "AC EVO - all game modes": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acevologo.webp",
        "F1 2025": "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/formulaonelogo.webp"
      };
      const compName = ticketData.competition || "";
      if (logoMap[compName]) {
        let raceLogoData;
        try { raceLogoData = await getImageDataURL(logoMap[compName]); } catch (e) { console.warn("Could not load race logo:", e); }
        if (raceLogoData) {
          const pageWidth = doc.internal.pageSize.getWidth();
          const imgWidthMM = 40;
          const imgProps = doc.getImageProperties(raceLogoData);
          const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
          const x = (pageWidth - imgWidthMM) / 2;
          doc.addImage(raceLogoData, "WEBP", x, y, imgWidthMM, imgHeightMM);
          y += imgHeightMM + 10;
        }
      }

      doc.setFont("helvetica","italic"); doc.setFontSize(10);
      const now = new Date();
      const footerText = `Generated: ${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,"0")}-${String(now.getDate()).padStart(2,"0")} ${String(now.getHours()).padStart(2,"0")}:${String(now.getMinutes()).padStart(2,"0")}`;
      doc.text(footerText, 15, doc.internal.pageSize.getHeight() - 15);

      doc.save(`IFWL_StewardDecision_${ticketId}.pdf`);
    }

    // Overview PDF button (now safe; Firebase is initialized)
    overviewAdminBtn.addEventListener("click", async () => {
      const fourDaysAgo = new Date();
      fourDaysAgo.setDate(fourDaysAgo.getDate() - 4);
      const ticketsCol = collection(db, "tickets");
      const q = query(ticketsCol, where("timestamp", ">=", fourDaysAgo), orderBy("timestamp","asc"));
      const snapshot = await getDocs(q);
      if (snapshot.empty) { alert("No tickets found in the last 4 days."); return; }

      const penaltyTimeMap = {
        RP1mi:"10s", RP1St:"30s", RP1Se:"SG30",
        RP2mi:"10s", RP2St:"30s", RP2Se:"SG30",
        RP3mi:"5s", RP3St:"15s", RP3Se:"SG30",
        RP4mi:"30s", RP4St:"SG30", RP4Se:"DQ",
        RP5mi:"5s", RP5St:"15s", RP5Se:"30s",
        RP6mi:"5s", RP6St:"30s", RP6Se:"SG30",
        RP7mi:"10s", RP7St:"30s", RP7Se:"SG30",
        RP8Mi:"5s", RP8St:"15s", RP8Se:"SG30",
        RP9Mi:"5s", RP9St:"15s", RP9Se:"SG30",
        RP10Mi:"10s", RP10St:"10s", RP10Se:"10s",
        RP11Mi:"DQ", RP11St:"DQ", RP11Se:"DQ"
      };

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 30;
      doc.setFontSize(16);
      doc.text("Ticket Overview (Last 4 Days)", 14, 20);
      doc.setFontSize(12);
      doc.text("Driver (ID)", 14, y);
      doc.text("Competition", 80, y);
      doc.text("Code", 160, y);
      y += 8;

      snapshot.docs.forEach((docSnap) => {
        const data = docSnap.data();
        const accused = data.accused || "";
        const competition = data.competition || "";
        const code = data.postRaceCode || "";
        const penalty = code && penaltyTimeMap[code] ? penaltyTimeMap[code] : "-";
        doc.text(accused, 14, y);
        doc.text(competition, 80, y);
        doc.text(penalty, 160, y);
        y += 8;
        if (y > 280) { doc.addPage(); y = 20; }
      });

      doc.save("ticket_overview.pdf");
    });

    // Default: show menu
    showSection(menuSection);
  </script>
</body>
</html>
