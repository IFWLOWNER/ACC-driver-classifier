<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Tickets • Admin Detailed View with PDF Export</title>
  <style>
    /* ------------------------------------------------------------
       Base styling for the entire page
       ------------------------------------------------------------ */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #6200EE;
      width: 100%;
      padding: 12px 0;
      color: #fff;
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 24px;
      position: relative;
    }
    .logout-btn {
      background-color: transparent;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 16px;
      top: 12px;
    }

    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 24px;
      max-width: 800px;
      width: 100%;
      margin-bottom: 24px;
    }
    .section-title {
      margin-top: 0;
      text-align: center;
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"],
    input[type="url"],
    input[type="email"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #6200EE;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .link-btn {
      background: none;
      border: none;
      color: #6200EE;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .status.error { color: #c00; }
    .status.success { color: #080; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #eee;
    }

    .hidden {
      display: none;
    }

    /* ------------------------------------------------------------
       Highlight full ticket row if appealed
       ------------------------------------------------------------ */
    .appeal-highlight {
      background-color: #fffbe6; /* light yellow background */
    }

    /* ------------------------------------------------------------
       Styles for the inline appeal form in public view
       ------------------------------------------------------------ */
    .appeal-form {
      background: #fafafa;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .appeal-form input[type="text"],
    .appeal-form textarea {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .appeal-form button {
      width: auto;
      margin-right: 8px;
    }

    /* ------------------------------------------------------------
       Styles for the detailed view row in admin
       ------------------------------------------------------------ */
    .detailRow td {
      background-color: #eef7ff; /* very light blue */
      padding: 0;
    }
    .detail-container {
      padding: 16px;
      font-size: 0.95rem;
    }
    .detail-container p {
      margin: 4px 0;
    }
    .detail-container hr {
      margin: 12px 0;
      border: none;
      border-top: 1px solid #ccc;
    }
    .detail-container .appeal-box {
      padding: 8px;
      border: 1px solid #f5e6a0;
      border-radius: 4px;
      background-color: #fffdf0;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #333;
    }
    .detail-container .appeal-box strong {
      color: #b36b00;
    }
    .detail-container .review-form {
      background: #eef7ff;
      padding: 12px;
      border: 1px solid #9ecfff;
      border-radius: 6px;
      margin-top: 12px;
    }
    .detail-container .review-form select,
    .detail-container .review-form textarea,
    .detail-container .review-form input[type="text"] {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .detail-container .review-form button {
      width: auto;
      margin-right: 8px;
    }
  </style>
  <!-- jsPDF UMD build for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    IFWL Ticketing System
    <button id="logoutBtn" class="logout-btn hidden">Logout</button>
  </header>

  <!-- ==============================================================
       SECTION 1: SUBMIT A NEW TICKET (VISIBLE TO EVERYONE)
       ============================================================== -->
  <div id="submitSection" class="container">
    <h2 class="section-title">Submit a New Ticket</h2>
    <div class="form-group">
      <label for="accused">Accused <span style="color: red;">*</span></label>
      <input type="text" id="accused" placeholder="e.g. Bob Jones" required />
    </div>
    <div class="form-group">
      <label for="competition">Competition <span style="color: red;">*</span></label>
      <input type="text" id="competition" placeholder="e.g. IFWL Sprint" required />
    </div>
    <div class="form-group">
      <label for="content">Content <span style="color: red;">*</span></label>
      <textarea id="content" placeholder="Full content/details of ticket" required></textarea>
    </div>
    <div class="form-group">
      <label for="event">Event</label>
      <input type="text" id="event" placeholder="e.g. Race 3: Heat A" />
    </div>
    <div class="form-group">
      <label for="proofUrl">Proof URL</label>
      <input type="url" id="proofUrl" placeholder="https://example.com/video" />
    </div>
    <div class="form-group">
      <label for="race">Race</label>
      <input type="text" id="race" placeholder="e.g. Race #12" />
    </div>
    <div class="form-group">
      <label for="reason">Reason <span style="color: red;">*</span></label>
      <textarea id="reason" placeholder="Reason for filing this ticket" required></textarea>
    </div>
    <div class="form-group">
      <label for="reporter">Reporter <span style="color: red;">*</span></label>
      <input type="text" id="reporter" placeholder="e.g. Alice Smith" required />
    </div>
    <div class="form-group">
      <label for="season">Season</label>
      <input type="text" id="season" placeholder="e.g. Summer 2025" />
    </div>
    <div class="form-group">
      <label for="steward">Steward (if assigned)</label>
      <input type="text" id="steward" placeholder="e.g. StewardName" />
    </div>
    <div class="form-group">
      <label for="track">Track</label>
      <input type="text" id="track" placeholder="e.g. Silverstone" />
    </div>
    <button id="submitBtn">Submit Ticket</button>
    <div class="status" id="statusMsg"></div>

    <button id="viewTicketsBtn" class="link-btn">View All Tickets</button>
    <button id="loginToggleBtn" class="link-btn">Admin Login</button>
  </div>

  <!-- ==============================================================
       SECTION 2: VIEW ALL TICKETS (PUBLIC, WITH INLINE APPEAL FORM)
       ============================================================== -->
  <div id="viewSection" class="container hidden">
    <h2 class="section-title">All Submitted Tickets</h2>
    <div id="ticketsListContainer">
      <!-- Public table + inline appeal form will be injected here -->
    </div>
    <button id="backFromViewBtn" class="link-btn">← Back to Submit</button>
  </div>

  <!-- ==============================================================
       SECTION 3: LOGIN FORM (for Admins)
       ============================================================== -->
  <div id="loginSection" class="container hidden">
    <h2 class="section-title">Admin Sign-In</h2>
    <div class="form-group">
      <label for="email">Email <span style="color: red;">*</span></label>
      <input type="email" id="email" placeholder="admin@example.com" required />
    </div>
    <div class="form-group">
      <label for="password">Password <span style="color: red;">*</span></label>
      <input type="password" id="password" placeholder="••••••••" required />
    </div>
    <button id="loginBtn">Login</button>
    <div class="status" id="loginStatusMsg"></div>
    <button id="backFromLoginBtn" class="link-btn">← Back</button>
  </div>

  <!-- ==============================================================
       SECTION 4: ADMIN DASHBOARD (PRIVATE, WITH DETAIL VIEW)
       ============================================================== -->
  <div id="adminSection" class="container hidden">
    <h2 class="section-title">Admin Dashboard</h2>
    <div id="adminTicketsContainer">
      <!-- Admin table will be injected here -->
    </div>
  </div>

  <!-- ==============================================================
       Firebase v9+ Modular SDK & App Logic
       ============================================================== -->
  <script type="module">
    // 1) Import required Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      query,
      orderBy,
      serverTimestamp,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // 2) Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    // 3) Initialize Firebase
    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);
    const auth  = getAuth(app);

    // 4) Cache DOM elements
    const submitSection        = document.getElementById("submitSection");
    const viewSection          = document.getElementById("viewSection");
    const loginSection         = document.getElementById("loginSection");
    const adminSection         = document.getElementById("adminSection");

    // Submit‐ticket elements
    const accusedInput         = document.getElementById("accused");
    const competitionInput     = document.getElementById("competition");
    const contentInput         = document.getElementById("content");
    const eventInput           = document.getElementById("event");
    const proofUrlInput        = document.getElementById("proofUrl");
    const raceInput            = document.getElementById("race");
    const reasonInput          = document.getElementById("reason");
    const reporterInput        = document.getElementById("reporter");
    const seasonInput          = document.getElementById("season");
    const stewardInput         = document.getElementById("steward");
    const trackInput           = document.getElementById("track");
    const submitBtn            = document.getElementById("submitBtn");
    const statusMsg            = document.getElementById("statusMsg");

    // View all tickets (public) elements
    const viewTicketsBtn       = document.getElementById("viewTicketsBtn");
    const backFromViewBtn      = document.getElementById("backFromViewBtn");
    const ticketsListContainer = document.getElementById("ticketsListContainer");

    // Login (admin) elements
    const loginToggleBtn       = document.getElementById("loginToggleBtn");
    const loginBtn             = document.getElementById("loginBtn");
    const backFromLoginBtn     = document.getElementById("backFromLoginBtn");
    const emailInput           = document.getElementById("email");
    const passwordInput        = document.getElementById("password");
    const loginStatusMsg       = document.getElementById("loginStatusMsg");

    // Admin dashboard elements
    const logoutBtn            = document.getElementById("logoutBtn");
    const adminTicketsContainer = document.getElementById("adminTicketsContainer");

    // ----------------------------------------------------------------
    // UTILITY: Show exactly one section at a time
    // ----------------------------------------------------------------
    function showSection(sectionToShow) {
      [submitSection, viewSection, loginSection, adminSection].forEach(sec => {
        sec.classList.add("hidden");
      });
      sectionToShow.classList.remove("hidden");
    }

    // ----------------------------------------------------------------
    // 5) HANDLE “SUBMIT TICKET” (public)
    // ----------------------------------------------------------------
    submitBtn.addEventListener("click", async () => {
      submitBtn.disabled = true;
      statusMsg.textContent = "Submitting…";
      statusMsg.className = "status";

      const accused     = accusedInput.value.trim();
      const competition = competitionInput.value.trim();
      const content     = contentInput.value.trim();
      const event       = eventInput.value.trim();
      const proofUrl    = proofUrlInput.value.trim();
      const race        = raceInput.value.trim();
      const reason      = reasonInput.value.trim();
      const reporter    = reporterInput.value.trim();
      const season      = seasonInput.value.trim();
      const steward     = stewardInput.value.trim();
      const track       = trackInput.value.trim();

      if (!accused || !competition || !content || !reason || !reporter) {
        statusMsg.textContent = "Please fill in all required fields: Accused, Competition, Content, Reason, Reporter.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }
      const newTicket = {
        accused:         accused,
        competition:     competition,
        content:         content,
        event:           event,
        proofUrl:        proofUrl,
        race:            race,
        reason:          reason,
        reporter:        reporter,
        season:          season,
        steward:         steward,
        track:           track,
        status:          "New Submission",
        stewardDecision: "",
        stewardTag:      "",
        timestamp:       serverTimestamp()
      };
      try {
        const docRef = await addDoc(collection(db, "tickets"), newTicket);
        statusMsg.textContent = `Ticket submitted (ID: ${docRef.id}). Thank you!`;
        statusMsg.className = "status success";
        // Clear fields
        accusedInput.value     = "";
        competitionInput.value = "";
        contentInput.value     = "";
        eventInput.value       = "";
        proofUrlInput.value    = "";
        raceInput.value        = "";
        reasonInput.value      = "";
        reporterInput.value    = "";
        seasonInput.value      = "";
        stewardInput.value     = "";
        trackInput.value       = "";
      } catch (error) {
        console.error("Error writing ticket: ", error);
        statusMsg.textContent = "Error submitting ticket. Please try again.";
        statusMsg.className = "status error";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ----------------------------------------------------------------
    // 6) INLINE APPEAL FORM HELPER (public)
    // ----------------------------------------------------------------
    function toggleAppealForm(ticketId, container) {
      // Remove any existing appeal form row
      const existingForm = container.querySelector(".appealFormRow");
      if (existingForm) {
        existingForm.remove();
      }

      // Find the <tr data-id="{ticketId}">
      const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
      if (!ticketRow) return;

      // Create a new <tr> right after ticketRow
      const formRow = document.createElement("tr");
      formRow.classList.add("appealFormRow");
      formRow.innerHTML = `
        <td colspan="7">
          <div class="appeal-form">
            <label for="appealInfo-${ticketId}"><strong>Appeal Info</strong></label>
            <textarea id="appealInfo-${ticketId}" placeholder="Enter your appeal details…" rows="3"></textarea>
            <label for="extraProof-${ticketId}"><strong>Extra Video Proof URL</strong></label>
            <input type="url" id="extraProof-${ticketId}" placeholder="https://example.com/extra-proof" />
            <div style="margin-top: 8px;">
              <button id="submitAppeal-${ticketId}">Submit Appeal</button>
              <button id="cancelAppeal-${ticketId}" style="background-color: #999; margin-left:8px;">Cancel</button>
            </div>
            <div id="appealStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
          </div>
        </td>
      `;
      ticketRow.insertAdjacentElement("afterend", formRow);

      // Wire up the “Cancel” button
      document.getElementById(`cancelAppeal-${ticketId}`).addEventListener("click", () => {
        formRow.remove();
      });

      // Wire up the “Submit Appeal” button
      document.getElementById(`submitAppeal-${ticketId}`).addEventListener("click", async () => {
        const appealInfoInput = document.getElementById(`appealInfo-${ticketId}`);
        const extraProofInput = document.getElementById(`extraProof-${ticketId}`);
        const appealStatusDiv = document.getElementById(`appealStatus-${ticketId}`);
        const appealInfoValue = appealInfoInput.value.trim();
        const extraProofValue = extraProofInput.value.trim();

        if (!appealInfoValue) {
          appealStatusDiv.textContent = "Please enter your appeal details.";
          appealStatusDiv.className = "status error";
          return;
        }
        appealStatusDiv.textContent = "Submitting appeal…";
        appealStatusDiv.className = "status";

        try {
          const appealsColRef = collection(db, "tickets", ticketId, "appeals");
          await addDoc(appealsColRef, {
            appealInfo:   appealInfoValue,
            extraProofUrl: extraProofValue,
            timestamp:    serverTimestamp()
          });
          appealStatusDiv.textContent = "Appeal submitted! We’ll review it soon.";
          appealStatusDiv.className = "status success";
          setTimeout(() => {
            formRow.remove();
          }, 2000);
        } catch (err) {
          console.error("Error submitting appeal:", err);
          appealStatusDiv.textContent = "Error submitting appeal. Please try again.";
          appealStatusDiv.className = "status error";
        }
      });
    }

    // ----------------------------------------------------------------
    // 7) TOGGLE DETAIL VIEW (admin): Show full ticket + appeals + review form + PDF button
    // ----------------------------------------------------------------
    async function toggleDetailView(ticketId, container) {
      // Remove any existing .detailRow
      const existingDetail = container.querySelector(".detailRow");
      if (existingDetail) {
        existingDetail.remove();
      }

      // Find the <tr data-id="{ticketId}">
      const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
      if (!ticketRow) return;

      // Fetch the ticket document
      const ticketDocRef = doc(db, "tickets", ticketId);
      const ticketSnap = await getDoc(ticketDocRef);
      if (!ticketSnap.exists()) return;
      const ticketData = ticketSnap.data();

      // Fetch any appeals for this ticket
      const appealsRef = collection(db, "tickets", ticketId, "appeals");
      const appealsSnapshot = await getDocs(appealsRef);
      let appealsHTML = "";
      if (!appealsSnapshot.empty) {
        appealsSnapshot.forEach(appSnap => {
          const appealData = appSnap.data();
          const appealTs = appealData.timestamp && appealData.timestamp.toDate
            ? appealData.timestamp.toDate().toLocaleString()
            : "";
          appealsHTML += `
            <div class="appeal-box">
              <div><strong>Appeal:</strong> ${appealData.appealInfo}</div>
              <div><strong>Extra Video Proof:</strong> ${appealData.extraProofUrl || "N/A"}</div>
              <div style="margin-top:4px; font-size:0.8rem; color:#555;">
                <em>Submitted: ${appealTs}</em>
              </div>
            </div>
          `;
        });
      }

      // Build the detail HTML
      const detailRow = document.createElement("tr");
      detailRow.classList.add("detailRow");
      detailRow.innerHTML = `
        <td colspan="7">
          <div class="detail-container">
            <h3>Ticket Details</h3>
            <p><strong>ID:</strong> ${ticketId}</p>
            <p><strong>Accused:</strong> ${ticketData.accused || ""}</p>
            <p><strong>Competition:</strong> ${ticketData.competition || ""}</p>
            <p><strong>Content / Incident Comments:</strong> ${ticketData.content || ""}</p>
            <p><strong>Event:</strong> ${ticketData.event || ""}</p>
            <p><strong>Race:</strong> ${ticketData.race || ""}</p>
            <p><strong>Reason:</strong> ${ticketData.reason || ""}</p>
            <p><strong>Reporter:</strong> ${ticketData.reporter || ""}</p>
            <p><strong>Season:</strong> ${ticketData.season || ""}</p>
            <p><strong>Steward (assigned):</strong> ${ticketData.steward || ""}</p>
            <p><strong>Track:</strong> ${ticketData.track || ""}</p>
            <p><strong>Status:</strong> ${ticketData.status || ""}</p>
            ${ticketData.stewardDecision 
              ? `<p><strong>Steward Decision:</strong> ${ticketData.stewardDecision}</p>` 
              : ""}
            ${ticketData.stewardTag 
              ? `<p><strong>Steward Tag:</strong> ${ticketData.stewardTag}</p>` 
              : ""}
            <p><strong>Submitted At:</strong> ${
              (ticketData.timestamp && ticketData.timestamp.toDate)
                ? ticketData.timestamp.toDate().toLocaleString()
                : ""
            }</p>
            ${appealsHTML 
              ? `<hr><h4>Appeals</h4>${appealsHTML}` 
              : ""}
            <hr>
            <div class="review-form">
              <h4>Admin Review</h4>
              <label for="statusSelect-${ticketId}"><strong>Select Outcome</strong></label>
              <select id="statusSelect-${ticketId}">
                <option value="Under Review" ${ticketData.status === "Under Review" ? "selected" : ""}>Under Review</option>
                <option value="Finalised" ${ticketData.status === "Finalised" ? "selected" : ""}>Finalised</option>
                <option value="Appeal In Progress" ${ticketData.status === "Appeal In Progress" ? "selected" : ""}>Appeal In Progress</option>
              </select>

              <label for="decisionText-${ticketId}"><strong>Steward Decision</strong></label>
              <textarea id="decisionText-${ticketId}" placeholder="Enter your decision…" rows="3">${ticketData.stewardDecision || ""}</textarea>

              <label for="stewardTag-${ticketId}"><strong>Steward Tag (e.g. Steward – IOC)</strong></label>
              <input type="text" id="stewardTag-${ticketId}" 
                     placeholder="e.g. Steward – IOC" 
                     value="${ticketData.stewardTag || ""}" />

              <div style="margin-top: 8px;">
                <button id="submitReview-${ticketId}">Update Ticket</button>
                <button id="cancelDetail-${ticketId}" style="background-color: #999; margin-left:8px;">Close</button>
                <button id="generatePDF-${ticketId}" style="background-color: #333; margin-left:8px;">
                  Generate Discord Form
                </button>
              </div>
              <div id="detailStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
            </div>
          </div>
        </td>
      `;
      ticketRow.insertAdjacentElement("afterend", detailRow);

      // Wire up the Cancel button
      document.getElementById(`cancelDetail-${ticketId}`).addEventListener("click", () => {
        detailRow.remove();
      });

      // Wire up the Submit Review button
      document.getElementById(`submitReview-${ticketId}`).addEventListener("click", async () => {
        const statusSelect    = document.getElementById(`statusSelect-${ticketId}`);
        const decisionInput   = document.getElementById(`decisionText-${ticketId}`);
        const stewardTagInput = document.getElementById(`stewardTag-${ticketId}`);
        const detailStatusDiv = document.getElementById(`detailStatus-${ticketId}`);
        const newStatus       = statusSelect.value;
        const decisionText    = decisionInput.value.trim();
        const stewardTagVal   = stewardTagInput.value.trim();

        if (!decisionText) {
          detailStatusDiv.textContent = "Please enter a steward decision.";
          detailStatusDiv.className = "status error";
          return;
        }
        if (!stewardTagVal) {
          detailStatusDiv.textContent = "Please enter a steward tag.";
          detailStatusDiv.className = "status error";
          return;
        }

        detailStatusDiv.textContent = "Updating ticket…";
        detailStatusDiv.className = "status";

        try {
          const ticketRef = doc(db, "tickets", ticketId);
          await updateDoc(ticketRef, {
            status:          newStatus,
            stewardDecision: decisionText,
            stewardTag:      stewardTagVal
          });
          detailStatusDiv.textContent = "Ticket updated!";
          detailStatusDiv.className = "status success";
          setTimeout(async () => {
            await fetchAndRenderTickets(adminTicketsContainer, true);
          }, 800);
        } catch (err) {
          console.error("Error updating ticket:", err);
          detailStatusDiv.textContent = "Error updating ticket. Please try again.";
          detailStatusDiv.className = "status error";
        }
      });

      // Wire up the Generate PDF button
      document.getElementById(`generatePDF-${ticketId}`).addEventListener("click", async () => {
        await generateDiscordForm(ticketId, ticketData);
      });
    }

    // ----------------------------------------------------------------
    // 8) FETCH & RENDER TICKETS (public vs. admin)
    // ----------------------------------------------------------------
    async function fetchAndRenderTickets(targetContainer, isAdmin = false) {
      const ticketsCol   = collection(db, "tickets");
      const ticketsQuery = query(ticketsCol, orderBy("timestamp", "desc"));

      try {
        const snapshot = await getDocs(ticketsQuery);
        if (snapshot.empty) {
          targetContainer.innerHTML = "<p>No tickets have been submitted yet.</p>";
          return;
        }

        // Build table header
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Accused</th>
                <th>Competition</th>
                <th>Reporter</th>
                <th>Status</th>
                <th>Submitted At</th>
                ${isAdmin 
                  ? "<th>Action</th>" 
                  : "<th>Appeal</th>"}
              </tr>
            </thead>
            <tbody>
        `;

        // Build each ticket row
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const ts   = data.timestamp && data.timestamp.toDate 
                        ? data.timestamp.toDate().toLocaleString() 
                        : "";
          const id   = docSnap.id;

          tableHTML += `
            <tr data-id="${id}" class="ticketRow">
              <td>${id}</td>
              <td>${data.accused || ""}</td>
              <td>${data.competition || ""}</td>
              <td>${data.reporter || ""}</td>
              <td>${data.status || ""}</td>
              <td>${ts}</td>
              ${isAdmin 
                ? `<td>
                    <button data-id="${id}" class="openBtn">Open</button>
                   </td>`
                : `<td>
                    <button data-id="${id}" class="appealBtn">Appeal</button>
                   </td>`}
            </tr>
          `;
        });

        tableHTML += `</tbody></table>`;
        targetContainer.innerHTML = tableHTML;

        if (isAdmin) {
          // 8.a) For each ticket row, check if appeals exist → add highlight class
          const ticketRows = targetContainer.querySelectorAll("tr.ticketRow");
          ticketRows.forEach(async (row) => {
            const ticketId = row.getAttribute("data-id");
            const appealsRef = collection(db, "tickets", ticketId, "appeals");
            const appealsSnapshot = await getDocs(appealsRef);

            if (!appealsSnapshot.empty) {
              row.classList.add("appeal-highlight");
            }
          });

          // 8.b) Wire up “Open” buttons to show detail view
          const openBtns = targetContainer.querySelectorAll(".openBtn");
          openBtns.forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleDetailView(ticketId, targetContainer);
            });
          });
        } else {
          // PUBLIC – wire up “Appeal” buttons
          const appealBtns = targetContainer.querySelectorAll(".appealBtn");
          appealBtns.forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleAppealForm(ticketId, targetContainer);
            });
          });
        }

      } catch (err) {
        console.error("Error fetching tickets:", err);
        targetContainer.innerHTML = "<p>Error loading tickets.</p>";
      }
    }

    // ----------------------------------------------------------------
    // 9) “View All Tickets” BUTTON (public)
    // ----------------------------------------------------------------
    viewTicketsBtn.addEventListener("click", async () => {
      showSection(viewSection);
      ticketsListContainer.innerHTML = "<p>Loading tickets…</p>";
      await fetchAndRenderTickets(ticketsListContainer, false);
    });
    backFromViewBtn.addEventListener("click", () => {
      showSection(submitSection);
    });

    // ----------------------------------------------------------------
    // 10) ADMIN LOGIN / AUTHENTICATION
    // ----------------------------------------------------------------
    loginToggleBtn.addEventListener("click", () => {
      loginStatusMsg.textContent = "";
      emailInput.value = "";
      passwordInput.value = "";
      showSection(loginSection);
    });
    backFromLoginBtn.addEventListener("click", () => {
      showSection(submitSection);
    });

    loginBtn.addEventListener("click", async () => {
      loginBtn.disabled = true;
      loginStatusMsg.textContent = "Signing in…";
      loginStatusMsg.className = "status";
      const email = emailInput.value.trim();
      const pw    = passwordInput.value.trim();
      if (!email || !pw) {
        loginStatusMsg.textContent = "Email & password are required.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (err) {
        console.error("Login error:", err);
        loginStatusMsg.textContent = "Login failed. Check credentials.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ----------------------------------------------------------------
    // 11) LISTEN FOR AUTH STATE CHANGES
    // ----------------------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        logoutBtn.classList.remove("hidden");
        showSection(adminSection);
        adminTicketsContainer.innerHTML = "<p>Loading tickets…</p>";
        await fetchAndRenderTickets(adminTicketsContainer, true);
      } else {
        logoutBtn.classList.add("hidden");
        showSection(submitSection);
      }
    });

    // On initial load, show the “Submit Ticket” section
    showSection(submitSection);

    // ----------------------------------------------------------------
    // 12) PDF GENERATION: Helper to convert image URL to Data URL
    // ----------------------------------------------------------------
    function getImageDataURL(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.setAttribute("crossOrigin", "anonymous");
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = function(e) {
          reject(e);
        };
        img.src = url;
      });
    }

    // ----------------------------------------------------------------
    // 13) GENERATE DISCORD FORM (PDF) for a given ticket
    // ----------------------------------------------------------------
    async function generateDiscordForm(ticketId, ticketData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "mm", format: "a4" });

      // 1) Load IFWL logo from GitHub (raw URL). Center at top.
      const logoUrl = "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/ifwl_logo.png";
      let imgData;
      try {
        imgData = await getImageDataURL(logoUrl);
      } catch (e) {
        console.warn("Could not load logo for PDF:", e);
      }
      let y = 10;
      if (imgData) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgWidthMM = 60;
        const imgProps = doc.getImageProperties(imgData);
        const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
        const x = (pageWidth - imgWidthMM) / 2;
        doc.addImage(imgData, "PNG", x, y, imgWidthMM, imgHeightMM);
        y += imgHeightMM + 10;
      }

      // 2) Header
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("IFWL Ticket Report", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
      y += 12;

      // 3) Accused, Reporter, Status, Incident Comments
      doc.setFontSize(14);
      doc.setFont("helvetica", "normal");
      doc.text(`Accused: ${ticketData.accused || ""}`, 15, y);
      y += 8;
      doc.text(`Reporter: ${ticketData.reporter || ""}`, 15, y);
      y += 8;
      doc.text(`Status: ${ticketData.status || ""}`, 15, y);
      y += 8;

      doc.text("Incident Comments:", 15, y);
      y += 6;
      doc.setFontSize(12);
      const pageWidth = doc.internal.pageSize.getWidth();
      const usableWidth = pageWidth - 30;
      const splitContent = doc.splitTextToSize(ticketData.content || "", usableWidth);
      doc.text(splitContent, 15, y);
      y += splitContent.length * 6 + 4;

      // 4) Steward Tag or “UNDER REVIEW”
      const stewardTagVal = ticketData.stewardTag || "UNDER REVIEW";
      doc.setFontSize(14);
      doc.text(`Steward: ${stewardTagVal}`, 15, y);
      y += 10;

      // 5) Footer timestamp
      doc.setFontSize(10);
      doc.setTextColor(100);
      const now = new Date();
      doc.text(
        `Generated: ${now.toLocaleDateString()} ${now.toLocaleTimeString()}`,
        15,
        doc.internal.pageSize.getHeight() - 15
      );

      // 6) Save PDF
      doc.save(`IFWL_ticket_${ticketId}.pdf`);
    }
  </script>
</body>
</html>
