<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Tickets • Submit & View</title>
  <style>
    /* Basic reset + form styling (you can adjust to match your branding) */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #6200EE;
      width: 100%;
      padding: 12px 0;
      color: #fff;
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 24px;
    }
    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 24px;
      max-width: 600px;
      width: 100%;
      margin-bottom: 24px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"],
    input[type="url"],
    input[type="email"],
    input[type="password"],
    textarea {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #6200EE;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .status.error { color: #c00; }
    .status.success { color: #080; }
    .link-btn {
      background: none;
      border: none;
      color: #6200EE;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    /* Simple table styling for “View Tickets” and admin dashboard */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #eee;
    }
    .section-title {
      margin-top: 0;
      text-align: center;
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    /* Hide sections by default */
    .hidden {
      display: none;
    }
    .logout-btn {
      background-color: transparent;
      border: 1px solid #6200EE;
      color: #6200EE;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      float: right;
      margin-top: -30px;
    }
  </style>
</head>
<body>
  <header>
    IFWL Ticketing System
    <button id="logoutBtn" class="logout-btn hidden">Logout</button>
  </header>

  <!-- -----------------------------------------------------
       SECTION 1: SUBMIT A NEW TICKET (visible to everyone)
       ----------------------------------------------------- -->
  <div id="submitSection" class="container">
    <h2 class="section-title">Submit a New Ticket</h2>
    <div class="form-group">
      <label for="accused">Accused <span style="color: red;">*</span></label>
      <input type="text" id="accused" placeholder="e.g. Bob Jones" required />
    </div>
    <div class="form-group">
      <label for="competition">Competition <span style="color: red;">*</span></label>
      <input type="text" id="competition" placeholder="e.g. IFWL Sprint" required />
    </div>
    <div class="form-group">
      <label for="content">Content <span style="color: red;">*</span></label>
      <textarea id="content" placeholder="Full content/details of ticket" required></textarea>
    </div>
    <div class="form-group">
      <label for="event">Event</label>
      <input type="text" id="event" placeholder="e.g. Race 3: Heat A" />
    </div>
    <div class="form-group">
      <label for="proofUrl">Proof URL</label>
      <input type="url" id="proofUrl" placeholder="https://example.com/video" />
    </div>
    <div class="form-group">
      <label for="race">Race</label>
      <input type="text" id="race" placeholder="e.g. Race #12" />
    </div>
    <div class="form-group">
      <label for="reason">Reason <span style="color: red;">*</span></label>
      <textarea id="reason" placeholder="Reason for filing this ticket" required></textarea>
    </div>
    <div class="form-group">
      <label for="reporter">Reporter <span style="color: red;">*</span></label>
      <input type="text" id="reporter" placeholder="e.g. Alice Smith" required />
    </div>
    <div class="form-group">
      <label for="season">Season</label>
      <input type="text" id="season" placeholder="e.g. Summer 2025" />
    </div>
    <div class="form-group">
      <label for="steward">Steward (if assigned)</label>
      <input type="text" id="steward" placeholder="e.g. StewardName" />
    </div>
    <div class="form-group">
      <label for="track">Track</label>
      <input type="text" id="track" placeholder="e.g. Silverstone" />
    </div>
    <button id="submitBtn">Submit Ticket</button>
    <div class="status" id="statusMsg"></div>

    <button id="viewTicketsBtn" class="link-btn">View All Tickets</button>
    <button id="loginToggleBtn" class="link-btn">Admin Login</button>
  </div>

  <!-- ------------------------------------
       SECTION 2: VIEW ALL TICKETS (PUBLIC)
       ------------------------------------- -->
  <div id="viewSection" class="container hidden">
    <h2 class="section-title">All Submitted Tickets</h2>
    <div id="ticketsListContainer">
      <!-- We'll inject a <table> of tickets here dynamically -->
    </div>
    <button id="backFromViewBtn" class="link-btn">← Back to Submit</button>
  </div>

  <!-- ------------------------------------
       SECTION 3: LOGIN FORM (for Admins)
       ------------------------------------- -->
  <div id="loginSection" class="container hidden">
    <h2 class="section-title">Admin Sign-In</h2>
    <div class="form-group">
      <label for="email">Email <span style="color: red;">*</span></label>
      <input type="email" id="email" placeholder="admin@example.com" required />
    </div>
    <div class="form-group">
      <label for="password">Password <span style="color: red;">*</span></label>
      <input type="password" id="password" placeholder="••••••••" required />
    </div>
    <button id="loginBtn">Login</button>
    <div class="status" id="loginStatusMsg"></div>
    <button id="backFromLoginBtn" class="link-btn">← Back</button>
  </div>

  <!-- --------------------------------------
       SECTION 4: ADMIN DASHBOARD (Private)
       -------------------------------------- -->
  <div id="adminSection" class="container hidden">
    <h2 class="section-title">Admin Dashboard</h2>
    <div id="adminTicketsContainer">
      <!-- Admin will see a similar table of tickets, possibly with extra columns -->
    </div>
    <!-- (You can add more admin controls here, e.g. change status, assign steward, etc.) -->
  </div>

  <!-- Firebase v9+ Modular SDK -->
  <script type="module">
    // 1) Import the functions you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      query,
      orderBy,
      serverTimestamp,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // 2) Your web app's Firebase configuration (must match your Android app)
    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    // 3) Initialize Firebase & services
    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);
    const auth  = getAuth(app);

    // 4) Get references to DOM elements
    const submitSection      = document.getElementById("submitSection");
    const viewSection        = document.getElementById("viewSection");
    const loginSection       = document.getElementById("loginSection");
    const adminSection       = document.getElementById("adminSection");

    // Submit form fields
    const accusedInput       = document.getElementById("accused");
    const competitionInput   = document.getElementById("competition");
    const contentInput       = document.getElementById("content");
    const eventInput         = document.getElementById("event");
    const proofUrlInput      = document.getElementById("proofUrl");
    const raceInput          = document.getElementById("race");
    const reasonInput        = document.getElementById("reason");
    const reporterInput      = document.getElementById("reporter");
    const seasonInput        = document.getElementById("season");
    const stewardInput       = document.getElementById("steward");
    const trackInput         = document.getElementById("track");
    const submitBtn          = document.getElementById("submitBtn");
    const statusMsg          = document.getElementById("statusMsg");

    // View tickets
    const viewTicketsBtn     = document.getElementById("viewTicketsBtn");
    const backFromViewBtn    = document.getElementById("backFromViewBtn");
    const ticketsListContainer = document.getElementById("ticketsListContainer");

    // Login form
    const loginToggleBtn     = document.getElementById("loginToggleBtn");
    const loginBtn           = document.getElementById("loginBtn");
    const backFromLoginBtn   = document.getElementById("backFromLoginBtn");
    const emailInput         = document.getElementById("email");
    const passwordInput      = document.getElementById("password");
    const loginStatusMsg     = document.getElementById("loginStatusMsg");

    // Admin dashboard
    const logoutBtn          = document.getElementById("logoutBtn");
    const adminTicketsContainer = document.getElementById("adminTicketsContainer");

    // ----------------------------------------------------------------
    // UTILITY: Show/hide sections
    // ----------------------------------------------------------------
    function showSection(sectionToShow) {
      [submitSection, viewSection, loginSection, adminSection].forEach(sec => {
        sec.classList.add("hidden");
      });
      sectionToShow.classList.remove("hidden");
    }

    // ----------------------------------------------------------------
    // 5) HANDLE TICKET SUBMISSION (Same as before, in v9 modular style)
    // ----------------------------------------------------------------
    submitBtn.addEventListener("click", async () => {
      submitBtn.disabled = true;
      statusMsg.textContent = "Submitting…";
      statusMsg.className = "status";

      // Read/trim
      const accused     = accusedInput.value.trim();
      const competition = competitionInput.value.trim();
      const content     = contentInput.value.trim();
      const event       = eventInput.value.trim();
      const proofUrl    = proofUrlInput.value.trim();
      const race        = raceInput.value.trim();
      const reason      = reasonInput.value.trim();
      const reporter    = reporterInput.value.trim();
      const season      = seasonInput.value.trim();
      const steward     = stewardInput.value.trim();
      const track       = trackInput.value.trim();

      // Validate required fields
      if (!accused || !competition || !content || !reason || !reporter) {
        statusMsg.textContent = "Please fill in all required fields: Accused, Competition, Content, Reason, Reporter.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }

      // Build object
      const newTicket = {
        accused:     accused,
        competition: competition,
        content:     content,
        event:       event,
        proofUrl:    proofUrl,
        race:        race,
        reason:      reason,
        reporter:    reporter,
        season:      season,
        steward:     steward,
        track:       track,
        status:      "New Submission",
        timestamp:   serverTimestamp()
      };

      try {
        const docRef = await addDoc(collection(db, "tickets"), newTicket);
        statusMsg.textContent = `Ticket submitted (ID: ${docRef.id}). Thank you!`;
        statusMsg.className = "status success";

        // Clear form
        accusedInput.value = "";
        competitionInput.value = "";
        contentInput.value = "";
        eventInput.value = "";
        proofUrlInput.value = "";
        raceInput.value = "";
        reasonInput.value = "";
        reporterInput.value = "";
        seasonInput.value = "";
        stewardInput.value = "";
        trackInput.value = "";
      } catch (error) {
        console.error("Error writing ticket: ", error);
        statusMsg.textContent = "Error submitting ticket. Please try again.";
        statusMsg.className = "status error";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ----------------------------------------------------------------
    // 6) VIEW ALL TICKETS (read‐only, sorted by timestamp descending)
    // ----------------------------------------------------------------
    async function fetchAndRenderTickets(targetContainer, isAdmin = false) {
      // Query: all docs in “tickets” ordered by timestamp desc
      const ticketsCol = collection(db, "tickets");
      const ticketsQuery = query(ticketsCol, orderBy("timestamp", "desc"));
      try {
        const snapshot = await getDocs(ticketsQuery);
        if (snapshot.empty) {
          targetContainer.innerHTML = "<p>No tickets have been submitted yet.</p>";
          return;
        }
        // Build a simple table: show ID, accused, competition, reporter, status, timestamp
        // Admin might see an extra “Action” column (for future)
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Accused</th>
                <th>Competition</th>
                <th>Reporter</th>
                <th>Status</th>
                <th>Submitted At</th>
                ${isAdmin ? "<th>Action</th>" : ""}
              </tr>
            </thead>
            <tbody>
        `;
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const ts = data.timestamp && data.timestamp.toDate
            ? data.timestamp.toDate().toLocaleString()
            : "";
          tableHTML += `
            <tr>
              <td>${docSnap.id}</td>
              <td>${data.accused || ""}</td>
              <td>${data.competition || ""}</td>
              <td>${data.reporter || ""}</td>
              <td>${data.status || ""}</td>
              <td>${ts}</td>
              ${isAdmin ? `<td>
                  <!-- Example: A “Set to Reviewed” button for admins -->
                  <button data-id="${docSnap.id}" class="markReviewedBtn">Mark Reviewed</button>
                </td>` : ""}
            </tr>
          `;
        });
        tableHTML += `</tbody></table>`;
        targetContainer.innerHTML = tableHTML;

        // If admin, wire up the “Mark Reviewed” buttons
        if (isAdmin) {
          const buttons = targetContainer.querySelectorAll(".markReviewedBtn");
          buttons.forEach(btn => {
            btn.addEventListener("click", async (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              try {
                const ticketRef = doc(db, "tickets", ticketId);
                await updateDoc(ticketRef, { status: "Reviewed" });
                // Refresh the table
                await fetchAndRenderTickets(adminTicketsContainer, true);
              } catch (err) {
                console.error("Error updating ticket status:", err);
                alert("Could not update status. Check console.");
              }
            });
          });
        }
      } catch (err) {
        console.error("Error fetching tickets:", err);
        targetContainer.innerHTML = "<p>Error loading tickets.</p>";
      }
    }

    // When “View All Tickets” is clicked (public)
    viewTicketsBtn.addEventListener("click", async () => {
      showSection(viewSection);
      ticketsListContainer.innerHTML = "<p>Loading tickets…</p>";
      await fetchAndRenderTickets(ticketsListContainer, false);
    });
    backFromViewBtn.addEventListener("click", () => {
      showSection(submitSection);
    });

    // ----------------------------------------------------------------
    // 7) ADMIN LOGIN / AUTHENTICATION
    //    • We assume you’ve already created steward accounts in Firebase Console (Email/Password).
    //    • In your Firestore Security Rules, you can check custom claims or user’s email patterns
    //      to ensure only stewards can update tickets. (Not shown here—just UI.)
    // ----------------------------------------------------------------
    loginToggleBtn.addEventListener("click", () => {
      // Clear any previous status
      loginStatusMsg.textContent = "";
      emailInput.value = "";
      passwordInput.value = "";
      showSection(loginSection);
    });
    backFromLoginBtn.addEventListener("click", () => {
      showSection(submitSection);
    });

    loginBtn.addEventListener("click", async () => {
      loginBtn.disabled = true;
      loginStatusMsg.textContent = "Signing in…";
      loginStatusMsg.className = "status";
      const email = emailInput.value.trim();
      const pw = passwordInput.value.trim();
      if (!email || !pw) {
        loginStatusMsg.textContent = "Email & password are required.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pw);
        // onAuthStateChanged will fire, showing adminSection
      } catch (err) {
        console.error("Login error:", err);
        loginStatusMsg.textContent = "Login failed. Check credentials.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      // onAuthStateChanged will fire, sending them back to submitSection
    });

    // ----------------------------------------------------------------
    // 8) LISTEN FOR AUTH STATE CHANGES
    //    • If user is logged in AND is a “steward” (for simplicity, we’ll just allow
    //      any authenticated user here—but in production, check a custom claim / Firestore doc).
    // ----------------------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Optionally: check in Firestore if this user’s email is listed in a “stewards” collection
        // For now, assume any signed‐in user is a steward. You can add your own logic:
        //   const docRef = doc(db, "stewards", user.uid);
        //   const docSnap = await getDoc(docRef);
        //   if (!docSnap.exists()) { /* not a steward—sign out, show error */ }
        //
        // Show Admin UI
        logoutBtn.classList.remove("hidden");
        showSection(adminSection);
        adminTicketsContainer.innerHTML = "<p>Loading tickets…</p>";
        await fetchAndRenderTickets(adminTicketsContainer, true);
      } else {
        // No user is signed in → return to “submit” view.
        logoutBtn.classList.add("hidden");
        showSection(submitSection);
      }
    });

    // On initial load: default to “submit ticket” if not already redirected by onAuthStateChanged
    showSection(submitSection);
  </script>
</body>
</html>
