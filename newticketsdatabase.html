<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Tickets • Highlight Finalised Tickets</title>
  <style>
    /* ------------------------------------------------------------
       Base styling for the entire page
       ------------------------------------------------------------ */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #6200EE;
      width: 100%;
      padding: 12px 0;
      color: #fff;
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 24px;
      position: relative;
    }
    .logout-btn {
      background-color: transparent;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 16px;
      top: 12px;
    }

    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 24px;
      max-width: 800px;
      width: 100%;
      margin-bottom: 24px;
    }
    .section-title {
      margin-top: 0;
      text-align: center;
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #6200EE;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .link-btn {
      background: none;
      border: none;
      color: #6200EE;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .status.error { color: #c00; }
    .status.success { color: #080; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #eee;
    }

    .hidden {
      display: none;
    }

    /* ------------------------------------------------------------
       Highlight full ticket row if appealed
       ------------------------------------------------------------ */
    .appeal-highlight {
      background-color: #E84040; /* light yellow background */
    }

    /* ------------------------------------------------------------
       Highlight entire row if status = "Finalised"
       ------------------------------------------------------------ */
    .finalised-row {
      background-color: #A5FF7F; /* very light green */
    }

    /* ------------------------------------------------------------
       Styles for the inline appeal form in public view
       ------------------------------------------------------------ */
    .appeal-form {
      background: #fafafa;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .appeal-form input[type="text"],
    .appeal-form textarea {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .appeal-form button {
      width: auto;
      margin-right: 8px;
    }

    /* ------------------------------------------------------------
       Styles for the detailed view row in admin
       ------------------------------------------------------------ */
    .detailRow td {
      background-color: #eef7ff; /* very light blue */
      padding: 0;
    }
    .detail-container {
      padding: 16px;
      font-size: 0.95rem;
    }
    .detail-container p {
      margin: 4px 0;
    }
    .detail-container a {
      color: #1a0dab;
      text-decoration: underline;
    }
    .detail-container hr {
      margin: 12px 0;
      border: none;
      border-top: 1px solid #ccc;
    }
    .detail-container .appeal-box {
      padding: 8px;
      border: 1px solid #f5e6a0;
      border-radius: 4px;
      background-color: #fffdf0;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #333;
    }
    .detail-container .appeal-box strong {
      color: #b36b00;
    }
    .detail-container .review-form {
      background: #eef7ff;
      padding: 12px;
      border: 1px solid #9ecfff;
      border-radius: 6px;
      margin-top: 12px;
    }
    .detail-container .review-form select,
    .detail-container .review-form textarea,
    .detail-container .review-form input[type="text"] {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .detail-container .review-form button {
      width: auto;
      margin-right: 8px;
    }
  </style>
  <!-- jsPDF UMD build for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    IFWL Ticketing System
    <button id="logoutBtn" class="logout-btn hidden">Logout</button>
  </header>

  <!-- ==============================================================
       SECTION 1: SUBMIT A NEW TICKET (VISIBLE TO EVERYONE)
       ============================================================== -->
  <div id="submitSection" class="container">
    <h2 class="section-title">Submit a New Ticket</h2>

    <!-- Accused (Driver) Dropdown -->
    <div class="form-group">
      <label for="accusedSelect">Accused (Driver) <span style="color: red;">*</span></label>
      <select id="accusedSelect">
        <option value="" disabled selected>Select a driver…</option>
      </select>
    </div>
    <div id="newDriverContainer" class="form-group hidden">
      <label for="newDriverInput"><strong>Add New Driver</strong></label>
      <input type="text" id="newDriverInput" placeholder="Type new driver name…" />
    </div>

    <!-- Driver Reporting Dropdown -->
    <div class="form-group">
      <label for="reporterSelect">Driver Reporting <span style="color: red;">*</span></label>
      <select id="reporterSelect">
        <option value="" disabled selected>Select reporting driver…</option>
      </select>
    </div>
    <div id="newReporterContainer" class="form-group hidden">
      <label for="newReporterInput"><strong>Add New Reporting Driver</strong></label>
      <input type="text" id="newReporterInput" placeholder="Type new driver name…" />
    </div>

    <!-- Competition Dropdown (hard-coded) -->
    <div class="form-group">
      <label for="competitionSelect">Competition <span style="color: red;">*</span></label>
      <select id="competitionSelect">
        <option value="" disabled selected>Select a competition…</option>
        <option value="ACC - BEGINNER CONSOLE">ACC - BEGINNER CONSOLE</option>
        <option value="ACC - BEGINNER PC">ACC - BEGINNER PC</option>
        <option value="ACC - PRO AM CONSOLE">ACC - PRO AM CONSOLE</option>
        <option value="ACC - PRO AM PC">ACC - PRO AM PC</option>
        <option value="ACC - ENDURO SOLO">ACC - ENDURO SOLO</option>
        <option value="ACC - ENDURO TEAMS">ACC - ENDURO TEAMS</option>
        <option value="ACC - GMC">ACC - GMC</option>
        <option value="ACC - AMATEUR PC">ACC - AMATEUR PC</option>
        <option value="ACC - AMATEUR CONSOLE">ACC - AMATEUR CONSOLE</option>
        <option value="AC - all game modes">AC – all game modes</option>
        <option value="AC EVO - all game modes">AC EVO – all game modes</option>
        <option value="F1 2025">F1 2025</option>
      </select>
    </div>

    <!-- Full Incident Summary -->
    <div class="form-group">
      <label for="fullIncident">Full Incident Summary <span style="color: red;">*</span></label>
      <textarea id="fullIncident" placeholder="Describe the incident in detail…" required></textarea>
    </div>

    <!-- Event Dropdown (static) -->
    <div class="form-group">
      <label for="eventSelect">Event</label>
      <select id="eventSelect">
        <option value="Practice">Practice</option>
        <option value="Qualifying">Qualifying</option>
        <option value="Race 1">Race 1</option>
        <option value="Race 2">Race 2</option>
        <option value="Race 3">Race 3</option>
      </select>
    </div>

    <!-- Proof URL (public, but omitted from PDF) -->
    <div class="form-group">
      <label for="proofUrl">Proof URL (if any)</label>
      <input type="url" id="proofUrl" placeholder="any video or image hosting site such as youtube/google drive/imgur" />
    </div>

    <!-- Season Dropdown (static) -->
    <div class="form-group">
      <label for="seasonSelect">Season</label>
      <select id="seasonSelect">
        <option value="Season 1">Season 1</option>
        <option value="Season 2">Season 2</option>
        <option value="Season 3">Season 3</option>
        <option value="Season 4">Season 4</option>
      </select>
    </div>

    <!-- Track Dropdown (dynamic) -->
    <div class="form-group">
      <label for="trackSelect">Track</label>
      <select id="trackSelect">
        <option value="" disabled selected>Select a track…</option>
      </select>
    </div>
    <div id="newTrackContainer" class="form-group hidden">
      <label for="newTrackInput"><strong>Add New Track</strong></label>
      <input type="text" id="newTrackInput" placeholder="Type new track name…" />
    </div>

    <!-- Rule Breach Dropdown (dynamic from /regulations) -->
    <div class="form-group">
      <label for="ruleBreachSelect">Rule Breach</label>
      <select id="ruleBreachSelect">
        <option value="" disabled selected>Select a regulation…</option>
      </select>
    </div>

    <!-- Submit Button -->
    <button id="submitBtn">Submit Ticket</button>
    <div class="status" id="statusMsg"></div>

    <button id="viewTicketsBtn" class="link-btn">View All Tickets</button>
    <button id="loginToggleBtn" class="link-btn">Admin Login</button>
  </div>

  <!-- ==============================================================
       SECTION 2: VIEW ALL TICKETS (PUBLIC, WITH INLINE APPEAL FORM)
       ============================================================== -->
  <div id="viewSection" class="container hidden">
    <h2 class="section-title">All Submitted Tickets</h2>
    <div id="ticketsListContainer">
      <!-- Public table + inline appeal form will be injected here -->
    </div>
    <button id="backFromViewBtn" class="link-btn">← Back to Submit</button>
  </div>

  <!-- ==============================================================
       SECTION 3: LOGIN FORM (for Admins)
       ============================================================== -->
  <div id="loginSection" class="container hidden">
    <h2 class="section-title">Admin Sign-In</h2>
    <div class="form-group">
      <label for="email">Email <span style="color: red;">*</span></label>
      <input type="email" id="email" placeholder="admin@example.com" required />
    </div>
    <div class="form-group">
      <label for="password">Password <span style="color: red;">*</span></label>
      <input type="password" id="password" placeholder="••••••••" required />
    </div>
    <button id="loginBtn">Login</button>
    <div class="status" id="loginStatusMsg"></div>
    <button id="backFromLoginBtn" class="link-btn">← Back</button>
  </div>

  <!-- ==============================================================
       SECTION 4: ADMIN DASHBOARD (PRIVATE, WITH DETAIL VIEW)
       ============================================================== -->
  <div id="adminSection" class="container hidden">
    <h2 class="section-title">Admin Dashboard</h2>
    <div id="adminTicketsContainer">
      <!-- Admin table will be injected here -->
    </div>
  </div>

  <!-- ==============================================================
       Firebase v9+ Modular SDK & App Logic (including PDF generation)
       ============================================================== -->
  <script type="module">
    // 1) Import required Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      query,
      serverTimestamp,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // 2) Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    // 3) Initialize Firebase
    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);
    const auth  = getAuth(app);

    // 4) Cache DOM elements
    const submitSection         = document.getElementById("submitSection");
    const viewSection           = document.getElementById("viewSection");
    const loginSection          = document.getElementById("loginSection");
    const adminSection          = document.getElementById("adminSection");

    // Submit-ticket elements
    const accusedSelect         = document.getElementById("accusedSelect");
    const newDriverContainer    = document.getElementById("newDriverContainer");
    const newDriverInput        = document.getElementById("newDriverInput");

    const reporterSelect        = document.getElementById("reporterSelect");
    const newReporterContainer  = document.getElementById("newReporterContainer");
    const newReporterInput      = document.getElementById("newReporterInput");

    const competitionSelect     = document.getElementById("competitionSelect");
    const fullIncident          = document.getElementById("fullIncident");
    const eventSelect           = document.getElementById("eventSelect");
    const proofUrlInput         = document.getElementById("proofUrl");
    const seasonSelect          = document.getElementById("seasonSelect");

    const trackSelect           = document.getElementById("trackSelect");
    const newTrackContainer     = document.getElementById("newTrackContainer");
    const newTrackInput         = document.getElementById("newTrackInput");

    const ruleBreachSelect      = document.getElementById("ruleBreachSelect");

    const submitBtn             = document.getElementById("submitBtn");
    const statusMsg             = document.getElementById("statusMsg");

    // View all tickets (public) elements
    const viewTicketsBtn        = document.getElementById("viewTicketsBtn");
    const backFromViewBtn       = document.getElementById("backFromViewBtn");
    const ticketsListContainer  = document.getElementById("ticketsListContainer");

    // Login (admin) elements
    const loginToggleBtn        = document.getElementById("loginToggleBtn");
    const loginBtn              = document.getElementById("loginBtn");
    const backFromLoginBtn      = document.getElementById("backFromLoginBtn");
    const emailInput            = document.getElementById("email");
    const passwordInput         = document.getElementById("password");
    const loginStatusMsg        = document.getElementById("loginStatusMsg");

    // Admin dashboard elements
    const logoutBtn             = document.getElementById("logoutBtn");
    const adminTicketsContainer = document.getElementById("adminTicketsContainer");

    // ----------------------------------------------------------------
    // UTILITY: Show exactly one section at a time
    // ----------------------------------------------------------------
    function showSection(sectionToShow) {
      [submitSection, viewSection, loginSection, adminSection].forEach(sec => {
        sec.classList.add("hidden");
      });
      sectionToShow.classList.remove("hidden");
    }

    // ----------------------------------------------------------------
    // Populate “Accused” dropdown from /drivers, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateDriverDropdown() {
      const snapshot = await getDocs(collection(db, "drivers"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.fullName && typeof data.fullName === "string") {
          names.push(data.fullName);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      accusedSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a driver…";
      placeholder.disabled = true;
      placeholder.selected = true;
      accusedSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        accusedSelect.appendChild(opt);
      });

      const newOpt = document.createElement("option");
      newOpt.value = "__ADD_NEW__";
      newOpt.textContent = "➕ Add New Driver…";
      accusedSelect.appendChild(newOpt);

      accusedSelect.addEventListener("change", () => {
        if (accusedSelect.value === "__ADD_NEW__") {
          newDriverContainer.classList.remove("hidden");
        } else {
          newDriverContainer.classList.add("hidden");
        }
      });
    }

    // ----------------------------------------------------------------
    // Populate “Reporter” dropdown from /drivers, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateReporterDropdown() {
      const snapshot = await getDocs(collection(db, "drivers"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.fullName && typeof data.fullName === "string") {
          names.push(data.fullName);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      reporterSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select reporting driver…";
      placeholder.disabled = true;
      placeholder.selected = true;
      reporterSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        reporterSelect.appendChild(opt);
      });

      const newOpt = document.createElement("option");
      newOpt.value = "__ADD_NEW__";
      newOpt.textContent = "➕ Add New Reporting Driver…";
      reporterSelect.appendChild(newOpt);

      reporterSelect.addEventListener("change", () => {
        if (reporterSelect.value === "__ADD_NEW__") {
          newReporterContainer.classList.remove("hidden");
        } else {
          newReporterContainer.classList.add("hidden");
        }
      });
    }

    // ----------------------------------------------------------------
    // Populate “Track” dropdown from /tracks, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateTrackDropdown() {
      const snapshot = await getDocs(collection(db, "tracks"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name && typeof data.name === "string") {
          names.push(data.name);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      trackSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a track…";
      placeholder.disabled = true;
      placeholder.selected = true;
      trackSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        trackSelect.appendChild(opt);
      });

      const newOpt = document.createElement("option");
      newOpt.value = "__ADD_NEW__";
      newOpt.textContent = "➕ Add New Track…";
      trackSelect.appendChild(newOpt);

      trackSelect.addEventListener("change", () => {
        if (trackSelect.value === "__ADD_NEW__") {
          newTrackContainer.classList.remove("hidden");
        } else {
          newTrackContainer.classList.add("hidden");
        }
      });
    }

    // ----------------------------------------------------------------
    // Populate “Rule Breach” dropdown from /regulations, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateRegulationsDropdown() {
      const snapshot = await getDocs(collection(db, "regulations"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name && typeof data.name === "string") {
          names.push(data.name);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      ruleBreachSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a regulation…";
      placeholder.disabled = true;
      placeholder.selected = true;
      ruleBreachSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        ruleBreachSelect.appendChild(opt);
      });
    }

    // ----------------------------------------------------------------
    // HANDLE “SUBMIT TICKET” (public)
    // ----------------------------------------------------------------
    submitBtn.addEventListener("click", async () => {
      submitBtn.disabled = true;
      statusMsg.textContent = "Submitting…";
      statusMsg.className = "status";

      // 1) Read and trim values
      let accused = accusedSelect.value;
      const newDriverName = newDriverInput.value.trim();

      let reporter = reporterSelect.value;
      const newReporterName = newReporterInput.value.trim();

      const competition = competitionSelect.value;
      if (!competition) {
        statusMsg.textContent = "Please select a competition.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }

      const summary = fullIncident.value.trim();
      const eventVal = eventSelect.value;
      const proofUrl = proofUrlInput.value.trim();
      const season = seasonSelect.value;

      let track = trackSelect.value;
      const newTrackName = newTrackInput.value.trim();

      const ruleBreach = ruleBreachSelect.value;

      // 2) Required fields: accused, reporter, competition, summary
      if (
        ((!accused && !newDriverName)) ||
        ((!reporter && !newReporterName)) ||
        !summary
      ) {
        statusMsg.textContent = "Please fill in all required fields: Accused, Driver Reporting, Competition, Full Incident Summary.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }

      // 3) If “Add New Driver…” was chosen, add to Firestore
      if (accused === "__ADD_NEW__") {
        accused = newDriverName;
        try {
          await addDoc(collection(db, "drivers"), { fullName: newDriverName });
        } catch (err) {
          console.error("Error adding new driver:", err);
        }
      }

      // 4) If “Add New Reporting Driver…” was chosen, add to Firestore
      if (reporter === "__ADD_NEW__") {
        reporter = newReporterName;
        try {
          await addDoc(collection(db, "drivers"), { fullName: newReporterName });
        } catch (err) {
          console.error("Error adding new reporting driver:", err);
        }
      }

      // 5) If “Add New Track…” was chosen, add to Firestore
      if (track === "__ADD_NEW__") {
        track = newTrackName;
        try {
          await addDoc(collection(db, "tracks"), { name: newTrackName });
        } catch (err) {
          console.error("Error adding new track:", err);
        }
      }

      // 6) Build the ticket object
      const newTicket = {
        accused: accused,
        reporter: reporter,
        competition: competition,
        fullIncident: summary,
        event: eventVal,
        proofUrl: proofUrl,
        season: season,
        track: track,
        ruleBreach: ruleBreach,
        status: "New Submission",
        stewardDecision: "",
        stewardTag: "",       // Assigned Steward will populate here once Admin updates
        timestamp: serverTimestamp()
      };

      try {
        const docRef = await addDoc(collection(db, "tickets"), newTicket);
        statusMsg.textContent = `Ticket submitted (ID: ${docRef.id}). Thank you!`;
        statusMsg.className = "status success";

        // Clear fields
        accusedSelect.value = "";
        newDriverContainer.classList.add("hidden");
        newDriverInput.value = "";

        reporterSelect.value = "";
        newReporterContainer.classList.add("hidden");
        newReporterInput.value = "";

        fullIncident.value = "";
        eventSelect.value = "Practice";
        proofUrlInput.value = "";
        seasonSelect.value = "Season 1";

        trackSelect.value = "";
        newTrackContainer.classList.add("hidden");
        newTrackInput.value = "";

        ruleBreachSelect.value = "";

      } catch (error) {
        console.error("Error writing ticket: ", error);
        statusMsg.textContent = "Error submitting ticket. Please try again.";
        statusMsg.className = "status error";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ----------------------------------------------------------------
    // INLINE APPEAL FORM HELPER (public)
    // ----------------------------------------------------------------
    function toggleAppealForm(ticketId, container) {
      // Remove any existing appeal form row
      const existingForm = container.querySelector(".appealFormRow");
      if (existingForm) {
        existingForm.remove();
      }

      // Find the row for ticketId
      const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
      if (!ticketRow) return;

      // Build an inline appeal form directly beneath the ticket row
      const formRow = document.createElement("tr");
      formRow.classList.add("appealFormRow");
      formRow.innerHTML = `
        <td colspan="8">
          <div class="appeal-form">
            <label for="appealInfo-${ticketId}"><strong>Appeal Info</strong></label>
            <textarea id="appealInfo-${ticketId}" placeholder="Enter your appeal details…" rows="3"></textarea>
            <label for="extraProof-${ticketId}"><strong>Extra Video Proof URL</strong></label>
            <input type="url" id="extraProof-${ticketId}" placeholder="https://example.com/extra-proof" />
            <div style="margin-top: 8px;">
              <button id="submitAppeal-${ticketId}">Submit Appeal</button>
              <button id="cancelAppeal-${ticketId}" style="background-color: #999; margin-left:8px;">Cancel</button>
            </div>
            <div id="appealStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
          </div>
        </td>
      `;
      ticketRow.insertAdjacentElement("afterend", formRow);

      document.getElementById(`cancelAppeal-${ticketId}`).addEventListener("click", () => {
        formRow.remove();
      });

      document.getElementById(`submitAppeal-${ticketId}`).addEventListener("click", async () => {
        const appealInfoInput = document.getElementById(`appealInfo-${ticketId}`);
        const extraProofInput = document.getElementById(`extraProof-${ticketId}`);
        const appealStatusDiv = document.getElementById(`appealStatus-${ticketId}`);
        const appealInfoValue = appealInfoInput.value.trim();
        const extraProofValue = extraProofInput.value.trim();

        if (!appealInfoValue) {
          appealStatusDiv.textContent = "Please enter your appeal details.";
          appealStatusDiv.className = "status error";
          return;
        }
        appealStatusDiv.textContent = "Submitting appeal…";
        appealStatusDiv.className = "status";

        try {
          const appealsColRef = collection(db, "tickets", ticketId, "appeals");
          await addDoc(appealsColRef, {
            appealInfo: appealInfoValue,
            extraProofUrl: extraProofValue,
            timestamp: serverTimestamp()
          });
          appealStatusDiv.textContent = "Appeal submitted! We’ll review it soon.";
          appealStatusDiv.className = "status success";
          setTimeout(() => {
            formRow.remove();
          }, 2000);
        } catch (err) {
          console.error("Error submitting appeal:", err);
          appealStatusDiv.textContent = "Error submitting appeal. Please try again.";
          appealStatusDiv.className = "status error";
        }
      });
    }

    // ----------------------------------------------------------------
    // TOGGLE DETAIL VIEW (admin): Show full ticket + appeals + review form + PDF button
    // ----------------------------------------------------------------
    async function toggleDetailView(ticketId, container) {
      const existingDetail = container.querySelector(".detailRow");
      if (existingDetail) {
        existingDetail.remove();
      }

      const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
      if (!ticketRow) return;

      const ticketDocRef = doc(db, "tickets", ticketId);
      const ticketSnap = await getDoc(ticketDocRef);
      if (!ticketSnap.exists()) return;
      const ticketData = ticketSnap.data();

      const appealsRef = collection(db, "tickets", ticketId, "appeals");
      const appealsSnapshot = await getDocs(appealsRef);
      let appealsHTML = "";
      if (!appealsSnapshot.empty) {
        appealsSnapshot.forEach(appSnap => {
          const appealData = appSnap.data();
          const appealTs = appealData.timestamp && appealData.timestamp.toDate
            ? appealData.timestamp.toDate().toLocaleString()
            : "";
          appealsHTML += `
            <div class="appeal-box">
              <div><strong>Appeal:</strong> ${appealData.appealInfo}</div>
              <div><strong>Extra Video Proof:</strong> ${appealData.extraProofUrl || "N/A"}</div>
              <div style="margin-top:4px; font-size:0.8rem; color:#555;">
                <em>Submitted: ${appealTs}</em>
              </div>
            </div>
          `;
        });
      }

      const detailRow = document.createElement("tr");
      detailRow.classList.add("detailRow");
      detailRow.innerHTML = `
        <td colspan="8">
          <div class="detail-container">
            <h3>Ticket Details</h3>
            <p><strong>ID:</strong> ${ticketId}</p>
            <p><strong>Accused:</strong> ${ticketData.accused || ""}</p>
            <p><strong>Driver Reporting:</strong> ${ticketData.reporter || ""}</p>
            <p><strong>Competition:</strong> ${ticketData.competition || ""}</p>
            <p><strong>Full Incident Summary:</strong> ${ticketData.fullIncident || ""}</p>
            <p><strong>Event:</strong> ${ticketData.event || ""}</p>
            <p><strong>Proof URL:</strong> ${
              ticketData.proofUrl
                ? `<a href="${ticketData.proofUrl}" target="_blank" rel="noopener noreferrer">${ticketData.proofUrl}</a>`
                : "N/A"
            }</p>
            <p><strong>Season:</strong> ${ticketData.season || ""}</p>
            <p><strong>Track:</strong> ${ticketData.track || ""}</p>
            <p><strong>Rule Breach:</strong> ${ticketData.ruleBreach || ""}</p>
            <p><strong>Status:</strong> ${ticketData.status || ""}</p>
            ${ticketData.stewardTag 
              ? `<p><strong>Assigned Steward:</strong> ${ticketData.stewardTag}</p>` 
              : `<p><strong>Assigned Steward:</strong> —</p>`}
            ${ticketData.stewardDecision 
              ? `<p><strong>Steward Decision:</strong> ${ticketData.stewardDecision}</p>` 
              : ""}
            <p><strong>Submitted At:</strong> ${
              (ticketData.timestamp && ticketData.timestamp.toDate)
                ? ticketData.timestamp.toDate().toLocaleString()
                : ""
            }</p>
            ${appealsHTML 
              ? `<hr><h4>Appeals</h4>${appealsHTML}` 
              : ""}
            <hr>
            <div class="review-form">
              <h4>Admin Review</h4>
              <label for="statusSelect-${ticketId}"><strong>Select Outcome</strong></label>
              <select id="statusSelect-${ticketId}">
                <option value="Under Review" ${ticketData.status === "Under Review" ? "selected" : ""}>Under Review</option>
                <option value="Finalised" ${ticketData.status === "Finalised" ? "selected" : ""}>Finalised</option>
                <option value="Appeal In Progress" ${ticketData.status === "Appeal In Progress" ? "selected" : ""}>Appeal In Progress</option>
              </select>

              <label for="decisionText-${ticketId}"><strong>Steward Decision</strong></label>
              <textarea id="decisionText-${ticketId}" placeholder="Enter your decision…" rows="3">${ticketData.stewardDecision || ""}</textarea>

              <label for="stewardTag-${ticketId}"><strong>Assigned Steward (Steward Tag)</strong></label>
              <input type="text" id="stewardTag-${ticketId}" 
                     placeholder="e.g. Steward – IOC" 
                     value="${ticketData.stewardTag || ""}" />
<label for="futureAdvice-${ticketId}"><strong>Future Advice</strong></label>
<select id="futureAdvice-${ticketId}">
  <option value="" disabled ${!ticketData.futureAdvice ? "selected" : ""}>Select advice…</option>
  <option value="Respectful Conduct: To avoid penalties for disrespectful behavior, maintain a neutral or positive tone in all communications—even under pressure. If you disagree with a steward’s decision, wait until the session ends before composing an appeal; keep it concise, factual, and free of emotional language to show professionalism and respect toward officials and fellow drivers." ${ticketData.futureAdvice === "Respectful Conduct: To avoid penalties for disrespectful behavior, maintain a neutral or positive tone in all communications—even under pressure. If you disagree with a steward’s decision, wait until the session ends before composing an appeal; keep it concise, factual, and free of emotional language to show professionalism and respect toward officials and fellow drivers." ? "selected" : ""}>
    Respectful Conduct
  </option>
  <option value="Racing Decorum: Prevent contact-related penalties by practicing clean overtakes in test sessions: focus on lifting earlier and carrying momentum rather than late diving into braking zones. Remind yourself mid-race to leave at least one car-width whenever there’s any uncertainty, and consciously avoid maneuvers like punting, bump-passing, or brake-checking." ${ticketData.futureAdvice === "Racing Decorum: Prevent contact-related penalties by practicing clean overtakes in test sessions: focus on lifting earlier and carrying momentum rather than late diving into braking zones. Remind yourself mid-race to leave at least one car-width whenever there’s any uncertainty, and consciously avoid maneuvers like punting, bump-passing, or brake-checking." ? "selected" : ""}>
    Racing Decorum
  </option>
  <option value="Passing Responsibilities: Ensure every passing attempt is fair by waiting for a fully clear gap before committing—if you’re not completely alongside before the turn-in point, back out and try again later. As the lead driver, avoid sudden line changes and be predictable in defense, giving overtakers a legitimate chance once they’ve shown clear intent." ${ticketData.futureAdvice === "Passing Responsibilities: Ensure every passing attempt is fair by waiting for a fully clear gap before committing—if you’re not completely alongside before the turn-in point, back out and try again later. As the lead driver, avoid sudden line changes and be predictable in defense, giving overtakers a legitimate chance once they’ve shown clear intent." ? "selected" : ""}>
    Passing Responsibilities
  </option>
  <option value="Passing Lines: In practice, mark your ideal defensive line and commit to it at race time; once an overtaker’s front wheel is alongside your rear wheel, leave enough room for a car’s width between you. During braking, stay on your chosen line and brake smoothly—never veer across the overtaker’s path." ${ticketData.futureAdvice === "Passing Lines: In practice, mark your ideal defensive line and commit to it at race time; once an overtaker’s front wheel is alongside your rear wheel, leave enough room for a car’s width between you. During braking, stay on your chosen line and brake smoothly—never veer across the overtaker’s path." ? "selected" : ""}>
    Passing Lines
  </option>
  <option value="Establishing Overlap: Only attempt a dive-bomb if you’ve already overlapped by at least half a car length at the turn-in marker; otherwise, exercise patience and wait for a safer opportunity. Always factor in tire wear and track conditions—if your tires are degraded, avoid forcing moves you can’t complete cleanly." ${ticketData.futureAdvice === "Establishing Overlap: Only attempt a dive-bomb if you’ve already overlapped by at least half a car length at the turn-in marker; otherwise, exercise patience and wait for a safer opportunity. Always factor in tire wear and track conditions—if your tires are degraded, avoid forcing moves you can’t complete cleanly." ? "selected" : ""}>
    Establishing Overlap
  </option>
  <option value="Line Commitment: Decide on your defensive line before entering the braking zone and hold it without deviation. If an unexpected incident forces you to change, lift early and signal your intention to avoid surprising following drivers; once you’ve straightened up, re-commit to your new line only after the track is clear." ${ticketData.futureAdvice === "Line Commitment: Decide on your defensive line before entering the braking zone and hold it without deviation. If an unexpected incident forces you to change, lift early and signal your intention to avoid surprising following drivers; once you’ve straightened up, re-commit to your new line only after the track is clear." ? "selected" : ""}>
    Line Commitment
  </option>
  <option value="Accident Predictability: If you spin or lose control, immediately floor and hold the brakes until you stop, keeping your car stationary and visible. Only rejoin when you can see at least two cars behind you have cleared the racing line safely; if in doubt, remain in the runoff area and wait for confirmation that it’s clear." ${ticketData.futureAdvice === "Accident Predictability: If you spin or lose control, immediately floor and hold the brakes until you stop, keeping your car stationary and visible. Only rejoin when you can see at least two cars behind you have cleared the racing line safely; if in doubt, remain in the runoff area and wait for confirmation that it’s clear." ? "selected" : ""}>
    Accident Predictability
  </option>
  <option value="Rejoining the Track: After going off, reduce to approximately half pace and keep your brake lights on until you’re fully back under control and clear of the racing line. Meanwhile, drivers on-track should monitor mirrors for re-joiners and anticipate their lower speed, giving them additional space to merge safely." ${ticketData.futureAdvice === "Rejoining the Track: After going off, reduce to approximately half pace and keep your brake lights on until you’re fully back under control and clear of the racing line. Meanwhile, drivers on-track should monitor mirrors for re-joiners and anticipate their lower speed, giving them additional space to merge safely." ? "selected" : ""}>
    Rejoining the Track
  </option>
  <option value="No Reverse Direction: Never reverse in the opposite direction on track; if you miss a turn, continue forward to the next escape route to turn around. Practice a quick “lift-and-spin” maneuver in non-critical areas so you can reorient your car facing forward without reversing." ${ticketData.futureAdvice === "No Reverse Direction: Never reverse in the opposite direction on track; if you miss a turn, continue forward to the next escape route to turn around. Practice a quick “lift-and-spin” maneuver in non-critical areas so you can reorient your car facing forward without reversing." ? "selected" : ""}>
    No Reverse Direction
  </option>
  <option value="Allowing Overtakes: When lapped, pick a consistent yield point—ideally on a straight or at a corner exit—and move off the fast line to let leaders through. If you find yourself unlapping and you’re faster, only do so where you can cleanly pull ahead without defensive moves, then resume racing as usual." ${ticketData.futureAdvice === "Allowing Overtakes: When lapped, pick a consistent yield point—ideally on a straight or at a corner exit—and move off the fast line to let leaders through. If you find yourself unlapping and you’re faster, only do so where you can cleanly pull ahead without defensive moves, then resume racing as usual." ? "selected" : ""}>
    Allowing Overtakes
  </option>
  <option value="Vehicle Modifications: Before each event, double-check your setup against the published Balance of Performance or approved configurations on IFWL.net. Save and load the event’s official setup cleanly on race day to ensure no unauthorized aero, tire, or engine tweaks slip in." ${ticketData.futureAdvice === "Vehicle Modifications: Before each event, double-check your setup against the published Balance of Performance or approved configurations on IFWL.net. Save and load the event’s official setup cleanly on race day to ensure no unauthorized aero, tire, or engine tweaks slip in." ? "selected" : ""}>
    Vehicle Modifications
  </option>
  <option value="Event Participation: If you know you can’t attend a race you’ve registered for, unregister immediately to free up the spot. To avoid missing the cutoff, set a personal reminder at least one hour before the official “unregister by” deadline. If you have been subject to a ragequit penalty - please remember an \"off track\" or incident isn't the end of your race - race until the chequered flag." ${ticketData.futureAdvice === "Event Participation: If you know you can’t attend a race you’ve registered for, unregister immediately to free up the spot. To avoid missing the cutoff, set a personal reminder at least one hour before the official “unregister by” deadline. If you have been subject to a ragequit penalty - please remember an \"off track\" or incident isn't the end of your race - race until the chequered flag." ? "selected" : ""}>
    Event Participation
  </option>
  <option value="Compliance: Keep bookmarked copies of the Forza, Assetto Corsa, and ACC Codes of Conduct, and quickly review key sections before each series begins. If you switch disciplines between events, revisit the developer’s official rules via the links on IFWL.net so you’re always up to date with any title-specific regulations." ${ticketData.futureAdvice === "Compliance: Keep bookmarked copies of the Forza, Assetto Corsa, and ACC Codes of Conduct, and quickly review key sections before each series begins. If you switch disciplines between events, revisit the developer’s official rules via the links on IFWL.net so you’re always up to date with any title-specific regulations." ? "selected" : ""}>
    Compliance
  </option>
</select>

              <div style="margin-top: 8px;">
                <button id="submitReview-${ticketId}">Update Ticket</button>
                <button id="cancelDetail-${ticketId}" style="background-color: #999; margin-left:8px;">Close</button>
                <button id="generatePDF-${ticketId}" style="background-color: #333; margin-left:8px;">
                  Generate Discord Form
                </button>
              </div>
              <div id="detailStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
            </div>
          </div>
        </td>
      `;
      ticketRow.insertAdjacentElement("afterend", detailRow);

      document.getElementById(`cancelDetail-${ticketId}`).addEventListener("click", () => {
        detailRow.remove();
      });

      // ----------------------------------------------------------------
      // Update ticket in Firestore when Admin clicks “Update Ticket”
      // ----------------------------------------------------------------
      document.getElementById(`submitReview-${ticketId}`).addEventListener("click", async () => {
        const statusSelect    = document.getElementById(`statusSelect-${ticketId}`);
        const decisionInput   = document.getElementById(`decisionText-${ticketId}`);
        const stewardTagInput = document.getElementById(`stewardTag-${ticketId}`);
        const detailStatusDiv = document.getElementById(`detailStatus-${ticketId}`);
        const newStatus       = statusSelect.value;
        const decisionText    = decisionInput.value.trim();
        const stewardTagVal   = stewardTagInput.value.trim();

        const futureAdviceSel = document.getElementById(`futureAdvice-${ticketId}`);
        const futureAdviceVal = futureAdviceSel.value;
if (!decisionText) {
          detailStatusDiv.textContent = "Please enter a steward decision.";
          detailStatusDiv.className = "status error";
          return;
        }
        if (!stewardTagVal) {
          detailStatusDiv.textContent = "Please enter an assigned steward.";
          detailStatusDiv.className = "status error";
          return;
        }

        detailStatusDiv.textContent = "Updating ticket…";
        detailStatusDiv.className = "status";

        try {
          const ticketRef = doc(db, "tickets", ticketId);
          await updateDoc(ticketRef, {
            status: newStatus,
            stewardDecision: decisionText,
            stewardTag: stewardTagVal,
            futureAdvice: futureAdviceVal
          });
          detailStatusDiv.textContent = "Ticket updated!";
          detailStatusDiv.className = "status success";
          setTimeout(async () => {
            await fetchAndRenderTickets(adminTicketsContainer, true);
          }, 800);
        } catch (err) {
          console.error("Error updating ticket:", err);
          detailStatusDiv.textContent = "Error updating ticket. Please try again.";
          detailStatusDiv.className = "status error";
        }
      });

      // ----------------------------------------------------------------
      // Generate the Steward Decision PDF when clicked
      // ----------------------------------------------------------------
      document.getElementById(`generatePDF-${ticketId}`).addEventListener("click", async () => {
        await generateDiscordForm(ticketId, ticketData);
      });
    }

    // ----------------------------------------------------------------
    // FETCH & RENDER TICKETS (public vs. admin)
    //
    // Public view: show “Appeal” or “Appeal Period Expired”
    // Admin view: show “Open”
    // Highlight “Finalised” rows in green
    // ----------------------------------------------------------------
    async function fetchAndRenderTickets(targetContainer, isAdmin = false) {
      const ticketsCol   = collection(db, "tickets");
      const ticketsQuery = query(ticketsCol);

      try {
        const snapshot = await getDocs(ticketsQuery);
        if (snapshot.empty) {
          targetContainer.innerHTML = "<p>No tickets have been submitted yet.</p>";
          return;
        }

        // Build table header (Admin sees “Assigned Steward”)
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Accused</th>
                <th>Reporter</th>
                <th>Competition</th>
                <th>Status</th>
                <th>Assigned Steward</th>
                <th>Submitted At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        snapshot.forEach(docSnap => {
          const data    = docSnap.data();
          const tsObj   = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : null;
          const tsStr   = tsObj ? tsObj.toLocaleString() : "";
          const id      = docSnap.id;
          const steward = data.stewardTag || "";

          // Determine if the 24h appeal window has expired
          let isExpired = false;
          if (tsObj) {
            const now = Date.now();
            const createdAtMs = tsObj.getTime();
            if (now - createdAtMs > 24 * 60 * 60 * 1000) { // 24 hours in ms
              isExpired = true;
            }
          }

          // Check if status is "Finalised" → give row a green background
          const isFinalised = (data.status === "Finalised");
          const rowClassList = ["ticketRow"];
          if (isFinalised) rowClassList.push("finalised-row");
          if (!isAdmin && !isExpired) {
            // Public and within 24h → clickable "Appeal"
            // (we’ll wire up the listener below)
          }

          // Build the appropriate Action button:
          let actionButtonHTML = "";
          if (isAdmin) {
            // Admin always sees “Open”
            actionButtonHTML = `<button data-id="${id}" class="openBtn">Open</button>`;
          } else {
            // Public sees “Appeal” or “Appeal Period Expired”
            if (isExpired) {
              actionButtonHTML = `
                <button disabled 
                        style="background-color: #999; cursor: not-allowed;">
                  Appeal Period Expired
                </button>
              `;
            } else {
              actionButtonHTML = `<button data-id="${id}" class="appealBtn">Appeal</button>`;
            }
          }

          tableHTML += `
            <tr data-id="${id}" class="${rowClassList.join(" ")}">
              <td>${id}</td>
              <td>${data.accused || ""}</td>
              <td>${data.reporter || ""}</td>
              <td>${data.competition || ""}</td>
              <td>${data.status || ""}</td>
              <td>${steward}</td>
              <td>${tsStr}</td>
              <td>${actionButtonHTML}</td>
            </tr>
          `;
        });

        tableHTML += `</tbody></table>`;
        targetContainer.innerHTML = tableHTML;

        // Highlight any tickets that already have appeals (light yellow)
        const ticketRows = targetContainer.querySelectorAll("tr.ticketRow");
        ticketRows.forEach(async (row) => {
          const ticketId = row.getAttribute("data-id");
          const appealsRef = collection(db, "tickets", ticketId, "appeals");
          const appealsSnapshot = await getDocs(appealsRef);
          if (!appealsSnapshot.empty) {
            row.classList.add("appeal-highlight");
          }
        });

        // Now wire up the appropriate buttons:
        if (isAdmin) {
          // Admin “Open” buttons → toggles detail view
          const openBtns = targetContainer.querySelectorAll(".openBtn");
          openBtns.forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleDetailView(ticketId, targetContainer);
            });
          });
        } else {
          // Public “Appeal” buttons → toggles inline appeal form
          const appealBtns = targetContainer.querySelectorAll(".appealBtn");
          appealBtns.forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleAppealForm(ticketId, targetContainer);
            });
          });
        }

      } catch (err) {
        console.error("Error fetching tickets:", err);
        targetContainer.innerHTML = "<p>Error loading tickets.</p>";
      }
    }

    // ----------------------------------------------------------------
    // “View All Tickets” BUTTON (public)
    // ----------------------------------------------------------------
    viewTicketsBtn.addEventListener("click", async () => {
      showSection(viewSection);
      ticketsListContainer.innerHTML = "<p>Loading tickets…</p>";
      await fetchAndRenderTickets(ticketsListContainer, false);
    });
    backFromViewBtn.addEventListener("click", () => {
      showSection(submitSection);
    });

    // ----------------------------------------------------------------
    // ADMIN LOGIN / AUTHENTICATION
    // ----------------------------------------------------------------
    loginToggleBtn.addEventListener("click", () => {
      loginStatusMsg.textContent = "";
      emailInput.value = "";
      passwordInput.value = "";
      showSection(loginSection);
    });
    backFromLoginBtn.addEventListener("click", () => {
      showSection(submitSection);
    });

    loginBtn.addEventListener("click", async () => {
      loginBtn.disabled = true;
      loginStatusMsg.textContent = "Signing in…";
      loginStatusMsg.className = "status";
      const email = emailInput.value.trim();
      const pw    = passwordInput.value.trim();
      if (!email || !pw) {
        loginStatusMsg.textContent = "Email & password are required.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (err) {
        console.error("Login error:", err);
        loginStatusMsg.textContent = "Login failed. Check credentials.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ----------------------------------------------------------------
    // LISTEN FOR AUTH STATE CHANGES
    // ----------------------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        logoutBtn.classList.remove("hidden");
        showSection(adminSection);
        adminTicketsContainer.innerHTML = "<p>Loading tickets…</p>";
        await fetchAndRenderTickets(adminTicketsContainer, true);
      } else {
        logoutBtn.classList.add("hidden");
        showSection(submitSection);
      }
    });

    // On initial load, show the “Submit Ticket” section and populate dropdowns
    showSection(submitSection);
    populateDriverDropdown();
    populateReporterDropdown();
    populateTrackDropdown();
    populateRegulationsDropdown();

    // ----------------------------------------------------------------
    // 12) PDF GENERATION: Helper to convert an image URL to Data URL
    // ----------------------------------------------------------------
    function getImageDataURL(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.setAttribute("crossOrigin", "anonymous");
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = function(e) {
          reject(e);
        };
        img.src = url;
      });
    }

    // ----------------------------------------------------------------
    // 13) GENERATE DISCORD FORM (PDF) for a given ticket
    //     Emulates an IFWL.NET Stewards’ decision format
    // ----------------------------------------------------------------
    async function generateDiscordForm(ticketId, ticketData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        unit: "mm",
        format: "a4",
        lineHeight: 1.2
      });

      // 1) Load IFWL logo from GitHub (raw URL) and center at top
      const ifwlLogoUrl = "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/ifwl_logo.png";
      let ifwlImgData;
      try {
        ifwlImgData = await getImageDataURL(ifwlLogoUrl);
      } catch (e) {
        console.warn("Could not load IFWL logo for PDF:", e);
      }
      let y = 10;
      if (ifwlImgData) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgWidthMM = 60; // fix width to 60mm
        const imgProps = doc.getImageProperties(ifwlImgData);
        const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
        const x = (pageWidth - imgWidthMM) / 2;
        doc.addImage(ifwlImgData, "PNG", x, y, imgWidthMM, imgHeightMM);
        y += imgHeightMM + 10;
      }

      // 2) Title Line ("IFWL Steward Decision")
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("IFWL Steward Decision", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
      y += 12;

      // 3) Header block: “From: The Stewards” on left,
      //    “Document: [Ticket ID]” on right in one single right-aligned call
      doc.setFontSize(11);
      doc.setFont("helvetica", "bold");
      doc.text("From:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text("The Stewards", 25, y);

      const rightX = doc.internal.pageSize.getWidth() - 15;
      doc.setFont("helvetica", "bold");
      // Render “Document: [ID]” as a single string, right-aligned
      doc.text(`Document: ${ticketId}`, rightX, y, { align: "right" });
      y += 8;

      // 4) “To: [Reporter]” on left, “Date: YYYY-MM-DD   Time: HH:MM” on right
      doc.setFont("helvetica", "bold");
      doc.text("To:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(ticketData.reporter || "—", 25, y);

      // Format date/time from ticketData.timestamp
      let dateStr = "—";
      let timeStr = "—";
      if (ticketData.timestamp && ticketData.timestamp.toDate) {
        const d = ticketData.timestamp.toDate();
        // YYYY-MM-DD
        dateStr = d.getFullYear() + "-" +
          String(d.getMonth() + 1).padStart(2, "0") + "-" +
          String(d.getDate()).padStart(2, "0");
        // HH:MM
        timeStr = String(d.getHours()).padStart(2, "0") + ":" +
          String(d.getMinutes()).padStart(2, "0");
      }
      doc.setFont("helvetica", "bold");
      doc.text("Date:", rightX, y, { align: "right" });
      doc.setFont("helvetica", "normal");
      doc.text(dateStr, rightX - 20, y, { align: "right" });

      doc.setFont("helvetica", "bold");
      doc.text("Time:", rightX - 45, y, { align: "right" });
      doc.setFont("helvetica", "normal");
      doc.text(timeStr, rightX - 65, y, { align: "right" });
      y += 12;

      // 5) *** NEW INTRODUCTORY PARAGRAPH ***
      doc.setFont("helvetica", "normal");
      const intro = "The IFWL.NET Racing Stewards, having received a formal report from one of our drivers, " +
                    "have officially opened the ticket detailed below. At present, the stewards are undertaking a comprehensive review, " +
                    "which includes gathering any available telemetry data & consulting relevant race footage. " +
                    "As part of this process, we are adhering strictly to the procedures and timelines outlined in the ticket information. " +
                    "Please refer to the ticket for full details on the current status, next steps, and any additional documentation submitted.";
      const introLines = doc.splitTextToSize(intro, 180);
      doc.text(introLines, 15, y);
      y += introLines.length * 6 + 8;

      // 6) “No / Driver:” [Accused]
      doc.setFont("helvetica", "bold");
      doc.text("No / Driver:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(ticketData.accused || "—", 45, y);
      y += 8;

      // 7) “Competitor:” [Competition]
      doc.setFont("helvetica", "bold");
      doc.text("Competitor:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(ticketData.competition || "—", 45, y);
      y += 8;

      // 8) “Time:” [submission HH:MM]
      doc.setFont("helvetica", "bold");
      doc.text("Time:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(timeStr, 45, y);
      y += 8;

      // 9) “Session:” [Event]
      doc.setFont("helvetica", "bold");
      doc.text("Session:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(ticketData.event || "—", 45, y);
      y += 8;

      // 10) *** TICKET STATUS ***
      doc.setFont("helvetica", "bold");
      doc.text("Status:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(ticketData.status || "—", 45, y);
      y += 12;

      // 11) “Fact:” [Full Incident Summary]
      doc.setFont("helvetica", "bold");
      doc.text("Fact:", 15, y);
      doc.setFont("helvetica", "normal");
      const factLines = doc.splitTextToSize(ticketData.fullIncident || "—", 150);
      doc.text(factLines, 45, y);
      y += factLines.length * 6 + 4;

      // 12) “Offence:” [Rule Breach]
      doc.setFont("helvetica", "bold");
      doc.text("Offence:", 15, y);
      doc.setFont("helvetica", "normal");
      const offenceLines = doc.splitTextToSize(ticketData.ruleBreach || "—", 150);
      doc.text(offenceLines, 45, y);
      y += offenceLines.length * 6 + 4;

      // 13) “Decision:” [Steward Decision]
      doc.setFont("helvetica", "bold");
      doc.text("Decision:", 15, y);
      doc.setFont("helvetica", "normal");
      const decisionLines = doc.splitTextToSize(ticketData.stewardDecision || "—", 150);
      doc.text(decisionLines, 45, y);
      y += decisionLines.length * 6 + 4;

      // 14) *** “Reason:” [Full Incident Summary] (repeated) ***
      doc.setFont("helvetica", "bold");
      doc.text("Reason:", 15, y);
      doc.setFont("helvetica", "normal");
      const reasonLines = doc.splitTextToSize(ticketData.fullIncident || "—", 150);
      doc.text(reasonLines, 45, y);
      y += reasonLines.length * 6 + 8;

      // 15) Signature line: “The Stewards”
      doc.setFont("helvetica", "bold");
      doc.text("The Stewards", 15, y);
      y += 12;

      // 16) *** RACE/COMPETITION LOGO BELOW SIGNATURE ***
      // Define a map of competition → logo URL (hosted publicly). Update these URLs to match your GitHub raw paths.
      const logoMap = {
        "ACC - BEGINNER CONSOLE":    "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - BEGINNER PC":         "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - PRO AM CONSOLE":       "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - PRO AM PC":            "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - ENDURO SOLO":          "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - ENDURO TEAMS":         "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - GMC":                  "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - AMATEUR PC":           "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - AMATEUR CONSOLE":      "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "AC - all game modes":        "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/aclogo.webp",
        "AC EVO - all game modes":    "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acevologo.webp",
        "F1 2025":                    "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/formulaonelogo.webp"
      };

      const compName = ticketData.competition || "";
      if (logoMap[compName]) {
        let raceLogoData;
        try {
          raceLogoData = await getImageDataURL(logoMap[compName]);
        } catch (e) {
          console.warn("Could not load race logo:", e);
        }
        if (raceLogoData) {
          const pageWidth = doc.internal.pageSize.getWidth();
          const imgWidthMM = 40; // adjust smaller than IFWL logo
          const imgProps = doc.getImageProperties(raceLogoData);
          const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
          const x = (pageWidth - imgWidthMM) / 2;
          doc.addImage(raceLogoData, "WEBP", x, y, imgWidthMM, imgHeightMM);
          y += imgHeightMM + 10;
        }
      }

      // 17) Footer: small italic line at the very bottom with generation timestamp
      doc.setFont("helvetica", "italic");
      doc.setFontSize(10);
      const now = new Date();
      const footerText = `Generated: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")} ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
      doc.text(footerText, 15, doc.internal.pageSize.getHeight() - 15);

      // 18) Save PDF
      doc.save(`IFWL_StewardDecision_${ticketId}.pdf`);
    }
  </script>
</body>
</html>
