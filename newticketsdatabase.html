<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Tickets ‚Ä¢ Discord-linked Reporter</title>

  <style>
    @font-face {
      font-family: 'GoodTimesRG';
      src: url('GoodTimesRg.otf') format('opentype');
      font-display: swap;
    }
    header, header nav ul li a { font-family: 'GoodTimesRG', serif; }

    /* Base layout */
    body{font-family:Arial,sans-serif;background:#f7f7f7;margin:0;display:flex;flex-direction:column;align-items:center;min-height:100vh;color:#333}
    header{background:#2A9D8F;width:100%;padding:16px 0;color:#fff;text-align:center}
    .container{background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:24px;max-width:800px;width:100%;margin:24px 0}
    .section-title{margin:0 0 12px;text-align:center}
    .form-group{margin-bottom:16px}
    label{display:block;margin-bottom:6px;font-weight:700;color:#555}
    input[type="text"],input[type="url"],input[type="email"],input[type="password"],select,textarea{width:100%;padding:8px 10px;border:1px solid #ccc;border-radius:4px;box-sizing:border-box;font-size:14px}
    textarea{resize:vertical;min-height:80px}
    button{width:100%;padding:12px;font-size:16px;background:#6200EE;color:#fff;border:none;border-radius:4px;cursor:pointer}
    button:disabled{background:#999;cursor:not-allowed}
    .link-btn{background:none;border:none;color:#6200EE;text-decoration:underline;cursor:pointer;font-size:14px;margin-top:8px}
    .status{margin-top:12px;text-align:center;color:#555}
    .status.error{color:#c00}.status.success{color:#080}

    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #ccc;padding:8px;text-align:left;font-size:14px}
    th{background:#eee}

    .hidden{display:none}
    .appeal-highlight{background:#E84040}
    .finalised-row{background:#A5FF7F}

    .appeal-form{background:#fafafa;padding:16px;border:1px solid #ddd;border-radius:6px;margin-top:8px;font-size:.95rem}
    .appeal-form button{width:auto;margin-right:8px}

    .detailRow td{background:#eef7ff;padding:0}
    .detail-container{padding:16px}
    .detail-container hr{border:none;border-top:1px solid #ccc;margin:12px 0}

    .patreon-box{margin-top:24px;padding:16px;background:#fff7e6;border:2px solid #ff9c00;border-radius:8px;text-align:center}
    .patreon-btn{display:inline-block;margin-top:10px;padding:10px 18px;background:#ff424d;color:#fff;border-radius:6px;text-decoration:none;font-weight:700}

    /* Discord */
    #discordLoginBtn{width:auto;background:#5865F2}
    #discordLoggedAs{display:inline-block;margin-left:8px;font-size:14px;color:#444}
  </style>

  <!-- jsPDF (for PDFs) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body style="background:url('ifwl_bg.webp') no-repeat center top;background-size:cover;">
  <!-- Top nav -->
  <header>
    <div style="max-width:1100px;margin:0 auto;display:flex;align-items:center;justify-content:center;gap:16px;flex-wrap:wrap">
      <a href="https://ifwl.net/"><img src="ifwlheaderlogo.webp" alt="IFWL" style="height:48px"></a>
      <nav>
        <ul style="list-style:none;margin:0;padding:0;display:flex;gap:20px;flex-wrap:wrap;justify-content:center">
          <li><a href="https://ifwl.net/" style="color:#fff;text-decoration:none">Home</a></li>
          <li><a href="https://ifwl.net/events" style="color:#fff;text-decoration:none">Races</a></li>
          <li><a href="https://ifwl.net/events/competitions/standings" style="color:#fff;text-decoration:none">Standings</a></li>
          <li><a href="https://ifwl.net/grid" style="color:#fff;text-decoration:none">Grid</a></li>
          <li><a href="https://ifwl.net/paddock/safety-car" style="color:#fff;text-decoration:none">Paddock</a></li>
          <li><a href="https://ifwl.net/merchandise" style="color:#fff;text-decoration:none">Merch</a></li>
          <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/" style="color:#fff;text-decoration:none">Classifier</a></li>
          <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/ifwl_live_stewarding.html" style="color:#fff;text-decoration:none">Live Stewarding Page</a></li>
          <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/stewarding_codes.html" style="color:#fff;text-decoration:none">Stewarding Codes Explained</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <!-- Quick logout (for admins) -->
  <div style="text-align:right;margin:12px;width:100%;max-width:800px;">
    <button id="logoutBtn" class="hidden">Logout</button>
  </div>

  <!-- Menu -->
  <div id="menuSection" class="container">
    <h2 class="section-title">Ticketing</h2>
    <div class="form-group"><button id="menuViewBtn">View All Tickets</button></div>
    <div class="form-group"><button id="menuSubmitBtn">Submit Ticket</button></div>
    <div class="form-group" style="margin-bottom:0"><button id="menuAdminBtn">Admin Login</button></div>
  </div>

  <!-- Submit -->
  <div id="submitSection" class="container hidden">
    <h2 class="section-title">Submit a New Ticket</h2>
    <div class="status"><strong>Important:</strong> Ticket submissions are final and cannot be edited or withdrawn.</div>

    <!-- Accused -->
    <div class="form-group">
      <label for="accusedSelect">Accused (Driver) <span style="color:#c00">*</span></label>
      <select id="accusedSelect"><option value="" disabled selected>Select a driver‚Ä¶</option></select>
    </div>
    <div id="newDriverContainer" class="form-group hidden">
      <label for="newDriverInput"><strong>Add New Driver</strong></label>
      <input id="newDriverInput" type="text" placeholder="Type new driver name‚Ä¶">
    </div>

    <!-- Reporter + Discord OAuth -->
    <div class="form-group">
      <label for="reporterSelect">Driver Reporting <span style="color:#c00">*</span></label>
      <select id="reporterSelect"><option value="" disabled selected>Select reporting driver‚Ä¶</option></select>
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <button id="discordLoginBtn" type="button">Sign in with Discord (auto-fill me)</button>
        <span id="discordLoggedAs"></span>
      </div>
    </div>
    <div id="newReporterContainer" class="form-group hidden">
      <label for="newReporterInput"><strong>Add New Reporting Driver</strong></label>
      <input id="newReporterInput" type="text" placeholder="Type new driver name‚Ä¶">
    </div>

    <!-- Competition -->
    <div class="form-group">
      <label for="competitionSelect">Competition <span style="color:#c00">*</span></label>
      <select id="competitionSelect">
        <option value="" disabled selected>Select a competition‚Ä¶</option>
        <option>ACC - BEGINNER CONSOLE</option><option>ACC - BEGINNER PC</option>
        <option>ACC - PRO AM CONSOLE</option><option>ACC - CONSOLE OPEN TRACK</option>
        <option>ACC - PC OPEN TRACK</option><option>LMU MULTICLASS</option>
        <option>RACEROOM</option><option>ACC - PRO AM PC</option>
        <option>ACC - ENDURO SOLO</option><option>ACC - ENDURO TEAMS</option>
        <option>ACC - GMC</option><option>ACC - AMATEUR PC</option>
        <option>ACC - AMATEUR CONSOLE</option><option>AC - all game modes</option>
        <option>AC EVO - all game modes</option><option>F1 2025</option>
      </select>
    </div>

    <!-- Summary -->
    <div class="form-group">
      <label for="fullIncident">Full Incident Summary <span style="color:#c00">*</span></label>
      <textarea id="fullIncident" placeholder="Describe the incident in detail‚Ä¶"></textarea>
    </div>

    <!-- Event -->
    <div class="form-group">
      <label for="eventSelect">Event</label>
      <select id="eventSelect"><option>Practice</option><option>Qualifying</option><option>Race 1</option><option>Race 2</option><option>Race 3</option></select>
    </div>

    <!-- Proof URL -->
    <div class="form-group">
      <label for="proofUrl">Proof URL (if any)</label>
      <input id="proofUrl" type="url" placeholder="YouTube/Google Drive/Imgur‚Ä¶">
    </div>

    <!-- Season -->
    <div class="form-group">
      <label for="seasonSelect">Season</label>
      <select id="seasonSelect"><option>Test Season</option><option>Season 1</option><option>Season 2</option><option>Season 3</option><option>Season 4</option></select>
    </div>

    <!-- Track -->
    <div class="form-group">
      <label for="trackSelect">Track</label>
      <select id="trackSelect"><option value="" disabled selected>Select a track‚Ä¶</option></select>
    </div>
    <div id="newTrackContainer" class="form-group hidden">
      <label for="newTrackInput"><strong>Add New Track</strong></label>
      <input id="newTrackInput" type="text" placeholder="Type new track name‚Ä¶">
    </div>

    <!-- Rule breach -->
    <div class="form-group">
      <label for="ruleBreachSelect">Rule Breach</label>
      <select id="ruleBreachSelect"><option value="" disabled selected>Select a regulation‚Ä¶</option></select>
    </div>

    <button id="submitBtn">Submit Ticket</button>
    <div id="statusMsg" class="status"></div>
  </div>

  <!-- View -->
  <div id="viewSection" class="container hidden">
    <h2 class="section-title">All Submitted Tickets</h2>
    <div id="ticketsListContainer"></div>
    <button id="backFromViewBtn" class="link-btn">‚Üê Back to Menu</button>
  </div>

  <!-- Admin login -->
  <div id="loginSection" class="container hidden">
    <h2 class="section-title">Admin Sign-In</h2>
    <div class="form-group"><label for="email">Email</label><input id="email" type="email" placeholder="admin@example.com"></div>
    <div class="form-group"><label for="password">Password</label><input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    <button id="loginBtn">Login</button>
    <div id="loginStatusMsg" class="status"></div>
    <button id="backFromLoginBtn" class="link-btn">‚Üê Back to Menu</button>
  </div>

  <!-- Admin dashboard -->
  <div id="adminSection" class="container hidden" style="max-width:1100px">
    <h2 class="section-title">Admin Dashboard</h2>
    <button id="overviewAdminBtn" style="margin-bottom:12px;background:#444">Generate Overview PDF</button>
    <div id="adminTicketsContainer" style="overflow-x:auto"></div>
  </div>

  <!-- Patreon -->
  <template id="patreonCallout">
    <div class="patreon-box">
      <p><strong>IFWL costs over ¬£200 a month to run.</strong><br> If you wish to help towards our costs, you can join today to become a <strong>Patreon member</strong> ‚Äì this gains you access to many perks!</p>
      <a class="patreon-btn" href="https://www.patreon.com/c/IFWL" target="_blank" rel="noopener">üíô Support IFWL on Patreon</a>
    </div>
  </template>

  <!-- Firebase + App -->
  <script type="module">
    /* ---------- Config ---------- */
    const OAUTH_START_URL = 'https://oauthdiscordstart-vdr3uafd2q-nw.a.run.app';
    // We accept messages from any *.run.app (your function callback will postMessage from there)
    const RUN_APP_SUFFIX = '.run.app';

    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs, getDoc,
      query, where, orderBy, serverTimestamp, updateDoc, doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    /* ---------- DOM ---------- */
    const sections = {
      menu: document.getElementById('menuSection'),
      submit: document.getElementById('submitSection'),
      view: document.getElementById('viewSection'),
      login: document.getElementById('loginSection'),
      admin: document.getElementById('adminSection'),
    };

    const menuViewBtn  = document.getElementById('menuViewBtn');
    const menuSubmitBtn= document.getElementById('menuSubmitBtn');
    const menuAdminBtn = document.getElementById('menuAdminBtn');

    const accusedSelect = document.getElementById('accusedSelect');
    const newDriverContainer = document.getElementById('newDriverContainer');
    const newDriverInput = document.getElementById('newDriverInput');

    const reporterSelect = document.getElementById('reporterSelect');
    const newReporterContainer = document.getElementById('newReporterContainer');
    const newReporterInput = document.getElementById('newReporterInput');

    const competitionSelect = document.getElementById('competitionSelect');
    const fullIncident = document.getElementById('fullIncident');
    const eventSelect = document.getElementById('eventSelect');
    const proofUrlInput = document.getElementById('proofUrl');
    const seasonSelect = document.getElementById('seasonSelect');

    const trackSelect = document.getElementById('trackSelect');
    const newTrackContainer = document.getElementById('newTrackContainer');
    const newTrackInput = document.getElementById('newTrackInput');

    const ruleBreachSelect = document.getElementById('ruleBreachSelect');

    const submitBtn = document.getElementById('submitBtn');
    const statusMsg = document.getElementById('statusMsg');

    const backFromViewBtn = document.getElementById('backFromViewBtn');
    const ticketsListContainer = document.getElementById('ticketsListContainer');

    const loginBtn = document.getElementById('loginBtn');
    const backFromLoginBtn = document.getElementById('backFromLoginBtn');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginStatusMsg = document.getElementById('loginStatusMsg');

    const logoutBtn = document.getElementById('logoutBtn');
    const adminTicketsContainer = document.getElementById('adminTicketsContainer');
    const overviewAdminBtn = document.getElementById('overviewAdminBtn');

    const patreonTpl = document.getElementById('patreonCallout');

    const discordLoginBtn = document.getElementById('discordLoginBtn');
    const discordLoggedAs = document.getElementById('discordLoggedAs');

    /* ---------- State for Discord user ---------- */
    let discordUser = null; // { id, username, global_name }
    let reporterAutofilled = false;

    /* ---------- Helpers ---------- */
    function showSection(key){
      Object.values(sections).forEach(s => s.classList.add('hidden'));
      sections[key].classList.remove('hidden');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function addPatreonCallout(el){
      const n = patreonTpl.content.firstElementChild.cloneNode(true);
      el.appendChild(n);
    }
    Object.values(sections).forEach(addPatreonCallout);

    async function populateSimple(colName, field, selectEl, addNewLabel){
      const snap = await getDocs(collection(db, colName));
      const arr=[]; snap.forEach(d => { const v=d.data()[field]; if(typeof v==='string') arr.push(v); });
      arr.sort((a,b)=>a.localeCompare(b));
      selectEl.innerHTML='';
      const ph=document.createElement('option');ph.value='';ph.textContent='Select‚Ä¶';ph.disabled=true;ph.selected=true;selectEl.appendChild(ph);
      arr.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;selectEl.appendChild(o);});
      if(addNewLabel){
        const o=document.createElement('option');o.value='__ADD_NEW__';o.textContent='‚ûï '+addNewLabel;selectEl.appendChild(o);
      }
    }

    async function populateDropdowns(){
      await populateSimple('drivers','fullName',accusedSelect,'Add New Driver‚Ä¶');
      await populateSimple('drivers','fullName',reporterSelect,'Add New Reporting Driver‚Ä¶');
      await populateSimple('tracks','name',trackSelect,'Add New Track‚Ä¶');

      // regulations
      const rs = await getDocs(collection(db,'regulations'));
      const regs=[]; rs.forEach(d=>{const n=d.data().name; if(typeof n==='string') regs.push(n);});
      regs.sort((a,b)=>a.localeCompare(b));
      ruleBreachSelect.innerHTML='';
      const ph=document.createElement('option');ph.value='';ph.textContent='Select a regulation‚Ä¶';ph.disabled=true;ph.selected=true;ruleBreachSelect.appendChild(ph);
      regs.forEach(n=>{const o=document.createElement('option');o.value=n;o.textContent=n;ruleBreachSelect.appendChild(o);});
    }

    accusedSelect.addEventListener('change',()=>newDriverContainer.classList.toggle('hidden',accusedSelect.value!=='__ADD_NEW__'));
    reporterSelect.addEventListener('change',()=>newReporterContainer.classList.toggle('hidden',reporterSelect.value!=='__ADD_NEW__'));
    trackSelect.addEventListener('change',()=>newTrackContainer.classList.toggle('hidden',trackSelect.value!=='__ADD_NEW__'));

    /* ---------- Discord OAuth popup ---------- */
    discordLoginBtn.addEventListener('click', () => {
      const w = 520, h = 720;
      const left = window.screenX + Math.max(0,(window.outerWidth - w)/2);
      const top  = window.screenY + Math.max(0,(window.outerHeight - h)/2);
      window.open(OAUTH_START_URL, 'ifwl_discord', `width=${w},height=${h},left=${left},top=${top}`);
    });

    window.addEventListener('message', (event) => {
      // Only accept from *.run.app (your Cloud Function)
      try {
        if (!event.origin.endsWith(RUN_APP_SUFFIX)) return;
      } catch { return; }
      const data = event.data || {};
      if (data.type !== 'IFWL_DISCORD_AUTH') return;

      if (data.ok && data.user) {
        discordUser = data.user; // { id, username, global_name }
        // Prefer global_name (display), else username
        const nameToUse = discordUser.global_name || discordUser.username || '';
        discordLoggedAs.textContent = `Signed in as ${nameToUse}`;
        // Try to select reporter matching name; else flip to "add new" with that name
        let matched = false;
        Array.from(reporterSelect.options).forEach(o=>{
          if(o.value.toLowerCase()===nameToUse.toLowerCase()){ reporterSelect.value=o.value; matched=true; }
        });
        if(!matched){
          reporterSelect.value='__ADD_NEW__';
          newReporterContainer.classList.remove('hidden');
          newReporterInput.value = nameToUse;
        }
        reporterAutofilled = true;
      } else {
        discordLoggedAs.textContent = 'Discord sign-in was cancelled or failed.';
      }
    });

    /* ---------- Submit ticket ---------- */
    submitBtn.addEventListener('click', async () => {
      submitBtn.disabled = true; statusMsg.className='status'; statusMsg.textContent='Submitting‚Ä¶';

      let accused = accusedSelect.value;
      const newDriverName = newDriverInput.value.trim();

      let reporter = reporterSelect.value;
      const newReporterName = newReporterInput.value.trim();

      const competition = competitionSelect.value;
      const summary = fullIncident.value.trim();
      const eventVal = eventSelect.value;
      const proofUrl = proofUrlInput.value.trim();
      const season = seasonSelect.value;

      let track = trackSelect.value;
      const newTrackName = newTrackInput.value.trim();

      const ruleBreach = ruleBreachSelect.value;

      if (((!accused && !newDriverName)) || ((!reporter && !newReporterName)) || !competition || !summary) {
        statusMsg.textContent = 'Please fill all required fields (Accused, Driver Reporting, Competition, Summary).';
        statusMsg.className = 'status error'; submitBtn.disabled=false; return;
      }

      try {
        if (accused === '__ADD_NEW__' && newDriverName) {
          accused = newDriverName;
          await addDoc(collection(db,'drivers'), { fullName:newDriverName });
        }
        if (reporter === '__ADD_NEW__' && newReporterName) {
          reporter = newReporterName;
          await addDoc(collection(db,'drivers'), { fullName:newReporterName });
        }
        if (track === '__ADD_NEW__' && newTrackName) {
          track = newTrackName;
          await addDoc(collection(db,'tracks'), { name:newTrackName });
        }
      } catch (e) {
        console.warn('Optional add-to-lists failed:', e);
      }

      const newTicket = {
        accused, reporter, competition,
        fullIncident: summary,
        event: eventVal,
        proofUrl, season, track, ruleBreach,
        status: 'New Submission',
        stewardDecision: '',
        stewardTag: '',
        timestamp: serverTimestamp(),
        // Discord info if available:
        reporterDiscordId: discordUser?.id || null,
        reporterDiscordUsername: discordUser ? (discordUser.global_name || discordUser.username || null) : null
      };

      try {
        await addDoc(collection(db,'tickets'), newTicket);
        statusMsg.textContent = 'Ticket submitted. Thank you!';
        statusMsg.className = 'status success';

        // Reset
        accusedSelect.value=''; newDriverContainer.classList.add('hidden'); newDriverInput.value='';
        reporterSelect.value=''; newReporterContainer.classList.add('hidden'); newReporterInput.value='';
        fullIncident.value=''; eventSelect.value='Practice'; proofUrlInput.value=''; seasonSelect.value='Test Season';
        trackSelect.value=''; newTrackContainer.classList.add('hidden'); newTrackInput.value='';
        ruleBreachSelect.value='';

      } catch (err) {
        console.error(err);
        statusMsg.textContent = 'Error submitting ticket. Please try again.';
        statusMsg.className = 'status error';
      } finally {
        submitBtn.disabled=false;
      }
    });

    /* ---------- Public appeals + Admin detail / list rendering ---------- */
    async function toggleAppealForm(ticketId, container){
      const exists = container.querySelector('.appealFormRow'); if (exists) exists.remove();
      const row = container.querySelector(`tr[data-id="${ticketId}"]`); if (!row) return;

      const tr=document.createElement('tr'); tr.className='appealFormRow';
      tr.innerHTML = `<td colspan="8">
        <div class="appeal-form">
          <label><strong>Appeal Info</strong></label>
          <textarea id="appealInfo-${ticketId}" rows="3" placeholder="Enter your appeal details‚Ä¶"></textarea>
          <label><strong>Extra Video Proof URL</strong></label>
          <input id="extraProof-${ticketId}" type="url" placeholder="https://‚Ä¶">
          <div style="margin-top:8px">
            <button id="submitAppeal-${ticketId}">Submit Appeal</button>
            <button id="cancelAppeal-${ticketId}" style="background:#999">Cancel</button>
          </div>
          <div id="appealStatus-${ticketId}" class="status"></div>
        </div></td>`;
      row.insertAdjacentElement('afterend', tr);

      document.getElementById(`cancelAppeal-${ticketId}`).onclick=()=>tr.remove();
      document.getElementById(`submitAppeal-${ticketId}`).onclick=async()=>{
        const info = (document.getElementById(`appealInfo-${ticketId}`).value||'').trim();
        const extra= (document.getElementById(`extraProof-${ticketId}`).value||'').trim();
        const s = document.getElementById(`appealStatus-${ticketId}`);
        if(!info){ s.textContent='Please enter your appeal details.'; s.className='status error'; return; }
        s.textContent='Submitting appeal‚Ä¶'; s.className='status';
        try{
          await addDoc(collection(db,'tickets',ticketId,'appeals'), { appealInfo:info, extraProofUrl:extra, timestamp:serverTimestamp() });
          s.textContent='Appeal submitted!'; s.className='status success'; setTimeout(()=>tr.remove(),1500);
        }catch(e){ s.textContent='Error submitting appeal.'; s.className='status error'; }
      };
    }

    async function toggleDetailView(ticketId, container){
      const exists = container.querySelector('.detailRow'); if (exists) exists.remove();
      const row = container.querySelector(`tr[data-id="${ticketId}"]`); if (!row) return;

      const tSnap = await getDoc(doc(db,'tickets',ticketId)); if(!tSnap.exists()) return;
      const t = tSnap.data();

      const appeals = await getDocs(collection(db,'tickets',ticketId,'appeals'));
      let appealsHTML='';
      appeals.forEach(a=>{
        const d=a.data(); const ts=d.timestamp?.toDate?d.timestamp.toDate().toLocaleString():'';
        appealsHTML += `<div class="appeal-box"><div><strong>Appeal:</strong> ${d.appealInfo||''}</div><div><strong>Extra Proof:</strong> ${d.extraProofUrl||'N/A'}</div><div style="font-size:.85rem;color:#555"><em>${ts}</em></div></div>`;
      });

      const tr=document.createElement('tr'); tr.className='detailRow';
      tr.innerHTML = `<td colspan="8">
        <div class="detail-container">
          <h3>Ticket Details</h3>
          <p><strong>ID:</strong> ${ticketId}</p>
          <p><strong>Accused:</strong> ${t.accused||''}</p>
          <p><strong>Driver Reporting:</strong> ${t.reporter||''} ${t.reporterDiscordUsername?`<span style="color:#555">(Discord: ${t.reporterDiscordUsername})</span>`:''}</p>
          <p><strong>Competition:</strong> ${t.competition||''}</p>
          <p><strong>Full Incident Summary:</strong> ${t.fullIncident||''}</p>
          <p><strong>Event:</strong> ${t.event||''}</p>
          <p><strong>Proof URL:</strong> ${t.proofUrl?`<a href="${t.proofUrl}" target="_blank" rel="noopener">${t.proofUrl}</a>`:'N/A'}</p>
          <p><strong>Season:</strong> ${t.season||''}</p>
          <p><strong>Track:</strong> ${t.track||''}</p>
          <p><strong>Rule Breach:</strong> ${t.ruleBreach||''}</p>
          <p><strong>Status:</strong> ${t.status||''}</p>
          ${appealsHTML?`<hr><h4>Appeals</h4>${appealsHTML}`:''}
          <hr>
          <div class="review-form">
            <h4>Admin Review</h4>
            <label><strong>Select Outcome</strong></label>
            <select id="status-${ticketId}">
              <option ${t.status==='Under Review'?'selected':''}>Under Review</option>
              <option ${t.status==='Finalised'?'selected':''}>Finalised</option>
              <option ${t.status==='Appeal In Progress'?'selected':''}>Appeal In Progress</option>
            </select>
            <label><strong>Steward Decision</strong></label>
            <textarea id="decision-${ticketId}" rows="3">${t.stewardDecision||''}</textarea>
            <label><strong>Assigned Steward</strong></label>
            <input id="steward-${ticketId}" type="text" value="${t.stewardTag||''}">
            <label><strong>Post-Race Code</strong></label>
            <input id="postrc-${ticketId}" type="text" value="${t.postRaceCode||''}" placeholder="RP‚Ä¶">
            <label><strong>Future Advice</strong></label>
            <input id="advice-${ticketId}" type="text" value="${t.futureAdvice||''}">
            <div style="margin-top:8px">
              <button id="update-${ticketId}">Update Ticket</button>
              <button id="close-${ticketId}" style="background:#999">Close</button>
            </div>
            <div id="detailStatus-${ticketId}" class="status"></div>
          </div>
        </div>
      </td>`;
      row.insertAdjacentElement('afterend', tr);

      document.getElementById(`close-${ticketId}`).onclick=()=>tr.remove();
      document.getElementById(`update-${ticketId}`).onclick=async()=>{
        const s = document.getElementById(`detailStatus-${ticketId}`);
        s.textContent='Saving‚Ä¶'; s.className='status';
        try{
          await updateDoc(doc(db,'tickets',ticketId),{
            status: document.getElementById(`status-${ticketId}`).value,
            stewardDecision: document.getElementById(`decision-${ticketId}`).value.trim(),
            stewardTag: document.getElementById(`steward-${ticketId}`).value.trim(),
            postRaceCode: document.getElementById(`postrc-${ticketId}`).value.trim(),
            futureAdvice: document.getElementById(`advice-${ticketId}`).value.trim()
          });
          s.textContent='Updated!'; s.className='status success';
          setTimeout(()=>tr.remove(),800);
          await fetchAndRenderTickets(adminTicketsContainer,true);
        }catch(e){ s.textContent='Update failed.'; s.className='status error'; }
      };
    }

    async function fetchAndRenderTickets(target,isAdmin=false){
      try{
        const snap = await getDocs(query(collection(db,'tickets')));
        if (snap.empty){ target.innerHTML='<p>No tickets yet.</p>'; return; }
        let html = `<table><thead><tr>
          <th>ID</th><th>Accused</th><th>Reporter</th><th>Competition</th>
          <th>Status</th><th>Assigned Steward</th><th>Submitted At</th><th>Action</th>
        </tr></thead><tbody>`;
        snap.forEach(d=>{
          const t=d.data(); const ts=t.timestamp?.toDate? t.timestamp.toDate().toLocaleString():'';
          const id=d.id; const isFinal=t.status==='Finalised';
          html += `<tr data-id="${id}" class="ticketRow ${isFinal?'finalised-row':''}">
            <td>${id}</td><td>${t.accused||''}</td><td>${t.reporter||''}</td>
            <td>${t.competition||''}</td><td>${t.status||''}</td>
            <td>${t.stewardTag||''}</td><td>${ts}</td>
            <td>${isAdmin?`<button class="openBtn" data-id="${id}">Open</button>`:`<button class="appealBtn" data-id="${id}">Appeal</button>`}</td>
          </tr>`;
        });
        html+='</tbody></table>';
        target.innerHTML=html;

        // mark appeals
        const rows = target.querySelectorAll('tr.ticketRow');
        for (const r of rows){
          const id=r.getAttribute('data-id');
          const a=await getDocs(collection(db,'tickets',id,'appeals'));
          if(!a.empty) r.classList.add('appeal-highlight');
        }

        if(isAdmin){
          target.querySelectorAll('.openBtn').forEach(b=>b.onclick=(e)=>toggleDetailView(e.currentTarget.dataset.id,target));
        }else{
          target.querySelectorAll('.appealBtn').forEach(b=>b.onclick=(e)=>toggleAppealForm(e.currentTarget.dataset.id,target));
        }
      }catch(e){ target.innerHTML='<p>Error loading tickets.</p>'; }
    }

    /* ---------- Nav ---------- */
    menuViewBtn.onclick = async()=>{ showSection('view'); ticketsListContainer.innerHTML='<p>Loading‚Ä¶</p>'; await fetchAndRenderTickets(ticketsListContainer,false); };
    menuSubmitBtn.onclick=()=>showSection('submit');
    menuAdminBtn.onclick =()=>showSection('login');
    backFromViewBtn.onclick=()=>showSection('menu');
    backFromLoginBtn.onclick=()=>showSection('menu');

    /* ---------- Auth ---------- */
    loginBtn.onclick = async()=>{
      loginBtn.disabled=true; loginStatusMsg.textContent='Signing in‚Ä¶'; loginStatusMsg.className='status';
      try{ await signInWithEmailAndPassword(auth,emailInput.value.trim(),passwordInput.value.trim()); }
      catch(e){ loginStatusMsg.textContent='Login failed.'; loginStatusMsg.className='status error'; loginBtn.disabled=false; }
    };
    logoutBtn.onclick=()=>signOut(auth);

    onAuthStateChanged(auth, async(user)=>{
      if(user){ logoutBtn.classList.remove('hidden'); showSection('admin'); adminTicketsContainer.innerHTML='<p>Loading‚Ä¶</p>'; await fetchAndRenderTickets(adminTicketsContainer,true); }
      else{ logoutBtn.classList.add('hidden'); showSection('menu'); }
    });

    /* ---------- Overview PDF (simple) ---------- */
    overviewAdminBtn.onclick = async()=>{
      const fourDaysAgo=new Date(); fourDaysAgo.setDate(fourDaysAgo.getDate()-4);
      const q = query(collection(db,'tickets'), where('timestamp','>=',fourDaysAgo), orderBy('timestamp','asc'));
      const snap = await getDocs(q);
      if (snap.empty){ alert('No tickets found in the last 4 days.'); return; }
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF(); let y=20;
      pdf.setFontSize(16); pdf.text('Ticket Overview (Last 4 Days)',14,y); y+=10; pdf.setFontSize(11);
      pdf.text('Driver',14,y); pdf.text('Competition',80,y); pdf.text('Code',160,y); y+=7;
      snap.forEach(d=>{ const t=d.data(); pdf.text(t.accused||'',14,y); pdf.text(t.competition||'',80,y); pdf.text(t.postRaceCode||'-',160,y); y+=7; if(y>280){pdf.addPage(); y=15;} });
      pdf.save('ticket_overview.pdf');
    };

    /* ---------- Init ---------- */
    await populateDropdowns();
    showSection('menu');
  </script>
</body>
</html>
