<!DOCTYPE html>
<html lang="en">
<head>

  <style>
    @font-face {
      font-family: 'GoodTimesRG';
      src: url('GoodTimesRg.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    /* Apply custom font to header and nav links */
    header, header nav ul li a {
      font-family: 'GoodTimesRG', serif;
      font-style: normal;
    }
  </style>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Tickets ‚Ä¢ Highlight Finalised Tickets</title>
  <style>
    /* ------------------------------------------------------------
       Base styling for the entire page
       ------------------------------------------------------------ */
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #6200EE;
      width: 100%;
      padding: 12px 0;
      color: #fff;
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 24px;
      position: relative;
    }
    .logout-btn {
      background-color: transparent;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 16px;
      top: 12px;
    }

    .container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      padding: 24px;
      max-width: 800px;
      width: 100%;
      margin-bottom: 24px;
    }
    .section-title {
      margin-top: 0;
      text-align: center;
      color: #333;
      font-size: 1.2rem;
      margin-bottom: 12px;
    }
    .form-group {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"],
    input[type="url"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    textarea {
      resize: vertical;
      min-height: 80px;
    }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #6200EE;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    .link-btn {
      background: none;
      border: none;
      color: #6200EE;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .status.error { color: #c00; }
    .status.success { color: #080; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background: #eee;
    }

    .hidden {
      display: none;
    }

    /* ------------------------------------------------------------
       Highlight full ticket row if appealed
       ------------------------------------------------------------ */
    .appeal-highlight {
      background-color: #E84040; /* red tint for appealed rows */
    }

    /* ------------------------------------------------------------
       Highlight entire row if status = "Finalised"
       ------------------------------------------------------------ */
    .finalised-row {
      background-color: #A5FF7F; /* light green */
    }

    /* ------------------------------------------------------------
       Styles for the inline appeal form in public view
       ------------------------------------------------------------ */
    .appeal-form {
      background: #fafafa;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .appeal-form input[type="text"],
    .appeal-form textarea {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .appeal-form button {
      width: auto;
      margin-right: 8px;
    }

    /* ------------------------------------------------------------
       Styles for the detailed view row in admin
       ------------------------------------------------------------ */
    .detailRow td {
      background-color: #eef7ff; /* very light blue */
      padding: 0;
    }
    .detail-container {
      padding: 16px;
      font-size: 0.95rem;
    }
    .detail-container p {
      margin: 4px 0;
    }
    .detail-container a {
      color: #1a0dab;
      text-decoration: underline;
    }
    .detail-container hr {
      margin: 12px 0;
      border: none;
      border-top: 1px solid #ccc;
    }
    .detail-container .appeal-box {
      padding: 8px;
      border: 1px solid #f5e6a0;
      border-radius: 4px;
      background-color: #fffdf0;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #333;
    }
    .detail-container .appeal-box strong {
      color: #b36b00;
    }
    .detail-container .review-form {
      background: #eef7ff;
      padding: 12px;
      border: 1px solid #9ecfff;
      border-radius: 6px;
      margin-top: 12px;
    }
    .detail-container .review-form select,
    .detail-container .review-form textarea,
    .detail-container .review-form input[type="text"] {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .detail-container .review-form button {
      width: auto;
      margin-right: 8px;
    }

    /* ------------------------------------------------------------
       Patreon callout (used in every section)
       ------------------------------------------------------------ */
    .patreon-box{
      margin-top:24px;
      padding:16px;
      background:#fff7e6;
      border:2px solid #ff9c00;
      border-radius:8px;
      text-align:center;
      font-size:15px;
    }
    .patreon-box p{ margin:0; }
    .patreon-box strong{ color:#000; }
    .patreon-btn{
      display:inline-block;
      margin-top:10px;
      padding:10px 18px;
      font-size:16px;
      background-color:#ff424d;
      color:#fff;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      transition:background .2s ease-in-out;
    }
    .patreon-btn:hover{ background-color:#e53742; }
  </style>
  <!-- jsPDF UMD build for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body style="margin:0;font-family:sans-serif;background:url('ifwl_bg.webp') no-repeat center top;background-size:cover;">
  
<header style="background-color:#2A9D8F; padding:16px 0;">
  <div style="max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:center;">
    <a href="https://ifwl.net/">
      <img src="ifwlheaderlogo.webp" alt="IFWL" style="height:48px;">
    </a>
    <nav>
      <ul style="list-style:none; margin:0; padding:0; display:flex; gap:24px; white-space:nowrap; justify-content:center;">
        <li><a href="https://ifwl.net/" style="color:#FFF; text-decoration:none;">Home</a></li>
        <li><a href="https://ifwl.net/events" style="color:#FFF; text-decoration:none;">Races</a></li>
        <li><a href="https://ifwl.net/events/competitions/standings" style="color:#FFF; text-decoration:none;">Standings</a></li>
        <li><a href="https://ifwl.net/grid" style="color:#FFF; text-decoration:none;">Grid</a></li>
        <li><a href="https://ifwl.net/paddock/safety-car" style="color:#FFF; text-decoration:none;">Paddock</a></li>
        <li><a href="https://ifwl.net/merchandise" style="color:#FFF; text-decoration:none;">Merch</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/" style="color:#FFF; text-decoration:none;">Classifier</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/ifwl_live_stewarding.html" style="color:#FFF; text-decoration:none;">Live Stewarding Page</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/stewarding_codes.html" style="color:#FFF; text-decoration:none;">Stewarding Codes Explained</a></li>
      </ul>
    </nav>
  </div>
</header>

<div style="text-align:right; margin:12px; width:100%; max-width:800px;">
  <button id="logoutBtn" style="padding:6px 12px; font-size:14px; cursor:pointer;">Logout</button>
</div>

  <!-- ==============================================================
       MENU SECTION (landing view)
       ============================================================== -->
  <div id="menuSection" class="container">
    <h2 class="section-title">Ticketing</h2>
    <div class="form-group">
      <button id="menuViewBtn">View All Tickets</button>
    </div>
    <div class="form-group">
      <button id="menuSubmitBtn">Submit Ticket</button>
    </div>
    <div class="form-group" style="margin-bottom:0;">
      <button id="menuAdminBtn">Admin Login</button>
    </div>
  </div>

  <!-- ==============================================================
       SECTION 1: SUBMIT A NEW TICKET (VISIBLE TO EVERYONE)
       ============================================================== -->
  <div id="submitSection" class="container hidden">
    <h2 class="section-title">Submit a New Ticket</h2>

    <div class="status" style="margin-bottom:16px;">
      <strong>Important:</strong> Ticket submissions are final. Once submitted, a ticket
      <strong>cannot be withdrawn or edited</strong>. Please review carefully before submitting.
    </div>

    <!-- Accused (Driver) Dropdown -->
    <div class="form-group">
      <label for="accusedSelect">Accused (Driver) <span style="color: red;">*</span></label>
      <select id="accusedSelect">
        <option value="" disabled selected>Select a driver‚Ä¶</option>
      </select>
    </div>
    <div id="newDriverContainer" class="form-group hidden">
      <label for="newDriverInput"><strong>Add New Driver</strong></label>
      <input type="text" id="newDriverInput" placeholder="Type new driver name‚Ä¶" />
    </div>

    <!-- Driver Reporting Dropdown -->
    <div class="form-group">
      <label for="reporterSelect">Driver Reporting <span style="color: red;">*</span></label>
      <select id="reporterSelect">
        <option value="" disabled selected>Select reporting driver‚Ä¶</option>
      </select>
    </div>
    <div id="newReporterContainer" class="form-group hidden">
      <label for="newReporterInput"><strong>Add New Reporting Driver</strong></label>
      <input type="text" id="newReporterInput" placeholder="Type new driver name‚Ä¶" />
    </div>

    <!-- Competition Dropdown (hard-coded) -->
    <div class="form-group">
      <label for="competitionSelect">Competition <span style="color: red;">*</span></label>
      <select id="competitionSelect">
  <option value="" disabled selected>Select a competition‚Ä¶</option>

  <!-- EXISTING OPTIONS (TEST SEASON) -->
  <option value="TEST SEASON - ACC - BEGINNER CONSOLE">TEST SEASON - ACC - BEGINNER CONSOLE</option>
  <option value="TEST SEASON - ACC - BEGINNER PC">TEST SEASON - ACC - BEGINNER PC</option>
  <option value="TEST SEASON - ACC - PRO AM CONSOLE">TEST SEASON - ACC - PRO AM CONSOLE</option>
  <option value="TEST SEASON - ACC - CONSOLE OPEN TRACK">TEST SEASON - ACC - CONSOLE OPEN TRACK</option>
  <option value="TEST SEASON - ACC - CONSOLE MAX MINI ENDURO">TEST SEASON - ACC - CONSOLE MAX MINI ENDURO</option>
  <option value="TEST SEASON - ACC - PC GT3GT4 MULTI CLASS">TEST SEASON - ACC - PC GT3GT4 MULTI CLASS</option>
  <option value="TEST SEASON - ACC - PC OPEN TRACK">TEST SEASON - ACC - PC OPEN TRACK</option>
  <option value="TEST SEASON - LMU MULTICLASS">TEST SEASON - LMU MULTICLASS</option>
  <option value="TEST SEASON - RACEROOM">TEST SEASON - RACEROOM</option>
  <option value="TEST SEASON - ACC - PRO AM PC">TEST SEASON - ACC - PRO AM PC</option>
  <option value="TEST SEASON - ACC - ENDURO SOLO">TEST SEASON - ACC - ENDURO SOLO</option>
  <option value="TEST SEASON - ACC - ENDURO TEAMS">TEST SEASON - ACC - ENDURO TEAMS</option>
  <option value="TEST SEASON - ACC - GMC">TEST SEASON - ACC - GMC</option>
  <option value="TEST SEASON - ACC - AMATEUR PC">TEST SEASON - ACC - AMATEUR PC</option>
  <option value="TEST SEASON - ACC - AMATEUR CONSOLE">TEST SEASON - ACC - AMATEUR CONSOLE</option>
  <option value="TEST SEASON - AC - all game modes">TEST SEASON - AC ‚Äì all game modes</option>
  <option value="TEST SEASON - AC EVO - all game modes">TEST SEASON - AC EVO ‚Äì all game modes</option>
  <option value="TEST SEASON - F1 2025">TEST SEASON - F1 2025</option>

  <!-- NEW OPTIONS YOU ASKED FOR (SEASON 1) -->
  <option value="SEASON 1 - RACEROOM VTCC">SEASON 1 - RACEROOM VTCC</option>
  <option value="SEASON 1 - RACEROOM N-GT">SEASON 1 - RACEROOM N-GT</option>
  <option value="SEASON 1 - PMR - MX-5">SEASON 1 - PMR ‚Äì MX-5</option>

  <!-- SCREENSHOT ITEMS (SEASON 1) -->
  <option value="SEASON 1 - AC EVO - BMW M2 CUP SERIES">SEASON 1 - AC EVO - BMW M2 CUP SERIES</option>
  <option value="SEASON 1 - ACC PC - BEGINNERS">SEASON 1 - ACC PC - BEGINNERS</option>
  <option value="SEASON 1 - ACC CONSOLE">SEASON 1 - ACC CONSOLE</option>
  <option value="SEASON 1 - RACEROOM - SERIES TBA">SEASON 1 - RACEROOM - SERIES TBA</option>
  <option value="SEASON 1 - ACC - MAX MINI ENDURO">SEASON 1 - ACC - MAX MINI ENDURO</option>
  <option value="SEASON 1 - ACC PC - OPEN TRACK">SEASON 1 - ACC PC - OPEN TRACK</option>
  <option value="SEASON 1 - PMR SERIES TBA">SEASON 1 - PMR SERIES TBA</option>
  <option value="SEASON 1 - ACC TEAM ENDURO">SEASON 1 - ACC TEAM ENDURO</option>
  <option value="SEASON 1 - ACC SOLO ENDURO">SEASON 1 - ACC SOLO ENDURO</option>
  <option value="SEASON 1 - ACC PC - PRO AM SERIES">SEASON 1 - ACC PC - PRO AM SERIES</option>
</select>
    </div>

    <!-- Full Incident Summary -->
    <div class="form-group">
      <label for="fullIncident">Full Incident Summary <span style="color: red;">*</span></label>
      <textarea id="fullIncident" placeholder="Describe the incident in detail‚Ä¶" required></textarea>
    </div>

    <!-- Event Dropdown (static) -->
    <div class="form-group">
      <label for="eventSelect">Event</label>
      <select id="eventSelect">
        <option value="Practice">Practice</option>
        <option value="Qualifying">Qualifying</option>
        <option value="Race 1">Race 1</option>
        <option value="Race 2">Race 2</option>
        <option value="Race 3">Race 3</option>
      </select>
    </div>

    <!-- Proof URL (public, but omitted from PDF) -->
    <div class="form-group">
      <label for="proofUrl">Proof URL (if any)</label>
      <input type="url" id="proofUrl" placeholder="any video or image hosting site such as youtube/google drive/imgur" />
    </div>

    <!-- Season Dropdown (static) -->
    <div class="form-group">
      <label for="seasonSelect">Season</label>
      <select id="seasonSelect">
        <option value="Test Season">Test Season</option>
        <option value="Season 1">Season 1</option>
        <option value="Season 2">Season 2</option>
        <option value="Season 3">Season 3</option>
        <option value="Season 4">Season 4</option>
      </select>
    </div>

    <!-- Track Dropdown (dynamic) -->
    <div class="form-group">
      <label for="trackSelect">Track</label>
      <select id="trackSelect">
        <option value="" disabled selected>Select a track‚Ä¶</option>
      </select>
    </div>
    <div id="newTrackContainer" class="form-group hidden">
      <label for="newTrackInput"><strong>Add New Track</strong></label>
      <input type="text" id="newTrackInput" placeholder="Type new track name‚Ä¶" />
    </div>

    <!-- Rule Breach Dropdown (dynamic from /regulations) -->
    <div class="form-group">
      <label for="ruleBreachSelect">Rule Breach</label>
      <select id="ruleBreachSelect">
        <option value="" disabled selected>Select a regulation‚Ä¶</option>
      </select>
    </div>

    <!-- Submit Button -->
    <button id="submitBtn">Submit Ticket</button>
    <div class="status" id="statusMsg"></div>

    <!-- (Links replaced by menu; keep hidden to avoid layout shifts) -->
    <button id="viewTicketsBtn" class="link-btn hidden">View All Tickets</button>
    <button id="loginToggleBtn" class="link-btn hidden">Admin Login</button>
  </div>

  <!-- ==============================================================
       SECTION 2: VIEW ALL TICKETS (PUBLIC, WITH INLINE APPEAL FORM)
       ============================================================== -->
  <div id="viewSection" class="container hidden">
    <h2 class="section-title">All Submitted Tickets</h2>
    <div id="ticketsListContainer">
      <!-- Public table + inline appeal form will be injected here -->
    </div>
    <button id="backFromViewBtn" class="link-btn">‚Üê Back to Menu</button>
  </div>

  <!-- ==============================================================
       SECTION 3: LOGIN FORM (for Admins)
       ============================================================== -->
  <div id="loginSection" class="container hidden">
    <h2 class="section-title">Admin Sign-In</h2>
    <div class="form-group">
      <label for="email">Email <span style="color: red;">*</span></label>
      <input type="email" id="email" placeholder="admin@example.com" required />
    </div>
    <div class="form-group">
      <label for="password">Password <span style="color: red;">*</span></label>
      <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
    </div>
    <button id="loginBtn">Login</button>
    <div class="status" id="loginStatusMsg"></div>
    <button id="backFromLoginBtn" class="link-btn">‚Üê Back to Menu</button>
  </div>

  <!-- ==============================================================
       SECTION 4: ADMIN DASHBOARD (PRIVATE, WITH DETAIL VIEW)
       ============================================================== -->
  <div id="adminSection" class="container hidden" style="max-width: 1100px; padding:24px;">
    <h2 class="section-title">Admin Dashboard</h2>
    <button id="overviewAdminBtn" style="margin-bottom:12px; padding:8px 16px; background-color:#444; color:#fff; border:none; border-radius:4px; cursor:pointer;">Generate Overview PDF</button>
    <div id="adminTicketsContainer" style="overflow-x:auto;">
      <!-- Admin table will be injected here -->
    </div>
  </div>

  <!-- ==============================================================
       Patreon callout template (cloned into every section by JS)
       ============================================================== -->
  <template id="patreonCallout">
    <div class="patreon-box">
      <p>
        <strong>IFWL costs over ¬£200 a month to run.</strong><br>
        If you wish to help towards our costs, you can join today to become a
        <strong>Patreon member</strong> ‚Äì this gains you access to many perks!
      </p>
      <a href="https://www.patreon.com/c/IFWL" target="_blank" rel="noopener" class="patreon-btn">
        üíô Support IFWL on Patreon
      </a>
    </div>
  </template>

  <!-- ==============================================================
       Firebase v9+ Modular SDK & App Logic (including PDF generation)
       ============================================================== -->
  <script type="module">
    // 1) Import required Firebase modules
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      query,
      where,
      orderBy,
      serverTimestamp,
      updateDoc,
      doc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import {
      getAuth,
      signInWithEmailAndPassword,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

    // 2) Your Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
      authDomain: "ifwl-591d8.firebaseapp.com",
      projectId: "ifwl-591d8",
      storageBucket: "ifwl-591d8.firebasestorage.app",
      messagingSenderId: "703021152109",
      appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
      measurementId: "G-974R4YE6L5"
    };

    // 3) Initialize Firebase
    const app   = initializeApp(firebaseConfig);
    const db    = getFirestore(app);
    const auth  = getAuth(app);

    // 4) Cache DOM elements
    const menuSection           = document.getElementById("menuSection");
    const submitSection         = document.getElementById("submitSection");
    const viewSection           = document.getElementById("viewSection");
    const loginSection          = document.getElementById("loginSection");
    const adminSection          = document.getElementById("adminSection");

    // Menu buttons
    const menuViewBtn           = document.getElementById("menuViewBtn");
    const menuSubmitBtn         = document.getElementById("menuSubmitBtn");
    const menuAdminBtn          = document.getElementById("menuAdminBtn");

    // Submit-ticket elements
    const accusedSelect         = document.getElementById("accusedSelect");
    const newDriverContainer    = document.getElementById("newDriverContainer");
    const newDriverInput        = document.getElementById("newDriverInput");

    const reporterSelect        = document.getElementById("reporterSelect");
    const newReporterContainer  = document.getElementById("newReporterContainer");
    const newReporterInput      = document.getElementById("newReporterInput");

    const competitionSelect     = document.getElementById("competitionSelect");
    const fullIncident          = document.getElementById("fullIncident");
    const eventSelect           = document.getElementById("eventSelect");
    const proofUrlInput         = document.getElementById("proofUrl");
    const seasonSelect          = document.getElementById("seasonSelect");

    const trackSelect           = document.getElementById("trackSelect");
    const newTrackContainer     = document.getElementById("newTrackContainer");
    const newTrackInput         = document.getElementById("newTrackInput");

    const ruleBreachSelect      = document.getElementById("ruleBreachSelect");

    const submitBtn             = document.getElementById("submitBtn");
    const statusMsg             = document.getElementById("statusMsg");

    // View all tickets (public) elements
    const backFromViewBtn       = document.getElementById("backFromViewBtn");
    const ticketsListContainer  = document.getElementById("ticketsListContainer");

    // Login (admin) elements
    const loginBtn              = document.getElementById("loginBtn");
    const backFromLoginBtn      = document.getElementById("backFromLoginBtn");
    const emailInput            = document.getElementById("email");
    const passwordInput         = document.getElementById("password");
    const loginStatusMsg        = document.getElementById("loginStatusMsg");

    // Admin dashboard elements
    const logoutBtn             = document.getElementById("logoutBtn");
    const adminTicketsContainer = document.getElementById("adminTicketsContainer");
    const overviewAdminBtn      = document.getElementById("overviewAdminBtn");

    // Patreon template
    const patreonTpl            = document.getElementById("patreonCallout");

    // ----------------------------------------------------------------
    // UTILITY: Show exactly one section at a time
    // ----------------------------------------------------------------
    function showSection(sectionToShow) {
      [menuSection, submitSection, viewSection, loginSection, adminSection].forEach(sec => {
        sec.classList.add("hidden");
      });
      sectionToShow.classList.remove("hidden");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    // ----------------------------------------------------------------
    // Add Patreon callout to every section
    // ----------------------------------------------------------------
    function addPatreonCallout(sectionEl){
      if (!sectionEl || !patreonTpl) return;
      const node = patreonTpl.content.firstElementChild.cloneNode(true);
      sectionEl.appendChild(node);
    }
    [menuSection, submitSection, viewSection, loginSection, adminSection].forEach(addPatreonCallout);

    // ----------------------------------------------------------------
    // Populate ‚ÄúAccused‚Äù dropdown from /drivers, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateDriverDropdown() {
      const snapshot = await getDocs(collection(db, "drivers"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.fullName && typeof data.fullName === "string") {
          names.push(data.fullName);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      accusedSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a driver‚Ä¶";
      placeholder.disabled = true;
      placeholder.selected = true;
      accusedSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        accusedSelect.appendChild(opt);
      });

      const newOpt = document.createElement("option");
      newOpt.value = "__ADD_NEW__";
      newOpt.textContent = "‚ûï Add New Driver‚Ä¶";
      accusedSelect.appendChild(newOpt);

      accusedSelect.addEventListener("change", () => {
        if (accusedSelect.value === "__ADD_NEW__") {
          newDriverContainer.classList.remove("hidden");
        } else {
          newDriverContainer.classList.add("hidden");
        }
      });
    }

    // ----------------------------------------------------------------
    // Populate ‚ÄúReporter‚Äù dropdown from /drivers, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateReporterDropdown() {
      const snapshot = await getDocs(collection(db, "drivers"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.fullName && typeof data.fullName === "string") {
          names.push(data.fullName);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      reporterSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select reporting driver‚Ä¶";
      placeholder.disabled = true;
      placeholder.selected = true;
      reporterSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        reporterSelect.appendChild(opt);
      });

      const newOpt = document.createElement("option");
      newOpt.value = "__ADD_NEW__";
      newOpt.textContent = "‚ûï Add New Reporting Driver‚Ä¶";
      reporterSelect.appendChild(newOpt);

      reporterSelect.addEventListener("change", () => {
        if (reporterSelect.value === "__ADD_NEW__") {
          newReporterContainer.classList.remove("hidden");
        } else {
          newReporterContainer.classList.add("hidden");
        }
      });
    }

    // ----------------------------------------------------------------
    // Populate ‚ÄúTrack‚Äù dropdown from /tracks, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateTrackDropdown() {
      const snapshot = await getDocs(collection(db, "tracks"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name && typeof data.name === "string") {
          names.push(data.name);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      trackSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a track‚Ä¶";
      placeholder.disabled = true;
      placeholder.selected = true;
      trackSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        trackSelect.appendChild(opt);
      });

      const newOpt = document.createElement("option");
      newOpt.value = "__ADD_NEW__";
      newOpt.textContent = "‚ûï Add New Track‚Ä¶";
      trackSelect.appendChild(newOpt);

      trackSelect.addEventListener("change", () => {
        if (trackSelect.value === "__ADD_NEW__") {
          newTrackContainer.classList.remove("hidden");
        } else {
          newTrackContainer.classList.add("hidden");
        }
      });
    }

    // ----------------------------------------------------------------
    // Populate ‚ÄúRule Breach‚Äù dropdown from /regulations, sorted alphabetically
    // ----------------------------------------------------------------
    async function populateRegulationsDropdown() {
      const snapshot = await getDocs(collection(db, "regulations"));
      const names = [];
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        if (data.name && typeof data.name === "string") {
          names.push(data.name);
        }
      });
      names.sort((a, b) => a.localeCompare(b));

      ruleBreachSelect.innerHTML = "";
      const placeholder = document.createElement("option");
      placeholder.value = "";
      placeholder.textContent = "Select a regulation‚Ä¶";
      placeholder.disabled = true;
      placeholder.selected = true;
      ruleBreachSelect.appendChild(placeholder);

      names.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        ruleBreachSelect.appendChild(opt);
      });
    }

    // ----------------------------------------------------------------
    // HANDLE ‚ÄúSUBMIT TICKET‚Äù (public)
    // ----------------------------------------------------------------
    submitBtn.addEventListener("click", async () => {
      submitBtn.disabled = true;
      statusMsg.textContent = "Submitting‚Ä¶";
      statusMsg.className = "status";

      // 1) Read and trim values
      let accused = accusedSelect.value;
      const newDriverName = newDriverInput.value.trim();

      let reporter = reporterSelect.value;
      const newReporterName = newReporterInput.value.trim();

      const competition = competitionSelect.value;
      if (!competition) {
        statusMsg.textContent = "Please select a competition.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }

      const summary = fullIncident.value.trim();
      const eventVal = eventSelect.value;
      const proofUrl = proofUrlInput.value.trim();
      const season = seasonSelect.value;

      let track = trackSelect.value;
      const newTrackName = newTrackInput.value.trim();

      const ruleBreach = ruleBreachSelect.value;

      // 2) Required fields: accused, reporter, competition, summary
      if (
        ((!accused && !newDriverName)) ||
        ((!reporter && !newReporterName)) ||
        !summary
      ) {
        statusMsg.textContent = "Please fill in all required fields: Accused, Driver Reporting, Competition, Full Incident Summary.";
        statusMsg.className = "status error";
        submitBtn.disabled = false;
        return;
      }

      // 3) If ‚ÄúAdd New Driver‚Ä¶‚Äù was chosen, add to Firestore
      if (accused === "__ADD_NEW__") {
        accused = newDriverName;
        try {
          await addDoc(collection(db, "drivers"), { fullName: newDriverName });
        } catch (err) {
          console.error("Error adding new driver:", err);
        }
      }

      // 4) If ‚ÄúAdd New Reporting Driver‚Ä¶‚Äù was chosen, add to Firestore
      if (reporter === "__ADD_NEW__") {
        reporter = newReporterName;
        try {
          await addDoc(collection(db, "drivers"), { fullName: newReporterName });
        } catch (err) {
          console.error("Error adding new reporting driver:", err);
        }
      }

      // 5) If ‚ÄúAdd New Track‚Ä¶‚Äù was chosen, add to Firestore
      if (track === "__ADD_NEW__") {
        track = newTrackName;
        try {
          await addDoc(collection(db, "tracks"), { name: newTrackName });
        } catch (err) {
          console.error("Error adding new track:", err);
        }
      }

      // 6) Build the ticket object
      const newTicket = {
        accused: accused,
        reporter: reporter,
        competition: competition,
        fullIncident: summary,
        event: eventVal,
        proofUrl: proofUrl,
        season: season,
        track: track,
        ruleBreach: ruleBreach,
        status: "New Submission",
        stewardDecision: "",
        stewardTag: "",       // Assigned Steward will populate here once Admin updates
        timestamp: serverTimestamp()
      };

      try {
        const docRef = await addDoc(collection(db, "tickets"), newTicket);
        statusMsg.textContent = `Ticket submitted (ID: ${docRef.id}). Thank you!`;
        statusMsg.className = "status success";

        // Clear fields
        accusedSelect.value = "";
        newDriverContainer.classList.add("hidden");
        newDriverInput.value = "";

        reporterSelect.value = "";
        newReporterContainer.classList.add("hidden");
        newReporterInput.value = "";

        fullIncident.value = "";
        eventSelect.value = "Practice";
        proofUrlInput.value = "";
        seasonSelect.value = "Season 1";

        trackSelect.value = "";
        newTrackContainer.classList.add("hidden");
        newTrackInput.value = "";

        ruleBreachSelect.value = "";

      } catch (error) {
        console.error("Error writing ticket: ", error);
        statusMsg.textContent = "Error submitting ticket. Please try again.";
        statusMsg.className = "status error";
      } finally {
        submitBtn.disabled = false;
      }
    });

    // ----------------------------------------------------------------
    // INLINE APPEAL FORM HELPER (public)
    // ----------------------------------------------------------------
    function toggleAppealForm(ticketId, container) {
      // Remove any existing appeal form row
      const existingForm = container.querySelector(".appealFormRow");
      if (existingForm) {
        existingForm.remove();
      }

      // Find the row for ticketId
      const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
      if (!ticketRow) return;

      // Build an inline appeal form directly beneath the ticket row
      const formRow = document.createElement("tr");
      formRow.classList.add("appealFormRow");
      formRow.innerHTML = `
        <td colspan="8">
          <div class="appeal-form">
            <label for="appealInfo-${ticketId}"><strong>Appeal Info</strong></label>
            <textarea id="appealInfo-${ticketId}" placeholder="Enter your appeal details‚Ä¶" rows="3"></textarea>
            <label for="extraProof-${ticketId}"><strong>Extra Video Proof URL</strong></label>
            <input type="url" id="extraProof-${ticketId}" placeholder="https://example.com/extra-proof" />
            <div style="margin-top: 8px;">
              <button id="submitAppeal-${ticketId}">Submit Appeal</button>
              <button id="cancelAppeal-${ticketId}" style="background-color: #999; margin-left:8px;">Cancel</button>
            </div>
            <div id="appealStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
          </div>
        </td>
      `;
      ticketRow.insertAdjacentElement("afterend", formRow);

      document.getElementById(`cancelAppeal-${ticketId}`).addEventListener("click", () => {
        formRow.remove();
      });

      document.getElementById(`submitAppeal-${ticketId}`).addEventListener("click", async () => {
        const appealInfoInput = document.getElementById(`appealInfo-${ticketId}`);
        const extraProofInput = document.getElementById(`extraProof-${ticketId}`);
        const appealStatusDiv = document.getElementById(`appealStatus-${ticketId}`);
        const appealInfoValue = appealInfoInput.value.trim();
        const extraProofValue = extraProofInput.value.trim();

        if (!appealInfoValue) {
          appealStatusDiv.textContent = "Please enter your appeal details.";
          appealStatusDiv.className = "status error";
          return;
        }
        appealStatusDiv.textContent = "Submitting appeal‚Ä¶";
        appealStatusDiv.className = "status";

        try {
          const appealsColRef = collection(db, "tickets", ticketId, "appeals");
          await addDoc(appealsColRef, {
            appealInfo: appealInfoValue,
            extraProofUrl: extraProofValue,
            timestamp: serverTimestamp()
          });
          appealStatusDiv.textContent = "Appeal submitted! We‚Äôll review it soon.";
          appealStatusDiv.className = "status success";
          setTimeout(() => {
            formRow.remove();
          }, 2000);
        } catch (err) {
          console.error("Error submitting appeal:", err);
          appealStatusDiv.textContent = "Error submitting appeal. Please try again.";
          appealStatusDiv.className = "status error";
        }
      });
    }

    // ----------------------------------------------------------------
    // TOGGLE DETAIL VIEW (admin): full ticket + appeals + review form + PDF
    // ----------------------------------------------------------------
    async function toggleDetailView(ticketId, container) {
      const existingDetail = container.querySelector(".detailRow");
      if (existingDetail) {
        existingDetail.remove();
      }

      const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
      if (!ticketRow) return;

      const ticketDocRef = doc(db, "tickets", ticketId);
      const ticketSnap = await getDoc(ticketDocRef);
      if (!ticketSnap.exists()) return;
      const ticketData = ticketSnap.data();

      const appealsRef = collection(db, "tickets", ticketId, "appeals");
      const appealsSnapshot = await getDocs(appealsRef);
      let appealsHTML = "";
      if (!appealsSnapshot.empty) {
        appealsSnapshot.forEach(appSnap => {
          const appealData = appSnap.data();
          const appealTs = appealData.timestamp && appealData.timestamp.toDate
            ? appealData.timestamp.toDate().toLocaleString()
            : "";
          appealsHTML += `
            <div class="appeal-box">
              <div><strong>Appeal:</strong> ${appealData.appealInfo}</div>
              <div><strong>Extra Video Proof:</strong> ${appealData.extraProofUrl || "N/A"}</div>
              <div style="margin-top:4px; font-size:0.8rem; color:#555;">
                <em>Submitted: ${appealTs}</em>
              </div>
            </div>
          `;
        });
      }

      const detailRow = document.createElement("tr");
      detailRow.classList.add("detailRow");
      detailRow.innerHTML = `
        <td colspan="8">
          <div class="detail-container">
            <h3>Ticket Details</h3>
            <p><strong>ID:</strong> ${ticketId}</p>
            <p><strong>Accused:</strong> ${ticketData.accused || ""}</p>
            <p><strong>Driver Reporting:</strong> ${ticketData.reporter || ""}</p>
            <p><strong>Competition:</strong> ${ticketData.competition || ""}</p>
            <p><strong>Full Incident Summary:</strong> ${ticketData.fullIncident || ""}</p>
            <p><strong>Event:</strong> ${ticketData.event || ""}</p>
            <p><strong>Proof URL:</strong> ${
              ticketData.proofUrl
                ? `<a href="${ticketData.proofUrl}" target="_blank" rel="noopener noreferrer">${ticketData.proofUrl}</a>`
                : "N/A"
            }</p>
            <p><strong>Season:</strong> ${ticketData.season || ""}</p>
            <p><strong>Track:</strong> ${ticketData.track || ""}</p>
            <p><strong>Rule Breach:</strong> ${ticketData.ruleBreach || ""}</p>
            <p><strong>Status:</strong> ${ticketData.status || ""}</p>
            ${ticketData.stewardTag 
              ? `<p><strong>Assigned Steward:</strong> ${ticketData.stewardTag}</p>` 
              : `<p><strong>Assigned Steward:</strong> ‚Äî</p>`}
            ${ticketData.stewardDecision 
              ? `<p><strong>Steward Decision:</strong> ${ticketData.stewardDecision}</p>` 
              : ""}
            ${ticketData.postRaceCode
              ? `<p><strong>Post-Race Code:</strong> ${ticketData.postRaceCode}</p>`
              : ""}
            <p><strong>Submitted At:</strong> ${
              (ticketData.timestamp && ticketData.timestamp.toDate)
                ? ticketData.timestamp.toDate().toLocaleString()
                : ""
            }</p>
            ${appealsHTML ? `<hr><h4>Appeals</h4>${appealsHTML}` : ""}
            <hr>
            <div class="review-form">
              <h4>Admin Review</h4>
              <label for="statusSelect-${ticketId}"><strong>Select Outcome</strong></label>
              <select id="statusSelect-${ticketId}">
                <option value="Under Review" ${ticketData.status === "Under Review" ? "selected" : ""}>Under Review</option>
                <option value="Finalised" ${ticketData.status === "Finalised" ? "selected" : ""}>Finalised</option>
                <option value="Appeal In Progress" ${ticketData.status === "Appeal In Progress" ? "selected" : ""}>Appeal In Progress</option>
              </select>

              <label for="decisionText-${ticketId}"><strong>Steward Decision</strong></label>
              <textarea id="decisionText-${ticketId}" placeholder="Enter your decision‚Ä¶" rows="3">${ticketData.stewardDecision || ""}</textarea>

              <label for="stewardTag-${ticketId}"><strong>Assigned Steward (Steward Tag)</strong></label>
              <input type="text" id="stewardTag-${ticketId}" 
                     placeholder="e.g. Steward ‚Äì IOC" 
                     value="${ticketData.stewardTag || ""}" />

              <!-- Post-Race Coding -->
              <label for="postRaceCode-${ticketId}"><strong>Post-Race Code</strong></label>
              <select id="postRaceCode-${ticketId}">
                <option value="" disabled selected>‚Äî Select a code ‚Äî</option>
                <option value="RP1mi">RP1mi ‚Äì Unsafe Track Rejoin (10s)</option>
                <option value="RP1St">RP1St ‚Äì Unsafe Track Rejoin (30s)</option>
                <option value="RP1Se">RP1Se ‚Äì Unsafe Track Rejoin (SG30)</option>
                <option value="RP2mi">RP2mi ‚Äì Unsafe Pit Exit / Crossing pit line (10s)</option>
                <option value="RP2St">RP2St ‚Äì Unsafe Pit Exit / Crossing pit line (30s)</option>
                <option value="RP2Se">RP2Se ‚Äì Unsafe Pit Exit / Crossing pit line (SG30)</option>
                <option value="RP3mi">RP3mi ‚Äì Blue Flag Abuse / Blocking While Lapped (5s)</option>
                <option value="RP3St">RP3St ‚Äì Blue Flag Abuse / Blocking While Lapped (15s)</option>
                <option value="RP3Se">RP3Se ‚Äì Blue Flag Abuse / Blocking While Lapped (SG30)</option>
                <option value="RP4mi">RP4mi ‚Äì Formation Lap / Start Line Infingement (30s)</option>
                <option value="RP4St">RP4St ‚Äì Formation Lap / Start Line Infingement (SG30)</option>
                <option value="RP4Se">RP4Se ‚Äì Formation Lap / Start Line Infingement (DQ)</option>
                <option value="RP5mi">RP5mi ‚Äì Illegal Overtake (5s)</option>
                <option value="RP5St">RP5St ‚Äì Illegal Overtake (15s)</option>
                <option value="RP5Se">RP5Se ‚Äì Illegal Overtake (30s)</option>
                <option value="RP6mi">RP6mi ‚Äì Late Blocking / Moving Under Braking (5s)</option>
                <option value="RP6St">RP6St ‚Äì Late Blocking / Moving Under Braking (30s)</option>
                <option value="RP6Se">RP6Se ‚Äì Late Blocking / Moving Under Braking (SG30)</option>
                <option value="RP7mi">RP7mi ‚Äì Divebomb / Overly Ambitious Lunge (10s)</option>
                <option value="RP7St">RP7St ‚Äì Divebomb / Overly Ambitious Lunge (30s)</option>
                <option value="RP7Se">RP7Se ‚Äì Divebomb / Overly Ambitious Lunge (SG30)</option>
                <option value="RP8Mi">RP8Mi ‚Äì Rear-End Collision (5s)</option>
                <option value="RP8St">RP8St ‚Äì Rear-End Collision (15s)</option>
                <option value="RP8Se">RP8Se ‚Äì Rear-End Collision (SG30)</option>
                <option value="RP9Mi">RP9Mi ‚Äì Not Leaving Room (5s)</option>
                <option value="RP9St">RP9St ‚Äì Not Leaving Room (15s)</option>
                <option value="RP9Se">RP9Se ‚Äì Not Leaving Room (SG30)</option>
                <option value="RP10Mi">RP10Mi ‚Äì Excessive flashing (10s)</option>
                <option value="RP10St">RP10St ‚Äì Excessive flashing (10s)</option>
                <option value="RP10Se">RP10Se ‚Äì Excessive flashing (10s)</option>
                <option value="RP11Mi">RP11Mi ‚Äì Intentional Ramming (DQ)</option>
                <option value="RP11St">RP11St ‚Äì Intentional Ramming (DQ)</option>
                <option value="RP11Se">RP11Se ‚Äì Intentional Ramming (DQ)</option>
              </select>

              <label for="futureAdvice-${ticketId}"><strong>Future Advice</strong></label>
              <select id="futureAdvice-${ticketId}">
                <option value="" disabled ${!ticketData.futureAdvice ? "selected" : ""}>Select advice‚Ä¶</option>
                <option value="Keep a neutral or positive tone; if you disagree, wait until the session ends to appeal, and keep it concise, factual, and professional." ${ticketData.futureAdvice === "Keep a neutral or positive tone; if you disagree, wait until the session ends to appeal, and keep it concise, factual, and professional." ? "selected" : ""}>Respectful Conduct</option>
                <option value="Execute clean overtakes: lift earlier, carry momentum, leave a car-width margin, and never late-dive or bump-pass." ${ticketData.futureAdvice === "Execute clean overtakes: lift earlier, carry momentum, leave a car-width margin, and never late-dive or bump-pass." ? "selected" : ""}>Racing Decorum</option>
                <option value="Only pass when you‚Äôre fully alongside before turn-in; as leader, defend predictably without sudden line-changes." ${ticketData.futureAdvice === "Only pass when you‚Äôre fully alongside before turn-in; as leader, defend predictably without sudden line-changes." ? "selected" : ""}>Passing Responsibilities</option>
                <option value="Set your defensive line in practice, hold it in the race, leave a car-width gap, and brake smoothly without veering." ${ticketData.futureAdvice === "Set your defensive line in practice, hold it in the race, leave a car-width gap, and brake smoothly without veering." ? "selected" : ""}>Passing Lines</option>
                <option value="Attempt a dive only with at least half a car-length overlap at turn-in, and factor in tire wear and track conditions." ${ticketData.futureAdvice === "Attempt a dive only with at least half a car-length overlap at turn-in, and factor in tire wear and track conditions." ? "selected" : ""}>Establishing Overlap</option>
                <option value="Choose your line before braking, stick to it, and if forced off it, lift early then re-commit once the track is clear." ${ticketData.futureAdvice === "Choose your line before braking, stick to it, and if forced off it, lift early then re-commit once the track is clear." ? "selected" : ""}>Line Commitment</option>
                <option value="If you spin, stop fully and stay visible; rejoin only after you see two cars clear the racing line safely." ${ticketData.futureAdvice === "If you spin, stop fully and stay visible; rejoin only after you see two cars clear the racing line safely." ? "selected" : ""}>Accident Predictability</option>
                <option value="Rejoin at half pace with brake lights on until clear; on-track drivers should give merging re-joiners extra space." ${ticketData.futureAdvice === "Rejoin at half pace with brake lights on until clear; on-track drivers should give merging re-joiners extra space." ? "selected" : ""}>Rejoining the Track</option>
                <option value="Never reverse opposite; continue forward to the next escape point or use a lift-and-spin in a safe zone." ${ticketData.futureAdvice === "Never reverse opposite; continue forward to the next escape point or use a lift-and-spin in a safe zone." ? "selected" : ""}>No Reverse Direction</option>
                <option value="When lapped, yield off-line at a consistent point; when unlapping, only pass cleanly if you have clear pace." ${ticketData.futureAdvice === "When lapped, yield off-line at a consistent point; when unlapping, only pass cleanly if you have clear pace." ? "selected" : ""}>Allowing Overtakes</option>
                <option value="Confirm your setup matches the official configuration before each event; avoid any unauthorized tweaks." ${ticketData.futureAdvice === "Confirm your setup matches the official configuration before each event; avoid any unauthorized tweaks." ? "selected" : ""}>Vehicle Modifications</option>
                <option value="Unregister early if you can‚Äôt attend and set a reminder one hour before the cutoff to avoid penalties. do not leave the race early AKA Ragequit" ${ticketData.futureAdvice === "Unregister early if you can‚Äôt attend and set a reminder one hour before the cutoff to avoid penalties. do not leave the race early AKA Ragequit" ? "selected" : ""}>Event Participation</option>
                <option value="Review the title-specific Codes of Conduct on IFWL.net before each series to stay up to date with all rules." ${ticketData.futureAdvice === "Review the title-specific Codes of Conduct on IFWL.net before each series to stay up to date with all rules." ? "selected" : ""}>Compliance</option>
              </select>

              <div style="margin-top: 8px;">
                <button id="submitReview-${ticketId}">Update Ticket</button>
                <button id="cancelDetail-${ticketId}" style="background-color: #999; margin-left:8px;">Close</button>
                <button id="generatePDF-${ticketId}" style="background-color: #333; margin-left:8px;">
                  Generate Discord Form
                </button>
              </div>
              <div id="detailStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
            </div>
          </div>
        </td>
      `;
      ticketRow.insertAdjacentElement("afterend", detailRow);

      // set Post-Race Code dropdown to saved value
      const prcSelect = document.getElementById(`postRaceCode-${ticketId}`);
      if (prcSelect && ticketData.postRaceCode) {
        prcSelect.value = ticketData.postRaceCode;
      }

      document.getElementById(`cancelDetail-${ticketId}`).addEventListener("click", () => {
        detailRow.remove();
      });

      // Update ticket in Firestore when Admin clicks ‚ÄúUpdate Ticket‚Äù
      document.getElementById(`submitReview-${ticketId}`).addEventListener("click", async () => {
        const statusSelect    = document.getElementById(`statusSelect-${ticketId}`);
        const decisionInput   = document.getElementById(`decisionText-${ticketId}`);
        const stewardTagInput = document.getElementById(`stewardTag-${ticketId}`);
        const detailStatusDiv = document.getElementById(`detailStatus-${ticketId}`);
        const newStatus       = statusSelect.value;
        const decisionText    = decisionInput.value.trim();
        const stewardTagVal   = stewardTagInput.value.trim();

        const futureAdviceSel = document.getElementById(`futureAdvice-${ticketId}`);
        const futureAdviceVal = futureAdviceSel.value;
        const postRaceCodeVal = document.getElementById(`postRaceCode-${ticketId}`).value;

        if (!decisionText) {
          detailStatusDiv.textContent = "Please enter a steward decision.";
          detailStatusDiv.className = "status error";
          return;
        }
        if (!stewardTagVal) {
          detailStatusDiv.textContent = "Please enter an assigned steward.";
          detailStatusDiv.className = "status error";
          return;
        }

        detailStatusDiv.textContent = "Updating ticket‚Ä¶";
        detailStatusDiv.className = "status";

        try {
          const ticketRef = doc(db, "tickets", ticketId);
          await updateDoc(ticketRef, {
            status: newStatus,
            stewardDecision: decisionText,
            stewardTag: stewardTagVal,
            futureAdvice: futureAdviceVal,
            postRaceCode: postRaceCodeVal
          });
          detailStatusDiv.textContent = "Ticket updated!";
          detailStatusDiv.className = "status success";
          setTimeout(async () => {
            await fetchAndRenderTickets(adminTicketsContainer, true);
          }, 800);
        } catch (err) {
          console.error("Error updating ticket:", err);
          detailStatusDiv.textContent = "Error updating ticket. Please try again.";
          detailStatusDiv.className = "status error";
        }
      });

      // Generate the Steward Decision PDF
      document.getElementById(`generatePDF-${ticketId}`).addEventListener("click", async () => {
        await generateDiscordForm(ticketId, ticketData);
      });
    }

    // ----------------------------------------------------------------
    // FETCH & RENDER TICKETS (public vs. admin)
    // ----------------------------------------------------------------
    async function fetchAndRenderTickets(targetContainer, isAdmin = false) {
      const ticketsCol   = collection(db, "tickets");
      const ticketsQuery = query(ticketsCol);

      try {
        const snapshot = await getDocs(ticketsQuery);
        if (snapshot.empty) {
          targetContainer.innerHTML = "<p>No tickets have been submitted yet.</p>";
          return;
        }

        // Build table header
        let tableHTML = `
          <table>
            <thead>
              <tr>
                <th>ID</th>
                <th>Accused</th>
                <th>Reporter</th>
                <th>Competition</th>
                <th>Status</th>
                <th>Assigned Steward</th>
                <th>Submitted At</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
        `;

        snapshot.forEach(docSnap => {
          const data    = docSnap.data();
          const tsObj   = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : null;
          const tsStr   = tsObj ? tsObj.toLocaleString() : "";
          const id      = docSnap.id;
          const steward = data.stewardTag || "";

          // Determine if the 24h appeal window has expired
          let isExpired = false;
          if (tsObj) {
            const now = Date.now();
            const createdAtMs = tsObj.getTime();
            if (now - createdAtMs > 24 * 60 * 60 * 1000) {
              isExpired = true;
            }
          }

          // Check if status is "Finalised"
          const isFinalised = (data.status === "Finalised");
          const rowClassList = ["ticketRow"];
          if (isFinalised) rowClassList.push("finalised-row");

          // Build Action button:
          let actionButtonHTML = "";
          if (isAdmin) {
            actionButtonHTML = `<button data-id="${id}" class="openBtn">Open</button>`;
          } else {
            actionButtonHTML = isExpired
              ? `<button disabled style="background-color: #999; cursor: not-allowed;">Appeal Period Expired</button>`
              : `<button data-id="${id}" class="appealBtn">Appeal</button>`;
          }

          tableHTML += `
            <tr data-id="${id}" class="${rowClassList.join(" ")}">
              <td>${id}</td>
              <td>${data.accused || ""}</td>
              <td>${data.reporter || ""}</td>
              <td>${data.competition || ""}</td>
              <td>${data.status || ""}</td>
              <td>${steward}</td>
              <td>${tsStr}</td>
              <td>${actionButtonHTML}</td>
            </tr>
          `;
        });

        tableHTML += `</tbody></table>`;
        targetContainer.innerHTML = tableHTML;

        // Highlight any tickets that already have appeals
        const ticketRows = targetContainer.querySelectorAll("tr.ticketRow");
        ticketRows.forEach(async (row) => {
          const ticketId = row.getAttribute("data-id");
          const appealsRef = collection(db, "tickets", ticketId, "appeals");
          const appealsSnapshot = await getDocs(appealsRef);
          if (!appealsSnapshot.empty) {
            row.classList.add("appeal-highlight");
          }
        });

        // Wire up buttons:
        if (isAdmin) {
          targetContainer.querySelectorAll(".openBtn").forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleDetailView(ticketId, targetContainer);
            });
          });
        } else {
          targetContainer.querySelectorAll(".appealBtn").forEach(btn => {
            btn.addEventListener("click", (e) => {
              const ticketId = e.currentTarget.getAttribute("data-id");
              toggleAppealForm(ticketId, targetContainer);
            });
          });
        }

      } catch (err) {
        console.error("Error fetching tickets:", err);
        targetContainer.innerHTML = "<p>Error loading tickets.</p>";
      }
    }

    // ----------------------------------------------------------------
    // Menu navigation
    // ----------------------------------------------------------------
    menuViewBtn.addEventListener("click", async () => {
      showSection(viewSection);
      ticketsListContainer.innerHTML = "<p>Loading tickets‚Ä¶</p>";
      await fetchAndRenderTickets(ticketsListContainer, false);
    });
    menuSubmitBtn.addEventListener("click", () => showSection(submitSection));
    menuAdminBtn.addEventListener("click", () => showSection(loginSection));

    backFromViewBtn.addEventListener("click", () => showSection(menuSection));
    backFromLoginBtn.addEventListener("click", () => showSection(menuSection));

    // ----------------------------------------------------------------
    // ADMIN LOGIN / AUTHENTICATION
    // ----------------------------------------------------------------
    loginBtn.addEventListener("click", async () => {
      loginBtn.disabled = true;
      loginStatusMsg.textContent = "Signing in‚Ä¶";
      loginStatusMsg.className = "status";
      const email = emailInput.value.trim();
      const pw    = passwordInput.value.trim();
      if (!email || !pw) {
        loginStatusMsg.textContent = "Email & password are required.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
        return;
      }
      try {
        await signInWithEmailAndPassword(auth, email, pw);
      } catch (err) {
        console.error("Login error:", err);
        loginStatusMsg.textContent = "Login failed. Check credentials.";
        loginStatusMsg.className = "status error";
        loginBtn.disabled = false;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // ----------------------------------------------------------------
    // LISTEN FOR AUTH STATE CHANGES
    // ----------------------------------------------------------------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        logoutBtn.classList.remove("hidden");
        showSection(adminSection);
        adminTicketsContainer.innerHTML = "<p>Loading tickets‚Ä¶</p>";
        await fetchAndRenderTickets(adminTicketsContainer, true);
      } else {
        logoutBtn.classList.add("hidden");
        showSection(menuSection); // default to menu when logged out
      }
    });

    // ----------------------------------------------------------------
    // Populate dropdowns on initial load (so submit is ready when opened)
    // ----------------------------------------------------------------
    populateDriverDropdown();
    populateReporterDropdown();
    populateTrackDropdown();
    populateRegulationsDropdown();

    // ----------------------------------------------------------------
    // 12) PDF GENERATION: Helper to convert an image URL to Data URL
    // ----------------------------------------------------------------
    function getImageDataURL(url) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.setAttribute("crossOrigin", "anonymous");
        img.onload = function() {
          const canvas = document.createElement("canvas");
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0);
          resolve(canvas.toDataURL("image/png"));
        };
        img.onerror = function(e) {
          reject(e);
        };
        img.src = url;
      });
    }

    // 13) Lookup for Post-Race Code descriptions and time penalties
    const postRaceCodeLookup = {
      RP1mi: "Unsafe Track Rejoin (10s)",
      RP1St: "Unsafe Track Rejoin (30s)",
      RP1Se: "Unsafe Track Rejoin (SG30)",
      RP2mi: "Unsafe Pit Exit / Crossing pit line (10s)",
      RP2St: "Unsafe Pit Exit / Crossing pit line (30s)",
      RP2Se: "Unsafe Pit Exit / Crossing pit line (SG30)",
      RP3mi: "Blue Flag Abuse / Blocking While Lapped (5s)",
      RP3St: "Blue Flag Abuse / Blocking While Lapped (15s)",
      RP3Se: "Blue Flag Abuse / Blocking While Lapped (SG30)",
      RP4mi: "Formation Lap / Start Line Infingement (30s)",
      RP4St: "Formation Lap / Start Line Infingement (SG30)",
      RP4Se: "Formation Lap / Start Line Infingement (DQ)",
      RP5mi: "Illegal Overtake (Off-Track or Gained Advantage) (5s)",
      RP5St: "Illegal Overtake (Off-Track or Gained Advantage) (15s)",
      RP5Se: "Illegal Overtake (Off-Track or Gained Advantage) (30s)",
      RP6mi: "Late Blocking / Moving Under Braking (5s)",
      RP6St: "Late Blocking / Moving Under Braking (30s)",
      RP6Se: "Late Blocking / Moving Under Braking (SG30)",
      RP7mi: "Divebomb / Overly Ambitious Lunge (10s)",
      RP7St: "Divebomb / Overly Ambitious Lunge (30s)",
      RP7Se: "Divebomb / Overly Ambitious Lunge (SG30)",
      RP8Mi: "Rear-End Collision (Braking Zone) (5s)",
      RP8St: "Rear-End Collision (Braking Zone) (15s)",
      RP8Se: "Rear-End Collision (Braking Zone) (SG30)",
      RP9Mi: "Squeezing Off Track / Not Leaving Room (5s)",
      RP9St: "Squeezing Off Track / Not Leaving Room (15s)",
      RP9Se: "Squeezing Off Track / Not Leaving Room (SG30)",
      RP10Mi: "Excessive flashing (10s)",
      RP10St: "Excessive flashing (10s)",
      RP10Se: "Excessive flashing (10s)",
      RP11Mi: "Intentional Ramming (DQ)",
      RP11St: "Intentional Ramming (DQ)",
      RP11Se: "Intentional Ramming (DQ)"
    };

    async function generateDiscordForm(ticketId, ticketData) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({
        unit: "mm",
        format: "a4",
        lineHeight: 1.2
      });

      // IFWL logo
      const ifwlLogoUrl = "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/ifwl_logo.png";
      let ifwlImgData;
      try {
        ifwlImgData = await getImageDataURL(ifwlLogoUrl);
      } catch (e) {
        console.warn("Could not load IFWL logo for PDF:", e);
      }
      let y = 10;
      if (ifwlImgData) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const imgWidthMM = 60;
        const imgProps = doc.getImageProperties(ifwlImgData);
        const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
        const x = (pageWidth - imgWidthMM) / 2;
        doc.addImage(ifwlImgData, "PNG", x, y, imgWidthMM, imgHeightMM);
        y += imgHeightMM + 10;
      }

      // Title
      doc.setFontSize(16);
      doc.setFont("helvetica", "bold");
      doc.text("IFWL Steward Decision", doc.internal.pageSize.getWidth() / 2, y, { align: "center" });
      y += 12;

      // Header
      doc.setFontSize(11);
      doc.setFont("helvetica", "bold");
      doc.text("From:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text("The Stewards", 25, y);

      const rightX = doc.internal.pageSize.getWidth() - 15;
      doc.setFont("helvetica", "bold");
      doc.text(`Document: ${ticketId}`, rightX, y, { align: "right" });
      y += 8;

      doc.setFont("helvetica", "bold");
      doc.text("To:", 15, y);
      doc.setFont("helvetica", "normal");
      doc.text(ticketData.reporter || "‚Äî", 25, y);

      let dateStr = "‚Äî";
      let timeStr = "‚Äî";
      if (ticketData.timestamp && ticketData.timestamp.toDate) {
        const d = ticketData.timestamp.toDate();
        dateStr = d.getFullYear() + "-" +
          String(d.getMonth() + 1).padStart(2, "0") + "-" +
          String(d.getDate()).padStart(2, "0");
        timeStr = String(d.getHours()).padStart(2, "0") + ":" +
          String(d.getMinutes()).padStart(2, "0");
      }
      doc.setFont("helvetica", "bold");
      doc.text("Date:", rightX, y, { align: "right" });
      doc.setFont("helvetica", "normal");
      doc.text(dateStr, rightX - 20, y, { align: "right" });

      doc.setFont("helvetica", "bold");
      doc.text("Time:", rightX - 45, y, { align: "right" });
      doc.setFont("helvetica", "normal");
      doc.text(timeStr, rightX - 65, y, { align: "right" });
      y += 12;

      // Intro
      doc.setFont("helvetica", "normal");
      const intro = "The IFWL.NET Racing Stewards, having received a formal report from one of our drivers, have officially opened the ticket detailed below. At present, the stewards are undertaking a comprehensive review, which includes gathering any available telemetry data & consulting relevant race footage. Please refer to the ticket for full details on the current status, next steps, and any additional documentation submitted.";
      const introLines = doc.splitTextToSize(intro, 180);
      doc.text(introLines, 15, y);
      y += introLines.length * 6 + 8;

      // Body fields
      doc.setFont("helvetica", "bold"); doc.text("No / Driver:", 15, y);
      doc.setFont("helvetica", "normal"); doc.text(ticketData.accused || "‚Äî", 45, y); y += 8;

      doc.setFont("helvetica", "bold"); doc.text("Competitor:", 15, y);
      doc.setFont("helvetica", "normal"); doc.text(ticketData.competition || "‚Äî", 45, y); y += 8;

      doc.setFont("helvetica", "bold"); doc.text("Time:", 15, y);
      doc.setFont("helvetica", "normal"); doc.text(timeStr, 45, y); y += 8;

      doc.setFont("helvetica", "bold"); doc.text("Session:", 15, y);
      doc.setFont("helvetica", "normal"); doc.text(ticketData.event || "‚Äî", 45, y); y += 8;

      doc.setFont("helvetica", "bold"); doc.text("Status:", 15, y);
      doc.setFont("helvetica", "normal"); doc.text(ticketData.status || "‚Äî", 45, y); y += 12;

      doc.setFont("helvetica", "bold"); doc.text("Fact:", 15, y);
      doc.setFont("helvetica", "normal");
      const factLines = doc.splitTextToSize(ticketData.fullIncident || "‚Äî", 150);
      doc.text(factLines, 45, y);
      y += factLines.length * 6 + 4;

      doc.setFont("helvetica", "bold"); doc.text("Offence:", 15, y);
      doc.setFont("helvetica", "normal");
      const offenceLines = doc.splitTextToSize(ticketData.ruleBreach || "‚Äî", 150);
      doc.text(offenceLines, 45, y);
      y += offenceLines.length * 6 + 4;

      doc.setFont("helvetica", "bold"); doc.text("Decision:", 15, y);
      doc.setFont("helvetica", "normal");
      const decisionLines = doc.splitTextToSize(ticketData.stewardDecision || "‚Äî", 150);
      doc.text(decisionLines, 45, y);
      y += decisionLines.length * 6 + 4;

      doc.setFont("helvetica", "bold"); doc.text("Reason:", 15, y);
      doc.setFont("helvetica", "normal");
      const reasonLines = doc.splitTextToSize(ticketData.fullIncident || "‚Äî", 150);
      doc.text(reasonLines, 45, y);
      y += reasonLines.length * 6 + 8;

      // Post-Race Code
      doc.setFont("helvetica", "bold");
      doc.text("Post-Race Code:", 15, y);
      doc.setFont("helvetica", "normal");
      const prc = ticketData.postRaceCode || "";
      const prcDesc = prc && postRaceCodeLookup[prc] ? `${prc} ‚Äì ${postRaceCodeLookup[prc]}` : "‚Äî";
      doc.text(prcDesc, 60, y);
      y += 8;

      // Future Advice
      doc.setFont("helvetica", "bold");
      doc.text("Future Advice:", 15, y);
      doc.setFont("helvetica", "normal");
      const adviceLines = doc.splitTextToSize(ticketData.futureAdvice || "‚Äî", 150);
      doc.text(adviceLines, 45, y);
      y += adviceLines.length * 6 + 4;

      // Signature line
      doc.setFont("helvetica", "bold");
      doc.text("The Stewards", 15, y);
      y += 12;

      // Competition logo (optional)
      const logoMap = {
        "ACC - BEGINNER CONSOLE":    "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - BEGINNER PC":         "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - PRO AM CONSOLE":      "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - PRO AM PC":           "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - ENDURO SOLO":         "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - ENDURO TEAMS":        "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - GMC":                 "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - AMATEUR PC":          "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "ACC - AMATEUR CONSOLE":     "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acclogo.webp",
        "AC - all game modes":       "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/aclogo.webp",
        "AC EVO - all game modes":   "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/acevologo.webp",
        "F1 2025":                   "https://raw.githubusercontent.com/IFWLOWNER/ACC-driver-classifier/main/formulaonelogo.webp"
      };

      const compName = ticketData.competition || "";
      if (logoMap[compName]) {
        let raceLogoData;
        try {
          raceLogoData = await getImageDataURL(logoMap[compName]);
        } catch (e) {
          console.warn("Could not load race logo:", e);
        }
        if (raceLogoData) {
          const pageWidth = doc.internal.pageSize.getWidth();
          const imgWidthMM = 40;
          const imgProps = doc.getImageProperties(raceLogoData);
          const imgHeightMM = (imgProps.height * imgWidthMM) / imgProps.width;
          const x = (pageWidth - imgWidthMM) / 2;
          doc.addImage(raceLogoData, "WEBP", x, y, imgWidthMM, imgHeightMM);
          y += imgHeightMM + 10;
        }
      }

      // Footer timestamp
      doc.setFont("helvetica", "italic");
      doc.setFontSize(10);
      const now = new Date();
      const footerText = `Generated: ${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, "0")}-${String(now.getDate()).padStart(2, "0")} ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
      doc.text(footerText, 15, doc.internal.pageSize.getHeight() - 15);

      doc.save(`IFWL_StewardDecision_${ticketId}.pdf`);
    }

    // Overview PDF button
    overviewAdminBtn.addEventListener("click", async () => {
      const fourDaysAgo = new Date();
      fourDaysAgo.setDate(fourDaysAgo.getDate() - 4);
      const ticketsCol = collection(db, "tickets");
      const q = query(
        ticketsCol,
        where("timestamp", ">=", fourDaysAgo),
        orderBy("timestamp", "asc")
      );
      const snapshot = await getDocs(q);
      if (snapshot.empty) {
        alert("No tickets found in the last 4 days.");
        return;
      }
      const penaltyTimeMap = {
        RP1mi: "10s", RP1St: "30s", RP1Se: "SG30",
        RP2mi: "10s", RP2St: "30s", RP2Se: "SG30",
        RP3mi: "5s",  RP3St: "15s", RP3Se: "SG30",
        RP4mi: "30s", RP4St: "SG30",RP4Se: "DQ",
        RP5mi: "5s",  RP5St: "15s", RP5Se: "30s",
        RP6mi: "5s",  RP6St: "30s", RP6Se: "SG30",
        RP7mi: "10s", RP7St: "30s", RP7Se: "SG30",
        RP8Mi: "5s",  RP8St: "15s", RP8Se: "SG30",
        RP9Mi: "5s",  RP9St: "15s", RP9Se: "SG30",
        RP10Mi:"10s",RP10St:"10s",RP10Se:"10s",
        RP11Mi:"DQ", RP11St:"DQ", RP11Se:"DQ"
      };

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      let y = 30;
      doc.setFontSize(16);
      doc.text("Ticket Overview (Last 4 Days)", 14, 20);
      doc.setFontSize(12);
      doc.text("Driver (ID)", 14, y);
      doc.text("Competition", 80, y);
      doc.text("Code", 160, y);
      y += 8;

      snapshot.docs.forEach((docSnap) => {
        const data = docSnap.data();
        const accused = data.accused || "";
        const competition = data.competition || "";
        const code = data.postRaceCode || "";
        const penalty = code && penaltyTimeMap[code] ? penaltyTimeMap[code] : "-";
        doc.text(accused, 14, y);
        doc.text(competition, 80, y);
        doc.text(penalty, 160, y);
        y += 8;
        if (y > 280) {
          doc.addPage();
          y = 20;
        }
      });
      doc.save("ticket_overview.pdf");
    });

    // Default: show menu
    showSection(menuSection);
  </script>
</body>
</html>
