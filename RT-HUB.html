<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFWL Race Team Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root{
      --bg1:#f7f8fb;
      --bg2:#eef2ff;
      --card:rgba(255,255,255,.92);
      --stroke:rgba(15,23,42,.10);
      --shadow: 0 18px 45px rgba(2,6,23,.10);
      --muted: rgba(15,23,42,.72);
      --text: #0f172a;
      --primary: #4f46e5;
      --primary2:#4338ca;
      --danger:#dc2626;
      --warn:#d97706;
      --ok:#16a34a;
    }
    html, body { background: radial-gradient(1000px 600px at 20% -10%, var(--bg2), transparent 55%), linear-gradient(180deg, var(--bg1), #ffffff); color: var(--text); }
    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .soft { border: 1px solid var(--stroke); }
    .muted { color: var(--muted); }
    .chip{
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.03);
    }
    .btn{
      border: 1px solid rgba(79,70,229,.20);
      background: var(--primary);
      color: white;
    }
    .btn:hover{ background: var(--primary2); }
    .btn2{
      border: 1px solid var(--stroke);
      background: rgba(2,6,23,.03);
      color: var(--text);
    }
    .btn2:hover{ background: rgba(2,6,23,.06); }
    .danger{
      background: rgba(220,38,38,.10);
      border: 1px solid rgba(220,38,38,.25);
      color: #7f1d1d;
    }
    .warn{
      background: rgba(217,119,6,.10);
      border: 1px solid rgba(217,119,6,.25);
      color:#7c2d12;
    }
    .ok{
      background: rgba(22,163,74,.10);
      border: 1px solid rgba(22,163,74,.25);
      color:#14532d;
    }
    .tab{ cursor:pointer; user-select:none; }
    .tabActive{ background: rgba(79,70,229,.10); border: 1px solid rgba(79,70,229,.22); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .mobileTabsShadow{ box-shadow: 0 -8px 25px rgba(2,6,23,.08); }
  </style>
</head>

<body>
  <div class="min-h-screen px-4 py-6 md:py-8">
    <div class="max-w-6xl mx-auto">

      <!-- Top Bar -->
      <div class="card rounded-2xl p-4 md:p-5 mb-5 sticky top-3 z-30">
        <div class="flex items-start md:items-center justify-between gap-3">
          <div class="flex items-center gap-3 min-w-0">
            <!-- LOGO (from GitHub) -->
            <img src="ifwl_logo.png" alt="IFWL" class="h-10 w-10 md:h-11 md:w-11 object-contain" />
            <div class="min-w-0">
              <div class="text-xs muted">IFWL • Race Team Hub</div>
              <div class="text-lg md:text-xl font-extrabold truncate">Stints • Availability • Setups • Strategy</div>
              <div class="text-xs muted mt-1 hidden md:block">Fast planning, mobile-friendly, and clean enough for assessors.</div>
            </div>
          </div>

          <div class="flex items-center gap-2 shrink-0">
            <!-- PC / Console switch -->
            <div class="chip rounded-xl p-1 flex items-center gap-1" aria-label="Platform switch">
              <button id="pcBtn" class="px-3 py-2 rounded-lg text-sm font-bold btn2">PC</button>
              <button id="consoleBtn" class="px-3 py-2 rounded-lg text-sm font-bold btn2">Console</button>
            </div>

            <a href="RT.html" class="px-3 py-2 rounded-xl btn2 text-sm hidden sm:inline-flex">RT Gate</a>
            <button id="logoutBtn" class="px-3 py-2 rounded-xl btn2 text-sm hidden">Logout</button>
            <button id="loginBtn" class="px-4 py-2 rounded-xl btn font-extrabold hidden">Login</button>
          </div>
        </div>

        <!-- Event strip -->
        <div class="mt-3 flex flex-wrap items-center gap-2">
          <span id="platformPill" class="chip px-3 py-1 rounded-full text-xs font-bold">Mode: —</span>
          <span id="sessionChip" class="chip px-3 py-1 rounded-full text-xs">Session: —</span>
          <span id="roleChip" class="chip px-3 py-1 rounded-full text-xs">Role: —</span>
          <span id="eventStrip" class="chip px-3 py-1 rounded-full text-xs muted">Event: —</span>
        </div>
      </div>

      <!-- Status -->
      <div id="statusBox" class="card rounded-2xl p-4 mb-5 hidden"></div>

      <!-- Gate Card -->
      <div id="gateCard" class="card rounded-2xl p-6 mb-5 hidden">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div>
            <div class="text-lg font-extrabold">Login required</div>
            <div class="muted mt-1">
              You must be <b>Assessor</b> or <b>Race Team ACC</b> to use this hub.
            </div>
            <div class="text-xs muted mt-3">
              Backend: <span class="mono" id="backendHint"></span>
            </div>
          </div>
          <div>
            <button id="loginBtn2" class="px-5 py-3 rounded-xl btn font-extrabold w-full md:w-auto">Login with Discord</button>
          </div>
        </div>
      </div>

      <!-- App -->
      <div id="app" class="hidden">

        <!-- Dashboard -->
        <div class="grid lg:grid-cols-3 gap-4 mb-5">
          <div class="card rounded-2xl p-5">
            <div class="text-sm muted">Signed in as</div>
            <div class="text-xl font-extrabold mt-1" id="whoami">—</div>
            <div class="mt-3 grid grid-cols-2 gap-2">
              <button id="myAvailBtn" class="px-3 py-2 rounded-xl btn2 text-sm text-left">Update availability</button>
              <button id="myStintBtn" class="px-3 py-2 rounded-xl btn2 text-sm text-left">Claim a stint</button>
              <button id="copyHubLinkBtn" class="px-3 py-2 rounded-xl btn2 text-sm text-left">Copy hub link</button>
              <button id="copyEventBtn" class="px-3 py-2 rounded-xl btn2 text-sm text-left">Copy event summary</button>
            </div>
          </div>

          <div class="card rounded-2xl p-5">
            <div class="flex items-start justify-between gap-2">
              <div>
                <div class="text-sm muted">Attendance status</div>
                <div class="text-xl font-extrabold mt-1" id="attHeadline">—</div>
                <div class="text-sm muted mt-1" id="attSub">—</div>
              </div>
              <button id="refreshBtn" class="px-3 py-2 rounded-xl btn2 text-sm">Refresh</button>
            </div>

            <div class="mt-4 grid grid-cols-3 gap-2">
              <div class="chip rounded-xl p-3">
                <div class="text-xs muted">Event ✅</div>
                <div class="text-lg font-extrabold mt-1" id="attEventYes">—</div>
              </div>
              <div class="chip rounded-xl p-3">
                <div class="text-xs muted">Practice ✅</div>
                <div class="text-lg font-extrabold mt-1" id="attPracticeYes">—</div>
              </div>
              <div class="chip rounded-xl p-3">
                <div class="text-xs muted">Missing</div>
                <div class="text-lg font-extrabold mt-1" id="attMissing">—</div>
              </div>
            </div>

            <div class="mt-3 flex gap-2">
              <button id="copyNudgeBtn" class="px-3 py-2 rounded-xl btn text-sm font-extrabold w-full">Copy nudge message</button>
            </div>
          </div>

          <div class="card rounded-2xl p-5">
            <div class="text-sm muted">Readiness</div>
            <div class="mt-3 space-y-3">
              <div class="chip rounded-xl p-3">
                <div class="flex items-center justify-between gap-2">
                  <div class="font-extrabold">Stints</div>
                  <div class="text-sm muted" id="stintProgress">—</div>
                </div>
                <div class="text-xs muted mt-1" id="stintUnclaimedLine">—</div>
              </div>
              <div class="chip rounded-xl p-3">
                <div class="flex items-center justify-between gap-2">
                  <div class="font-extrabold">Setups</div>
                  <div class="text-sm muted" id="setupCountLine">—</div>
                </div>
                <div class="text-xs muted mt-1" id="pitLine">Pit: —</div>
              </div>
              <div class="chip rounded-xl p-3">
                <div class="flex items-center justify-between gap-2">
                  <div class="font-extrabold">Weather</div>
                  <div class="text-sm muted" id="weatherBadge">—</div>
                </div>
                <div class="text-xs muted mt-1" id="weatherLine">—</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabs (desktop) -->
        <div class="card rounded-2xl p-2 mb-4 hidden md:flex flex-wrap gap-2">
          <div class="tab tabActive px-4 py-2 rounded-xl text-sm font-extrabold" data-tab="overview">Overview</div>
          <div class="tab px-4 py-2 rounded-xl text-sm font-extrabold" data-tab="availability">Availability</div>
          <div class="tab px-4 py-2 rounded-xl text-sm font-extrabold" data-tab="stints">Stints</div>
          <div class="tab px-4 py-2 rounded-xl text-sm font-extrabold" data-tab="setups">Setups</div>
          <div class="tab px-4 py-2 rounded-xl text-sm font-extrabold" data-tab="fuel">Fuel</div>
          <div class="tab px-4 py-2 rounded-xl text-sm font-extrabold" data-tab="assessor" id="assessorTab" style="display:none;">Assessor</div>
        </div>

        <!-- Panels -->
        <div id="panel-overview" class="grid lg:grid-cols-3 gap-4">
          <div class="card rounded-2xl p-6 lg:col-span-2">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="min-w-0">
                <div class="text-sm muted">Event brief</div>
                <div class="text-2xl font-extrabold mt-1" id="eventTitle">—</div>
                <div class="muted mt-2 text-sm" id="eventMeta">—</div>

                <div class="mt-4 flex flex-wrap gap-2">
                  <a id="simgridBtn" href="#" target="_blank" class="px-4 py-2 rounded-xl btn font-extrabold inline-block">Open SimGrid</a>
                  <a id="carImgBtn" href="#" target="_blank" class="px-4 py-2 rounded-xl btn2 text-sm inline-block">Car image</a>
                </div>
              </div>

              <div class="md:w-56 shrink-0">
                <img id="carImg" src="" alt="" class="w-full h-32 object-cover rounded-2xl soft hidden" />
              </div>
            </div>

            <div class="grid md:grid-cols-3 gap-3 mt-6">
              <div class="chip rounded-2xl p-4">
                <div class="text-xs muted">Track</div>
                <div class="font-extrabold mt-1" id="trackTxt">—</div>
              </div>
              <div class="chip rounded-2xl p-4">
                <div class="text-xs muted">Start</div>
                <div class="font-extrabold mt-1" id="startTxt">—</div>
              </div>
              <div class="chip rounded-2xl p-4">
                <div class="text-xs muted">Pit strategy</div>
                <div class="font-extrabold mt-1" id="pitTxt">—</div>
              </div>
            </div>

            <div class="mt-6 grid md:grid-cols-2 gap-4">
              <div class="chip rounded-2xl p-4">
                <div class="text-sm font-extrabold">Weather</div>
                <div class="muted text-sm mt-2" id="weatherTxt">—</div>
              </div>

              <div class="chip rounded-2xl p-4">
                <div class="text-sm font-extrabold">Fast actions</div>
                <div class="muted text-sm mt-2">
                  <ul class="list-disc pl-5 space-y-1">
                    <li>Mark availability (Yes / Maybe / No)</li>
                    <li>Claim stints + add notes</li>
                    <li>Assessor publishes setups + pit plan</li>
                    <li>Copy-ready outputs for Discord</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <div class="card rounded-2xl p-6">
            <div class="text-sm muted">Live snapshot</div>
            <div class="text-lg font-extrabold mt-1">Who’s in?</div>

            <div class="mt-4">
              <div class="text-xs muted mb-2">Availability (Practice / Event)</div>
              <div id="availMini" class="space-y-2 text-sm"></div>
            </div>

            <div class="mt-5">
              <div class="text-xs muted mb-2">Stints claimed</div>
              <div id="stintsMini" class="space-y-2 text-sm"></div>
            </div>
          </div>
        </div>

        <!-- Availability Panel -->
        <div id="panel-availability" class="hidden">
          <div class="grid lg:grid-cols-3 gap-4">
            <div class="card rounded-2xl p-6">
              <div class="text-xl font-extrabold">Your availability</div>
              <div class="muted text-sm mt-2">
                Choose Yes / Maybe / No. Use notes for timeslots, “can qualify”, “can start”, etc.
              </div>

              <div class="mt-5 space-y-3">
                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Practice</div>
                  <select id="myPracticeStatus" class="w-full bg-transparent outline-none text-sm">
                    <option value="YES">Yes</option>
                    <option value="MAYBE">Maybe</option>
                    <option value="NO">No</option>
                  </select>
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Event</div>
                  <select id="myEventStatus" class="w-full bg-transparent outline-none text-sm">
                    <option value="YES">Yes</option>
                    <option value="MAYBE">Maybe</option>
                    <option value="NO">No</option>
                  </select>
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Notes (times / roles / anything)</div>
                  <textarea id="myAvailNotes" class="w-full bg-transparent outline-none text-sm min-h-[90px]" placeholder="e.g. Can do Q + start. Free from 12:30 onward."></textarea>
                  <div class="text-[11px] muted mt-2">
                    Tip: “Maybe” is stored safely using tags in notes (no backend changes needed).
                  </div>
                </div>

                <button id="saveAvailBtn" class="w-full px-4 py-3 rounded-xl btn font-extrabold">Save</button>
              </div>
            </div>

            <div class="card rounded-2xl p-6 lg:col-span-2">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-xl font-extrabold">Team availability</div>
                  <div class="muted text-sm mt-1">
                    Sorted + easy to scan. (Yes/Maybe/No shown even though backend stays boolean.)
                  </div>
                </div>
                <button id="refreshAvailBtn" class="px-4 py-2 rounded-xl btn2 text-sm">Refresh</button>
              </div>

              <div class="mt-5 overflow-x-auto">
                <table class="w-full text-sm">
                  <thead class="muted">
                    <tr>
                      <th class="text-left py-2">Driver</th>
                      <th class="text-left py-2">Practice</th>
                      <th class="text-left py-2">Event</th>
                      <th class="text-left py-2">Notes</th>
                      <th class="text-left py-2">Updated</th>
                    </tr>
                  </thead>
                  <tbody id="availTable" class="align-top"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Stints Panel -->
        <div id="panel-stints" class="hidden">
          <div class="grid lg:grid-cols-3 gap-4">
            <div class="card rounded-2xl p-6">
              <div class="text-xl font-extrabold">Claim a stint</div>
              <div class="muted text-sm mt-2">
                Claim/update a stint. Add notes like “Q + start”, “night”, timeslots, backup plan.
              </div>

              <div class="mt-4 chip rounded-xl p-3">
                <div class="text-xs muted mb-2">Stint #</div>
                <input id="stintIdInput" class="w-full bg-transparent outline-none text-sm" placeholder="1" />
              </div>

              <div class="mt-3 chip rounded-xl p-3">
                <div class="text-xs muted mb-2">Notes</div>
                <textarea id="stintNotesInput" class="w-full bg-transparent outline-none text-sm min-h-[90px]" placeholder="e.g. Can do stint 1 + 2. Prefer night stint."></textarea>
              </div>

              <button id="claimStintBtn" class="w-full mt-3 px-4 py-3 rounded-xl btn font-extrabold">Claim / Update</button>
            </div>

            <div class="card rounded-2xl p-6 lg:col-span-2">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                <div>
                  <div class="text-xl font-extrabold">Stints</div>
                  <div class="muted text-sm mt-1">Board view + a final “share-ready” plan.</div>
                </div>

                <div class="flex items-center gap-2">
                  <div class="chip rounded-xl p-1 flex items-center gap-1">
                    <button id="stintViewBoard" class="px-3 py-2 rounded-lg text-sm font-bold btn2">Board</button>
                    <button id="stintViewFinal" class="px-3 py-2 rounded-lg text-sm font-bold btn2">Final plan</button>
                  </div>
                  <button id="refreshStintsBtn" class="px-4 py-2 rounded-xl btn2 text-sm">Refresh</button>
                </div>
              </div>

              <div id="stintBoardWrap" class="mt-5 grid sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>

              <div id="stintFinalWrap" class="mt-5 hidden">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                  <div class="font-extrabold">Final stint plan</div>
                  <button id="copyFinalPlanBtn" class="px-4 py-2 rounded-xl btn text-sm font-extrabold">Copy final plan</button>
                </div>

                <div class="mt-3 overflow-x-auto">
                  <table class="w-full text-sm">
                    <thead class="muted">
                      <tr>
                        <th class="text-left py-2">Stint</th>
                        <th class="text-left py-2">Driver</th>
                        <th class="text-left py-2">Notes</th>
                        <th class="text-left py-2">Status</th>
                      </tr>
                    </thead>
                    <tbody id="finalPlanTable" class="align-top"></tbody>
                  </table>
                </div>

                <div class="mt-4 warn rounded-2xl p-4 text-sm hidden" id="finalPlanWarn">
                  Some stints are still unclaimed. Use the Board view to fill gaps.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Setups Panel -->
        <div id="panel-setups" class="hidden">
          <div class="grid lg:grid-cols-3 gap-4">
            <div class="card rounded-2xl p-6">
              <div class="text-xl font-extrabold">Setups</div>
              <div class="muted text-sm mt-2">
                Assessor publishes approved setups. Tags are parsed from notes like <span class="mono">#wet #race #quali</span>.
              </div>
              <div class="mt-4 chip rounded-2xl p-4">
                <div class="text-sm font-extrabold">Tag examples</div>
                <div class="muted text-sm mt-2">
                  <div class="mono">#safe #aggressive #wet #dry #quali #race</div>
                </div>
              </div>
            </div>

            <div class="card rounded-2xl p-6 lg:col-span-2">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-xl font-extrabold">Setup library (current event)</div>
                  <div class="muted text-sm mt-1">Click to open. Copy links easily.</div>
                </div>
                <button id="refreshSetupsBtn" class="px-4 py-2 rounded-xl btn2 text-sm">Refresh</button>
              </div>

              <div id="setupsList" class="mt-5 grid md:grid-cols-2 gap-3"></div>

              <div class="mt-4 warn rounded-2xl p-4 text-sm hidden" id="noSetupsBox">
                No setups added yet. Assessor can add them in <b>Assessor</b>.
              </div>
            </div>
          </div>
        </div>

        <!-- Fuel Panel -->
        <div id="panel-fuel" class="hidden">
          <div class="grid lg:grid-cols-3 gap-4">
            <div class="card rounded-2xl p-6">
              <div class="text-xl font-extrabold">Fuel tools (ACC)</div>
              <div class="muted text-sm mt-2">Quick planning for stints and safety margin.</div>

              <div class="mt-5 space-y-3">
                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Fuel per lap</div>
                  <input id="fuelPerLap" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. 2.75" />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Laps (race or stint)</div>
                  <input id="lapsCount" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. 30" />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Extra laps (formation / safety)</div>
                  <input id="extraLaps" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. 2" />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Margin %</div>
                  <input id="marginPct" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. 3" />
                </div>

                <button id="calcFuelBtn" class="w-full px-4 py-3 rounded-xl btn font-extrabold">Calculate</button>
              </div>
            </div>

            <div class="card rounded-2xl p-6 lg:col-span-2">
              <div class="text-xl font-extrabold">Result</div>
              <div id="fuelResult" class="mt-4 chip rounded-2xl p-5 text-sm">
                Enter values and click calculate.
              </div>
              <div class="mt-4 chip rounded-2xl p-4 text-sm muted">
                Planning tool only — always validate in-game.
              </div>
            </div>
          </div>
        </div>

        <!-- Assessor Panel -->
        <div id="panel-assessor" class="hidden">
          <div class="grid lg:grid-cols-3 gap-4">
            <div class="card rounded-2xl p-6 lg:col-span-2">
              <div class="flex items-center justify-between gap-3">
                <div>
                  <div class="text-xl font-extrabold">Assessor tools</div>
                  <div class="muted text-sm mt-1">Set event, weather, pit plan, and setup links.</div>
                </div>
                <button id="loadEventToFormBtn" class="px-4 py-2 rounded-xl btn2 text-sm">Load current</button>
              </div>

              <div class="mt-5 grid md:grid-cols-2 gap-3">
                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Event title</div>
                  <input id="evTitle" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. 12 Hours of Misano" />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Track</div>
                  <input id="evTrack" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. Misano" />
                </div>

                <div class="chip rounded-xl p-3 md:col-span-2">
                  <div class="text-xs muted mb-2">SimGrid URL</div>
                  <input id="evSimgrid" class="w-full bg-transparent outline-none text-sm" placeholder="https://..." />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Car name</div>
                  <input id="evCarName" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. Ferrari 296 GT3" />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Car image URL</div>
                  <input id="evCarImg" class="w-full bg-transparent outline-none text-sm" placeholder="https://..." />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Start time (ISO)</div>
                  <input id="evStartIso" class="w-full bg-transparent outline-none text-sm" placeholder="2026-02-21T10:00:00Z" />
                </div>

                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Pit strategy</div>
                  <input id="evPit" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. 65L, double-stint tyres..." />
                </div>
              </div>

              <div class="mt-5 grid md:grid-cols-3 gap-3">
                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Weather</div>
                  <input id="wCond" class="w-full bg-transparent outline-none text-sm" placeholder="Dry / Wet / Mixed" />
                </div>
                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Ambient °C</div>
                  <input id="wAmb" class="w-full bg-transparent outline-none text-sm" placeholder="18" />
                </div>
                <div class="chip rounded-xl p-3">
                  <div class="text-xs muted mb-2">Track °C</div>
                  <input id="wTrack" class="w-full bg-transparent outline-none text-sm" placeholder="26" />
                </div>
                <div class="chip rounded-xl p-3 md:col-span-3">
                  <div class="text-xs muted mb-2">Weather notes</div>
                  <input id="wNotes" class="w-full bg-transparent outline-none text-sm" placeholder="e.g. rain expected mid-race, watch pressures" />
                </div>
              </div>

              <div class="mt-5 chip rounded-2xl p-4">
                <div class="flex items-center justify-between gap-3">
                  <div class="font-extrabold">Setup links</div>
                  <button id="addSetupBtn" class="px-3 py-2 rounded-xl btn2 text-sm">+ Add setup</button>
                </div>
                <div id="setupFormList" class="mt-4 space-y-3"></div>
                <div class="text-[11px] muted mt-3">Add tags in Notes like <span class="mono">#wet #race</span>.</div>
              </div>

              <div class="mt-5 flex flex-col sm:flex-row gap-2">
                <button id="saveEventBtn" class="px-5 py-3 rounded-xl btn font-extrabold">Save event</button>
                <button id="assessorRefreshBtn" class="px-5 py-3 rounded-xl btn2 text-sm">Refresh hub</button>
              </div>
            </div>

            <div class="card rounded-2xl p-6">
              <div class="text-xl font-extrabold">Admin actions</div>
              <div class="muted text-sm mt-2">Use at the start of a new event.</div>

              <button id="clearStintsBtn" class="w-full mt-4 px-4 py-3 rounded-xl danger font-extrabold">Clear all stints</button>

              <div class="mt-4 chip rounded-2xl p-4 text-sm muted">Clears only <b>stint assignments</b>, not availability.</div>
              <div class="mt-5 chip rounded-2xl p-4 text-xs muted">
                This hub does not touch steward/ticket systems.<br/>
                It only uses:
                <div class="mono mt-2">rt/currentEvent<br/>rt_availability/*<br/>rt_stints/*</div>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /app -->

      <div class="text-center text-xs muted mt-8 pb-20 md:pb-0">
        IFWL Race Team Hub • Built for fast planning and cleaner comms
      </div>

      <!-- Mobile bottom tabs -->
      <div class="fixed bottom-3 left-0 right-0 px-4 md:hidden z-40">
        <div class="card rounded-2xl p-2 mobileTabsShadow">
          <div class="grid grid-cols-5 gap-2 text-xs font-extrabold">
            <button class="tabMobile px-2 py-2 rounded-xl btn2" data-tab="overview">Home</button>
            <button class="tabMobile px-2 py-2 rounded-xl btn2" data-tab="availability">Avail</button>
            <button class="tabMobile px-2 py-2 rounded-xl btn2" data-tab="stints">Stints</button>
            <button class="tabMobile px-2 py-2 rounded-xl btn2" data-tab="setups">Setups</button>
            <button class="tabMobile px-2 py-2 rounded-xl btn2" data-tab="fuel">Fuel</button>
          </div>
        </div>
      </div>

    </div>
  </div>

<script>
/** ===========================
 * CONFIG — your deployed endpoints (UNCHANGED)
 * =========================== */
const FUNCTIONS_BASE = "https://europe-west2-ifwl-591d8.cloudfunctions.net";
const RT_GATE = `${FUNCTIONS_BASE}/rtGate`;

const API = {
  eventGet: `${FUNCTIONS_BASE}/rtEventGet`,
  eventSet: `${FUNCTIONS_BASE}/rtEventSet`,
  availUpsert: `${FUNCTIONS_BASE}/rtAvailabilityUpsert`,
  availList: `${FUNCTIONS_BASE}/rtAvailabilityList`,
  stintUpsert: `${FUNCTIONS_BASE}/rtStintUpsert`,
  stintList: `${FUNCTIONS_BASE}/rtStintList`,
  stintClear: `${FUNCTIONS_BASE}/rtStintClear`,
};

// must match your Discord redirect allowlist
const REDIRECT_URI = window.location.origin + window.location.pathname;

// storage keys
const K = {
  session: "IFWL_RT_SESSION",
  user: "IFWL_RT_USER",
  platform: "IFWL_RT_PLATFORM", // "pc" | "console"
  lapLocalPrefix: "IFWL_RT_LAP_LOCAL_", // per platform
};

// Platform modes
const PLATFORMS = { pc: "PC", console: "Console" };

// Safe today, future-ready:
// Off by default so we don't depend on backend support.
// When you add platform-aware endpoints later, you can set to true.
const USE_PLATFORM_QUERY_ON_GET = false;

const els = (id) => document.getElementById(id);

function esc(s) {
  return String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

function showStatus(html, type="ok") {
  const box = els("statusBox");
  box.className = `card rounded-2xl p-4 mb-5 ${type === "ok" ? "ok" : type === "warn" ? "warn" : "danger"}`;
  box.innerHTML = html;
  box.classList.remove("hidden");
}
function hideStatus() {
  els("statusBox").classList.add("hidden");
  els("statusBox").innerHTML = "";
}

/** ===========================
 * Tabs
 * =========================== */
function setTab(name) {
  document.querySelectorAll(".tab").forEach(t => t.classList.toggle("tabActive", t.dataset.tab === name));
  document.querySelectorAll(".tabMobile").forEach(t => t.classList.toggle("tabActive", t.dataset.tab === name));

  ["overview","availability","stints","setups","fuel","assessor"].forEach(p => {
    const el = document.getElementById(`panel-${p}`);
    if (el) el.classList.toggle("hidden", p !== name);
  });

  window.scrollTo({ top: 0, behavior: "smooth" });
}
document.querySelectorAll(".tab").forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));
document.querySelectorAll(".tabMobile").forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

/** ===========================
 * Platform switch
 * =========================== */
function getPlatform() {
  const url = new URL(window.location.href);
  const fromUrl = (url.searchParams.get("mode") || "").toLowerCase();
  if (fromUrl === "pc" || fromUrl === "console") return fromUrl;

  const v = (localStorage.getItem(K.platform) || "").toLowerCase();
  if (v === "pc" || v === "console") return v;

  return window.matchMedia("(max-width: 768px)").matches ? "console" : "pc";
}
function setPlatform(p) {
  const plat = (p === "console") ? "console" : "pc";
  localStorage.setItem(K.platform, plat);

  els("pcBtn").classList.toggle("btn", plat === "pc");
  els("pcBtn").classList.toggle("btn2", plat !== "pc");
  els("consoleBtn").classList.toggle("btn", plat === "console");
  els("consoleBtn").classList.toggle("btn2", plat !== "console");
  els("platformPill").textContent = `Mode: ${PLATFORMS[plat]}`;

  // keep mode param for sharing
  const url = new URL(window.location.href);
  url.searchParams.set("mode", plat);
  history.replaceState({}, document.title, url.toString());
}
els("pcBtn").addEventListener("click", async () => { setPlatform("pc"); await refreshAll(); });
els("consoleBtn").addEventListener("click", async () => { setPlatform("console"); await refreshAll(); });

function withPlatformQuery(url) {
  if (!USE_PLATFORM_QUERY_ON_GET) return url;
  const u = new URL(url);
  u.searchParams.set("platform", getPlatform());
  return u.toString();
}

/** ===========================
 * Auth / Session (UNCHANGED FLOW)
 * =========================== */
function getSession() { return localStorage.getItem(K.session) || ""; }
function setSession(token) {
  localStorage.setItem(K.session, token);
  els("sessionChip").textContent = token ? "Session: Active" : "Session: None";
}
function setUser(user) {
  localStorage.setItem(K.user, JSON.stringify(user || {}));
  els("whoami").textContent = user?.username ? user.username : "—";
  els("roleChip").textContent = user?.isAssessor ? "Role: Assessor" : "Role: Member";
  els("assessorTab").style.display = user?.isAssessor ? "block" : "none";
}
function clearAuth() {
  localStorage.removeItem(K.session);
  localStorage.removeItem(K.user);
}

function showGate() {
  els("app").classList.add("hidden");
  els("gateCard").classList.remove("hidden");
  els("loginBtn").classList.remove("hidden");
  els("loginBtn2").classList.remove("hidden");
  els("logoutBtn").classList.add("hidden");
  els("backendHint").textContent = RT_GATE;
}
function showApp() {
  els("gateCard").classList.add("hidden");
  els("app").classList.remove("hidden");
  els("loginBtn").classList.add("hidden");
  els("loginBtn2").classList.add("hidden");
  els("logoutBtn").classList.remove("hidden");
}

async function apiFetch(url, opts = {}) {
  const token = getSession();
  const headers = Object.assign({}, opts.headers || {});
  if (token) headers["Authorization"] = `Bearer ${token}`;

  const res = await fetch(url, { ...opts, headers });

  if (res.status === 401) {
    clearAuth();
    showStatus("⛔ Session expired. Please login again.", "warn");
    showGate();
    throw new Error("Unauthorized (401)");
  }
  return res;
}

async function startLogin() {
  const startUrl = `${RT_GATE}?start=1&redirect=${encodeURIComponent(REDIRECT_URI)}`;
  const r = await fetch(startUrl);
  const data = await r.json();
  if (!data?.url) throw new Error(data?.error || "No login URL returned");
  window.location.href = data.url;
}

async function handleCallback() {
  const params = new URLSearchParams(location.search);
  const code = params.get("code");
  const error = params.get("error");

  if (error) {
    showStatus(`❌ Discord login error: <b>${esc(error)}</b>`, "bad");
    return;
  }
  if (!code) return;

  const checkUrl = `${RT_GATE}?code=${encodeURIComponent(code)}&redirect=${encodeURIComponent(REDIRECT_URI)}&issue=1`;
  const r = await fetch(checkUrl);
  const data = await r.json();

  // clean URL but keep mode param
  const u = new URL(window.location.href);
  u.searchParams.delete("code");
  u.searchParams.delete("error");
  history.replaceState({}, document.title, u.toString());

  if (!data?.accessGranted) {
    showStatus(`⛔ <b>Access Denied</b><br/>Discord: ${esc(data?.username || "user")}`, "bad");
    clearAuth();
    showGate();
    return;
  }
  if (!data?.sessionToken) {
    showStatus(`⚠️ Logged in, but no sessionToken returned.`, "warn");
    clearAuth();
    showGate();
    return;
  }

  setSession(data.sessionToken);
  setUser({ username: data.username, userId: data.userId, isAssessor: !!data.isAssessor });
  showStatus(`✅ <b>Access Granted</b><br/>Welcome ${esc(data.username)}.`, "ok");
  showApp();
  await refreshAll();
}

/** ===========================
 * Helpers
 * =========================== */
function fmtIso(iso) {
  if (!iso) return "—";
  const d = new Date(iso);
  if (isNaN(d.getTime())) return String(iso);
  return d.toLocaleString();
}

function parseTimestamp(anyTs) {
  if (!anyTs) return "";
  if (typeof anyTs === "string") {
    const d = new Date(anyTs);
    return isNaN(d.getTime()) ? anyTs : d.toLocaleString();
  }
  const s = anyTs._seconds ?? anyTs.seconds ?? null;
  if (typeof s === "number") return new Date(s * 1000).toLocaleString();
  return "";
}

/** Availability status tags stored in notes (no backend change) */
function encodeAvailNotes(rawNotes, practiceStatus, eventStatus) {
  const notes = String(rawNotes || "");
  const cleaned = notes
    .replace(/\[P:(YES|MAYBE|NO)\]\s*/g, "")
    .replace(/\[E:(YES|MAYBE|NO)\]\s*/g, "")
    .trim();
  return `[P:${practiceStatus}] [E:${eventStatus}] ${cleaned}`.trim();
}
function decodeAvailNotes(notes) {
  const s = String(notes || "");
  const p = (s.match(/\[P:(YES|MAYBE|NO)\]/) || [])[1] || "";
  const e = (s.match(/\[E:(YES|MAYBE|NO)\]/) || [])[1] || "";
  const cleaned = s
    .replace(/\[P:(YES|MAYBE|NO)\]\s*/g, "")
    .replace(/\[E:(YES|MAYBE|NO)\]\s*/g, "")
    .trim();
  return { practiceStatus: p, eventStatus: e, cleanedNotes: cleaned };
}
function statusEmoji(st) {
  if (st === "YES") return "✅";
  if (st === "MAYBE") return "❓";
  if (st === "NO") return "❌";
  return "—";
}
function tagChipsFromNotes(notes) {
  const s = String(notes || "");
  const tags = (s.match(/#[a-z0-9_-]+/gi) || []).map(t => t.toLowerCase());
  const unique = [...new Set(tags)].slice(0, 6);
  return unique;
}

/** ===========================
 * State + Rendering
 * =========================== */
let currentEvent = null;
let availabilityRows = [];
let stintRows = [];
const MAX_STINTS_DEFAULT = 12;

function renderEvent() {
  const ev = currentEvent || {};
  const title = ev.title || "—";
  const track = ev.track || "—";
  const start = fmtIso(ev.startsAtIso);
  const carName = ev.carName || "";
  const sim = ev.simgridUrl || "#";
  const carImg = ev.carImageUrl || "";

  els("eventTitle").textContent = title;
  els("eventMeta").textContent = `${carName ? carName + " • " : ""}${track} • ${start}`;
  els("trackTxt").textContent = track;
  els("startTxt").textContent = start;
  els("pitTxt").textContent = ev.pitStrategy ? ev.pitStrategy : "—";

  els("eventStrip").textContent = `Event: ${title} • ${track}`;
  els("simgridBtn").href = sim || "#";
  els("carImgBtn").href = carImg || "#";

  const carImgEl = els("carImg");
  if (carImg) {
    carImgEl.src = carImg;
    carImgEl.classList.remove("hidden");
  } else {
    carImgEl.classList.add("hidden");
  }

  const w = ev.weather || {};
  const weatherLineHtml = [
    w.conditions ? `<b>${esc(w.conditions)}</b>` : "—",
    (w.ambientC || w.ambientC === 0) ? `Ambient: <b>${esc(w.ambientC)}</b>°C` : "",
    (w.trackC || w.trackC === 0) ? `Track: <b>${esc(w.trackC)}</b>°C` : "",
    w.notes ? `<span class="muted">(${esc(w.notes)})</span>` : ""
  ].filter(Boolean).join(" • ");

  els("weatherTxt").innerHTML = weatherLineHtml || "—";

  // dashboard lines
  const cond = String(w.conditions || "—");
  els("weatherBadge").textContent = cond;
  els("weatherLine").textContent = (w.notes || w.ambientC || w.trackC) ? `${w.notes || ""} ${w.ambientC!==undefined ? `• ${w.ambientC}°C` : ""} ${w.trackC!==undefined ? `• ${w.trackC}°C track` : ""}`.trim() : "—";

  const setups = Array.isArray(ev.setups) ? ev.setups : [];
  els("setupCountLine").textContent = setups.length ? `${setups.length} setup(s)` : "None";
  els("pitLine").textContent = `Pit: ${ev.pitStrategy ? String(ev.pitStrategy).slice(0, 80) : "—"}`;

  renderSetups();
}

function renderSetups() {
  const list = els("setupsList");
  const noBox = els("noSetupsBox");
  list.innerHTML = "";

  const setups = Array.isArray(currentEvent?.setups) ? currentEvent.setups : [];
  if (!setups.length) {
    noBox.classList.remove("hidden");
    return;
  }
  noBox.classList.add("hidden");

  setups.forEach(s => {
    const card = document.createElement("div");
    card.className = "chip rounded-2xl p-4";

    const url = s.url || "#";
    const notes = String(s.notes || "");
    const tags = tagChipsFromNotes(notes);

    const tagHtml = tags.length
      ? `<div class="mt-2 flex flex-wrap gap-1">${tags.map(t => `<span class="chip px-2 py-0.5 rounded-full text-[11px] font-bold">${esc(t)}</span>`).join("")}</div>`
      : "";

    card.innerHTML = `
      <div class="flex items-start justify-between gap-2">
        <div class="min-w-0">
          <div class="font-extrabold truncate">${esc(s.label || "Setup")}</div>
          <div class="muted text-sm mt-1">${esc(notes)}</div>
          ${tagHtml}
        </div>
        <div class="flex flex-col gap-2 shrink-0">
          <a href="${esc(url)}" target="_blank" class="px-3 py-2 rounded-xl btn2 text-sm whitespace-nowrap">Open</a>
          <button class="px-3 py-2 rounded-xl btn text-sm font-extrabold copySetupBtn" data-url="${esc(url)}">Copy</button>
        </div>
      </div>
      <div class="mt-3 text-xs muted mono break-all">${esc(url)}</div>
    `;
    list.appendChild(card);
  });

  document.querySelectorAll(".copySetupBtn").forEach(btn => {
    btn.addEventListener("click", async () => {
      try { await navigator.clipboard.writeText(btn.dataset.url || ""); } catch {}
      showStatus("✅ Setup link copied.", "ok");
    });
  });
}

function renderAvailTable() {
  const tb = els("availTable");
  tb.innerHTML = "";

  const rows = [...availabilityRows].sort((a,b) => (a.username||"").localeCompare(b.username||""));
  rows.forEach(r => {
    const decoded = decodeAvailNotes(r.notes);
    // derive display statuses
    const pStatus = decoded.practiceStatus || (r.practice ? "YES" : "NO");
    const eStatus = decoded.eventStatus || (r.event ? "YES" : "NO");

    const tr = document.createElement("tr");
    tr.className = "border-t border-black/5";
    tr.innerHTML = `
      <td class="py-3 font-bold">${esc(r.username || "—")}</td>
      <td class="py-3">${statusEmoji(pStatus)} <span class="muted text-xs">${esc(pStatus)}</span></td>
      <td class="py-3">${statusEmoji(eStatus)} <span class="muted text-xs">${esc(eStatus)}</span></td>
      <td class="py-3 muted">${esc(decoded.cleanedNotes || "")}</td>
      <td class="py-3 muted text-xs">${esc(parseTimestamp(r.updatedAt))}</td>
    `;
    tb.appendChild(tr);
  });

  // mini list
  const mini = els("availMini");
  mini.innerHTML = "";
  rows.slice(0, 8).forEach(r => {
    const d = decodeAvailNotes(r.notes);
    const pStatus = d.practiceStatus || (r.practice ? "YES" : "NO");
    const eStatus = d.eventStatus || (r.event ? "YES" : "NO");
    const line = document.createElement("div");
    line.className = "chip rounded-xl px-3 py-2 flex items-center justify-between gap-3";
    line.innerHTML = `
      <div class="font-bold truncate">${esc(r.username || "—")}</div>
      <div class="text-xs muted shrink-0">${statusEmoji(pStatus)} P • ${statusEmoji(eStatus)} E</div>
    `;
    mini.appendChild(line);
  });
  if (rows.length > 8) {
    const more = document.createElement("div");
    more.className = "text-xs muted mt-2";
    more.textContent = `+ ${rows.length - 8} more...`;
    mini.appendChild(more);
  }
}

function renderStints() {
  // Board
  const wrap = els("stintBoardWrap");
  wrap.innerHTML = "";

  const map = new Map();
  stintRows.forEach(s => map.set(String(s.stintId), s));

  for (let i=1; i<=MAX_STINTS_DEFAULT; i++) {
    const key = String(i);
    const s = map.get(key);
    const claimed = !!s?.userId;

    const card = document.createElement("div");
    card.className = `chip rounded-2xl p-4 ${claimed ? "" : "border-dashed"}`;
    card.innerHTML = `
      <div class="flex items-center justify-between gap-2">
        <div class="font-extrabold text-lg">Stint ${i}</div>
        <button class="px-3 py-2 rounded-xl btn2 text-sm claimBtn" data-stint="${i}">${claimed ? "Update" : "Claim"}</button>
      </div>
      <div class="mt-2 text-sm">
        <div class="${claimed ? "" : "muted"}">
          ${claimed ? `<b>${esc(s.username || "—")}</b>` : "Unclaimed"}
        </div>
        <div class="muted text-xs mt-1">${esc(s?.notes || "")}</div>
      </div>
    `;
    wrap.appendChild(card);
  }

  document.querySelectorAll(".claimBtn").forEach(btn => {
    btn.addEventListener("click", () => {
      setTab("stints");
      setStintView("board");
      els("stintIdInput").value = btn.dataset.stint;
      els("stintNotesInput").focus();
    });
  });

  // Mini
  const mini = els("stintsMini");
  mini.innerHTML = "";
  const claimedRows = [...stintRows].sort((a,b)=>Number(a.stintId)-Number(b.stintId)).slice(0, 8);
  claimedRows.forEach(s => {
    const line = document.createElement("div");
    line.className = "chip rounded-xl px-3 py-2 flex items-center justify-between";
    line.innerHTML = `
      <div class="font-bold">#${esc(s.stintId)}</div>
      <div class="text-xs muted">${esc(s.username || "—")}</div>
    `;
    mini.appendChild(line);
  });
  if (!stintRows.length) {
    const none = document.createElement("div");
    none.className = "text-xs muted";
    none.textContent = "No stints claimed yet.";
    mini.appendChild(none);
  }

  // Final Plan
  renderFinalPlan();
}

function renderFinalPlan() {
  const tb = els("finalPlanTable");
  const warn = els("finalPlanWarn");
  tb.innerHTML = "";

  const map = new Map();
  stintRows.forEach(s => map.set(String(s.stintId), s));

  let unclaimedCount = 0;

  for (let i=1; i<=MAX_STINTS_DEFAULT; i++) {
    const s = map.get(String(i));
    const claimed = !!s?.userId;
    if (!claimed) unclaimedCount++;

    const tr = document.createElement("tr");
    tr.className = "border-t border-black/5";
    tr.innerHTML = `
      <td class="py-3 font-bold">#${i}</td>
      <td class="py-3">${claimed ? `<b>${esc(s.username || "—")}</b>` : "<span class='muted'>—</span>"}</td>
      <td class="py-3 muted">${esc(s?.notes || "")}</td>
      <td class="py-3">${claimed ? "<span class='chip px-2 py-1 rounded-full text-xs font-bold'>Claimed</span>" : "<span class='chip px-2 py-1 rounded-full text-xs font-bold'>Unclaimed</span>"}</td>
    `;
    tb.appendChild(tr);
  }

  warn.classList.toggle("hidden", unclaimedCount === 0);

  // Dashboard readiness
  const claimed = stintRows.length;
  els("stintProgress").textContent = `${claimed}/${MAX_STINTS_DEFAULT} claimed`;
  if (unclaimedCount) {
    const nums = [];
    for (let i=1; i<=MAX_STINTS_DEFAULT; i++) if (!map.get(String(i))?.userId) nums.push(i);
    els("stintUnclaimedLine").textContent = `Unclaimed: ${nums.slice(0, 10).join(", ")}${nums.length>10 ? "…" : ""}`;
  } else {
    els("stintUnclaimedLine").textContent = "All stints claimed ✅";
  }
}

/** ===========================
 * Dashboard summary
 * =========================== */
function renderDashboard() {
  const rows = availabilityRows || [];
  const total = rows.length;

  // Count event YES, practice YES, missing response (= no row)
  // We don't know "roster size" unless you store it, so missing means: no availability row at all.
  // We'll still show "Missing: 0" if there are rows; this is best-effort.
  let eventYes = 0, practiceYes = 0;

  rows.forEach(r => {
    const d = decodeAvailNotes(r.notes);
    const pStatus = d.practiceStatus || (r.practice ? "YES" : "NO");
    const eStatus = d.eventStatus || (r.event ? "YES" : "NO");
    if (pStatus === "YES") practiceYes++;
    if (eStatus === "YES") eventYes++;
  });

  // Missing: unknown roster → show 0, but headline references "responses"
  els("attEventYes").textContent = String(eventYes);
  els("attPracticeYes").textContent = String(practiceYes);
  els("attMissing").textContent = "—";

  els("attHeadline").textContent = `${eventYes} confirmed`;
  els("attSub").textContent = total ? `${total} response(s) recorded` : "No availability recorded yet";

  // copy nudge message uses "no response" (best-effort: if no roster, it's generic)
  els("copyNudgeBtn").disabled = !true;
}

/** ===========================
 * API calls
 * =========================== */
async function loadEvent() {
  const r = await apiFetch(withPlatformQuery(API.eventGet));
  const data = await r.json();
  if (!data?.ok) throw new Error(data?.error || "Event fetch failed");
  currentEvent = data.event || null;
  renderEvent();
}

async function loadAvailability() {
  const r = await apiFetch(withPlatformQuery(API.availList));
  const data = await r.json();
  if (!data?.ok) throw new Error(data?.error || "Availability fetch failed");
  availabilityRows = Array.isArray(data.rows) ? data.rows : [];
  renderAvailTable();
  renderDashboard();
}

async function loadStints() {
  const r = await apiFetch(withPlatformQuery(API.stintList));
  const data = await r.json();
  if (!data?.ok) throw new Error(data?.error || "Stints fetch failed");
  stintRows = Array.isArray(data.rows) ? data.rows : [];
  renderStints();
}

/** show partial failures instead of silent allSettled */
async function refreshAll() {
  hideStatus();

  const results = await Promise.allSettled([loadEvent(), loadAvailability(), loadStints()]);
  const labels = ["Event", "Availability", "Stints"];

  const failed = results
    .map((r, i) => ({ r, i }))
    .filter(x => x.r.status === "rejected")
    .map(x => `${labels[x.i]} failed`);

  if (failed.length) {
    showStatus(`⚠️ Partial refresh: <b>${failed.join(", ")}</b>`, "warn");
  }
}

/** ===========================
 * Stint view toggle
 * =========================== */
function setStintView(view) {
  const isFinal = view === "final";
  els("stintFinalWrap").classList.toggle("hidden", !isFinal);
  els("stintBoardWrap").classList.toggle("hidden", isFinal);

  els("stintViewFinal").classList.toggle("btn", isFinal);
  els("stintViewFinal").classList.toggle("btn2", !isFinal);
  els("stintViewBoard").classList.toggle("btn", !isFinal);
  els("stintViewBoard").classList.toggle("btn2", isFinal);
}
els("stintViewBoard").addEventListener("click", () => setStintView("board"));
els("stintViewFinal").addEventListener("click", () => { renderFinalPlan(); setStintView("final"); });

/** ===========================
 * Actions
 * =========================== */
els("loginBtn").addEventListener("click", () => startLogin().catch(e => showStatus(`❌ ${esc(e.message || e)}`,"bad")));
els("loginBtn2").addEventListener("click", () => startLogin().catch(e => showStatus(`❌ ${esc(e.message || e)}`,"bad")));

els("logoutBtn").addEventListener("click", () => {
  clearAuth();
  showStatus("Logged out.", "ok");
  showGate();
});

els("refreshBtn").addEventListener("click", () => refreshAll().catch(e => showStatus(`❌ ${esc(e.message || e)}`,"bad")));

els("myAvailBtn").addEventListener("click", () => setTab("availability"));
els("myStintBtn").addEventListener("click", () => setTab("stints"));

els("copyHubLinkBtn").addEventListener("click", async () => {
  const url = window.location.href;
  try { await navigator.clipboard.writeText(url); } catch {}
  showStatus(`✅ Hub link copied.`, "ok");
});

els("copyEventBtn").addEventListener("click", async () => {
  const ev = currentEvent || {};
  const msg = [
    `IFWL ${PLATFORMS[getPlatform()]} Event: ${ev.title || "—"}`,
    `Track: ${ev.track || "—"}`,
    `Start: ${ev.startsAtIso || "—"}`,
    `SimGrid: ${ev.simgridUrl || "—"}`,
    `Car: ${ev.carName || "—"}`,
    ev.pitStrategy ? `Pit: ${ev.pitStrategy}` : ""
  ].filter(Boolean).join("\n");
  try { await navigator.clipboard.writeText(msg); } catch {}
  showStatus(`✅ Event summary copied.`, "ok");
});

els("copyNudgeBtn").addEventListener("click", async () => {
  const ev = currentEvent || {};
  const msg = [
    `🔔 IFWL ${PLATFORMS[getPlatform()]} reminder`,
    `Please mark your availability for: ${ev.title || "the next event"}`,
    `Link: ${window.location.href}`,
    ``,
    `✅ Yes / ❓ Maybe / ❌ No — add notes if you're late or can only do certain roles.`,
  ].join("\n");
  try { await navigator.clipboard.writeText(msg); } catch {}
  showStatus("✅ Nudge message copied.", "ok");
});

// Availability save (maps YES/MAYBE/NO into existing booleans + tags in notes)
els("saveAvailBtn").addEventListener("click", async () => {
  try {
    const p = String(els("myPracticeStatus").value || "YES");
    const e = String(els("myEventStatus").value || "YES");
    const notesTagged = encodeAvailNotes(els("myAvailNotes").value, p, e);

    const body = {
      practice: (p === "YES"),
      event: (e === "YES"),
      notes: notesTagged,
    };

    const r = await apiFetch(API.availUpsert, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await r.json();
    if (!data?.ok) throw new Error(data?.error || "Save failed");
    showStatus(`✅ Availability saved.`, "ok");
    await loadAvailability();
    setTab("availability");
  } catch (e) {
    showStatus(`❌ ${esc(e.message || e)}`, "bad");
  }
});
els("refreshAvailBtn").addEventListener("click", () => loadAvailability().catch(e => showStatus(`❌ ${esc(e.message||e)}`,"bad")));

// Stint claim
els("claimStintBtn").addEventListener("click", async () => {
  try {
    const stintId = String(els("stintIdInput").value || "").trim();
    const notes = String(els("stintNotesInput").value || "");
    const r = await apiFetch(API.stintUpsert, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ stintId, notes })
    });
    const data = await r.json();
    if (!data?.ok) throw new Error(data?.error || "Stint update failed");
    showStatus(`✅ Stint ${esc(stintId)} saved.`, "ok");
    await loadStints();
    setTab("stints");
  } catch (e) {
    showStatus(`❌ ${esc(e.message || e)}`, "bad");
  }
});
els("refreshStintsBtn").addEventListener("click", () => loadStints().catch(e => showStatus(`❌ ${esc(e.message||e)}`,"bad")));

// Copy final plan
els("copyFinalPlanBtn").addEventListener("click", async () => {
  const map = new Map();
  stintRows.forEach(s => map.set(String(s.stintId), s));

  const lines = [];
  lines.push(`🏁 IFWL ${PLATFORMS[getPlatform()]} Final Stint Plan`);
  if (currentEvent?.title) lines.push(`Event: ${currentEvent.title}`);
  if (currentEvent?.track) lines.push(`Track: ${currentEvent.track}`);
  lines.push("");

  for (let i=1; i<=MAX_STINTS_DEFAULT; i++) {
    const s = map.get(String(i));
    const claimed = !!s?.userId;
    const who = claimed ? (s.username || "—") : "UNCLAIMED";
    const note = String(s?.notes || "").trim();
    lines.push(`#${i} — ${who}${note ? ` — ${note}` : ""}`);
  }

  const text = lines.join("\n");
  try { await navigator.clipboard.writeText(text); } catch {}
  showStatus("✅ Final plan copied.", "ok");
});

// Setups refresh
els("refreshSetupsBtn").addEventListener("click", () => loadEvent().catch(e => showStatus(`❌ ${esc(e.message||e)}`,"bad")));

// Fuel calculator
els("calcFuelBtn").addEventListener("click", () => {
  const fpl = parseFloat(els("fuelPerLap").value || "0");
  const laps = parseInt(els("lapsCount").value || "0", 10);
  const extra = parseInt(els("extraLaps").value || "0", 10);
  const margin = parseFloat(els("marginPct").value || "0");

  if (!fpl || !laps) {
    els("fuelResult").innerHTML = "Enter at least fuel per lap and laps.";
    return;
  }
  const base = fpl * (laps + (isNaN(extra) ? 0 : extra));
  const withMargin = base * (1 + ((isNaN(margin) ? 0 : margin) / 100));
  const rounded = Math.ceil(withMargin * 10) / 10;

  els("fuelResult").innerHTML = `
    <div class="text-lg font-extrabold">Recommended Fuel</div>
    <div class="mt-2">
      Base: <b>${base.toFixed(2)} L</b><br/>
      With margin (${(isNaN(margin)?0:margin).toFixed(1)}%): <b>${withMargin.toFixed(2)} L</b><br/>
      Rounded up: <b class="text-emerald-700">${rounded.toFixed(1)} L</b>
    </div>
    <div class="muted text-xs mt-3">(Planning tool — validate in-game.)</div>
  `;
});

/** ===========================
 * Assessor form
 * =========================== */
function addSetupRow(val={label:"",url:"",notes:""}) {
  const wrap = document.createElement("div");
  wrap.className = "chip rounded-xl p-3";
  wrap.innerHTML = `
    <div class="grid md:grid-cols-3 gap-2">
      <input class="bg-transparent outline-none text-sm md:col-span-1 setupLabel" placeholder="Label (e.g. Safe)" value="${esc(val.label||"")}" />
      <input class="bg-transparent outline-none text-sm md:col-span-2 setupUrl" placeholder="URL" value="${esc(val.url||"")}" />
      <input class="bg-transparent outline-none text-sm md:col-span-3 setupNotes" placeholder="Notes (optional, add tags like #wet #race)" value="${esc(val.notes||"")}" />
    </div>
    <div class="mt-2 flex justify-end">
      <button class="px-3 py-2 rounded-xl btn2 text-xs removeSetupBtn">Remove</button>
    </div>
  `;
  wrap.querySelector(".removeSetupBtn").addEventListener("click", () => wrap.remove());
  els("setupFormList").appendChild(wrap);
}
els("addSetupBtn").addEventListener("click", () => addSetupRow());

els("loadEventToFormBtn").addEventListener("click", () => {
  const ev = currentEvent || {};
  els("evTitle").value = ev.title || "";
  els("evTrack").value = ev.track || "";
  els("evSimgrid").value = ev.simgridUrl || "";
  els("evCarName").value = ev.carName || "";
  els("evCarImg").value = ev.carImageUrl || "";
  els("evStartIso").value = ev.startsAtIso || "";
  els("evPit").value = ev.pitStrategy || "";

  const w = ev.weather || {};
  els("wCond").value = w.conditions || "";
  els("wAmb").value = (w.ambientC ?? "") === null ? "" : (w.ambientC ?? "");
  els("wTrack").value = (w.trackC ?? "") === null ? "" : (w.trackC ?? "");
  els("wNotes").value = w.notes || "";

  els("setupFormList").innerHTML = "";
  (Array.isArray(ev.setups) ? ev.setups : []).forEach(s => addSetupRow(s));
  if (!(Array.isArray(ev.setups) && ev.setups.length)) addSetupRow();

  showStatus("✅ Loaded current event into the form.", "ok");
});

els("saveEventBtn").addEventListener("click", async () => {
  try {
    const setups = [];
    document.querySelectorAll("#setupFormList > div").forEach(row => {
      const label = row.querySelector(".setupLabel")?.value || "";
      const url = row.querySelector(".setupUrl")?.value || "";
      const notes = row.querySelector(".setupNotes")?.value || "";
      if (label.trim() || url.trim() || notes.trim()) setups.push({ label, url, notes });
    });

    const body = {
      title: els("evTitle").value,
      track: els("evTrack").value,
      simgridUrl: els("evSimgrid").value,
      carName: els("evCarName").value,
      carImageUrl: els("evCarImg").value,
      startsAtIso: els("evStartIso").value,
      pitStrategy: els("evPit").value,
      weather: {
        conditions: els("wCond").value,
        ambientC: els("wAmb").value,
        trackC: els("wTrack").value,
        notes: els("wNotes").value
      },
      setups
    };

    const r = await apiFetch(API.eventSet, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body)
    });
    const data = await r.json();
    if (!data?.ok) throw new Error(data?.error || "Save failed (assessor only?)");

    showStatus("✅ Event saved.", "ok");
    await loadEvent();
    setTab("overview");
  } catch (e) {
    showStatus(`❌ ${esc(e.message || e)}`, "bad");
  }
});

els("assessorRefreshBtn").addEventListener("click", () => refreshAll().catch(e => showStatus(`❌ ${esc(e.message||e)}`,"bad")));

// Clear stints (assessor)
els("clearStintsBtn").addEventListener("click", async () => {
  try {
    const ok = confirm("Clear ALL stints? (This does not delete availability)");
    if (!ok) return;
    const r = await apiFetch(API.stintClear, { method: "POST" });
    const data = await r.json();
    if (!data?.ok) throw new Error(data?.error || "Clear failed");
    showStatus("✅ Stints cleared.", "ok");
    await loadStints();
    setTab("stints");
  } catch (e) {
    showStatus(`❌ ${esc(e.message || e)}`, "bad");
  }
});

/** ===========================
 * Misc
 * =========================== */
els("myAvailBtn").addEventListener("click", () => setTab("availability"));
els("myStintBtn").addEventListener("click", () => setTab("stints"));

/** ===========================
 * Init
 * =========================== */
(async function init() {
  // apply platform early
  setPlatform(getPlatform());

  els("backendHint").textContent = RT_GATE;

  // stint default view
  setStintView("board");

  // already logged in?
  const token = getSession();
  if (token) {
    els("sessionChip").textContent = "Session: Active";
    try {
      const u = JSON.parse(localStorage.getItem(K.user) || "{}");
      setUser(u);
      showApp();
      await refreshAll();
    } catch {
      clearAuth();
      showGate();
    }
  } else {
    els("sessionChip").textContent = "Session: None";
    showGate();
  }

  await handleCallback();
})();
</script>
</body>
</html>
