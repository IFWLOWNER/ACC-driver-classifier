<!DOCTYPE html>
<html lang="en">
<head>

  <style>
    @font-face {
      font-family: 'GoodTimesRG';
      src: url('GoodTimesRg.otf') format('opentype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    header, header nav ul li a {
      font-family: 'GoodTimesRG', serif;
      font-style: normal;
    }
  </style>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IFWL Ticket Submission Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #6200EE;
      width: 100%;
      padding: 12px 0;
      color: #fff;
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 24px;
      position: relative;
    }
    .logout-btn {
      background-color: transparent;
      border: 1px solid #fff;
      color: #fff;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      position: absolute;
      right: 16px;
      top: 12px;
    }

    .container {
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      box-shadow: 0 2px 14px rgba(0,0,0,0.14);
      padding: 24px;
      max-width: 800px;
      width: 100%;
      margin-bottom: 24px;
      backdrop-filter: blur(3px);
    }
    .section-title {
      margin-top: 0;
      text-align: center;
      color: #111;
      font-size: 1.2rem;
      margin-bottom: 12px;
      font-family: 'GoodTimesRG', serif;
      letter-spacing: 0.5px;
    }
    .subheading {
      text-align: center;
      margin-top: -6px;
      margin-bottom: 16px;
      color: #333;
      font-size: 14px;
      opacity: 0.9;
    }

    .form-group { margin-bottom: 16px; }
    label {
      display: block;
      margin-bottom: 6px;
      color: #555;
      font-weight: bold;
    }
    input[type="text"],
    input[type="url"],
    input[type="email"],
    input[type="password"],
    textarea,
    select {
      width: 100%;
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
      font-size: 14px;
      background: #fff;
    }
    textarea { resize: vertical; min-height: 80px; }
    button {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      background-color: #2A9D8F;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:disabled { background-color: #999; cursor: not-allowed; }
    .link-btn {
      background: none;
      border: none;
      color: #2A9D8F;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
      margin-top: 8px;
    }
    .status {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      text-align: center;
    }
    .status.error { color: #c00; }
    .status.success { color: #080; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th { background: #eee; }

    .hidden { display: none; }

    .appeal-highlight { background-color: #E84040; }
    .finalised-row { background-color: #A5FF7F; }

    .appeal-form {
      background: #fafafa;
      padding: 16px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-top: 8px;
      font-size: 0.95rem;
    }
    .appeal-form input[type="text"],
    .appeal-form textarea {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .appeal-form button { width: auto; margin-right: 8px; }

    .detailRow td { background-color: #eef7ff; padding: 0; }
    .detail-container { padding: 16px; font-size: 0.95rem; }
    .detail-container p { margin: 4px 0; }
    .detail-container a { color: #1a0dab; text-decoration: underline; }
    .detail-container hr { margin: 12px 0; border: none; border-top: 1px solid #ccc; }
    .detail-container .appeal-box {
      padding: 8px;
      border: 1px solid #f5e6a0;
      border-radius: 4px;
      background-color: #fffdf0;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #333;
    }
    .detail-container .appeal-box strong { color: #b36b00; }
    .detail-container .review-form {
      background: #eef7ff;
      padding: 12px;
      border: 1px solid #9ecfff;
      border-radius: 6px;
      margin-top: 12px;
    }
    .detail-container .review-form select,
    .detail-container .review-form textarea,
    .detail-container .review-form input[type="text"] {
      margin-top: 4px;
      margin-bottom: 12px;
    }
    .detail-container .review-form button { width: auto; margin-right: 8px; }

    .patreon-box{
      margin-top:24px;
      padding:16px;
      background:#fff7e6;
      border:2px solid #ff9c00;
      border-radius:8px;
      text-align:center;
      font-size:15px;
    }
    .patreon-box p{ margin:0; }
    .patreon-box strong{ color:#000; }
    .patreon-btn{
      display:inline-block;
      margin-top:10px;
      padding:10px 18px;
      font-size:16px;
      background-color:#ff424d;
      color:#fff;
      border-radius:6px;
      text-decoration:none;
      font-weight:bold;
      transition:background .2s ease-in-out;
    }
    .patreon-btn:hover{ background-color:#e53742; }

    .driver-picker { position: relative; }
    .driver-picker .picker-row { display: flex; gap: 10px; align-items: center; }
    .driver-picker .picker-actions { display: flex; gap: 8px; margin-top: 8px; }
    .driver-picker .mini-btn {
      width: auto;
      padding: 8px 10px;
      font-size: 13px;
      border-radius: 8px;
      background: #2A9D8F;
    }
    .driver-picker .mini-btn.secondary { background: #666; }
    .driver-picker .results {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 8px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
      max-height: 260px;
      overflow: auto;
      z-index: 50;
      padding: 6px;
    }
    .driver-picker .result-item {
      padding: 10px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
    }
    .driver-picker .result-item:hover { background: #f2f2f2; }
    .driver-picker .result-meta { font-size: 12px; color: #666; white-space: nowrap; }
    .driver-picker .no-results { padding: 10px; color: #444; font-size: 14px; }
    .hidden-select { display: none !important; }

    /* ============================
       NEW: Discord login screen UI
       ============================ */
    .portal-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      margin-bottom: 18px;
    }
    .portal-hero img {
      height: 74px;
      max-width: 90%;
      object-fit: contain;
      filter: drop-shadow(0 6px 14px rgba(0,0,0,0.18));
    }
    .discord-card {
      border: 1px solid rgba(0,0,0,0.1);
      background: rgba(255,255,255,0.9);
      border-radius: 12px;
      padding: 16px;
    }
    .discord-btn {
      background: #5865F2;
      border-radius: 10px;
      font-weight: 700;
      letter-spacing: 0.2px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .discord-btn:hover { filter: brightness(0.98); }
    .discord-btn svg { width: 20px; height: 20px; }
    .user-pill {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(42, 157, 143, 0.12);
      border: 1px solid rgba(42, 157, 143, 0.35);
      font-size: 13px;
      color: #0b3f39;
      margin: 10px auto 0;
      justify-content: center;
      width: fit-content;
      max-width: 100%;
      text-align: center;
      flex-wrap: wrap;
    }
    .small-note {
      font-size: 12px;
      opacity: 0.9;
      margin-top: 10px;
      line-height: 1.35;
    }
    .divider {
      height: 1px;
      background: rgba(0,0,0,0.12);
      margin: 14px 0;
    }
  </style>

  <!-- jsPDF UMD build for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>

<body style="margin:0;font-family:sans-serif;background:url('ifwl_bg.webp') no-repeat center top;background-size:cover;">

<header style="background-color:#2A9D8F; padding:16px 0;">
  <div style="max-width:1100px; margin:0 auto; display:flex; align-items:center; justify-content:center;">
    <a href="https://ifwl.net/">
      <img src="ifwlheaderlogo.webp" alt="IFWL" style="height:48px;">
    </a>
    <nav>
      <ul style="list-style:none; margin:0; padding:0; display:flex; gap:24px; white-space:nowrap; justify-content:center;">
        <li><a href="https://ifwl.net/" style="color:#FFF; text-decoration:none;">Home</a></li>
        <li><a href="https://ifwl.net/events" style="color:#FFF; text-decoration:none;">Races</a></li>
        <li><a href="https://ifwl.net/events/competitions/standings" style="color:#FFF; text-decoration:none;">Standings</a></li>
        <li><a href="https://ifwl.net/grid" style="color:#FFF; text-decoration:none;">Grid</a></li>
        <li><a href="https://ifwl.net/paddock/safety-car" style="color:#FFF; text-decoration:none;">Paddock</a></li>
        <li><a href="https://ifwl.net/merchandise" style="color:#FFF; text-decoration:none;">Merch</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/" style="color:#FFF; text-decoration:none;">Classifier</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/ifwl_live_stewarding.html" style="color:#FFF; text-decoration:none;">Live Stewarding Page</a></li>
        <li><a href="https://ifwlowner.github.io/ACC-driver-classifier/stewarding_codes.html" style="color:#FFF; text-decoration:none;">Stewarding Codes Explained</a></li>
      </ul>
    </nav>
  </div>
</header>

<!-- NEW: Discord user + logout (public session) -->
<div id="publicUserBar" style="margin:12px; width:100%; max-width:800px; display:flex; justify-content:space-between; align-items:center; gap:10px;" class="hidden">
  <div id="publicUserPill" class="user-pill" style="margin:0;"></div>
  <button id="discordLogoutBtn" style="width:auto; padding:10px 12px; font-size:14px; border-radius:10px; background:#333;">Logout</button>
</div>

<!-- Existing admin logout button kept (for Firebase admin auth) -->
<div style="text-align:right; margin:12px; width:100%; max-width:800px;">
  <button id="logoutBtn" style="padding:6px 12px; font-size:14px; cursor:pointer;">Logout (Admin)</button>
</div>

<!-- ==============================================================
     NEW: DISCORD LOGIN SECTION (GATE TO PORTAL)
     ============================================================== -->
<div id="discordLoginSection" class="container hidden">
  <div class="portal-hero">
    <img src="ifwl_logo.png" alt="IFWL Logo">
    <div class="section-title" style="margin-bottom:0;">IFWL Ticket Submission Portal</div>
    <div class="subheading">Login with Discord to submit tickets and statements.</div>
  </div>

  <div class="discord-card">
    <button id="discordLoginBtn" class="discord-btn">
      <!-- Discord icon -->
      <svg viewBox="0 0 127.14 96.36" aria-hidden="true" focusable="false">
        <path fill="#fff" d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21a105.73,105.73,0,0,0,32.17,16.15,77.7,77.7,0,0,0,6.89-11.11,68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2A75.57,75.57,0,0,0,95.73,78c.87.71,1.77,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1,105.25,105.25,0,0,0,32.19-16.14C129.24,52.84,122.06,29.11,107.7,8.07ZM42.45,65.69c-6.05,0-11-5.55-11-12.38s4.86-12.39,11-12.39S53.47,46.5,53.39,53.31,48.52,65.69,42.45,65.69Zm42.24,0c-6.05,0-11-5.55-11-12.38s4.86-12.39,11-12.39S95.7,46.5,95.62,53.31,90.76,65.69,84.69,65.69Z"/>
      </svg>
      Login with Discord
    </button>

    <div class="small-note">
      <strong>Nickname format required:</strong> <code>[drivernumber] - driver name</code><br>
      Example: <code>[18] - Smokey BH92</code><br>
      If your nickname isn‚Äôt set correctly in the IFWL Discord, you‚Äôll be asked to update it before submitting.
    </div>

    <div class="divider"></div>

    <div id="discordLoginStatus" class="status"></div>

    <!-- Fallback/testing helper (remove if you don‚Äôt want it visible) -->
    <button id="devMockLoginBtn" class="link-btn" style="width:100%; margin-top:10px;">
      (Dev) Mock login locally
    </button>
  </div>
</div>

<!-- ==============================================================
     MENU SECTION (landing view)
     ============================================================== -->
<div id="menuSection" class="container hidden">
  <h2 class="section-title">Ticketing</h2>
  <div class="subheading" id="welcomeLine"></div>

  <div class="form-group">
    <button id="menuViewBtn">Submit a statement to a ticket here</button>
  </div>

  <div class="form-group">
    <button id="menuSubmitBtn">Submit Ticket</button>
  </div>
</div>

<!-- ==============================================================
     SECTION 1: SUBMIT A NEW TICKET (REQUIRES DISCORD LOGIN)
     ============================================================== -->
<div id="submitSection" class="container hidden">
  <h2 class="section-title">Submit a New Ticket</h2>

  <div id="reportingAsBox" class="status" style="margin-bottom:12px; margin-top:0;">
    <!-- populated by JS after discord login -->
  </div>

  <div class="status" style="margin-bottom:16px;">
    <strong>Important:</strong> Ticket submissions are final. Once submitted, a ticket
    <strong>cannot be withdrawn or edited</strong>. Please review carefully before submitting.
  </div>

  <!-- Accused (Driver) SEARCH PICKER -->
  <div class="form-group">
    <label for="accusedSearch">Accused (Driver) <span style="color: red;">*</span></label>

    <div class="driver-picker" id="accusedPicker">
      <div class="picker-row">
        <input type="text" id="accusedSearch" placeholder="Search by number or name (e.g. 18 or Smokey)..." autocomplete="off" />
      </div>
      <div id="accusedResults" class="results hidden"></div>

      <div class="picker-actions">
        <button type="button" id="accusedManualBtn" class="mini-btn secondary">Can‚Äôt find driver? Add manually</button>
        <button type="button" id="accusedClearBtn" class="mini-btn">Clear</button>
      </div>
    </div>

    <select id="accusedSelect" class="hidden-select">
      <option value="" disabled selected>Select a driver‚Ä¶</option>
    </select>
  </div>

  <div id="newDriverContainer" class="form-group hidden">
    <label><strong>Add New Driver</strong></label>
    <input type="text" id="newDriverNumber" placeholder="Driver number (optional) e.g. 18" />
    <input type="text" id="newDriverInput" placeholder="Driver name e.g. Smokey BH92" />
    <div class="status" style="margin-top:6px; font-size:12px; color:#666; text-align:left;">
      Tip: saved format will be <strong>[number] - name</strong> (and still works with old driver records).
    </div>
  </div>

  <!-- REMOVED: Driver Reporting picker (now taken from Discord login) -->
  <div class="form-group hidden">
    <label>Driver Reporting (Discord)</label>
    <input type="text" id="reporterLocked" disabled />
  </div>

  <!-- Competition Dropdown (hard-coded) -->
  <div class="form-group">
    <label for="competitionSelect">Competition <span style="color: red;">*</span></label>
    <select id="competitionSelect">
      <option value="" disabled selected>Select a competition‚Ä¶</option>
      <option value="SEASON 1 - AC EVO - BMW M2 CUP SERIES">SEASON 1 - AC EVO - BMW M2 CUP SERIES</option>
      <option value="SEASON 1 - RACEROOM - SERIES">SEASON 1 - RACEROOM - SERIES</option>
      <option value="SEASON 1 - PMR SERIES">SEASON 1 - PMR SERIES</option>

      <option value="SEASON 1 - ACC PC - BEGINNERS">SEASON 1 - ACC PC - BEGINNERS</option>
      <option value="SEASON 1 - ACC PC - OPEN TRACK">SEASON 1 - ACC PC - OPEN TRACK</option>
      <option value="SEASON 1 - ACC PC - PRO AM SERIES">SEASON 1 - ACC PC - PRO AM SERIES</option>

      <option value="SEASON 1 - ACC CONSOLE - OPEN TRACK">SEASON 1 - ACC CONSOLE - OPEN TRACK</option>
      <option value="SEASON 1 - ACC CONSOLE - FRIDAY FINESSE">SEASON 1 - ACC CONSOLE - FRIDAY FINESSE</option>
      <option value="SEASON 1 - ACC CONSOLE - MAX MINI ENDURO">SEASON 1 - ACC CONSOLE - MAX MINI ENDURO</option>

      <option value="SEASON 1 - ACC TEAM ENDURO">SEASON 1 - ACC TEAM ENDURO</option>
      <option value="SEASON 1 - ACC SOLO ENDURO">SEASON 1 - ACC SOLO ENDURO</option>
    </select>
  </div>

  <div class="form-group">
    <label for="fullIncident">Full Incident Summary <span style="color: red;">*</span></label>
    <textarea id="fullIncident" placeholder="Describe the incident in detail‚Ä¶" required></textarea>
  </div>

  <div class="form-group">
    <label for="eventSelect">Event</label>
    <select id="eventSelect">
      <option value="Practice">Practice</option>
      <option value="Qualifying">Qualifying</option>
      <option value="Race 1">Race 1</option>
      <option value="Race 2">Race 2</option>
      <option value="Race 3">Race 3</option>
    </select>
  </div>

  <div class="form-group">
    <label for="proofUrl">Proof URL (if any)</label>
    <input type="url" id="proofUrl" placeholder="any video or image hosting site such as youtube/google drive/imgur" />
  </div>

  <div class="form-group">
    <label for="seasonSelect">Season</label>
    <select id="seasonSelect">
      <option value="Test Season">Test Season</option>
      <option value="Season 1">Season 1</option>
      <option value="Season 2">Season 2</option>
      <option value="Season 3">Season 3</option>
      <option value="Season 4">Season 4</option>
    </select>
  </div>

  <div class="form-group">
    <label for="trackSelect">Track</label>
    <select id="trackSelect">
      <option value="" disabled selected>Select a track‚Ä¶</option>
    </select>
  </div>
  <div id="newTrackContainer" class="form-group hidden">
    <label for="newTrackInput"><strong>Add New Track</strong></label>
    <input type="text" id="newTrackInput" placeholder="Type new track name‚Ä¶" />
  </div>

  <div class="form-group">
    <label for="ruleBreachSelect">Rule Breach</label>
    <select id="ruleBreachSelect">
      <option value="" disabled selected>Select a regulation‚Ä¶</option>
    </select>
  </div>

  <button id="submitBtn">Submit Ticket</button>
  <div class="status" id="statusMsg"></div>

  <button id="viewTicketsBtn" class="link-btn hidden">View All Tickets</button>
  <button id="loginToggleBtn" class="link-btn hidden">Admin Login</button>
</div>

<!-- ==============================================================
     SECTION 2: VIEW ALL TICKETS (PUBLIC) - left intact
     ============================================================== -->
<div id="viewSection" class="container hidden">
  <h2 class="section-title">All Submitted Tickets</h2>
  <div id="ticketsListContainer"></div>
  <button id="backFromViewBtn" class="link-btn">‚Üê Back to Menu</button>
</div>

<!-- ==============================================================
     SECTION 3: ADMIN LOGIN FORM (unchanged)
     ============================================================== -->
<div id="loginSection" class="container hidden">
  <h2 class="section-title">Admin Sign-In</h2>
  <div class="form-group">
    <label for="email">Email <span style="color: red;">*</span></label>
    <input type="email" id="email" placeholder="admin@example.com" required />
  </div>
  <div class="form-group">
    <label for="password">Password <span style="color: red;">*</span></label>
    <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required />
  </div>
  <button id="loginBtn">Login</button>
  <div class="status" id="loginStatusMsg"></div>
  <button id="backFromLoginBtn" class="link-btn">‚Üê Back to Menu</button>
</div>

<!-- ==============================================================
     SECTION 4: ADMIN DASHBOARD (unchanged)
     ============================================================== -->
<div id="adminSection" class="container hidden" style="max-width: 1100px; padding:24px;">
  <h2 class="section-title">Admin Dashboard</h2>
  <button id="overviewAdminBtn" style="margin-bottom:12px; padding:8px 16px; background-color:#444; color:#fff; border:none; border-radius:4px; cursor:pointer;">Generate Overview PDF</button>
  <div id="adminTicketsContainer" style="overflow-x:auto;"></div>
</div>

<!-- Patreon template -->
<template id="patreonCallout">
  <div class="patreon-box">
    <p>
      <strong>IFWL costs over ¬£200 a month to run.</strong><br>
      If you wish to help towards our costs, you can join today to become a
      <strong>Patreon member</strong> ‚Äì this gains you access to many perks!
    </p>
    <a href="https://www.patreon.com/c/IFWL" target="_blank" rel="noopener" class="patreon-btn">
      üíô Support IFWL on Patreon
    </a>
  </div>
</template>

<script type="module">
  // Firebase imports
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    getDocs,
    getDoc,
    query,
    where,
    orderBy,
    serverTimestamp,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

  // ============================
  // DISCORD LOGIN CONFIG (EDIT)
  // ============================
  // You need SOME backend/service that returns the Discord guild nickname.
  // After successful login, it should redirect back to THIS page with:
  //   ?discord=1&nick=...&id=...&username=...
  //
  // Example:
  //   https://your-worker.yourdomain.com/discord/login?redirect=https://yourpage.com/ifwl_tickets.html
  //
  // Replace this with your actual Discord auth start URL:
  const DISCORD_LOGIN_START_URL = "https://YOUR-DISCORD-AUTH-SERVICE/login?redirect=" + encodeURIComponent(window.location.href.split("?")[0]);

  // If you *require* the guild nickname format:
  const REQUIRE_NICK_FORMAT = true;
  const NICK_REGEX = /^\[\d+\]\s*-\s*.+$/; // [18] - Smokey BH92

  // ============================
  // Firebase config
  // ============================
  const firebaseConfig = {
    apiKey: "AIzaSyDw7lK1obLfMziXFr7gJr5R5huFGjfVcc8",
    authDomain: "ifwl-591d8.firebaseapp.com",
    projectId: "ifwl-591d8",
    storageBucket: "ifwl-591d8.firebasestorage.app",
    messagingSenderId: "703021152109",
    appId: "1:703021152109:web:18e2f6a73e0521e4850c64",
    measurementId: "G-974R4YE6L5"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  // Sections
  const discordLoginSection = document.getElementById("discordLoginSection");
  const menuSection         = document.getElementById("menuSection");
  const submitSection       = document.getElementById("submitSection");
  const viewSection         = document.getElementById("viewSection");
  const loginSection        = document.getElementById("loginSection");
  const adminSection        = document.getElementById("adminSection");

  // Public user bar
  const publicUserBar       = document.getElementById("publicUserBar");
  const publicUserPill      = document.getElementById("publicUserPill");
  const discordLogoutBtn    = document.getElementById("discordLogoutBtn");

  // Login UI
  const discordLoginBtn     = document.getElementById("discordLoginBtn");
  const discordLoginStatus  = document.getElementById("discordLoginStatus");
  const devMockLoginBtn     = document.getElementById("devMockLoginBtn");

  // Menu buttons
  const menuViewBtn   = document.getElementById("menuViewBtn");
  const menuSubmitBtn = document.getElementById("menuSubmitBtn");

  // Submit elements
  const accusedSelect      = document.getElementById("accusedSelect");
  const newDriverContainer = document.getElementById("newDriverContainer");
  const newDriverInput     = document.getElementById("newDriverInput");
  const newDriverNumber    = document.getElementById("newDriverNumber");

  // Reporter (locked from Discord)
  const reporterLocked     = document.getElementById("reporterLocked");
  const reportingAsBox     = document.getElementById("reportingAsBox");
  const welcomeLine        = document.getElementById("welcomeLine");

  const competitionSelect  = document.getElementById("competitionSelect");
  const fullIncident       = document.getElementById("fullIncident");
  const eventSelect        = document.getElementById("eventSelect");
  const proofUrlInput      = document.getElementById("proofUrl");
  const seasonSelect       = document.getElementById("seasonSelect");
  const trackSelect        = document.getElementById("trackSelect");
  const newTrackContainer  = document.getElementById("newTrackContainer");
  const newTrackInput      = document.getElementById("newTrackInput");
  const ruleBreachSelect   = document.getElementById("ruleBreachSelect");
  const submitBtn          = document.getElementById("submitBtn");
  const statusMsg          = document.getElementById("statusMsg");

  // Public view section
  const backFromViewBtn      = document.getElementById("backFromViewBtn");
  const ticketsListContainer = document.getElementById("ticketsListContainer");

  // Admin auth elements (unchanged)
  const loginBtn         = document.getElementById("loginBtn");
  const backFromLoginBtn = document.getElementById("backFromLoginBtn");
  const emailInput       = document.getElementById("email");
  const passwordInput    = document.getElementById("password");
  const loginStatusMsg   = document.getElementById("loginStatusMsg");
  const logoutBtn        = document.getElementById("logoutBtn");
  const adminTicketsContainer = document.getElementById("adminTicketsContainer");
  const overviewAdminBtn = document.getElementById("overviewAdminBtn");

  // Patreon template
  const patreonTpl = document.getElementById("patreonCallout");

  const OPEN_STATEMENTS_URL = "https://ifwlowner.github.io/ACC-driver-classifier/openstatements.html";

  function safeStr(v){ return (typeof v === "string" ? v : "").trim(); }

  // ============================
  // Discord session helpers
  // ============================
  const LS_KEY = "ifwl_discord_user";

  function setDiscordUser(userObj){
    localStorage.setItem(LS_KEY, JSON.stringify(userObj));
  }

  function getDiscordUser(){
    try {
      const raw = localStorage.getItem(LS_KEY);
      return raw ? JSON.parse(raw) : null;
    } catch {
      return null;
    }
  }

  function clearDiscordUser(){
    localStorage.removeItem(LS_KEY);
  }

  function validateNick(nick){
    if (!REQUIRE_NICK_FORMAT) return true;
    return NICK_REGEX.test(safeStr(nick));
  }

  function renderDiscordUserUI(){
    const u = getDiscordUser();
    if (!u) {
      publicUserBar.classList.add("hidden");
      return;
    }
    publicUserBar.classList.remove("hidden");
    const nick = safeStr(u.nick);
    publicUserPill.textContent = nick ? `Logged in as: ${nick}` : `Logged in (Discord)`;
    if (reporterLocked) reporterLocked.value = nick || "";

    if (welcomeLine) {
      welcomeLine.textContent = nick ? `Welcome, ${nick}` : "Welcome";
    }
    if (reportingAsBox) {
      reportingAsBox.innerHTML = nick
        ? `<strong>Reporting as:</strong> ${nick}`
        : `<strong>Reporting as:</strong> (Discord logged in)`;
    }
  }

  // ============================
  // Section control (now includes Discord login)
  // ============================
  function showSection(sectionToShow) {
    [discordLoginSection, menuSection, submitSection, viewSection, loginSection, adminSection].forEach(sec => {
      sec.classList.add("hidden");
    });
    sectionToShow.classList.remove("hidden");
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function requireDiscordOrShowLogin(){
    const u = getDiscordUser();
    if (!u) {
      showSection(discordLoginSection);
      return false;
    }
    if (!validateNick(u.nick)) {
      showSection(discordLoginSection);
      discordLoginStatus.textContent = "Your IFWL Discord server nickname must be set to: [drivernumber] - driver name (e.g. [18] - Smokey BH92). Please update your nickname and log in again.";
      discordLoginStatus.className = "status error";
      return false;
    }
    return true;
  }

  // Add Patreon callout to every section
  function addPatreonCallout(sectionEl){
    if (!sectionEl || !patreonTpl) return;
    const node = patreonTpl.content.firstElementChild.cloneNode(true);
    sectionEl.appendChild(node);
  }
  [discordLoginSection, menuSection, submitSection, viewSection, loginSection, adminSection].forEach(addPatreonCallout);

  // ============================
  // Discord login flow
  // ============================
  function parseDiscordCallbackParams(){
    const url = new URL(window.location.href);
    // expected: ?discord=1&nick=...&id=...&username=...
    if (url.searchParams.get("discord") !== "1") return null;

    const nick = url.searchParams.get("nick") || "";
    const id   = url.searchParams.get("id") || "";
    const username = url.searchParams.get("username") || "";
    const global = url.searchParams.get("global") || "";

    // clean URL (remove params) after capture
    url.searchParams.delete("discord");
    url.searchParams.delete("nick");
    url.searchParams.delete("id");
    url.searchParams.delete("username");
    url.searchParams.delete("global");
    window.history.replaceState({}, document.title, url.toString());

    return { nick, id, username, global, loggedInAt: Date.now() };
  }

  discordLoginBtn.addEventListener("click", () => {
    // Start your Discord OAuth flow
    window.location.href = DISCORD_LOGIN_START_URL;
  });

  // Optional dev mock (safe to remove)
  devMockLoginBtn.addEventListener("click", () => {
    const mock = { nick: "[18] - Smokey BH92", id: "1234567890", username: "MockUser", global: "MockUser", loggedInAt: Date.now() };
    setDiscordUser(mock);
    renderDiscordUserUI();
    showSection(menuSection);
  });

  discordLogoutBtn.addEventListener("click", () => {
    clearDiscordUser();
    renderDiscordUserUI();
    showSection(discordLoginSection);
  });

  // ============================
  // Driver picker + cache (Accused only)
  // ============================
  let DRIVERS_CACHE = [];

  function extractNumbers(text){
    const nums = String(text || "").match(/\d+/g);
    return nums ? nums.join("") : "";
  }

  function normalizeSearchText(driver){
    const full = safeStr(driver.fullName || "");
    const name = safeStr(driver.name || "");
    const number = safeStr(driver.number || "");
    const numericFromFull = extractNumbers(full);
    const combined = `${full} ${name} ${number} ${numericFromFull}`.toLowerCase();
    return combined.replace(/\s+/g, " ").trim();
  }

  function buildFullNameFromParts(number, name){
    const n = safeStr(number);
    const nm = safeStr(name);
    if (!nm) return "";
    if (n) return `[${n}] - ${nm}`;
    return nm;
  }

  async function loadDriversCache(){
    const snapshot = await getDocs(collection(db, "drivers"));
    const list = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data() || {};
      const fullName = safeStr(data.fullName);
      if (!fullName) return;
      list.push({
        docId: docSnap.id,
        fullName,
        name: safeStr(data.name),
        number: safeStr(data.number),
        searchText: ""
      });
    });
    list.forEach(d => d.searchText = normalizeSearchText(d));
    list.sort((a,b) => a.fullName.localeCompare(b.fullName));
    DRIVERS_CACHE = list;
  }

  function populateHiddenSelect(selectEl, placeholderText){
    selectEl.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = placeholderText;
    placeholder.disabled = true;
    placeholder.selected = true;
    selectEl.appendChild(placeholder);

    DRIVERS_CACHE.forEach(d => {
      const opt = document.createElement("option");
      opt.value = d.fullName;
      opt.textContent = d.fullName;
      selectEl.appendChild(opt);
    });

    const newOpt = document.createElement("option");
    newOpt.value = "__ADD_NEW__";
    newOpt.textContent = "‚ûï Add New Driver‚Ä¶";
    selectEl.appendChild(newOpt);
  }

  function closeResults(resultsEl){
    resultsEl.classList.add("hidden");
    resultsEl.innerHTML = "";
  }
  function openResults(resultsEl){ resultsEl.classList.remove("hidden"); }

  function filterDrivers(queryText){
    const q = safeStr(queryText).toLowerCase();
    if (!q) return [];
    return DRIVERS_CACHE.filter(d => d.searchText.includes(q));
  }

  function setupDriverPicker(opts){
    const {
      searchInput,
      resultsEl,
      hiddenSelect,
      manualBtn,
      clearBtn,
      manualContainer,
      manualNameInput,
      manualNumberInput,
      placeholderText
    } = opts;

    populateHiddenSelect(hiddenSelect, placeholderText);

    function pickDriver(fullName){
      hiddenSelect.value = fullName || "";
      searchInput.value = fullName || "";
      manualContainer.classList.add("hidden");
      manualNameInput.value = "";
      manualNumberInput.value = "";
      closeResults(resultsEl);
    }

    function showManual(prefillQuery){
      hiddenSelect.value = "__ADD_NEW__";
      const q = safeStr(prefillQuery);
      if (q && /^\d+$/.test(q)) {
        manualNumberInput.value = q;
        manualNameInput.value = "";
      } else {
        manualNameInput.value = q;
      }
      manualContainer.classList.remove("hidden");
      closeResults(resultsEl);
      setTimeout(() => manualNameInput.focus(), 50);
    }

    searchInput.addEventListener("input", () => {
      const q = safeStr(searchInput.value);
      if (!q) {
        hiddenSelect.value = "";
        closeResults(resultsEl);
        return;
      }
      const matches = filterDrivers(q).slice(0, 30);
      resultsEl.innerHTML = "";

      if (matches.length === 0) {
        openResults(resultsEl);
        const noDiv = document.createElement("div");
        noDiv.className = "no-results";
        noDiv.innerHTML = `
          <div><strong>No results</strong> for "<span style="color:#000">${q.replace(/</g,"&lt;")}</span>"</div>
          <div style="margin-top:8px;">
            <button type="button" style="width:auto; padding:8px 10px; font-size:13px; background:#2A9D8F; border-radius:8px;">
              ‚ûï Add this driver
            </button>
          </div>
        `;
        resultsEl.appendChild(noDiv);
        const btn = noDiv.querySelector("button");
        btn.addEventListener("click", () => showManual(q));
        return;
      }

      openResults(resultsEl);
      matches.forEach(d => {
        const item = document.createElement("div");
        item.className = "result-item";
        item.innerHTML = `
          <div>${d.fullName.replace(/</g,"&lt;")}</div>
          <div class="result-meta">${d.number ? "#" + d.number : ""}</div>
        `;
        item.addEventListener("click", () => pickDriver(d.fullName));
        resultsEl.appendChild(item);
      });
    });

    document.addEventListener("click", (e) => {
      const pickerRoot = searchInput.closest(".driver-picker");
      if (!pickerRoot) return;
      if (!pickerRoot.contains(e.target)) closeResults(resultsEl);
    });

    searchInput.addEventListener("keydown", (e) => {
      if (e.key !== "Enter") return;
      e.preventDefault();
      const q = safeStr(searchInput.value);
      if (!q) return;
      const matches = filterDrivers(q);
      if (matches.length === 1) {
        hiddenSelect.value = matches[0].fullName;
        searchInput.value = matches[0].fullName;
        closeResults(resultsEl);
        manualContainer.classList.add("hidden");
      } else if (matches.length === 0) {
        showManual(q);
      }
    });

    manualBtn.addEventListener("click", () => showManual(searchInput.value));
    clearBtn.addEventListener("click", () => {
      searchInput.value = "";
      hiddenSelect.value = "";
      manualContainer.classList.add("hidden");
      manualNameInput.value = "";
      manualNumberInput.value = "";
      closeResults(resultsEl);
    });

    hiddenSelect.addEventListener("change", () => {
      if (hiddenSelect.value === "__ADD_NEW__") showManual(searchInput.value);
      else pickDriver(hiddenSelect.value);
    });

    return { pickDriver, showManual };
  }

  // Tracks dropdown (unchanged)
  async function populateTrackDropdown() {
    const snapshot = await getDocs(collection(db, "tracks"));
    const seen = new Set();
    const names = [];

    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!data.name || typeof data.name !== "string") return;
      const clean = data.name.trim();
      if (!clean) return;
      const key = clean.toLowerCase();
      if (seen.has(key)) return;
      seen.add(key);
      names.push(clean);
    });

    names.sort((a,b) => a.localeCompare(b));

    trackSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Select a track‚Ä¶";
    placeholder.disabled = true;
    placeholder.selected = true;
    trackSelect.appendChild(placeholder);

    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      trackSelect.appendChild(opt);
    });

    const newOpt = document.createElement("option");
    newOpt.value = "__ADD_NEW__";
    newOpt.textContent = "‚ûï Add New Track‚Ä¶";
    trackSelect.appendChild(newOpt);

    trackSelect.addEventListener("change", () => {
      if (trackSelect.value === "__ADD_NEW__") newTrackContainer.classList.remove("hidden");
      else newTrackContainer.classList.add("hidden");
    });
  }

  // Regulations dropdown (unchanged)
  async function populateRegulationsDropdown() {
    const snapshot = await getDocs(collection(db, "regulations"));
    const names = [];
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (data.name && typeof data.name === "string") names.push(data.name);
    });
    names.sort((a,b) => a.localeCompare(b));

    ruleBreachSelect.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Select a regulation‚Ä¶";
    placeholder.disabled = true;
    placeholder.selected = true;
    ruleBreachSelect.appendChild(placeholder);

    names.forEach(name => {
      const opt = document.createElement("option");
      opt.value = name;
      opt.textContent = name;
      ruleBreachSelect.appendChild(opt);
    });
  }

  // ============================
  // Menu navigation (GATED)
  // ============================
  menuViewBtn.addEventListener("click", () => {
    if (!requireDiscordOrShowLogin()) return;
    window.location.href = OPEN_STATEMENTS_URL;
  });

  menuSubmitBtn.addEventListener("click", () => {
    if (!requireDiscordOrShowLogin()) return;
    showSection(submitSection);
  });

  backFromViewBtn.addEventListener("click", () => showSection(menuSection));
  backFromLoginBtn.addEventListener("click", () => showSection(menuSection));

  // ============================
  // SUBMIT TICKET (reporter = Discord nick)
  // ============================
  submitBtn.addEventListener("click", async () => {
    const discordUser = getDiscordUser();
    if (!discordUser) {
      statusMsg.textContent = "You must log in with Discord before submitting a ticket.";
      statusMsg.className = "status error";
      showSection(discordLoginSection);
      return;
    }
    if (!validateNick(discordUser.nick)) {
      statusMsg.textContent = "Your IFWL Discord nickname must be: [drivernumber] - driver name. Please update it and log in again.";
      statusMsg.className = "status error";
      showSection(discordLoginSection);
      return;
    }

    submitBtn.disabled = true;
    statusMsg.textContent = "Submitting‚Ä¶";
    statusMsg.className = "status";

    let accused = accusedSelect.value;
    const accusedNameManual = safeStr(newDriverInput.value);
    const accusedNumberManual = safeStr(newDriverNumber.value);

    const reporter = safeStr(discordUser.nick); // <<<<<<<<<<<<<<<< HERE
    const competition = competitionSelect.value;

    if (!competition) {
      statusMsg.textContent = "Please select a competition.";
      statusMsg.className = "status error";
      submitBtn.disabled = false;
      return;
    }

    const summary = safeStr(fullIncident.value);
    const eventVal = eventSelect.value;
    const proofUrl = safeStr(proofUrlInput.value);
    const season = seasonSelect.value;

    let track = trackSelect.value;
    const newTrackName = safeStr(newTrackInput.value);

    const ruleBreach = ruleBreachSelect.value;

    const accusedValid = (accused && accused !== "__ADD_NEW__") || (accused === "__ADD_NEW__" && accusedNameManual);
    if (!accusedValid || !summary) {
      statusMsg.textContent = "Please fill in all required fields: Accused, Competition, Full Incident Summary.";
      statusMsg.className = "status error";
      submitBtn.disabled = false;
      return;
    }

    // If accused is manual, add to Firestore
    if (accused === "__ADD_NEW__") {
      const fullNameBuilt = buildFullNameFromParts(accusedNumberManual, accusedNameManual);
      accused = fullNameBuilt;

      try {
        await addDoc(collection(db, "drivers"), {
          fullName: fullNameBuilt,
          name: accusedNameManual,
          number: accusedNumberManual,
          key: `${(accusedNumberManual || "").trim()}|${(accusedNameManual || "").trim()}`.toLowerCase()
        });
        await loadDriversCache();
        populateHiddenSelect(accusedSelect, "Select a driver‚Ä¶");
      } catch (err) {
        console.error("Error adding new driver:", err);
      }
    }

    // If new track chosen, add de-duped
    if (track === "__ADD_NEW__") {
      track = newTrackName;
      try {
        const cleanName = (newTrackName || "").trim();
        const key = cleanName.toLowerCase();
        if (cleanName) {
          let exists = false;
          try {
            const byKeySnap = await getDocs(query(collection(db, "tracks"), where("key", "==", key)));
            if (!byKeySnap.empty) exists = true;
          } catch {}
          if (!exists) {
            try {
              const byNameSnap = await getDocs(query(collection(db, "tracks"), where("name", "==", cleanName)));
              if (!byNameSnap.empty) exists = true;
            } catch {}
          }
          if (!exists) {
            await addDoc(collection(db, "tracks"), { name: cleanName, key });
            await populateTrackDropdown();
          }
        }
      } catch (err) {
        console.error("Error adding new track:", err);
      }
    }

    const newTicket = {
      accused,
      reporter, // discord nick
      reporterDiscordId: safeStr(discordUser.id || ""),
      reporterDiscordUsername: safeStr(discordUser.username || ""),
      reporterDiscordGlobal: safeStr(discordUser.global || ""),
      competition,
      fullIncident: summary,
      event: eventVal,
      proofUrl,
      season,
      track,
      ruleBreach,
      status: "New Submission",
      stewardDecision: "",
      stewardTag: "",
      timestamp: serverTimestamp()
    };

    try {
      const docRef = await addDoc(collection(db, "tickets"), newTicket);
      statusMsg.textContent = `Ticket submitted (ID: ${docRef.id}). Thank you!`;
      statusMsg.className = "status success";

      // Clear accused UI
      document.getElementById("accusedSearch").value = "";
      accusedSelect.value = "";
      newDriverContainer.classList.add("hidden");
      newDriverInput.value = "";
      newDriverNumber.value = "";
      document.getElementById("accusedResults").classList.add("hidden");
      document.getElementById("accusedResults").innerHTML = "";

      // Clear rest
      fullIncident.value = "";
      eventSelect.value = "Practice";
      proofUrlInput.value = "";
      seasonSelect.value = "Season 1";
      trackSelect.value = "";
      newTrackContainer.classList.add("hidden");
      newTrackInput.value = "";
      ruleBreachSelect.value = "";

    } catch (error) {
      console.error("Error writing ticket: ", error);
      statusMsg.textContent = "Error submitting ticket. Please try again.";
      statusMsg.className = "status error";
    } finally {
      submitBtn.disabled = false;
    }
  });

  // ============================
  // Admin login unchanged
  // ============================
  loginBtn.addEventListener("click", async () => {
    loginBtn.disabled = true;
    loginStatusMsg.textContent = "Signing in‚Ä¶";
    loginStatusMsg.className = "status";
    const email = emailInput.value.trim();
    const pw    = passwordInput.value.trim();
    if (!email || !pw) {
      loginStatusMsg.textContent = "Email & password are required.";
      loginStatusMsg.className = "status error";
      loginBtn.disabled = false;
      return;
    }
    try {
      await signInWithEmailAndPassword(auth, email, pw);
    } catch (err) {
      console.error("Login error:", err);
      loginStatusMsg.textContent = "Login failed. Check credentials.";
      loginStatusMsg.className = "status error";
      loginBtn.disabled = false;
    }
  });

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      logoutBtn.classList.remove("hidden");
      showSection(adminSection);
      adminTicketsContainer.innerHTML = "<p>Loading tickets‚Ä¶</p>";
      await fetchAndRenderTickets(adminTicketsContainer, true);
    } else {
      logoutBtn.classList.add("hidden");
      // Do NOT auto-show menu unless discord logged in
      if (requireDiscordOrShowLogin()) showSection(menuSection);
    }
  });

  // ============================
  // Appeal form + admin table rendering (unchanged from your existing)
  // (Kept minimal here: you already had these functions)
  // ============================
  function toggleAppealForm(ticketId, container) {
    const existingForm = container.querySelector(".appealFormRow");
    if (existingForm) existingForm.remove();

    const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
    if (!ticketRow) return;

    const formRow = document.createElement("tr");
    formRow.classList.add("appealFormRow");
    formRow.innerHTML = `
      <td colspan="8">
        <div class="appeal-form">
          <label for="appealInfo-${ticketId}"><strong>Appeal Info</strong></label>
          <textarea id="appealInfo-${ticketId}" placeholder="Enter your appeal details‚Ä¶" rows="3"></textarea>
          <label for="extraProof-${ticketId}"><strong>Extra Video Proof URL</strong></label>
          <input type="url" id="extraProof-${ticketId}" placeholder="https://example.com/extra-proof" />
          <div style="margin-top: 8px;">
            <button id="submitAppeal-${ticketId}">Submit Appeal</button>
            <button id="cancelAppeal-${ticketId}" style="background-color: #999; margin-left:8px;">Cancel</button>
          </div>
          <div id="appealStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
        </div>
      </td>
    `;
    ticketRow.insertAdjacentElement("afterend", formRow);

    document.getElementById(`cancelAppeal-${ticketId}`).addEventListener("click", () => formRow.remove());

    document.getElementById(`submitAppeal-${ticketId}`).addEventListener("click", async () => {
      const appealInfoInput = document.getElementById(`appealInfo-${ticketId}`);
      const extraProofInput = document.getElementById(`extraProof-${ticketId}`);
      const appealStatusDiv = document.getElementById(`appealStatus-${ticketId}`);
      const appealInfoValue = appealInfoInput.value.trim();
      const extraProofValue = extraProofInput.value.trim();

      if (!appealInfoValue) {
        appealStatusDiv.textContent = "Please enter your appeal details.";
        appealStatusDiv.className = "status error";
        return;
      }
      appealStatusDiv.textContent = "Submitting appeal‚Ä¶";
      appealStatusDiv.className = "status";

      try {
        const appealsColRef = collection(db, "tickets", ticketId, "appeals");
        await addDoc(appealsColRef, {
          appealInfo: appealInfoValue,
          extraProofUrl: extraProofValue,
          timestamp: serverTimestamp()
        });
        appealStatusDiv.textContent = "Appeal submitted! We‚Äôll review it soon.";
        appealStatusDiv.className = "status success";
        setTimeout(() => formRow.remove(), 2000);
      } catch (err) {
        console.error("Error submitting appeal:", err);
        appealStatusDiv.textContent = "Error submitting appeal. Please try again.";
        appealStatusDiv.className = "status error";
      }
    });
  }

  async function toggleDetailView(ticketId, container) {
    const existingDetail = container.querySelector(".detailRow");
    if (existingDetail) existingDetail.remove();

    const ticketRow = container.querySelector(`tr[data-id="${ticketId}"]`);
    if (!ticketRow) return;

    const ticketDocRef = doc(db, "tickets", ticketId);
    const ticketSnap = await getDoc(ticketDocRef);
    if (!ticketSnap.exists()) return;
    const ticketData = ticketSnap.data();

    const appealsRef = collection(db, "tickets", ticketId, "appeals");
    const appealsSnapshot = await getDocs(appealsRef);
    let appealsHTML = "";
    if (!appealsSnapshot.empty) {
      appealsSnapshot.forEach(appSnap => {
        const appealData = appSnap.data();
        const appealTs = appealData.timestamp && appealData.timestamp.toDate
          ? appealData.timestamp.toDate().toLocaleString()
          : "";
        appealsHTML += `
          <div class="appeal-box">
            <div><strong>Appeal:</strong> ${appealData.appealInfo}</div>
            <div><strong>Extra Video Proof:</strong> ${appealData.extraProofUrl || "N/A"}</div>
            <div style="margin-top:4px; font-size:0.8rem; color:#555;">
              <em>Submitted: ${appealTs}</em>
            </div>
          </div>
        `;
      });
    }

    const detailRow = document.createElement("tr");
    detailRow.classList.add("detailRow");
    detailRow.innerHTML = `
      <td colspan="8">
        <div class="detail-container">
          <h3>Ticket Details</h3>
          <p><strong>ID:</strong> ${ticketId}</p>
          <p><strong>Accused:</strong> ${ticketData.accused || ""}</p>
          <p><strong>Driver Reporting:</strong> ${ticketData.reporter || ""}</p>
          <p><strong>Competition:</strong> ${ticketData.competition || ""}</p>
          <p><strong>Full Incident Summary:</strong> ${ticketData.fullIncident || ""}</p>
          <p><strong>Event:</strong> ${ticketData.event || ""}</p>
          <p><strong>Proof URL:</strong> ${
            ticketData.proofUrl
              ? `<a href="${ticketData.proofUrl}" target="_blank" rel="noopener noreferrer">${ticketData.proofUrl}</a>`
              : "N/A"
          }</p>
          <p><strong>Season:</strong> ${ticketData.season || ""}</p>
          <p><strong>Track:</strong> ${ticketData.track || ""}</p>
          <p><strong>Rule Breach:</strong> ${ticketData.ruleBreach || ""}</p>
          <p><strong>Status:</strong> ${ticketData.status || ""}</p>
          ${ticketData.stewardTag ? `<p><strong>Assigned Steward:</strong> ${ticketData.stewardTag}</p>` : `<p><strong>Assigned Steward:</strong> ‚Äî</p>`}
          ${ticketData.stewardDecision ? `<p><strong>Steward Decision:</strong> ${ticketData.stewardDecision}</p>` : ""}
          ${ticketData.postRaceCode ? `<p><strong>Post-Race Code:</strong> ${ticketData.postRaceCode}</p>` : ""}
          <p><strong>Submitted At:</strong> ${
            (ticketData.timestamp && ticketData.timestamp.toDate)
              ? ticketData.timestamp.toDate().toLocaleString()
              : ""
          }</p>
          ${appealsHTML ? `<hr><h4>Appeals</h4>${appealsHTML}` : ""}
          <hr>
          <div class="review-form">
            <h4>Admin Review</h4>
            <label for="statusSelect-${ticketId}"><strong>Select Outcome</strong></label>
            <select id="statusSelect-${ticketId}">
              <option value="Under Review" ${ticketData.status === "Under Review" ? "selected" : ""}>Under Review</option>
              <option value="Finalised" ${ticketData.status === "Finalised" ? "selected" : ""}>Finalised</option>
              <option value="Appeal In Progress" ${ticketData.status === "Appeal In Progress" ? "selected" : ""}>Appeal In Progress</option>
            </select>

            <label for="decisionText-${ticketId}"><strong>Steward Decision</strong></label>
            <textarea id="decisionText-${ticketId}" placeholder="Enter your decision‚Ä¶" rows="3">${ticketData.stewardDecision || ""}</textarea>

            <label for="stewardTag-${ticketId}"><strong>Assigned Steward (Steward Tag)</strong></label>
            <input type="text" id="stewardTag-${ticketId}"
                   placeholder="e.g. Steward ‚Äì IOC"
                   value="${ticketData.stewardTag || ""}" />

            <label for="postRaceCode-${ticketId}"><strong>Post-Race Code</strong></label>
            <input type="text" id="postRaceCode-${ticketId}" value="${ticketData.postRaceCode || ""}" placeholder="e.g. RP7st" />

            <div style="margin-top: 8px;">
              <button id="submitReview-${ticketId}">Update Ticket</button>
              <button id="cancelDetail-${ticketId}" style="background-color: #999; margin-left:8px;">Close</button>
            </div>
            <div id="detailStatus-${ticketId}" class="status" style="margin-top:8px;"></div>
          </div>
        </div>
      </td>
    `;
    ticketRow.insertAdjacentElement("afterend", detailRow);

    document.getElementById(`cancelDetail-${ticketId}`).addEventListener("click", () => detailRow.remove());

    document.getElementById(`submitReview-${ticketId}`).addEventListener("click", async () => {
      const statusSelect    = document.getElementById(`statusSelect-${ticketId}`);
      const decisionInput   = document.getElementById(`decisionText-${ticketId}`);
      const stewardTagInput = document.getElementById(`stewardTag-${ticketId}`);
      const prcInput        = document.getElementById(`postRaceCode-${ticketId}`);
      const detailStatusDiv = document.getElementById(`detailStatus-${ticketId}`);

      const newStatus       = statusSelect.value;
      const decisionText    = decisionInput.value.trim();
      const stewardTagVal   = stewardTagInput.value.trim();
      const postRaceCodeVal = prcInput.value.trim();

      if (!decisionText) {
        detailStatusDiv.textContent = "Please enter a steward decision.";
        detailStatusDiv.className = "status error";
        return;
      }
      if (!stewardTagVal) {
        detailStatusDiv.textContent = "Please enter an assigned steward.";
        detailStatusDiv.className = "status error";
        return;
      }

      detailStatusDiv.textContent = "Updating ticket‚Ä¶";
      detailStatusDiv.className = "status";

      try {
        const ticketRef = doc(db, "tickets", ticketId);
        await updateDoc(ticketRef, {
          status: newStatus,
          stewardDecision: decisionText,
          stewardTag: stewardTagVal,
          postRaceCode: postRaceCodeVal
        });
        detailStatusDiv.textContent = "Ticket updated!";
        detailStatusDiv.className = "status success";
        setTimeout(async () => {
          await fetchAndRenderTickets(adminTicketsContainer, true);
        }, 800);
      } catch (err) {
        console.error("Error updating ticket:", err);
        detailStatusDiv.textContent = "Error updating ticket. Please try again.";
        detailStatusDiv.className = "status error";
      }
    });
  }

  async function fetchAndRenderTickets(targetContainer, isAdmin = false) {
    const ticketsCol   = collection(db, "tickets");
    const ticketsQuery = query(ticketsCol);

    try {
      const snapshot = await getDocs(ticketsQuery);
      if (snapshot.empty) {
        targetContainer.innerHTML = "<p>No tickets have been submitted yet.</p>";
        return;
      }

      let tableHTML = `
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Accused</th>
              <th>Reporter</th>
              <th>Competition</th>
              <th>Status</th>
              <th>Assigned Steward</th>
              <th>Submitted At</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      snapshot.forEach(docSnap => {
        const data  = docSnap.data();
        const tsObj = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : null;
        const tsStr = tsObj ? tsObj.toLocaleString() : "";
        const id    = docSnap.id;
        const steward = data.stewardTag || "";

        let isExpired = false;
        if (tsObj) {
          const now = Date.now();
          const createdAtMs = tsObj.getTime();
          if (now - createdAtMs > 24 * 60 * 60 * 1000) isExpired = true;
        }

        const isFinalised = (data.status === "Finalised");
        const rowClassList = ["ticketRow"];
        if (isFinalised) rowClassList.push("finalised-row");

        let actionButtonHTML = "";
        if (isAdmin) {
          actionButtonHTML = `<button data-id="${id}" class="openBtn">Open</button>`;
        } else {
          actionButtonHTML = isExpired
            ? `<button disabled style="background-color: #999; cursor: not-allowed;">Appeal Period Expired</button>`
            : `<button data-id="${id}" class="appealBtn">Appeal</button>`;
        }

        tableHTML += `
          <tr data-id="${id}" class="${rowClassList.join(" ")}">
            <td>${id}</td>
            <td>${data.accused || ""}</td>
            <td>${data.reporter || ""}</td>
            <td>${data.competition || ""}</td>
            <td>${data.status || ""}</td>
            <td>${steward}</td>
            <td>${tsStr}</td>
            <td>${actionButtonHTML}</td>
          </tr>
        `;
      });

      tableHTML += `</tbody></table>`;
      targetContainer.innerHTML = tableHTML;

      const ticketRows = targetContainer.querySelectorAll("tr.ticketRow");
      ticketRows.forEach(async (row) => {
        const ticketId = row.getAttribute("data-id");
        const appealsRef = collection(db, "tickets", ticketId, "appeals");
        const appealsSnapshot = await getDocs(appealsRef);
        if (!appealsSnapshot.empty) row.classList.add("appeal-highlight");
      });

      if (isAdmin) {
        targetContainer.querySelectorAll(".openBtn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const ticketId = e.currentTarget.getAttribute("data-id");
            toggleDetailView(ticketId, targetContainer);
          });
        });
      } else {
        targetContainer.querySelectorAll(".appealBtn").forEach(btn => {
          btn.addEventListener("click", (e) => {
            const ticketId = e.currentTarget.getAttribute("data-id");
            toggleAppealForm(ticketId, targetContainer);
          });
        });
      }

    } catch (err) {
      console.error("Error fetching tickets:", err);
      targetContainer.innerHTML = "<p>Error loading tickets.</p>";
    }
  }

  // Overview PDF button (kept minimal/unchanged behavior)
  overviewAdminBtn.addEventListener("click", async () => {
    const fourDaysAgo = new Date();
    fourDaysAgo.setDate(fourDaysAgo.getDate() - 4);

    const ticketsCol = collection(db, "tickets");
    const q = query(
      ticketsCol,
      where("timestamp", ">=", fourDaysAgo),
      orderBy("timestamp", "asc")
    );

    const snapshot = await getDocs(q);
    if (snapshot.empty) {
      alert("No tickets found in the last 4 days.");
      return;
    }

    const { jsPDF } = window.jspdf;
    const docPDF = new jsPDF();
    let y = 30;
    docPDF.setFontSize(16);
    docPDF.text("Ticket Overview (Last 4 Days)", 14, 20);
    docPDF.setFontSize(12);
    docPDF.text("Driver (Accused)", 14, y);
    docPDF.text("Competition", 80, y);
    docPDF.text("Reporter", 150, y);
    y += 8;

    snapshot.docs.forEach((docSnap) => {
      const data = docSnap.data();
      docPDF.text((data.accused || "").slice(0, 28), 14, y);
      docPDF.text((data.competition || "").slice(0, 30), 80, y);
      docPDF.text((data.reporter || "").slice(0, 18), 150, y);
      y += 8;
      if (y > 280) {
        docPDF.addPage();
        y = 20;
      }
    });

    docPDF.save("ticket_overview.pdf");
  });

  // ============================
  // Init: drivers + accused picker + dropdowns
  // ============================
  await loadDriversCache();

  setupDriverPicker({
    searchInput: document.getElementById("accusedSearch"),
    resultsEl: document.getElementById("accusedResults"),
    hiddenSelect: accusedSelect,
    manualBtn: document.getElementById("accusedManualBtn"),
    clearBtn: document.getElementById("accusedClearBtn"),
    manualContainer: newDriverContainer,
    manualNameInput: newDriverInput,
    manualNumberInput: newDriverNumber,
    placeholderText: "Select a driver‚Ä¶"
  });

  populateTrackDropdown();
  populateRegulationsDropdown();

  // ============================
  // Capture discord callback (if present)
  // ============================
  const cb = parseDiscordCallbackParams();
  if (cb) {
    // Save and validate
    setDiscordUser(cb);
    if (!validateNick(cb.nick)) {
      discordLoginStatus.textContent = "Login received, but your IFWL server nickname is not in the required format: [drivernumber] - driver name.";
      discordLoginStatus.className = "status error";
      showSection(discordLoginSection);
    } else {
      discordLoginStatus.textContent = "Login successful!";
      discordLoginStatus.className = "status success";
      renderDiscordUserUI();
      showSection(menuSection);
    }
  }

  // ============================
  // Default landing
  // ============================
  renderDiscordUserUI();
  if (requireDiscordOrShowLogin()) {
    showSection(menuSection);
  } else {
    showSection(discordLoginSection);
  }
</script>

</body>
</html>
