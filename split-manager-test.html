<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IFWL Split Manager (Test)</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-100 text-slate-900">
  <div class="max-w-6xl mx-auto p-4 md:p-8 space-y-6">

    <!-- Header -->
    <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight">IFWL Split Manager (TEST)</h1>
        <p class="text-slate-600 text-sm mt-1">
          Upload a SimGrid entry list JSON → Parse drivers → Generate splits → Copy to Discord / Export JSON
        </p>
      </div>
      <div class="text-xs text-slate-500">
        Version: <span class="font-mono">test-0.2.0</span>
      </div>
    </header>

    <!-- Controls -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-6 shadow-sm space-y-4">
      <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">

        <!-- Upload -->
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-700">Upload JSON</label>
          <input id="fileInput" type="file" accept=".json,application/json"
                 class="block w-full text-sm bg-white border border-slate-300 rounded-xl p-2
                        file:mr-3 file:py-2 file:px-3 file:rounded-lg file:border-0
                        file:bg-slate-200 file:text-slate-900 hover:file:bg-slate-300"/>
          <div class="flex gap-2 flex-wrap">
            <button id="btnLoadSample"
              class="px-3 py-2 rounded-xl bg-slate-200 hover:bg-slate-300 text-sm font-semibold">
              Load sample JSON
            </button>
            <button id="btnClear"
              class="px-3 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-300 text-sm font-semibold">
              Clear
            </button>
          </div>
        </div>

        <!-- Split size -->
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-700">Split size</label>
          <input id="splitSize" type="number" min="2" max="100" value="30"
                 class="w-full bg-white border border-slate-300 rounded-xl p-2 text-sm"/>
          <p class="text-xs text-slate-500">ACC grids often 25–35 depending on server settings.</p>
        </div>

        <!-- Seeding -->
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-700">Seed / sort by</label>
          <select id="seedField"
                  class="w-full bg-white border border-slate-300 rounded-xl p-2 text-sm">
            <option value="auto">Auto-detect (best numeric field)</option>
            <option value="name">Name (A→Z)</option>
            <option value="raceNumber">Race number</option>
            <option value="playerID">Player ID</option>
          </select>
          <p class="text-xs text-slate-500">
            Your SimGrid entrylist JSON often doesn’t contain “rating”, so auto will pick what exists.
          </p>
        </div>

        <!-- Split method -->
        <div class="space-y-2">
          <label class="text-sm font-semibold text-slate-700">Split method</label>
          <select id="splitMethod"
                  class="w-full bg-white border border-slate-300 rounded-xl p-2 text-sm">
            <option value="topdown">Top-down (Split 1 strongest first)</option>
            <option value="snake">Snake draft (balances splits)</option>
          </select>
          <p class="text-xs text-slate-500">Snake is useful if you seed by strength.</p>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <button id="btnParse"
          class="px-4 py-2 rounded-xl bg-blue-600 hover:bg-blue-500 text-white text-sm font-bold">
          Parse JSON
        </button>
        <button id="btnMakeSplits"
          class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-bold">
          Generate Splits
        </button>
        <button id="btnCopyDiscord"
          class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-300 text-sm font-bold">
          Copy Discord text
        </button>
        <button id="btnExportSplits"
          class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 border border-slate-300 text-sm font-bold">
          Export splits JSON
        </button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
          <div class="text-xs font-semibold text-slate-600 mb-2">Status</div>
          <pre id="status" class="text-xs text-slate-800 whitespace-pre-wrap"></pre>
        </div>
        <div class="bg-slate-50 border border-slate-200 rounded-2xl p-3">
          <div class="text-xs font-semibold text-slate-600 mb-2">Detected Structure</div>
          <pre id="structure" class="text-xs text-slate-800 whitespace-pre-wrap"></pre>
        </div>
      </div>
    </section>

    <!-- Drivers -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-6 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-lg font-extrabold">Drivers</h2>
        <div class="text-sm text-slate-600">Count: <span id="driverCount" class="font-bold">0</span></div>
      </div>

      <div class="overflow-x-auto mt-4">
        <table class="w-full text-sm">
          <thead class="text-slate-600">
            <tr class="border-b border-slate-200">
              <th class="text-left py-2 pr-3">#</th>
              <th class="text-left py-2 pr-3">Name</th>
              <th class="text-left py-2 pr-3">Race #</th>
              <th class="text-left py-2 pr-3">Player ID</th>
              <th class="text-left py-2 pr-3">Notes</th>
            </tr>
          </thead>
          <tbody id="driversTbody"></tbody>
        </table>
      </div>
    </section>

    <!-- Splits -->
    <section class="bg-white border border-slate-200 rounded-2xl p-4 md:p-6 shadow-sm">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-lg font-extrabold">Splits</h2>
        <div class="text-sm text-slate-600">Splits: <span id="splitCount" class="font-bold">0</span></div>
      </div>

      <div id="splitsWrap" class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-4"></div>
    </section>

    <footer class="text-xs text-slate-500 pb-6">
      Note: This is a static GitHub Pages test page. For Discord posting, the secure way is via Apps Script (webhook kept private).
    </footer>

  </div>

<script>
  // =========================
  // State
  // =========================
  let rawJson = null;
  let drivers = [];   // normalized drivers
  let splits = [];    // array of arrays

  const el = (id) => document.getElementById(id);

  function setStatus(msg) { el("status").textContent = msg; }
  function setStructure(msg) { el("structure").textContent = msg; }

  function escapeHtml(str) {
    return String(str ?? "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  // =========================
  // SimGrid Entrylist parsing helpers
  // =========================
  function findEntriesArray(obj) {
    if (!obj) return null;
    if (Array.isArray(obj)) return obj;
    if (Array.isArray(obj.entries)) return obj.entries;
    if (Array.isArray(obj.participants)) return obj.participants;
    if (Array.isArray(obj.drivers)) return obj.drivers;

    // Shallow scan (last resort)
    for (const [k, v] of Object.entries(obj)) {
      if (Array.isArray(v) && v.length && typeof v[0] === "object") return v;
    }
    return null;
  }

  function normalizeDriver(entry) {
    // SimGrid/ACC-style: entry.drivers[0].firstName + lastName
    const d0 = Array.isArray(entry.drivers) ? entry.drivers[0] : null;

    const first = (d0 && (d0.firstName ?? d0.firstname)) ? String(d0.firstName ?? d0.firstname).trim() : "";
    const last  = (d0 && (d0.lastName ?? d0.lastname)) ? String(d0.lastName ?? d0.lastname).trim() : "";

    const playerID =
      (d0 && d0.playerID) ||
      entry.playerID ||
      entry.steamId ||
      entry.steamID ||
      "";

    const nameFromParts = [first, last].filter(Boolean).join(" ").trim();

    const name =
      nameFromParts ||
      entry.name ||
      entry.driverName ||
      entry.username ||
      entry.displayName ||
      (playerID ? `Unknown (${playerID})` : "Unknown");

    const raceNumber = (entry.raceNumber !== undefined && entry.raceNumber !== null) ? String(entry.raceNumber) : "";

    const notes = [];
    if (entry.forcedCarModel !== undefined) notes.push("forcedCarModel: " + entry.forcedCarModel);
    if (entry.restrictor !== undefined) notes.push("restrictor: " + entry.restrictor);
    if (entry.ballast !== undefined) notes.push("ballast: " + entry.ballast);
    if (entry.isServerAdmin) notes.push("server admin");
    if (d0 && d0.shortName) notes.push("tag: " + d0.shortName);

    return {
      raw: entry,
      name,
      raceNumber,
      playerID: String(playerID || ""),
      notes: notes.join(" • "),
    };
  }

  // =========================
  // Seeding / sorting
  // =========================
  function tryGetNumeric(entry, key) {
    const v = entry?.raw?.[key];
    const n = Number(v);
    return Number.isFinite(n) ? n : null;
  }

  function detectBestNumericField(normalizedDrivers) {
    // Pick a numeric field that exists on many entries
    // (in SimGrid entrylist, often raceNumber exists; sometimes others exist)
    const candidateKeys = [
      "raceNumber", "forcedCarModel", "restrictor", "ballast",
      "rating", "elo", "irating", "pace", "rank", "score"
    ];

    let bestKey = null;
    let bestCount = 0;

    for (const key of candidateKeys) {
      const count = normalizedDrivers.reduce((acc, d) => acc + (tryGetNumeric(d, key) !== null ? 1 : 0), 0);
      if (count > bestCount) {
        bestCount = count;
        bestKey = key;
      }
    }

    // fallback
    return bestKey || "raceNumber";
  }

  function sortDrivers(list, seedChoice) {
    const choice = seedChoice;

    // Basic sorts
    if (choice === "name") {
      return { sorted: [...list].sort((a,b) => a.name.localeCompare(b.name)), used: "name" };
    }
    if (choice === "playerID") {
      return { sorted: [...list].sort((a,b) => a.playerID.localeCompare(b.playerID)), used: "playerID" };
    }
    if (choice === "raceNumber") {
      return {
        sorted: [...list].sort((a,b) => (Number(a.raceNumber||999999) - Number(b.raceNumber||999999))),
        used: "raceNumber"
      };
    }

    // Auto-detect numeric field from raw JSON
    const best = detectBestNumericField(list);
    const sorted = [...list].sort((a,b) => {
      const av = tryGetNumeric(a, best);
      const bv = tryGetNumeric(b, best);

      // Put missing values at the bottom
      if (av === null && bv === null) return a.name.localeCompare(b.name);
      if (av === null) return 1;
      if (bv === null) return -1;

      // If it's raceNumber-like, smaller first; otherwise larger first
      const ascendingKeys = new Set(["raceNumber", "forcedCarModel"]);
      return ascendingKeys.has(best) ? (av - bv) : (bv - av);
    });

    return { sorted, used: `auto:${best}` };
  }

  // =========================
  // Split generation
  // =========================
  function makeSplitsTopDown(sorted, size) {
    const out = [];
    for (let i = 0; i < sorted.length; i += size) out.push(sorted.slice(i, i + size));
    return out;
  }

  function makeSplitsSnake(sorted, size) {
    const splitCount = Math.ceil(sorted.length / size);
    const buckets = Array.from({ length: splitCount }, () => []);
    let dir = 1, idx = 0;

    for (const d of sorted) {
      buckets[idx].push(d);
      if (dir === 1) {
        if (idx === splitCount - 1) dir = -1;
        else idx++;
      } else {
        if (idx === 0) dir = 1;
        else idx--;
      }
    }
    return buckets.filter(b => b.length);
  }

  // =========================
  // Rendering
  // =========================
  function renderDrivers(list) {
    el("driverCount").textContent = list.length;
    const tbody = el("driversTbody");
    tbody.innerHTML = "";

    list.forEach((d, i) => {
      const tr = document.createElement("tr");
      tr.className = "border-b border-slate-200/70";
      tr.innerHTML = `
        <td class="py-2 pr-3 text-slate-500">${i + 1}</td>
        <td class="py-2 pr-3 font-semibold">${escapeHtml(d.name)}</td>
        <td class="py-2 pr-3">${escapeHtml(d.raceNumber || "")}</td>
        <td class="py-2 pr-3 font-mono text-xs text-slate-700">${escapeHtml(d.playerID || "")}</td>
        <td class="py-2 pr-3 text-slate-600">${escapeHtml(d.notes || "")}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function renderSplits(splitsArr) {
    el("splitCount").textContent = splitsArr.length;
    const wrap = el("splitsWrap");
    wrap.innerHTML = "";

    splitsArr.forEach((bucket, idx) => {
      const card = document.createElement("div");
      card.className = "bg-slate-50 border border-slate-200 rounded-2xl p-4";

      const rows = bucket.map((d, i) => `
        <div class="flex justify-between gap-3 py-1 border-b border-slate-200/70 last:border-0">
          <div class="text-slate-500 w-8">${i + 1}.</div>
          <div class="flex-1 font-semibold">${escapeHtml(d.name)}</div>
          <div class="text-slate-600 text-xs font-mono">${escapeHtml(d.raceNumber ? "#" + d.raceNumber : "")}</div>
        </div>
      `).join("");

      card.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <div class="font-extrabold text-lg">Split ${idx + 1}</div>
          <div class="text-xs text-slate-600">Drivers: ${bucket.length}</div>
        </div>
        <div class="text-sm">${rows}</div>
      `;
      wrap.appendChild(card);
    });
  }

  // =========================
  // Output helpers
  // =========================
  function formatDiscord(splitsArr) {
    const lines = [];
    lines.push("**IFWL SPLITS**");
    splitsArr.forEach((bucket, idx) => {
      lines.push(`\n__Split ${idx + 1}__`);
      bucket.forEach((d, i) => {
        const rn = d.raceNumber ? ` (#${d.raceNumber})` : "";
        lines.push(`${String(i + 1).padStart(2, " ")}. ${d.name}${rn}`);
      });
    });
    return lines.join("\n");
  }

  function exportSplitsJson() {
    const payload = {
      generatedAt: new Date().toISOString(),
      splitSize: Number(el("splitSize").value || 30),
      splitMethod: el("splitMethod").value,
      seedField: el("seedField").value,
      splits: splits.map((bucket, idx) => ({
        split: idx + 1,
        drivers: bucket.map(d => ({
          name: d.name,
          raceNumber: d.raceNumber,
          playerID: d.playerID
        }))
      }))
    };

    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "ifwl_splits.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // =========================
  // Actions
  // =========================
  async function handleFileUpload(file) {
    const text = await file.text();
    try {
      rawJson = JSON.parse(text);
      setStatus("Loaded JSON from file: " + file.name + "\nNow click: Parse JSON");
    } catch (e) {
      rawJson = null;
      setStatus("❌ Failed to parse JSON: " + e.message);
    }
  }

  function parseJsonToDrivers() {
    if (!rawJson) {
      setStatus("❌ No JSON loaded yet. Upload a file or click 'Load sample JSON'.");
      return;
    }

    const arr = findEntriesArray(rawJson);
    if (!arr || !arr.length) {
      setStatus("❌ Could not find an entries array in this JSON.");
      setStructure("No entries array detected.");
      drivers = [];
      splits = [];
      renderDrivers([]);
      renderSplits([]);
      return;
    }

    drivers = arr
  .map(normalizeDriver)
  .filter(d => !d.isServerAdmin)
  .filter(d => !d.name.startsWith("Unknown"));


    // show a quick structure preview
    const first = arr[0] || {};
    const keys = Object.keys(first).slice(0, 120);
    setStructure(
      "Entries array length: " + arr.length + "\n" +
      "Top-level entry keys (first item):\n" + keys.join(", ") + "\n\n" +
      "Name source expected: entry.drivers[0].firstName / lastName"
    );

    const { sorted, used } = sortDrivers(drivers, el("seedField").value);
    drivers = sorted;

    renderDrivers(drivers);
    setStatus("✅ Parsed " + drivers.length + " drivers\nSeed used: " + used + "\nNow click: Generate Splits");
  }

  function generateSplits() {
    if (!drivers.length) {
      setStatus("❌ No drivers parsed yet. Click 'Parse JSON' first.");
      return;
    }

    const size = Math.max(2, Math.min(100, Number(el("splitSize").value || 30)));
    const method = el("splitMethod").value;
    const { sorted, used } = sortDrivers(drivers, el("seedField").value);

    drivers = sorted;
    splits = (method === "snake") ? makeSplitsSnake(sorted, size) : makeSplitsTopDown(sorted, size);

    renderDrivers(drivers);
    renderSplits(splits);

    setStatus(
      "✅ Splits generated\n" +
      "Drivers: " + drivers.length + "\n" +
      "Split size: " + size + "\n" +
      "Method: " + method + "\n" +
      "Seed used: " + used + "\n" +
      "Split count: " + splits.length
    );
  }

  async function copyDiscord() {
    if (!splits.length) {
      setStatus("❌ No splits generated yet.");
      return;
    }
    const text = formatDiscord(splits);
    await navigator.clipboard.writeText(text);
    setStatus("✅ Copied Discord text to clipboard.");
  }

  function loadSampleJson() {
    rawJson = {
      event: { name: "TEST EVENT", provider: "SimGrid sample" },
      entries: Array.from({ length: 78 }, (_, i) => ({
        raceNumber: i + 1,
        forcedCarModel: (i % 4),
        restrictor: 0,
        ballast: 0,
        drivers: [{
          firstName: "Driver",
          lastName: String(i + 1).padStart(2, "0"),
          playerID: "S7656119" + String(100000000 + i)
        }]
      }))
    };
    setStatus("Loaded sample JSON with 78 entries.\nNow click: Parse JSON");
    setStructure("Sample loaded.");
  }

  function clearAll() {
    rawJson = null;
    drivers = [];
    splits = [];
    el("driversTbody").innerHTML = "";
    el("splitsWrap").innerHTML = "";
    el("driverCount").textContent = "0";
    el("splitCount").textContent = "0";
    setStatus("Cleared.\nUpload a JSON file or load the sample.");
    setStructure("");
    el("fileInput").value = "";
  }

  // =========================
  // Wire up UI
  // =========================
  el("fileInput").addEventListener("change", async (ev) => {
    const file = ev.target.files && ev.target.files[0];
    if (!file) return;
    await handleFileUpload(file);
  });

  el("btnLoadSample").addEventListener("click", loadSampleJson);
  el("btnClear").addEventListener("click", clearAll);
  el("btnParse").addEventListener("click", parseJsonToDrivers);
  el("btnMakeSplits").addEventListener("click", generateSplits);
  el("btnCopyDiscord").addEventListener("click", copyDiscord);
  el("btnExportSplits").addEventListener("click", exportSplitsJson);

  setStatus("Ready.\nUpload a JSON file or click 'Load sample JSON'.");
</script>

</body>
</html>
