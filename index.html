<!DOCTYPE html>
<html class="dark" data-theme="light" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IFWL ACC Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="ifwl_logo.png"/>
  <meta name="description" content="IFWL driver classification and server leaderboard tool for ACC."/>
</head>
<body class="bg-gray-100 text-gray-900"
      style="background: url('ifwl_bg.webp') no-repeat center center fixed; background-size: cover;">

<!-- Sticky Nav -->
<div class="sticky top-0 z-50 bg-white shadow flex justify-between items-center px-6 py-3">
  <div class="flex items-center gap-4">
    <img src="ifwl_logo.png" alt="IFWL Logo" class="h-10"/>
    <span class="text-sm text-gray-600 font-mono">Beta 0.1.25</span>
  </div>
  <div class="flex gap-2">
    <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
            onclick="scrollToSection('classifier')">Classifier</button>
    <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
            onclick="scrollToSection('leaderboardSection')">Driver Times</button>
    <button class="bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700"
            onclick="scrollToSection('serverStatusPanel')">Server Status</button>
  </div>
</div>

<!-- Main Content: Classifier + Leaderboard -->
<div class="max-w-7xl mx-auto mt-8 px-4">

  <!-- ACC Driver Classification (main card) -->
  <div class="bg-white rounded-2xl shadow p-6 w-full" id="classifier">
    <h2 class="text-xl font-bold mb-4">ACC Driver Classification</h2>

    <!-- Small version badge -->
    <div class="fixed top-2 left-2 text-xs text-gray-500 font-mono bg-white bg-opacity-80 px-2 py-1 rounded shadow">
      Beta 0.0.0155
    </div>

    <div class="mb-6">
      <a href="https://www.ifwl.net" target="_blank"></a>
    </div>

    <div class="bg-white p-8 rounded-2xl shadow-md w-full max-w-lg">
      <!-- Sponsors / Affiliates -->
      <div class="mb-6 text-center">
        <h2 class="text-lg font-semibold mb-4 text-gray-700">Proudly Sponsored &amp; Affiliated With</h2>
        <div class="flex justify-center gap-4 flex-wrap items-center">
          <a href="https://www.g-portal.com/en?ref=ifwl" target="_blank" title="G-Portal (Main Sponsor)"></a>
          <a href="https://www.fanatec.com/eu/en?utm_medium=FAP%20Banner&amp;utm_source=IFWL&amp;utm_campaign=General%20Links&amp;a_aid=IFWL"
             target="_blank" title="Fanatec Affiliate"></a>
          <a href="https://www.cdkeys.com/?irclickid=WjSVYp0TKxyKRityly0JazM8UksUvt0O5Syr3k0&amp;utm_source=impact&amp;utm_medium=affiliate&amp;utm_campaign=IFWL.NET&amp;utm_id=5473508&amp;irgwc=1"
             target="_blank" title="CDKeys Affiliate"></a>
          <a href="https://mozaracing.com/?ref=IFWL" target="_blank" title="Moza Racing Affiliate"></a>
        </div>
      </div>

      <h1 class="text-2xl font-bold mb-4">ACC Driver Classification</h1>

      <form id="classificationForm" class="space-y-4">
        <input id="driverName" type="text" required
               class="w-full p-2 border rounded"
               placeholder="Driver Name"/>

        <select id="track" required class="w-full p-2 border rounded">
          <option value="">Select Track</option>
          <option>Monza</option>
          <option>Spa Francorchamps</option>
          <option>Silverstone</option>
          <option>Nurburgring GP</option>
          <option>Barcelona</option>
          <option>Zandvoort</option>
          <option>Suzuka</option>
          <option>Paul Ricard</option>
          <option>Imola</option>
          <option>Mount Panorama</option>
          <option>Misano</option>
          <option>Kyalami</option>
          <option>Brands Hatch</option>
          <option>Donnington Park</option>
          <option>Valencia</option>
          <option>Laguna Seca</option>
          <option>Watkins Glen</option>
          <option>Zolder</option>
          <option>Red Bull Ring</option>
          <option>Hungaroring</option>
          <option>Nurburgring Nordchleiffe</option>
        </select>

        <select id="carClass" required class="w-full p-2 border rounded">
          <option value="">Select Car Class</option>
          <option value="GT3">GT3</option>
          <option value="GT4">GT4 coming soon</option>
        </select>

        <label for="weather" class="block text-left text-sm font-medium text-gray-700">Weather</label>
        <select id="weather" required
                class="w-full p-2 border rounded"
                onchange="document.getElementById('weatherNote').style.display = this.value === 'wet' ? 'block' : 'none';">
          <option value="dry">Dry</option>
          <option value="wet">Wet</option>
        </select>

        <input id="lapTime"
               type="text"
               required
               class="w-full p-2 border rounded"
               placeholder="Lap Time (e.g. 1:47.382)"
               pattern="^[0-9]:[0-5][0-9]\.[0-9]{3}$"
               title="Please enter time in the format m:ss.sss (e.g. 1:47.382)"/>

        <p id="weatherNote" class="text-sm text-blue-600 mt-1 hidden">
          Note: Wet weather adds a 5% buffer to your lap time for fairer classification.
        </p>

        <button type="submit"
                class="w-full bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
          Classify Me
        </button>
      </form>

      <p id="bopNote" class="text-sm text-gray-600 mt-6">
        Note: These times are tailored for IFWL.NET, which uses LFM BOP. Other leagues may vary.
        In ACC, check "Driver &gt; Stats" â€” the top time is your best hotlap, the grey-boxed bottom time is your race pace.
        Use race pace for accurate classification.
      </p>

      <div id="result" class="mt-4 text-lg font-semibold"></div>

      <div id="simgridPromo" class="mt-6 hidden bg-gray-800 p-4 rounded-lg">
        <a href="https://www.thesimgrid.com/communities/ifwl" target="_blank"></a>
      </div>

      <div class="flex gap-4 mt-6 justify-center">
        <a href="https://discord.gg/bBax4w29vS" target="_blank"
           class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700 transition">
          Join the League
        </a>
        <a href="https://www.patreon.com/c/IFWL" target="_blank"
           class="bg-blue-600 text-white px-4 py-2 rounded-xl shadow hover:bg-blue-700 transition">
          Support the League
        </a>
      </div>
    </div>
  </div>

  <!-- Track Leaderboard: appears after a classification -->
  <div id="leaderboardSection"
       class="bg-white rounded-2xl shadow p-6 w-full mt-8 hidden">
    <h2 class="text-xl font-bold mb-2">
      Live Leaderboard (Driver Times)
    </h2>
    <p class="text-sm text-gray-600 mb-4">
      Showing all recorded laps for
      <span id="leaderboardTrackName" class="font-semibold"></span>,
      sorted from fastest to slowest. Your latest lap is highlighted.
    </p>

    <div class="overflow-x-auto">
      <table class="min-w-full bg-white rounded shadow-md overflow-hidden">
        <thead class="bg-gray-200">
        <tr>
          <th class="px-4 py-2 text-left">Pos</th>
          <th class="px-4 py-2 text-left">Driver</th>
          <th class="px-4 py-2 text-left">Car</th>
          <th class="px-4 py-2 text-left">Best Lap</th>
          <th class="px-4 py-2 text-left">Session</th>
          <th class="px-4 py-2 text-left">Date</th>
        </tr>
        </thead>
        <tbody id="leaderboardBody" class="divide-y divide-gray-100"></tbody>
      </table>
    </div>

    <p class="text-xs text-gray-500 mt-4">
      Note: Any entry marked 'CLASSIFIER TIME' was user-submitted and cannot be verified.
      Only entries with P, Q, or R (Practice, Qualifying, Race) are verified server times.
    </p>
  </div>
</div>

<!-- Server Status Button -->
<div id="serverStatusPanel" class="max-w-7xl mx-auto mt-10 px-4 text-center">
  <div class="bg-white rounded-2xl shadow p-6">
    <h2 class="text-lg font-bold mb-4">Live ACC Server Status</h2>
    <a href="https://acc-status.jonatan.net" target="_blank"
       class="inline-block bg-blue-600 text-white text-lg font-semibold px-6 py-3 rounded shadow hover:bg-blue-700 transition">
      Click here to view live ACC server status â†’
    </a>
  </div>
</div>

<!-- Dynamic Countdown Widget -->
<div class="max-w-xl mx-auto mt-10 p-6 bg-white dark:bg-gray-800 rounded-xl shadow-md text-center">
  <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Next IFWL Event Countdown</h2>
  <p id="event-name" class="text-lg text-gray-600 dark:text-gray-300 mb-2">Loading...</p>
  <div id="countdown" class="text-3xl font-mono text-blue-600 dark:text-blue-400">Loading...</div>
</div>

<!-- Unified Sponsor Block -->
<div class="max-w-7xl mx-auto mt-12 px-4">
  <div class="bg-white rounded-2xl shadow p-6 text-center">
    <h2 class="text-lg font-semibold mb-4">Sponsored &amp; Affiliated By</h2>
    <div class="flex justify-center flex-wrap gap-6 mt-4">
      <a href="https://www.g-portal.com/?ref=ifwl" target="_blank">
        <img src="use_this_simgrid.png" alt="G-Portal" class="h-10"/>
      </a>
      <a href="https://www.fanatec.com?utm_medium=FAP+Banner&amp;utm_source=IFWL&amp;utm_campaign=General+Links&amp;a_aid=IFWL"
         target="_blank">
        <img src="fanatec.png" alt="Fanatec" class="h-10"/>
      </a>
      <a href="https://cdkeys.pxf.io/3eBZvy" target="_blank">
        <img src="cdkeys.png" alt="CDKeys" class="h-10"/>
      </a>
      <a href="https://mozaracing.com/?ref=IFWL" target="_blank">
        <img src="moza.png" alt="Moza Racing" class="h-10"/>
      </a>
    </div>
  </div>
</div>

<!-- Scripts -->
<script>
  function scrollToSection(id) {
    const el = document.getElementById(id);
    if (el) el.scrollIntoView({behavior: 'smooth'});
  }

  /* ---------- Countdown Logic ---------- */
  const events = [
    {name: "Beginner Series PC â€“ Bathurst", time: "2025-05-14T19:30:00Z"},
    {name: "Beginner Series Console â€“ Bathurst", time: "2025-05-14T17:30:00Z"},
    {name: "AC Skoda VRS Series â€“ Mallory Park", time: "2025-05-16T18:30:00Z"},
    {name: "Console Enduro â€“ MT PANORAMA", time: "2025-05-17T18:30:00Z"},
    {name: "Saturday Showdown PC â€“ Zolder", time: "2025-05-17T14:00:00Z"},
    {name: "Saturday Showdown Console â€“ Zolder", time: "2025-05-17T14:00:00Z"},
    {name: "ACC Pro-Am Console S2 â€“ Bathurst", time: "2025-05-18T19:00:00Z"},
    {name: "ACC Pro-Am PC S2 â€“ Bathurst", time: "2025-05-18T19:00:00Z"}
  ];

  const eventName = document.getElementById("event-name");
  const countdownEl = document.getElementById("countdown");

  function getNextEvent() {
    const now = new Date();
    return events
      .map(e => ({...e, date: new Date(e.time)}))
      .filter(e => e.date > now)
      .sort((a, b) => a.date - b.date)[0];
  }

  function updateCountdown() {
    const next = getNextEvent();
    if (!next) {
      countdownEl.innerText = "No upcoming events.";
      eventName.innerText = "";
      return;
    }

    eventName.innerText = next.name;
    const now = new Date().getTime();
    const distance = next.date.getTime() - now;

    if (distance <= 0) {
      countdownEl.innerText = "Event Started!";
      return;
    }

    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((distance % (1000 * 60)) / 1000);

    countdownEl.innerText = `${days}d ${hours}h ${minutes}m ${seconds}s`;
  }

  setInterval(updateCountdown, 1000);
  updateCountdown();

  /* ---------- Classifier + Leaderboard Logic ---------- */

  const classificationData = {
    "Monza": {"GT3": ["1:53.7", "1:51.7", "1:49.7", "1:47.7", "1:45.7"]},
    "Spa Francorchamps": {"GT3": ["2:23.0", "2:21.0", "2:19.0", "2:17.0", "2:15.0"]},
    "Silverstone": {"GT3": ["2:04.437", "2:02.437", "2:00.437", "1:58.437", "1:56.437"]},
    "Nurburgring GP": {"GT3": ["2:00.1", "1:58.1", "1:56.1", "1:54.1", "1:52.1"]},
    "Barcelona": {"GT3": ["1:49.6", "1:47.6", "1:45.6", "1:43.6", "1:41.6"]},
    "Zandvoort": {"GT3": ["1:41.5", "1:39.5", "1:37.5", "1:35.5", "1:33.5"]},
    "Suzuka": {"GT3": ["2:06.270", "2:04.270", "2:02.270", "2:00.270", "1:58.270"]},
    "Paul Ricard": {"GT3": ["1:59.9", "1:57.9", "1:55.9", "1:53.9", "1:51.9"]},
    "Imola": {"GT3": ["1:46.972", "1:44.972", "1:42.972", "1:40.972", "1:38.972"]},
    "Mount Panorama": {"GT3": ["2:07.847", "2:05.847", "2:03.847", "2:01.847", "1:59.847"]},
    "Misano": {"GT3": ["1:39.592", "1:37.592", "1:35.592", "1:33.592", "1:31.592"]},
    "Kyalami": {"GT3": ["1:47.720", "1:45.720", "1:43.720", "1:41.720", "1:39.720"]},
    "Brands Hatch": {"GT3": ["1:29.300", "1:27.300", "1:25.300", "1:23.300", "1:21.300"]},
    "Donnington Park": {"GT3": ["1:32.991", "1:30.991", "1:28.991", "1:26.991", "1:24.991"]},
    "Valencia": {"GT3": ["1:36.475", "1:34.475", "1:32.475", "1:30.475", "1:28.475"]},
    "Laguna Seca": {"GT3": ["1:28.427", "1:26.427", "1:24.427", "1:22.427", "1:20.427"]},
    "Watkins Glen": {"GT3": ["1:50.510", "1:48.510", "1:46.510", "1:44.510", "1:42.510"]},
    "Zolder": {"GT3": ["1:33.307", "1:31.307", "1:29.307", "1:27.307", "1:25.307"]},
    "Red Bull Ring": {"GT3": ["1:33.000", "1:31.000", "1:29.000", "1:27.000", "1:25.000"]},
    "Hungaroring": {"GT3": ["1:48.105", "1:46.105", "1:44.105", "1:42.105", "1:40.105"]},
    "Nurburgring Nordchleiffe": {"GT3": ["8:24.347", "8:22.347", "8:20.347", "8:18.347", "8:16.347"]}
  };

  const classes = [
    "IFWL.NET dertermines your entry as an error - Please check your entered time again.",
    "IFWL.NET determines you as a  entry level SPLIT 3 | Beginner driver : you have some way to go to get a higher tier, Good luck!.",
    "IFWL.NET determines you as a SPLIT 3 | Beginner driver : well done!!",
    "IFWL.NET determines you as a SPLIT 2 | AM driver : well done!!",
    "IFWL.NET determines you as a SPLIT 2 | AM driver : well done!!",
    "IFWL.NET determines you as a SPLIT 1 | PRO driver : well done!!",
    "IFWL.NET determines you as a Alien - consider getting a real race car ! :) "
  ];

  const tips = [
    "ðŸ Tip: Focus on smooth throttle and brake inputs to maintain car balance through corners.",
    "â„¹ï¸ Fun Facts: IFWL.NET website has had over 500,000 page hits in the last 12 months.",
    "ðŸŽï¸ Driver info : 'doing a klutz' was phrased on the 3rd corner of Zandvoort. ask him why in discord.",
    "ðŸ§  Tip: Learn your braking points and slowly push them deeper as you gain confidence.",
    "â„¹ï¸ Fun Facts: IFWL offers tailored training to members who wish to join the operations team",
    "ðŸŽï¸ Driver info : 'bananas' - A codeword used by driver #81 & #99 which was found to mean 'block them' - driver #75 fell foul to this alot",
    "ðŸŽ¯ Tip: Consistency is key â€“ aim for clean laps before chasing ultimate pace.",
    "â„¹ï¸ Fun Facts: IFWL has over Â£3000 in yearly outgoings. 1/3 of that was winnings to players",
    "ðŸŽï¸ Driver info : Driver #199 has been AFK since 2024 if you see him, inform IFWL officials.",
    "ðŸ” Tip: Use your track map and replays to spot where you're losing time.",
    "â„¹ï¸ Fun Facts: IFWL was the first league in the UK to establish affiliations with 3 big name gaming suppliers",
    "ðŸŽï¸ Driver info : when IFWL don't have a PC commentator, this is usually due to driver #652 wanting to race!",
    "ðŸ›ž Tip: Trail braking helps rotate the car â€“ practice easing off the brake into the apex.",
    "â„¹ï¸ Fun Facts: IFWL was started by 3 lads in 2022 when other leagues refused to race on weekends.",
    "ðŸŽï¸ Driver info : driver #66 thinks he has a chance of winning any wheelspin, to date - he's won ziltch."
  ];

  function getRandomTip() {
    return tips[Math.floor(Math.random() * tips.length)];
  }

  function timeToSeconds(timeStr) {
    const [min, sec] = timeStr.split(":");
    const [seconds, ms] = sec.split(".");
    return parseInt(min) * 60 + parseInt(seconds) + parseFloat(`0.${ms}`);
  }

  function classify(track, carClass, lapTime) {
    const weather = document.getElementById("weather").value;
    const rainImpact = weather === "wet" ? 1.05 : 1;
    const thresholds = classificationData[track][carClass].map(timeToSeconds);
    const userTime = timeToSeconds(lapTime) / rainImpact;

    let classification = classes[classes.length - 1];
    let gapInfo = "";

    for (let i = 0; i < thresholds.length; i++) {
      if (userTime >= thresholds[i]) {
        classification = classes[i + 1] || classes[classes.length - 1];

        const fasterGap = (i > 0) ? Math.abs((userTime - thresholds[i - 1]).toFixed(3)) : null;
        const slowerGap = (i < thresholds.length - 1) ? Math.abs((thresholds[i + 1] - userTime).toFixed(3)) : null;

        if (fasterGap !== null && slowerGap !== null) {
          gapInfo = `
            You are <span class="bg-red-200 text-red-800 px-1 rounded">${fasterGap} s slower</span> than the faster category,
            and <span class="bg-green-200 text-green-800 px-1 rounded">${slowerGap} s faster</span> than the slower category.
          `;
        } else if (fasterGap === null) {
          gapInfo = `
            You are <span class="bg-green-200 text-green-800 px-1 rounded">${slowerGap} s faster</span> than the next category.
          `;
        } else {
          gapInfo = `
            You are <span class="bg-red-200 text-red-800 px-1 rounded">${fasterGap} s slower</span> than the top category.
          `;
        }
        break;
      }
    }

    return {classification, gapInfo};
  }

  /* ----- Leaderboard sheet fetch ----- */

  const SHEET_ID = "1i5qJ0GaRp_tGUb0rzXUBzGq0RowtbQSVDjAyNASyh4g";
  const SHEET_NAME = "Results";
  const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

  const carMap = {
    0: "AMR V8 Vantage", 1: "Audi R8 LMS (2015)", 2: "BMW M6 GT3", 3: "Bentley Continental GT3 (2015)",
    4: "Bentley Continental GT3 (2018)", 5: "Jaguar G3", 6: "Lamborghini HuracÃ¡n GT3", 7: "McLaren 650S GT3",
    8: "Mercedes-AMG GT3", 9: "Nissan GT-R Nismo GT3 (2015)", 10: "Porsche 911 GT3 R (2018)",
    11: "Reiter Engineering R-EX GT3", 12: "Honda NSX GT3", 13: "Lexus RC F GT3", 14: "Lamborghini HuracÃ¡n GT3 Evo",
    15: "Honda NSX GT3 Evo", 16: "McLaren 720S GT3", 17: "Audi R8 LMS Evo", 18: "Ferrari 488 GT3",
    19: "Ferrari 488 GT3 Evo 2020", 20: "Porsche 991 II GT3 R", 21: "Lamborghini HuracÃ¡n Super Trofeo",
    22: "Audi R8 LMS GT4", 23: "BMW M4 GT4", 24: "Chevrolet Camaro GT4", 25: "Ginetta G55 GT4",
    26: "KTM X-Bow GT4", 27: "Maserati GranTurismo MC GT4", 28: "McLaren 570S GT4", 29: "Mercedes-AMG GT4",
    30: "Porsche 718 Cayman GT4", 31: "Alpine A110 GT4", 32: "BMW M2 CS Racing", 50: "Porsche 991 GT3 Cup",
    51: "Porsche 992 GT3 Cup", 60: "Lamborghini HuracÃ¡n Super Trofeo Evo2", 61: "Ferrari 296 GT3",
    62: "Porsche 992 GT3 R", 63: "McLaren 720S GT3 Evo", 64: "Mercedes-AMG GT3 Evo (2020)",
    65: "Audi R8 LMS Evo II", 66: "Lamborghini HuracÃ¡n GT3 Evo2", 67: "BMW M4 GT3",
    68: "Aston Martin Vantage V8 Evo", 69: "McLaren Artura GT4", 70: "Alpine A110 GT4 Evo",
    71: "Mercedes-AMG GT2", 72: "Porsche 935", 73: "Maserati MC20 GT2", 74: "Audi R8 LMS GT2",
    75: "KTM X-Bow GT2"
  };

  let leaderboardData = [];
  let leaderboardLoaded = false;

  async function loadLeaderboardData() {
    if (leaderboardLoaded) return;
    const res = await fetch(API_URL);
    const text = await res.text();
    const json = JSON.parse(text.substring(47).slice(0, -2));
    leaderboardData = json.table.rows.map(r => r.c.map(c => c ? c.v : ""));
    leaderboardLoaded = true;
  }

  async function showTrackLeaderboard(track, driverName) {
    await loadLeaderboardData();

    // Row layout from sheet: [0]=Track, [1]=Date, [2]=Session, [3]=Driver, [4]=CarId, [5]=BestLap, [6]=TotalTime
    const rowsForTrack = leaderboardData
      .filter(r => r[0] === track && r[5]); // ensure we have a best lap

    rowsForTrack.sort((a, b) => timeToSeconds(a[5]) - timeToSeconds(b[5]));

    const tbody = document.getElementById("leaderboardBody");
    tbody.innerHTML = "";

    rowsForTrack.forEach((row, index) => {
      const tr = document.createElement("tr");
      const isCurrentDriver = row[3] && driverName && row[3].toString().trim().toLowerCase() === driverName.trim().toLowerCase();
      if (isCurrentDriver) {
        tr.className = "bg-yellow-100";
      }

      const date = row[1] || "";
      const session = row[2] || "";
      const driver = row[3] || "";
      const carId = row[4];
      const bestLap = row[5] || "";
      const carName = carMap[carId] || carId || "";

      tr.innerHTML = `
        <td class="px-4 py-2">${index + 1}</td>
        <td class="px-4 py-2">${driver}</td>
        <td class="px-4 py-2">${carName}</td>
        <td class="px-4 py-2">${bestLap}</td>
        <td class="px-4 py-2">${session}</td>
        <td class="px-4 py-2">${date}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("leaderboardTrackName").textContent = track;
    document.getElementById("leaderboardSection").classList.remove("hidden");
  }

  /* ----- Form submit ----- */

  document.getElementById("classificationForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    document.getElementById("bopNote").style.display = "none";

    const name = document.getElementById("driverName").value.trim();
    const track = document.getElementById("track").value;
    const carClass = document.getElementById("carClass").value;
    const lapTime = document.getElementById("lapTime").value.trim();
    const weather = document.getElementById("weather").value;

    const resultData = classify(track, carClass, lapTime);

    document.getElementById("result").innerHTML = `
      <div class="mb-4">
        <a href="https://discord.gg/bBax4w29vS" target="_blank"
           class="inline-block mt-4 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded">
          ðŸ“¤ Share this result on Discord
        </a>
      </div>
      ${name}, your classification is:<br><strong>${resultData.classification}</strong><br>
      <span class="text-sm text-gray-600">${resultData.gapInfo}</span><br><br>
      <span class="text-sm text-blue-700 italic">${getRandomTip()}</span>
    `;

    document.getElementById("simgridPromo").classList.remove("hidden");

    // Save to sheet via Apps Script (as before)
    const formData = new URLSearchParams();
    formData.append("name", name);
    formData.append("track", track);
    formData.append("carClass", carClass);
    formData.append("lapTime", lapTime);
    formData.append("weather", weather);
    formData.append("result", resultData.classification);

    fetch("https://script.google.com/macros/s/AKfycbyITdZAsY0oaeG48PK5r120i1d4Qp_4GUw4QgQygAFihv1NkIMcIpctOaxdjD9Ru0wr/exec", {
      method: "POST",
      mode: "no-cors",
      headers: {"Content-Type": "application/x-www-form-urlencoded"},
      body: formData.toString()
    });

    // After saving, show leaderboard for this track
    showTrackLeaderboard(track, name);
  });

</script>

</body>
</html>
