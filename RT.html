<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFWL Season Rules Gate</title>
  <style>
    body { font-family: system-ui, Arial; background:#0b0f17; color:#e6eefc; margin:0; padding:40px; }
    .card { max-width:720px; margin:0 auto; background:#111a2b; border:1px solid #22304d; border-radius:14px; padding:28px; }
    h1 { margin:0 0 10px 0; font-size:34px; }
    .muted { opacity:.82; font-size:14px; line-height:1.5; }
    .actions { margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    button {
      background:#5865F2; color:white; border:0; padding:10px 14px;
      border-radius:10px; font-weight:800; cursor:pointer;
    }
    button:hover { filter:brightness(1.05); }
    .btnSecondary { background:#334155; }

    .status { margin-top:14px; padding:12px; border-radius:10px; }
    .ok { background:#0f2a1b; border:1px solid #1f6b3b; }
    .bad { background:#2a1414; border:1px solid #7a2a2a; }

    code { background:#0b1220; padding:2px 6px; border-radius:6px; }

    #rulesOrEligibility { margin-top: 14px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>IFWL Season 2 Rules Access</h1>
    <p class="muted">
      Login with Discord. To access the rules you must have <b>BOTH</b> required roles:
      <b>SIMGRIDEVENTMEMBER</b> and <b>IFWL ACTIVE RACER</b>.
    </p>

    <div class="actions">
      <button id="loginBtn">Login with Discord</button>
      <button id="logoutBtn" class="btnSecondary" style="display:none;">Logout</button>
    </div>

    <div id="result" class="status" style="display:none;"></div>
    <div id="rulesOrEligibility"></div>

    <p class="muted" style="margin-top:16px;">
      Tip: This page expects a backend endpoint at:<br/>
      <code id="endpointHint"></code>
    </p>
  </div>

  <script>
    // Backend endpoint
    const FUNCTION = "https://europe-west2-ifwl-591d8.cloudfunctions.net/rtGate";
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // MUST have BOTH
    const REQUIRED_ROLE_IDS = [
      "1452080618799235224", // SIMGRIDEVENTMEMBER
      "1166713466917224449"  // IFWL ACTIVE RACER
    ];

    // Rules page
    const RULES_URL = "https://ifwlowner.github.io/ACC-driver-classifier/s2rules.html";

    document.getElementById("endpointHint").textContent = FUNCTION;

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const resultBox = document.getElementById("result");

    function show(status, ok) {
      resultBox.style.display = "block";
      resultBox.className = "status " + (ok ? "ok" : "bad");
      resultBox.innerHTML = status;
    }

    function setLoggedInUI(isLoggedIn) {
      loginBtn.style.display = isLoggedIn ? "none" : "inline-block";
      logoutBtn.style.display = isLoggedIn ? "inline-block" : "none";
    }

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, c =>
        ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c])
      );
    }

    function clearSession() {
      localStorage.removeItem("IFWL_RT_SESSION");
      localStorage.removeItem("IFWL_RT_USER");
    }

    function hasBothRequiredRoles(roleIds) {
      const roles = Array.isArray(roleIds) ? roleIds.map(String) : [];
      return REQUIRED_ROLE_IDS.every(req => roles.includes(req));
    }

    // Decode JWT payload (no verification; just for reading roles)
    function decodeJwtPayload(token) {
      try {
        const parts = String(token || "").split(".");
        if (parts.length < 2) return null;
        const b64 = parts[1].replace(/-/g, "+").replace(/_/g, "/");
        const padded = b64 + "===".slice((b64.length + 3) % 4);
        const json = atob(padded);
        return JSON.parse(json);
      } catch {
        return null;
      }
    }

    function renderRulesOrEligibility(isGreen) {
      const el = document.getElementById("rulesOrEligibility");
      if (!el) return;

      if (isGreen) {
        el.innerHTML = `
          <div style="margin-top:12px; padding:12px; border:1px solid #bbf7d0; background:#ecfdf5; border-radius:14px;">
            <div style="font-weight:800; color:#065f46;">You‚Äôre eligible.</div>
            <div style="margin-top:6px; color:#065f46; font-size:14px;">
              Click below to view the Season 2 Rules.
            </div>
            <a href="${RULES_URL}"
              target="_blank" rel="noopener noreferrer"
              style="display:inline-block; margin-top:10px; padding:10px 14px; border-radius:12px;
                    text-decoration:none; font-weight:800; border:1px solid #bbf7d0; background:#fff;">
              üìò Season 2 Rules
            </a>
          </div>
        `;
      } else {
        el.innerHTML = `
          <div style="margin-top:12px; padding:12px; border:1px solid #fecaca; background:#fff5f5; border-radius:14px;">
            <div style="font-weight:900; color:#7f1d1d;">You‚Äôre not eligible yet.</div>
            <div style="margin-top:6px; color:#7f1d1d; font-size:14px;">
              To access the rules you need <b>BOTH</b>:
            </div>
            <ol style="margin:10px 0 0 18px; color:#7f1d1d; font-size:14px;">
              <li>
                <strong>Be in an IFWL SimGrid hosted event</strong> (you must be signed up/registered and active on the event).
              </li>
              <li>
                <strong>Have a fully updated Driver Profile on</strong>
                <a href="https://ifwl.net" target="_blank" rel="noopener noreferrer" style="font-weight:900; color:#7f1d1d;">
                  www.ifwl.net
                </a>.
                Once fully complete your IFWL Discord name will show formatted correctly like:
                <span style="font-family:monospace; font-weight:900;">[ 81 ] - drivername</span>
              </li>
            </ol>
          </div>
        `;
      }
    }

    async function startLogin() {
      const startUrl = FUNCTION + `?start=1&redirect=${encodeURIComponent(REDIRECT_URI)}`;
      const r = await fetch(startUrl);
      const data = await r.json();
      if (!data.url) throw new Error(data.error || "No login url returned");
      window.location.href = data.url;
    }

    async function handleCallback() {
      const params = new URLSearchParams(location.search);
      const code = params.get("code");
      const error = params.get("error");

      if (error) {
        show(`‚ùå Discord login error: <b>${escapeHtml(error)}</b>`, false);
        renderRulesOrEligibility(false);
        return;
      }
      if (!code) return;

      show("Checking your roles‚Ä¶", true);

      const checkUrl =
        FUNCTION +
        `?code=${encodeURIComponent(code)}&redirect=${encodeURIComponent(REDIRECT_URI)}&issue=1`;

      const r = await fetch(checkUrl);
      const data = await r.json();

      // Clean URL
      history.replaceState({}, document.title, REDIRECT_URI);

      setLoggedInUI(true);

      // Store session token if provided
      if (data.sessionToken) {
        localStorage.setItem("IFWL_RT_SESSION", data.sessionToken);
      }

      // üî• FIX: Use roles embedded in sessionToken, since backend already includes them.
      const token = data.sessionToken || localStorage.getItem("IFWL_RT_SESSION") || "";
      const payload = decodeJwtPayload(token);
      const tokenRoles = payload && Array.isArray(payload.roles) ? payload.roles : null;

      // If token roles exist, enforce BOTH. Otherwise fallback to backend accessGranted.
      const granted = tokenRoles ? hasBothRequiredRoles(tokenRoles) : !!data.accessGranted;

      localStorage.setItem("IFWL_RT_USER", JSON.stringify({
        username: data.username,
        userId: data.userId,
        granted
      }));

      if (granted) {
        show(`‚úÖ Access granted for <b>${escapeHtml(data.username || "user")}</b>.`, true);
        renderRulesOrEligibility(true);
      } else {
        show(`‚õî <b>Access Denied</b><br/>Discord: ${escapeHtml(data.username || "user")}`, false);
        renderRulesOrEligibility(false);
      }
    }

    loginBtn.addEventListener("click", () => {
      startLogin().catch(e => {
        show(`‚ùå ${escapeHtml(e.message || e)}`, false);
        renderRulesOrEligibility(false);
      });
    });

    logoutBtn.addEventListener("click", () => {
      clearSession();
      setLoggedInUI(false);
      show("Logged out.", true);
      document.getElementById("rulesOrEligibility").innerHTML = "";
    });

    handleCallback().catch(e => {
      show(`‚ùå ${escapeHtml(e.message || e)}`, false);
      renderRulesOrEligibility(false);
    });
  </script>
</body>
</html>
