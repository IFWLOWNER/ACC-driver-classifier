<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFWL RT Role Gate</title>
  <style>
    body { font-family: system-ui, Arial; background:#0b0f17; color:#e6eefc; margin:0; padding:40px; }
    .card { max-width:720px; margin:0 auto; background:#111a2b; border:1px solid #22304d; border-radius:14px; padding:22px; }
    button { background:#5865F2; color:white; border:0; padding:12px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:hover { filter:brightness(1.05); }
    .muted { opacity:.8; font-size:14px; }
    .status { margin-top:14px; padding:12px; border-radius:10px; }
    .ok { background:#0f2a1b; border:1px solid #1f6b3b; }
    .bad { background:#2a1414; border:1px solid #7a2a2a; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="card">
    <h1>IFWL Race Team Gate (Test v1)</h1>
    <p class="muted">
      Login with Discord. If you have <b>IFWL Race team Assessor</b> or <b>IFWL RACE TEAM ACC</b>, you’ll get access.
    </p>

    <button id="loginBtn">Login with Discord</button>
    <button id="logoutBtn" style="display:none;background:#334155;margin-left:8px;">Logout</button>

    <div id="result" class="status" style="display:none;"></div>

    <p class="muted" style="margin-top:16px;">
      Tip: This page expects a backend endpoint at:<br/>
      <code id="endpointHint"></code>
    </p>
  </div>

  <script>
  const FUNCTION = "https://europe-west2-ifwl-591d8.cloudfunctions.net/rtGate";
  const REDIRECT_URI = window.location.origin + window.location.pathname;

  document.getElementById("endpointHint").textContent = FUNCTION;

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const resultBox = document.getElementById("result");

  function show(status, ok) {
    resultBox.style.display = "block";
    resultBox.className = "status " + (ok ? "ok" : "bad");
    resultBox.innerHTML = status;
  }

  function setLoggedInUI(isLoggedIn) {
    loginBtn.style.display = isLoggedIn ? "none" : "inline-block";
    logoutBtn.style.display = isLoggedIn ? "inline-block" : "none";
  }

  function escapeHtml(s) {
    return String(s || "").replace(/[&<>"']/g, c =>
      ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c])
    );
  }

  async function startLogin() {
    const startUrl = FUNCTION + `?start=1&redirect=${encodeURIComponent(REDIRECT_URI)}`;
    const r = await fetch(startUrl);
    const data = await r.json();
    if (!data.url) throw new Error(data.error || "No login url returned");
    window.location.href = data.url;
  }

  async function handleCallback() {
    const params = new URLSearchParams(location.search);
    const code = params.get("code");
    const error = params.get("error");

    if (error) {
      show(`❌ Discord login error: <b>${escapeHtml(error)}</b>`, false);
      return;
    }
    if (!code) return;

    show("Checking your roles…", true);

    const checkUrl = FUNCTION + `?code=${encodeURIComponent(code)}&redirect=${encodeURIComponent(REDIRECT_URI)}`;
    const r = await fetch(checkUrl);
    const data = await r.json();

    // clean URL
    history.replaceState({}, document.title, REDIRECT_URI);

    setLoggedInUI(true);

    

  loginBtn.addEventListener("click", () => {
    startLogin().catch(e => show(`❌ ${escapeHtml(e.message || e)}`, false));
  });

  // For now, “logout” is just UI reset (we’re not storing a session)
  logoutBtn.addEventListener("click", () => {
    setLoggedInUI(false);
    show("Logged out.", true);
  });

  handleCallback().catch(e => show(`❌ ${escapeHtml(e.message || e)}`, false));
</script>
</body>
</html>
