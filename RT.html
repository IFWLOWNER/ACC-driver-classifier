<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IFWL Season 2 Rules Access test</title>
  <style>
    body { font-family: system-ui, Arial; background:#0b0f17; color:#e6eefc; margin:0; padding:40px; }
    .card { max-width:720px; margin:0 auto; background:#111a2b; border:1px solid #22304d; border-radius:14px; padding:22px; }
    button { background:#5865F2; color:white; border:0; padding:12px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:hover { filter:brightness(1.05); }
    .muted { opacity:.8; font-size:14px; line-height:1.5; }
    .status { margin-top:14px; padding:12px; border-radius:10px; }
    .ok { background:#0f2a1b; border:1px solid #1f6b3b; }
    .bad { background:#2a1414; border:1px solid #7a2a2a; }
    code { background:#0b1220; padding:2px 6px; border-radius:6px; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #2b3b5e; background:#0b1220; }
  </style>
</head>
<body>
  <div class="card">
    <h1 style="margin:0 0 6px 0;">IFWL Season 2 Rules Access</h1>
    <p class="muted" style="margin:0 0 12px 0;">
      Login with Discord. To access the rules you must have <b>BOTH</b> required roles:
      <b>SIMGRIDEVENTMEMBER</b> and <b>IFWL ACTIVE RACER</b>.
    </p>

    <button id="loginBtn">Login with Discord</button>
    <button id="logoutBtn" style="display:none;background:#334155;margin-left:8px;">Logout</button>

    <div id="result" class="status" style="display:none;"></div>
    <div id="rulesOrEligibility"></div>

    <p class="muted" style="margin-top:16px;">
      Tip: This page expects a backend endpoint at:<br/>
      <code id="endpointHint"></code>
    </p>
  </div>

  <script>
    const FUNCTION = "https://europe-west2-ifwl-591d8.cloudfunctions.net/rtGate";
    const REDIRECT_URI = window.location.origin + window.location.pathname;

    // Public URL for display only (actual access should route via backend so we can log reads)
    const RULES_URL = "https://ifwlowner.github.io/ACC-driver-classifier/s2rules.html";

    document.getElementById("endpointHint").textContent = FUNCTION;

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const resultBox = document.getElementById("result");

    function show(status, ok) {
      resultBox.style.display = "block";
      resultBox.className = "status " + (ok ? "ok" : "bad");
      resultBox.innerHTML = status;
    }

    function setLoggedInUI(isLoggedIn) {
      loginBtn.style.display = isLoggedIn ? "none" : "inline-block";
      logoutBtn.style.display = isLoggedIn ? "inline-block" : "none";
    }

    function escapeHtml(s) {
      return String(s || "").replace(/[&<>"']/g, c =>
        ({ "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c])
      );
    }

    // ‚úÖ Open rules through backend so Firestore logging happens (rules_access collection)
    function openRulesViaBackend() {
      const token = localStorage.getItem("IFWL_RT_SESSION") || "";
      if (!token) {
        show("‚ö†Ô∏è Missing session. Please login again.", false);
        return;
      }
      const url = FUNCTION + `?rules=1&token=${encodeURIComponent(token)}`;
      window.open(url, "_blank", "noopener,noreferrer");
    }

    function renderRulesOrEligibility(isGreen) {
      const el = document.getElementById("rulesOrEligibility");
      if (!el) return;

      if (isGreen) {
        el.innerHTML = `
          <div style="margin-top:12px; padding:12px; border:1px solid #bbf7d0; background:#ecfdf5; border-radius:14px;">
            <div style="font-weight:800; color:#065f46;">You‚Äôre eligible.</div>
            <div style="margin-top:6px; color:#065f46; font-size:14px;">
              Click below to view the Season 2 Rules.
            </div>

            <!-- IMPORTANT: This button routes via backend (rtGate?rules=1) so access can be logged -->
            <button id="rulesBtn"
              style="display:inline-block; margin-top:10px; padding:10px 14px; border-radius:12px;
                     font-weight:800; border:1px solid #bbf7d0; background:#fff; color:#111; cursor:pointer;">
              üìò Season 2 Rules
            </button>

            <div style="margin-top:8px; font-size:12px; color:#065f46; opacity:.85;">
              (This will open via the IFWL gateway so rule access can be tracked.)
            </div>

            <div style="margin-top:10px; font-size:12px; opacity:.7; color:#065f46;">
              Direct link (public): <a href="${RULES_URL}" target="_blank" rel="noopener noreferrer" style="color:#065f46; font-weight:800;">${RULES_URL}</a>
            </div>
          </div>
        `;

        // Wire up button AFTER innerHTML is set
        const btn = document.getElementById("rulesBtn");
        if (btn) btn.addEventListener("click", openRulesViaBackend);

      } else {
        el.innerHTML = `
          <div style="margin-top:12px; padding:12px; border:1px solid #fecaca; background:#fff5f5; border-radius:14px;">
            <div style="font-weight:900; color:#7f1d1d;">You‚Äôre not eligible yet.</div>
            <div style="margin-top:6px; color:#7f1d1d; font-size:14px;">
              To access the rules you need <b>BOTH</b>:
            </div>
            <ol style="margin:10px 0 0 18px; color:#7f1d1d; font-size:14px;">
              <li><strong>Be in an IFWL SimGrid hosted event</strong> (you must be signed up/registered and active on the event).</li>
              <li>
                <strong>Have a fully updated Driver Profile on</strong>
                <a href="https://ifwl.net" target="_blank" rel="noopener noreferrer" style="font-weight:900; color:#7f1d1d;">
                  www.ifwl.net
                </a>.
                Once fully complete your IFWL Discord name will show formatted correctly like:
                <span style="font-family:monospace; font-weight:900;">[ 81 ] - drivername</span>
              </li>
            </ol>
          </div>
        `;
      }
    }

    async function startLogin() {
      const startUrl = FUNCTION + `?start=1&redirect=${encodeURIComponent(REDIRECT_URI)}`;
      const r = await fetch(startUrl);
      const data = await r.json();
      if (!data.url) throw new Error(data.error || "No login url returned");
      window.location.href = data.url;
    }

    async function handleCallback() {
      const params = new URLSearchParams(location.search);
      const code = params.get("code");
      const error = params.get("error");

      if (error) {
        show(`‚ùå Discord login error: <b>${escapeHtml(error)}</b>`, false);
        renderRulesOrEligibility(false);
        return;
      }
      if (!code) return;

      show("Checking your roles‚Ä¶", true);

      const checkUrl =
        FUNCTION +
        `?code=${encodeURIComponent(code)}&redirect=${encodeURIComponent(REDIRECT_URI)}&issue=1`;

      const r = await fetch(checkUrl);
      const data = await r.json();

      // clean URL
      history.replaceState({}, document.title, REDIRECT_URI);

      setLoggedInUI(true);

      // store session if backend sent one
      if (data.sessionToken) {
        localStorage.setItem("IFWL_RT_SESSION", data.sessionToken);
      }

      // ‚úÖ RULES PAGE MUST USE rulesGranted (NOT accessGranted)
      const eligibleForRules = !!data.rulesGranted;

      // Optional: show a tiny pill about Race Team hub access, but do NOT block rules
      const rtPill = data.accessGranted
        ? `<span class="pill">Race Team Hub: YES</span>`
        : `<span class="pill">Race Team Hub: NO</span>`;

      if (eligibleForRules) {
        show(`‚úÖ Rules access granted for <b>${escapeHtml(data.username || "user")}</b> &nbsp; ${rtPill}`, true);
        renderRulesOrEligibility(true);
      } else {
        show(`‚õî Rules access denied for <b>${escapeHtml(data.username || "user")}</b> &nbsp; ${rtPill}`, false);
        renderRulesOrEligibility(false);
      }
    }

    loginBtn.addEventListener("click", () => {
      startLogin().catch(e => show(`‚ùå ${escapeHtml(e.message || e)}`, false));
    });

    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem("IFWL_RT_SESSION");
      setLoggedInUI(false);
      show("Logged out.", true);
      document.getElementById("rulesOrEligibility").innerHTML = "";
    });

    handleCallback().catch(e => {
      show(`‚ùå ${escapeHtml(e.message || e)}`, false);
      renderRulesOrEligibility(false);
    });
  </script>
</body>
</html>
